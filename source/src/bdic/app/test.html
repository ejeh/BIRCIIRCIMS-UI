<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Refactored Multi-Step Form</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
      .status-indicator {
        position: fixed;
        top: 10px;
        right: 10px;
        padding: 8px 12px;
        border-radius: 4px;
        font-weight: bold;
        z-index: 1000;
      }
      .status-saving {
        background: #ffc107;
        color: #000;
      }
      .status-saved {
        background: #28a745;
        color: #fff;
      }
      .status-error {
        background: #dc3545;
        color: #fff;
      }
    </style>
  </head>
  <body>
    <div id="autoSaveStatus" class="status-indicator">Ready</div>
    <script>
      $(document).ready(function () {
        // Form steps data
        const steps = [
          { id: "profile", title: "Profile Details", icon: "bi-person" },
          { id: "address", title: "Residential Address", icon: "bi-geo-alt" },
          { id: "identity", title: "Identification", icon: "bi-credit-card" },
          { id: "nok", title: "Next of Kin", icon: "bi-people" },
          { id: "contacts", title: "Contact Details", icon: "bi-telephone" },
          { id: "family", title: "Family Details", icon: "bi-people" },
          { id: "business", title: "Business Details", icon: "bi-briefcase" },
          {
            id: "employment",
            title: "Employment History",
            icon: "bi-briefcase",
          },
          {
            id: "education",
            title: "Education Details",
            icon: "bi-mortarboard",
          },
          { id: "health", title: "Health Information", icon: "bi-heart" },
        ];

        let currentStep = 0;

        // Use unique IDs instead of indices to prevent renumbering issues
        let nextNeighborId = 1;
        let nextFamilyId = 1;
        let nextEmploymentId = 1;
        let nextInstitutionId = 1;

        // Keep track of active items
        const activeNeighbors = new Set();
        const activeFamilyMembers = new Set();
        const activeEmployments = new Set();
        const activeInstitutions = new Set();

        // Initialize form
        updateStepDisplay();

        // Initialize first items
        activeNeighbors.add(0);
        activeFamilyMembers.add(0);
        activeEmployments.add(0);
        activeInstitutions.add(0);

        // Identification type change handler
        $("#identification").change(function () {
          const value = $(this).val();
          $("#other-identification-container").toggle(value === "others");
        });

        // Generic function to create item HTML
        function createNeighborHTML(id, displayNumber) {
          return `
      <div class="neighbor-item" data-id="${id}">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <label class="form-label">Neighbor ${displayNumber}</label>
          <button type="button" class="btn btn-outline-danger btn-sm remove-neighbor" data-id="${id}">
            <i class="bi bi-dash"></i>
          </button>
        </div>
        <div class="row g-3">
          <div class="col-md-4">
            <input type="text" class="form-control" name="neighbor_name_${id}" placeholder="Full Name">
          </div>
          <div class="col-md-4">
            <input type="text" class="form-control" name="neighbor_address_${id}" placeholder="Residential Address">
          </div>
          <div class="col-md-4">
            <input type="tel" class="form-control" name="neighbor_phone_${id}" placeholder="Phone Number">
          </div>
        </div>
      </div>
    `;
        }

        function createFamilyHTML(id, displayNumber) {
          return `
      <div class="family-item" data-id="${id}">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <label class="form-label">Family Member ${displayNumber}</label>
          <button type="button" class="btn btn-outline-danger btn-sm remove-family-member" data-id="${id}">
            <i class="bi bi-dash"></i>
          </button>
        </div>
        <div class="row g-3">
          <div class="col-md-3">
            <input type="text" class="form-control" name="family_name_${id}" placeholder="Full Name">
          </div>
          <div class="col-md-3">
            <input type="text" class="form-control" name="family_relationship_${id}" placeholder="Relationship">
          </div>
          <div class="col-md-3">
            <input type="text" class="form-control" name="family_address_${id}" placeholder="Residential Address">
          </div>
          <div class="col-md-3">
            <input type="tel" class="form-control" name="family_phone_${id}" placeholder="Phone Number">
          </div>
        </div>
      </div>
    `;
        }

        function createEmploymentHTML(id, displayNumber) {
          return `
      <div class="employment-item" data-id="${id}">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <label class="form-label">Employment ${displayNumber}</label>
          <button type="button" class="btn btn-outline-danger btn-sm remove-employment" data-id="${id}">
            <i class="bi bi-dash"></i>
          </button>
        </div>
        
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Company Name</label>
            <input type="text" class="form-control" name="companyName_${id}" placeholder="Enter company name">
          </div>
          <div class="col-md-6">
            <label class="form-label">Address</label>
            <input type="text" class="form-control" name="employment_address_${id}" placeholder="Enter company address">
          </div>
          <div class="col-md-6">
            <label class="form-label">Designation</label>
            <input type="text" class="form-control" name="designation_${id}" placeholder="Enter your designation">
          </div>
          <div class="col-md-6">
            <label class="form-label">Start Year</label>
            <input type="number" class="form-control" name="startYear_${id}" placeholder="Enter start year">
          </div>
          <div class="col-md-6">
            <label class="form-label">End Year</label>
            <input type="number" class="form-control" name="endYear_${id}" placeholder="Enter end year">
            <p class="text-muted small mt-1">Leave blank if this is your current employment.</p>
          </div>
          <div class="col-md-6">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="isCurrentEmployment_${id}" name="isCurrentEmployment_${id}">
              <label class="form-check-label" for="isCurrentEmployment_${id}">
                This is my current employment
              </label>
            </div>
          </div>
        </div>

        <div class="mt-3">
          <label class="form-label">Description of Company</label>
          <textarea class="form-control" name="employment_description_${id}" rows="3" placeholder="Describe the company"></textarea>
        </div>
      </div>
    `;
        }

        function createInstitutionHTML(id, displayNumber) {
          return `
      <div class="institution-item border rounded p-4 mt-3" data-id="${id}">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <label class="form-label">Tertiary Institution ${displayNumber}</label>
          <button type="button" class="btn btn-outline-danger btn-sm remove-institution" data-id="${id}">
            <i class="bi bi-dash"></i>
          </button>
        </div>
        
        <div class="row g-3">
          <div class="col-md-6">
            <input type="text" class="form-control" name="tertiaryInstitution_name_${id}" placeholder="Name of Tertiary Institution">
          </div>
          <div class="col-md-6">
            <input type="text" class="form-control" name="tertiaryInstitution_address_${id}" placeholder="Address of Tertiary Institution">
          </div>
          <div class="col-md-6">
            <input type="text" class="form-control" name="tertiaryInstitution_certificate_${id}" placeholder="Certificate Obtained">
          </div>
          <div class="col-md-6">
            <input type="text" class="form-control" name="tertiaryInstitution_matricNo_${id}" placeholder="Matriculation Number">
          </div>
          <div class="col-md-12">
            <input type="text" class="form-control" name="tertiaryInstitution_year_${id}" placeholder="Year of Attendance">
          </div>
        </div>
      </div>
    `;
        }

        // Function to update display numbers without changing form names
        function updateDisplayNumbers(
          containerSelector,
          itemSelector,
          labelPrefix,
          activeSet
        ) {
          const items = $(containerSelector).find(itemSelector);
          items.each(function (index) {
            $(this)
              .find(".form-label")
              .first()
              .text(`${labelPrefix} ${index + 1}`);
          });

          // Update remove button visibility
          const removeButtons = $(containerSelector).find(
            ".btn-outline-danger"
          );
          removeButtons.toggle(activeSet.size > 1);
        }

        // Add neighbor handler
        $("#add-neighbor").click(function () {
          if (activeNeighbors.size < 5) {
            const id = nextNeighborId++;
            activeNeighbors.add(id);

            const neighborHtml = createNeighborHTML(id, activeNeighbors.size);
            $("#neighbors-container").append(neighborHtml);

            // Update UI state
            $("#neighbor-max-message").toggle(activeNeighbors.size >= 5);
            $("#add-neighbor").prop("disabled", activeNeighbors.size >= 5);
            updateDisplayNumbers(
              "#neighbors-container",
              ".neighbor-item",
              "Neighbor",
              activeNeighbors
            );
          }
        });

        // Remove neighbor handler (delegated)
        $("#neighbors-container").on("click", ".remove-neighbor", function () {
          const id = parseInt($(this).data("id"));
          if (activeNeighbors.size > 1) {
            $(this).closest(".neighbor-item").remove();
            activeNeighbors.delete(id);

            // Update UI state
            $("#neighbor-max-message").hide();
            $("#add-neighbor").prop("disabled", false);
            updateDisplayNumbers(
              "#neighbors-container",
              ".neighbor-item",
              "Neighbor",
              activeNeighbors
            );
          }
        });

        // Add family member handler
        $("#add-family-member").click(function () {
          if (activeFamilyMembers.size < 5) {
            const id = nextFamilyId++;
            activeFamilyMembers.add(id);

            const familyHtml = createFamilyHTML(id, activeFamilyMembers.size);
            $("#family-members-container").append(familyHtml);

            // Update UI state
            $("#family-max-message").toggle(activeFamilyMembers.size >= 5);
            $("#add-family-member").prop(
              "disabled",
              activeFamilyMembers.size >= 5
            );
            updateDisplayNumbers(
              "#family-members-container",
              ".family-item",
              "Family Member",
              activeFamilyMembers
            );
          }
        });

        // Remove family member handler (delegated)
        $("#family-members-container").on(
          "click",
          ".remove-family-member",
          function () {
            const id = parseInt($(this).data("id"));
            if (activeFamilyMembers.size > 1) {
              $(this).closest(".family-item").remove();
              activeFamilyMembers.delete(id);

              // Update UI state
              $("#family-max-message").hide();
              $("#add-family-member").prop("disabled", false);
              updateDisplayNumbers(
                "#family-members-container",
                ".family-item",
                "Family Member",
                activeFamilyMembers
              );
            }
          }
        );

        // Add employment handler
        $("#add-employment").click(function () {
          const id = nextEmploymentId++;
          activeEmployments.add(id);

          const employmentHtml = createEmploymentHTML(
            id,
            activeEmployments.size
          );
          $("#employment-history-container").append(employmentHtml);

          updateDisplayNumbers(
            "#employment-history-container",
            ".employment-item",
            "Employment",
            activeEmployments
          );
        });

        // Remove employment handler (delegated)
        $("#employment-history-container").on(
          "click",
          ".remove-employment",
          function () {
            const id = parseInt($(this).data("id"));
            if (activeEmployments.size > 1) {
              $(this).closest(".employment-item").remove();
              activeEmployments.delete(id);

              updateDisplayNumbers(
                "#employment-history-container",
                ".employment-item",
                "Employment",
                activeEmployments
              );
            }
          }
        );

        // Add institution handler
        $("#add-institution").click(function () {
          const id = nextInstitutionId++;
          activeInstitutions.add(id);

          const institutionHtml = createInstitutionHTML(
            id,
            activeInstitutions.size
          );
          $("#tertiary-institutions-container").append(institutionHtml);

          updateDisplayNumbers(
            "#tertiary-institutions-container",
            ".institution-item",
            "Tertiary Institution",
            activeInstitutions
          );
        });

        // Remove institution handler (delegated)
        $("#tertiary-institutions-container").on(
          "click",
          ".remove-institution",
          function () {
            const id = parseInt($(this).data("id"));
            if (activeInstitutions.size > 1) {
              $(this).closest(".institution-item").remove();
              activeInstitutions.delete(id);

              updateDisplayNumbers(
                "#tertiary-institutions-container",
                ".institution-item",
                "Tertiary Institution",
                activeInstitutions
              );
            }
          }
        );

        // Next step handler
        $("#next-step").click(function () {
          if (currentStep < steps.length - 1) {
            currentStep++;
            updateStepDisplay();
          }
        });

        // Previous step handler
        $("#prev-step").click(function () {
          if (currentStep > 0) {
            currentStep--;
            updateStepDisplay();
          }
        });

        // Form submit handler
        $("#unifiedForm").submit(function (e) {
          e.preventDefault();
          // Add your form submission logic here
          console.log("Form submitted");
        });

        // Update step display
        function updateStepDisplay() {
          // Hide all sections
          $(".form-section").removeClass("active");

          // Show current section
          $(`#${steps[currentStep].id}-section`).addClass("active");

          // Update step info in header
          $("#current-step-title").text(steps[currentStep].title);
          $("#current-step-description").text(
            `Step ${currentStep + 1} of ${steps.length}`
          );
          $("#current-step-icon")
            .removeClass()
            .addClass(`bi ${steps[currentStep].icon}`);

          // Update progress bar
          const progressPercent = ((currentStep + 1) / steps.length) * 100;
          $("#progress-bar").css("width", `${progressPercent}%`);

          // Update navigation buttons
          $("#prev-step").prop("disabled", currentStep === 0);

          if (currentStep === steps.length - 1) {
            $("#next-step").hide();
            $("#submit-btn").show();
          } else {
            $("#next-step").show();
            $("#submit-btn").hide();
          }
        }
      });
    </script>
    <script>
      $(document).ready(function () {
        // Hold state for counts and the auto-save timer.
        const state = {
          autoSaveTimer: null,
          institutionCount: 0,
          neighborCount: 0,
          familyCount: 0,
          employmentCount: 0,
          isDataLoaded: false, // Flag to prevent premature auto-saves
          pendingSave: false, // Flag to prevent concurrent saves
        };

        // Utility function to set input values safely
        const setInputValue = (id, value) => {
          const element = document.getElementById(id);
          if (element) {
            element.value = value || "";
          }
        };

        // Debounced auto-save function
        const debouncedAutoSave = (() => {
          let timeoutId;
          return (delay = 1000) => {
            clearTimeout(timeoutId);
            $("#autoSaveStatus").text("Saving...").css("color", "blue");
            timeoutId = setTimeout(() => {
              if (state.isDataLoaded) {
                autoSave();
              }
            }, delay);
          };
        })();

        /* ===================================================
         * Field Addition Functions (Improved)
         * =================================================== */

        // Add a new tertiary institution section with better validation
        const addInstitution = (institutionData = {}) => {
          const container = $("#tertiary-institution-container");
          const index = container.find(".institution-fields").length;

          const newInstitutionFields = `
      <div class="institution-fields m-b30" data-index="${index}">
        <label class="form-label">Tertiary Institution ${index + 1}</label>
        <input
          type="text"
          class="form-control institution-input"
          name="educationalHistory.tertiaryInstitutions[${index}].name"
          placeholder="Name of Tertiary Institution"
          value="${escapeHtml(institutionData.name || "")}"
          data-field="name"
        />
        <input
          type="text"
          class="form-control institution-input"
          name="educationalHistory.tertiaryInstitutions[${index}].address"
          placeholder="Address of Tertiary Institution"
          value="${escapeHtml(institutionData.address || "")}"
          data-field="address"
        />
        <input
          type="text"
          class="form-control institution-input"
          name="educationalHistory.tertiaryInstitutions[${index}].certificateObtained"
          placeholder="Certificate Obtained"
          value="${escapeHtml(institutionData.certificateObtained || "")}"
          data-field="certificateObtained"
        />
        <input
          type="text"
          class="form-control institution-input"
          name="educationalHistory.tertiaryInstitutions[${index}].matricNo"
          placeholder="Matriculation Number"
          value="${escapeHtml(institutionData.matricNo || "")}"
          data-field="matricNo"
        />
        <input
          type="text"
          class="form-control institution-input"
          name="educationalHistory.tertiaryInstitutions[${index}].yearOfAttendance"
          placeholder="Year of Attendance"
          value="${escapeHtml(institutionData.yearOfAttendance || "")}"
          data-field="yearOfAttendance"
        />
        <button type="button" class="btn btn-danger btn-sm remove-institution mt-2">Remove</button>
      </div>`;

          container.append(newInstitutionFields);
          state.institutionCount++;

          // Bind remove button event
          container
            .find(".remove-institution")
            .last()
            .on("click", function () {
              $(this).closest(".institution-fields").remove();
              state.institutionCount--;
              reindexInstitutions();
            });

          // Only trigger auto-save if data is already loaded (not during initial population)
          if (state.isDataLoaded) {
            debouncedAutoSave();
          }
        };

        // Reindex institutions after removal
        const reindexInstitutions = () => {
          $("#tertiary-institution-container .institution-fields").each(
            function (newIndex) {
              $(this).attr("data-index", newIndex);
              $(this)
                .find("label")
                .text(`Tertiary Institution ${newIndex + 1}`);
              $(this)
                .find("input")
                .each(function () {
                  const currentName = $(this).attr("name");
                  if (
                    currentName &&
                    currentName.includes("tertiaryInstitutions")
                  ) {
                    const newName = currentName.replace(
                      /\[\d+\]/,
                      `[${newIndex}]`
                    );
                    $(this).attr("name", newName);
                  }
                });
            }
          );
        };

        // Add a new family section with improved validation
        const addFamily = (familyData = {}) => {
          if (state.familyCount >= 5) {
            console.warn("Maximum family members reached");
            return;
          }

          const container = $("#family-container");
          const index = container.find(".family-fields").length;

          const newFamilyFields = `
      <div class="family-fields m-b30" data-index="${index}">
        <label class="form-label">Family ${index + 1}</label>
        <input 
          type="text" 
          class="form-control m-b10 family-name" 
          name="family_name[]" 
          placeholder="Full Name" 
          value="${escapeHtml(familyData.name || "")}"
        />
        <input
          type="text" 
          class="form-control m-b10 family-relationship" 
          name="family_relationship[]" 
          placeholder="Relationship" 
          value="${escapeHtml(familyData.relationship || "")}"
        />
        <input 
          type="tel" 
          class="form-control family-phone" 
          name="family_phone[]" 
          placeholder="Phone Number" 
          value="${escapeHtml(familyData.phone || "")}"
        />
        <input 
          type="text" 
          class="form-control family-address" 
          name="family_address[]" 
          placeholder="Residential Address" 
          value="${escapeHtml(familyData.address || "")}"
        />
        <button type="button" class="btn btn-danger btn-sm remove-family mt-2">Remove</button>
      </div>`;

          container.append(newFamilyFields);
          state.familyCount++;

          // Update button state
          updateFamilyButtonState();

          // Bind remove button event
          container
            .find(".remove-family")
            .last()
            .on("click", function () {
              $(this).closest(".family-fields").remove();
              state.familyCount--;
              updateFamilyButtonState();
              reindexFamily();
            });

          if (state.isDataLoaded) {
            debouncedAutoSave();
          }
        };

        // Update family button state
        const updateFamilyButtonState = () => {
          const addButton = $("#add-family");
          if (state.familyCount >= 5) {
            addButton
              .prop("disabled", true)
              .text("Maximum family reached")
              .removeClass("btn-primary")
              .addClass("btn-secondary");
          } else {
            addButton
              .prop("disabled", false)
              .text("Add Family Member")
              .removeClass("btn-secondary")
              .addClass("btn-primary");
          }
        };

        // Reindex family after removal
        const reindexFamily = () => {
          $("#family-container .family-fields").each(function (newIndex) {
            $(this).attr("data-index", newIndex);
            $(this)
              .find("label")
              .text(`Family ${newIndex + 1}`);
          });
        };

        // Add a new neighbor section with improved validation
        const addNeighbor = (neighborData = {}) => {
          if (state.neighborCount >= 5) {
            console.warn("Maximum neighbors reached");
            return;
          }

          const container = $("#neighbors-container");
          const index = container.find(".neighbor-fields").length;

          const newNeighborFields = `
      <div class="neighbor-fields m-b30" data-index="${index}">
        <label class="form-label">Neighbor ${index + 1}</label>
        <input 
          type="text" 
          class="form-control m-b10 neighbor-name" 
          name="neighbor_name[]" 
          placeholder="Full Name" 
          value="${escapeHtml(neighborData.name || "")}"
        />
        <input 
          type="text" 
          class="form-control m-b10 neighbor-address" 
          name="neighbor_address[]" 
          placeholder="Residential Address" 
          value="${escapeHtml(neighborData.address || "")}"
        />
        <input 
          type="tel" 
          class="form-control neighbor-phone" 
          name="neighbor_phone[]" 
          placeholder="Phone Number" 
          value="${escapeHtml(neighborData.phone || "")}"
        />
        <button type="button" class="btn btn-danger btn-sm remove-neighbor mt-2">Remove</button>
      </div>`;

          container.append(newNeighborFields);
          state.neighborCount++;

          // Update button state
          updateNeighborButtonState();

          // Bind remove button event
          container
            .find(".remove-neighbor")
            .last()
            .on("click", function () {
              $(this).closest(".neighbor-fields").remove();
              state.neighborCount--;
              updateNeighborButtonState();
              reindexNeighbors();
            });

          if (state.isDataLoaded) {
            debouncedAutoSave();
          }
        };

        // Update neighbor button state
        const updateNeighborButtonState = () => {
          const addButton = $("#add-neighbor");
          if (state.neighborCount >= 5) {
            addButton
              .prop("disabled", true)
              .text("Maximum neighbors reached")
              .removeClass("btn-primary")
              .addClass("btn-secondary");
          } else {
            addButton
              .prop("disabled", false)
              .text("Add Neighbor")
              .removeClass("btn-secondary")
              .addClass("btn-primary");
          }
        };

        // Reindex neighbors after removal
        const reindexNeighbors = () => {
          $("#neighbors-container .neighbor-fields").each(function (newIndex) {
            $(this).attr("data-index", newIndex);
            $(this)
              .find("label")
              .text(`Neighbor ${newIndex + 1}`);
          });
        };

        // Add a new employment section with improved validation
        const addEmployment = (employmentData = {}) => {
          const container = $("#employment-history-container");
          const index = container.find(".employment-fields").length;

          const newEmploymentFields = `
      <div class="employment-fields m-b30" data-index="${index}">
        <label class="form-label">Employment ${index + 1}</label> 
        <input
          type="text"
          class="form-control"
          name="companyName[]"
          placeholder="Company Name"
          value="${escapeHtml(employmentData.companyName || "")}"
        />
        <input
          type="text"
          class="form-control"
          name="address[]"
          placeholder="Company Address"
          value="${escapeHtml(employmentData.address || "")}"
        />
        <input
          type="text"
          class="form-control"  
          name="designation[]"
          placeholder="Designation"
          value="${escapeHtml(employmentData.designation || "")}"
        />
        <input
          type="number"
          class="form-control"
          name="startYear[]"
          placeholder="Start Year"
          value="${employmentData.startYear || ""}"
        />
        <div>
          <input
            type="number"
            class="form-control"
            name="endYear[]"
            placeholder="End Year"
            value="${employmentData.endYear || ""}"
          />
          <small class="form-text text-muted">Leave blank if this is your current employment.</small>
        </div>
        <div class="form-check">
          <input
            type="checkbox"
            class="form-check-input"
            name="isCurrentEmployment[]"
            ${employmentData.isCurrentEmployment ? "checked" : ""}
          />
          <label class="form-check-label" for="isCurrentEmployment">This is my current employment</label>
        </div>
        <div>
          <label for="description">Description of Company</label>
          <textarea
            class="form-control"
            name="description[]"
            placeholder="Job Description"
          >${escapeHtml(employmentData.description || "")}</textarea>
        </div>
        <button type="button" class="btn btn-danger btn-sm remove-employment mt-2">Remove</button>
      </div>`;

          container.append(newEmploymentFields);
          state.employmentCount++;

          // Bind remove button event
          container
            .find(".remove-employment")
            .last()
            .on("click", function () {
              $(this).closest(".employment-fields").remove();
              state.employmentCount--;
              reindexEmployment();
            });

          if (state.isDataLoaded) {
            debouncedAutoSave();
          }
        };

        // Reindex employment after removal
        const reindexEmployment = () => {
          $("#employment-history-container .employment-fields").each(function (
            newIndex
          ) {
            $(this).attr("data-index", newIndex);
            $(this)
              .find("label")
              .text(`Employment ${newIndex + 1}`);
          });
        };

        // Utility function to escape HTML to prevent XSS
        const escapeHtml = (text) => {
          if (!text) return "";
          const map = {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#039;",
          };
          return text.replace(/[&<>"']/g, (m) => map[m]);
        };

        /* ===================================================
         * Data Population Logic (Improved with Safety Checks)
         * =================================================== */

        const populateTertiaryInstitutions = (institutions) => {
          const container = $("#tertiary-institution-container");
          container.empty(); // Clear existing fields
          state.institutionCount = 0; // Reset count

          if (
            institutions &&
            Array.isArray(institutions) &&
            institutions.length > 0
          ) {
            institutions.forEach((institution) => {
              if (institution && typeof institution === "object") {
                addInstitution(institution);
              }
            });
          } else {
            // Add at least one empty institution field
            addInstitution();
          }
        };

        const populateFamily = (family) => {
          const container = $("#family-container");
          container.empty(); // Clear existing fields
          state.familyCount = 0; // Reset count

          if (family && Array.isArray(family) && family.length > 0) {
            family.forEach((fam) => {
              if (fam && typeof fam === "object") {
                addFamily(fam);
              }
            });
          } else {
            // Add at least one empty family field
            addFamily();
          }
        };

        const populateNeighbors = (neighbors) => {
          const container = $("#neighbors-container");
          container.empty(); // Clear existing fields
          state.neighborCount = 0; // Reset count

          if (neighbors && Array.isArray(neighbors) && neighbors.length > 0) {
            neighbors.forEach((neighbor) => {
              if (neighbor && typeof neighbor === "object") {
                addNeighbor(neighbor);
              }
            });
          } else {
            // Add at least one empty neighbor field
            addNeighbor();
          }
        };

        const populateEmploymentHistory = (employments) => {
          const container = $("#employment-history-container");
          container.empty(); // Clear existing fields
          state.employmentCount = 0; // Reset count

          if (
            employments &&
            Array.isArray(employments) &&
            employments.length > 0
          ) {
            employments.forEach((employment) => {
              if (employment && typeof employment === "object") {
                addEmployment(employment);
              }
            });
          } else {
            // Add at least one empty employment field
            addEmployment();
          }
        };

        // Improved AJAX success handler with better error handling
        const handleProfileDataSuccess = (data) => {
          try {
            // Set flag to prevent auto-saves during population
            state.isDataLoaded = false;

            // Populate other fields safely
            if (data) {
              // Handle educational history
              if (data.educationalHistory) {
                // Primary and secondary school population
                if (data.educationalHistory.primarySchool) {
                  setInputValue(
                    "primarySchool.name",
                    data.educationalHistory.primarySchool.name
                  );
                  setInputValue(
                    "primarySchool.address",
                    data.educationalHistory.primarySchool.address
                  );
                  setInputValue(
                    "primarySchool.yearOfAttendance",
                    data.educationalHistory.primarySchool.yearOfAttendance
                  );
                }

                if (data.educationalHistory.secondarySchool) {
                  setInputValue(
                    "secondarySchool.name",
                    data.educationalHistory.secondarySchool.name
                  );
                  setInputValue(
                    "secondarySchool.address",
                    data.educationalHistory.secondarySchool.address
                  );
                  setInputValue(
                    "secondarySchool.yearOfAttendance",
                    data.educationalHistory.secondarySchool.yearOfAttendance
                  );
                }

                // Tertiary institutions
                populateTertiaryInstitutions(
                  data.educationalHistory.tertiaryInstitutions
                );
              }

              // Populate family data
              if (data.family) {
                populateFamily(data.family);
              }

              // Populate neighbor data
              if (data.neighbor) {
                populateNeighbors(data.neighbor);
              }

              // Populate employment history
              if (data.employmentHistory) {
                populateEmploymentHistory(data.employmentHistory);
              }

              // Update counts after population
              state.institutionCount = $(
                "#tertiary-institution-container .institution-fields"
              ).length;
              state.familyCount = $("#family-container .family-fields").length;
              state.neighborCount = $(
                "#neighbors-container .neighbor-fields"
              ).length;
              state.employmentCount = $(
                "#employment-history-container .employment-fields"
              ).length;

              // Update button states
              updateFamilyButtonState();
              updateNeighborButtonState();
            }

            // Set flag to allow auto-saves after population is complete
            state.isDataLoaded = true;

            console.log("Profile data populated successfully");
          } catch (error) {
            console.error("Error populating profile data:", error);
            state.isDataLoaded = true; // Still allow saves even if population fails
          }
        };

        // Improved AJAX call with better error handling
        const loadProfileData = () => {
          if (!user || !user.id || !token) {
            console.error("Missing user data or token");
            state.isDataLoaded = true; // Allow saves even without loaded data
            return;
          }

          $.ajax({
            url: `${BACKEND_URL}/users/${user.id}`,
            method: "GET",
            headers: { Authorization: `Bearer ${token}` },
            timeout: 10000, // 10 second timeout
            success: handleProfileDataSuccess,
            error: function (xhr, status, error) {
              console.error("Failed to load profile data:", {
                status: xhr.status,
                statusText: xhr.statusText,
                error: error,
              });

              // Still allow the form to function even if data loading fails
              state.isDataLoaded = true;

              // Add default empty fields if no data was loaded
              if (
                $("#tertiary-institution-container .institution-fields")
                  .length === 0
              ) {
                addInstitution();
              }
              if ($("#family-container .family-fields").length === 0) {
                addFamily();
              }
              if ($("#neighbors-container .neighbor-fields").length === 0) {
                addNeighbor();
              }
              if (
                $("#employment-history-container .employment-fields").length ===
                0
              ) {
                addEmployment();
              }
            },
          });
        };

        /* ===================================================
         * Data Collection (Improved)
         * =================================================== */

        const collectFormData = () => {
          try {
            // Initialize FormData (this will also capture file uploads)
            const formData = new FormData();

            // List of simple fields by their IDs.
            const fields = [
              "middlename",
              "lastname",
              "nationality",
              "community",
              "religion",
              "gender",
              "stateOfOrigin",
              "DOB",
              "countryOfResidence",
              "lgaOfOrigin",
              "maritalStatus",
              "house_number",
              "street_name",
              "nearest_bus_stop_landmark",
              "city_town",
              "stateOfResidence",
              "lgaOfResidence",
              "id_number",
              "issue_date",
              "expiry_date",
            ];

            fields.forEach((field) => {
              const element = $(`#${field}`);
              const value = element.length ? element.val() || "" : "";
              formData.append(field, value);
            });

            // Build the next-of-kin object with safe value extraction
            const nextOfKin = {
              nok_surname: $("#nok_surname").val()?.trim() || "",
              nok_firstname: $("#nok_firstname").val()?.trim() || "",
              nok_middlename: $("#nok_middlename").val()?.trim() || "",
              nok_relationship: $("#nok_relationship").val()?.trim() || "",
              nok_countryOfResidence:
                $("#nok_countryOfResidence").val()?.trim() || "",
              nok_stateOfResidence:
                $("#nok_stateOfResidence").val()?.trim() || "",
              nok_lgaOfResidence: $("#nok_lgaOfResidence").val()?.trim() || "",
              nok_cityOfResidence:
                $("#nok_cityOfResidence").val()?.trim() || "",
              nok_address: $("#nok_address").val()?.trim() || "",
            };

            // Build the health info object
            const healthInfo = {
              bloodGroup: $("#bloodGroup").val() || "",
              genotype: $("#genotype").val() || "",
              disabilityStatus: $("#disabilityStatus").val() || "",
            };

            // Build the business object
            const business = {
              biz_name: $("#biz_name").val()?.trim() || "",
              biz_type: $("#biz_type").val() || "",
              registration_number:
                $("#registration_number").val()?.trim() || "",
              biz_address: $("#biz_address").val()?.trim() || "",
              nature_of_business:
                $("#nature_of_business").val()?.trim() ||
                $("#nature_of_bussiness").val()?.trim() ||
                "",
              numberOfYears: $("#numberOfYears").val()?.trim() || "",
              numberOfEmployees: $("#numberOfEmployees").val()?.trim() || "",
              annualRevenue: $("#annualRevenue").val()?.trim() || "",
              TIN: $("#TIN").val()?.trim() || "",
              biz_phone: $("#biz_phone").val()?.trim() || "",
              biz_email: $("#biz_email").val()?.trim() || "",
            };

            // Collect neighbor entries safely
            const neighbor = [];
            $(".neighbor-fields").each(function () {
              const neighborData = {
                name:
                  $(this).find('input[name="neighbor_name[]"]').val()?.trim() ||
                  "",
                address:
                  $(this)
                    .find('input[name="neighbor_address[]"]')
                    .val()
                    ?.trim() || "",
                phone:
                  $(this)
                    .find('input[name="neighbor_phone[]"]')
                    .val()
                    ?.trim() || "",
              };

              // Only add if at least one field has data
              if (
                neighborData.name ||
                neighborData.address ||
                neighborData.phone
              ) {
                neighbor.push(neighborData);
              }
            });

            // Collect family entries safely
            const family = [];
            $(".family-fields").each(function () {
              const familyData = {
                name:
                  $(this).find('input[name="family_name[]"]').val()?.trim() ||
                  "",
                relationship:
                  $(this)
                    .find('input[name="family_relationship[]"]')
                    .val()
                    ?.trim() || "",
                phone:
                  $(this).find('input[name="family_phone[]"]').val()?.trim() ||
                  "",
                address:
                  $(this)
                    .find('input[name="family_address[]"]')
                    .val()
                    ?.trim() || "",
              };

              // Only add if at least one field has data
              if (
                familyData.name ||
                familyData.relationship ||
                familyData.phone ||
                familyData.address
              ) {
                family.push(familyData);
              }
            });

            // Build educational history safely
            const educationalHistory = {
              primarySchool: {
                name: $('input[name="primarySchool.name"]').val()?.trim() || "",
                address:
                  $('input[name="primarySchool.address"]').val()?.trim() || "",
                yearOfAttendance:
                  $('input[name="primarySchool.yearOfAttendance"]')
                    .val()
                    ?.trim() || "",
              },
              secondarySchool: {
                name:
                  $('input[name="secondarySchool.name"]').val()?.trim() || "",
                address:
                  $('input[name="secondarySchool.address"]').val()?.trim() ||
                  "",
                yearOfAttendance:
                  $('input[name="secondarySchool.yearOfAttendance"]')
                    .val()
                    ?.trim() || "",
              },
              tertiaryInstitutions: [],
            };

            $(".institution-fields").each(function (index) {
              const institution = {
                name:
                  $(this)
                    .find(`input[name*="[${index}].name"]`)
                    .val()
                    ?.trim() || "",
                address:
                  $(this)
                    .find(`input[name*="[${index}].address"]`)
                    .val()
                    ?.trim() || "",
                certificateObtained:
                  $(this)
                    .find(`input[name*="[${index}].certificateObtained"]`)
                    .val()
                    ?.trim() || "",
                matricNo:
                  $(this)
                    .find(`input[name*="[${index}].matricNo"]`)
                    .val()
                    ?.trim() || "",
                yearOfAttendance:
                  $(this)
                    .find(`input[name*="[${index}].yearOfAttendance"]`)
                    .val()
                    ?.trim() || "",
              };

              // Only add if at least one field has data
              if (
                institution.name ||
                institution.address ||
                institution.certificateObtained ||
                institution.matricNo ||
                institution.yearOfAttendance
              ) {
                educationalHistory.tertiaryInstitutions.push(institution);
              }
            });

            // Employment History
            const employmentHistory = [];
            $(".employment-fields").each(function () {
              const employment = {
                companyName:
                  $(this).find('input[name="companyName[]"]').val()?.trim() ||
                  "",
                address:
                  $(this).find('input[name="address[]"]').val()?.trim() || "",
                designation:
                  $(this).find('input[name="designation[]"]').val()?.trim() ||
                  "",
                startYear:
                  $(this).find('input[name="startYear[]"]').val()?.trim() || "",
                endYear:
                  $(this).find('input[name="endYear[]"]').val()?.trim() || "",
                isCurrentEmployment: $(this)
                  .find('input[name="isCurrentEmployment[]"]')
                  .is(":checked"),
                description:
                  $(this)
                    .find('textarea[name="description[]"]')
                    .val()
                    ?.trim() || "",
              };

              // Only add if at least one field has data
              if (
                employment.companyName ||
                employment.address ||
                employment.designation ||
                employment.startYear ||
                employment.endYear ||
                employment.description
              ) {
                employmentHistory.push(employment);
              }
            });

            return {
              formData,
              nextOfKin,
              healthInfo,
              business,
              educationalHistory,
              employmentHistory,
              neighbor,
              family,
            };
          } catch (error) {
            console.error("Error collecting form data:", error);
            throw error;
          }
        };

        /* ===================================================
         * Auto-Save / Update Handling (Improved)
         * =================================================== */
        let cameraStream = null;
        let photoCaptured = false;

        // Utility: Convert dataURL to File
        function dataURLtoFile(dataurl, filename) {
          try {
            const arr = dataurl.split(",");
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while (n--) {
              u8arr[n] = bstr.charCodeAt(n);
            }
            return new File([u8arr], filename, { type: mime });
          } catch (error) {
            console.error("Error converting dataURL to file:", error);
            return null;
          }
        }

        // Enhanced Auto-Save System with Data Loss Prevention
        class FormDataManager {
          constructor() {
            this.state = {
              autoSaveTimer: null,
              retryTimer: null,
              maxRetries: 3,
              retryDelay: 2000,
              currentRetryCount: 0,
              lastSaveAttempt: null,
              pendingChanges: false,
              isOnline: navigator.onLine,
              formData: new Map(),
              lastKnownGoodState: null,
            };

            this.initializeNetworkMonitoring();
            this.initializePageUnloadProtection();
            this.loadPersistedData();
          }

          // Network monitoring to detect connectivity issues
          initializeNetworkMonitoring() {
            window.addEventListener("online", () => {
              console.log("Connection restored");
              this.state.isOnline = true;
              this.updateStatus("Connection restored. Syncing data...", "blue");
              if (this.state.pendingChanges) {
                this.performAutoSave();
              }
            });

            window.addEventListener("offline", () => {
              console.log("Connection lost");
              this.state.isOnline = false;
              this.updateStatus("Offline - changes saved locally", "orange");
            });
          }

          // Prevent data loss on page unload
          initializePageUnloadProtection() {
            window.addEventListener("beforeunload", (e) => {
              if (this.state.pendingChanges) {
                // Save to local storage as backup
                this.saveToLocalStorage();

                // Show confirmation dialog
                const message =
                  "You have unsaved changes. Are you sure you want to leave?";
                e.returnValue = message;
                return message;
              }
            });

            // Handle page visibility changes (mobile browsers)
            document.addEventListener("visibilitychange", () => {
              if (
                document.visibilityState === "hidden" &&
                this.state.pendingChanges
              ) {
                this.saveToLocalStorage();
                if (this.state.isOnline) {
                  this.performAutoSave(true); // Force immediate save
                }
              }
            });
          }

          // Load persisted data from local storage
          loadPersistedData() {
            try {
              const savedData = localStorage.getItem("formData_backup");
              if (savedData) {
                const parsedData = JSON.parse(savedData);
                const timestamp = new Date(parsedData.timestamp);
                const now = new Date();

                // Only restore if data is less than 24 hours old
                if (now - timestamp < 24 * 60 * 60 * 1000) {
                  this.showDataRecoveryDialog(parsedData.data);
                } else {
                  localStorage.removeItem("formData_backup");
                }
              }
            } catch (error) {
              console.warn("Failed to load persisted data:", error);
              localStorage.removeItem("formData_backup");
            }
          }

          // Show dialog to recover unsaved data
          showDataRecoveryDialog(savedData) {
            Swal.fire({
              title: "Recover Unsaved Changes?",
              text: "We found unsaved changes from your previous session. Would you like to restore them?",
              icon: "question",
              showCancelButton: true,
              confirmButtonText: "Restore",
              cancelButtonText: "Discard",
            }).then((result) => {
              if (result.isConfirmed) {
                this.restoreFormData(savedData);
                this.updateStatus("Previous session data restored", "green");
              } else {
                localStorage.removeItem("formData_backup");
              }
            });
          }

          // Restore form data to the page
          restoreFormData(data) {
            Object.entries(data).forEach(([key, value]) => {
              const element = $(`[name="${key}"], #${key}`);
              if (element.length) {
                if (
                  element.is('input[type="checkbox"]') ||
                  element.is('input[type="radio"]')
                ) {
                  element.prop("checked", value);
                } else {
                  element.val(value);
                }
              }
            });
            this.state.pendingChanges = true;
          }

          // Save form data to local storage as backup
          saveToLocalStorage() {
            try {
              const formData = this.collectFormData();
              const backupData = {
                data: formData,
                timestamp: new Date().toISOString(),
              };
              localStorage.setItem(
                "formData_backup",
                JSON.stringify(backupData)
              );
              console.log("Form data backed up to local storage");
            } catch (error) {
              console.warn("Failed to save to local storage:", error);
            }
          }

          // Collect all form data
          collectFormData() {
            const formData = {};

            // Collect regular form inputs
            $(
              "#unifiedForm input, #unifiedForm select, #unifiedForm textarea"
            ).each(function () {
              const $el = $(this);
              const name = $el.attr("name") || $el.attr("id");

              if (name) {
                if (
                  $el.is('input[type="checkbox"]') ||
                  $el.is('input[type="radio"]')
                ) {
                  formData[name] = $el.is(":checked");
                } else {
                  formData[name] = $el.val();
                }
              }
            });

            return formData;
          }

          // Enhanced auto-save with retry mechanism
          async performAutoSave(forceImmediate = false) {
            if (!this.state.isOnline && !forceImmediate) {
              this.saveToLocalStorage();
              this.updateStatus("Offline - saved locally", "orange");
              return;
            }

            this.state.lastSaveAttempt = new Date();

            try {
              // Collect form data
              const formData = new FormData();
              const collectedData = this.collectFormData();

              // Add regular form fields
              Object.entries(collectedData).forEach(([key, value]) => {
                if (value !== null && value !== undefined) {
                  formData.append(key, value);
                }
              });

              // Add photo data if present
              // const photoData = $("#passportPhotoData").val();
              // if (photoData) {
              //   // Convert base64 to blob for more efficient transmission
              //   const blob = this.base64ToBlob(photoData);
              //   formData.append("passportPhoto", blob, "passport_photo.jpg");
              // }

              const canvas = $("#snapshot").get(0);
              const dataURL = canvas.toDataURL("image/jpeg", 0.9);
              const passportPhotoFile = $("#passportPhoto")[0]?.files[0];

              // console.log("photoCaptured:", photoCaptured);
              // console.log("passportPhotoFile:", passportPhotoFile);
              // console.log("dataURL from canvas:", dataURL);

              if (photoCaptured && dataURL) {
                formData.append(
                  "passportPhoto",
                  dataURLtoFile(dataURL, "captured-passport.jpg")
                );
              } else if (passportPhotoFile) {
                formData.append("passportPhoto", passportPhotoFile);
              }

              // Perform the save operation
              const response = await this.saveWithRetry(formData);

              if (response.ok) {
                this.onSaveSuccess();
              } else {
                throw new Error(
                  `Server error: ${response.status} ${response.statusText}`
                );
              }
            } catch (error) {
              this.onSaveError(error);
            }
          }

          // Save with retry mechanism
          async saveWithRetry(formData, retryCount = 0) {
            try {
              const token =
                localStorage.getItem("authToken") ||
                sessionStorage.getItem("authToken");
              if (!token) {
                throw new Error("Authentication token not found");
              }

              const user = JSON.parse(
                localStorage.getItem("user") ||
                  sessionStorage.getItem("user") ||
                  "{}"
              );
              if (!user.id) {
                throw new Error("User ID not found");
              }

              const controller = new AbortController();
              const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout

              const response = await fetch(`${BACKEND_URL}/users/${user.id}`, {
                method: "PUT",
                headers: {
                  Authorization: `Bearer ${token}`,
                },
                body: formData,
                signal: controller.signal,
              });

              clearTimeout(timeoutId);
              return response;
            } catch (error) {
              if (retryCount < this.state.maxRetries) {
                console.log(
                  `Save attempt ${retryCount + 1} failed, retrying in ${
                    this.state.retryDelay
                  }ms...`
                );
                this.updateStatus(
                  `Save failed, retrying... (${retryCount + 1}/${
                    this.state.maxRetries
                  })`,
                  "orange"
                );

                await new Promise((resolve) =>
                  setTimeout(resolve, this.state.retryDelay)
                );
                return this.saveWithRetry(formData, retryCount + 1);
              }
              throw error;
            }
          }

          // Handle successful save
          onSaveSuccess() {
            console.log("Auto-save successful");
            this.updateStatus("Saved", "green");
            this.state.pendingChanges = false;
            this.state.currentRetryCount = 0;
            this.state.lastKnownGoodState = this.collectFormData();

            // Remove local storage backup after successful save
            localStorage.removeItem("formData_backup");

            // Clear any retry timers
            if (this.state.retryTimer) {
              clearTimeout(this.state.retryTimer);
              this.state.retryTimer = null;
            }
          }

          // Handle save errors
          onSaveError(error) {
            console.error("Auto-save error:", error);

            // Save to local storage as fallback
            this.saveToLocalStorage();

            if (error.name === "AbortError") {
              this.updateStatus("Save timed out - saved locally", "red");
            } else if (!this.state.isOnline) {
              this.updateStatus("Offline - saved locally", "orange");
            } else {
              this.updateStatus("Failed to save - saved locally", "red");
            }

            // Schedule retry if online
            if (
              this.state.isOnline &&
              this.state.currentRetryCount < this.state.maxRetries
            ) {
              this.state.retryTimer = setTimeout(() => {
                this.performAutoSave();
              }, this.state.retryDelay * (this.state.currentRetryCount + 1));
            }
          }

          // Update status indicator
          updateStatus(message, color) {
            $("#autoSaveStatus").text(message).css("color", color);
          }

          // Convert base64 to blob for efficient transmission
          base64ToBlob(base64String) {
            const parts = base64String.split(",");
            const contentType = parts[0].match(/:(.*?);/)[1];
            const raw = window.atob(parts[1]);
            const rawLength = raw.length;
            const uint8Array = new Uint8Array(rawLength);

            for (let i = 0; i < rawLength; ++i) {
              uint8Array[i] = raw.charCodeAt(i);
            }

            return new Blob([uint8Array], { type: contentType });
          }

          // Debounced auto-save trigger
          triggerAutoSave() {
            this.state.pendingChanges = true;
            clearTimeout(this.state.autoSaveTimer);
            this.updateStatus("Saving...", "blue");

            this.state.autoSaveTimer = setTimeout(() => {
              this.performAutoSave();
            }, 1000); // 1-second debounce
          }

          // Force immediate save (for critical operations)
          async forceSave() {
            clearTimeout(this.state.autoSaveTimer);
            this.updateStatus("Saving...", "blue");
            await this.performAutoSave(true);
          }
        }

        // Initialize the form data manager
        const formManager = new FormDataManager();

        // Camera and photo handling with enhanced error handling
        // let cameraStream = null;
        // let photoCaptured = false;

        //  Enhanced Camera Start
        $("#start-camera").click(async function () {
          try {
            const constraints = {
              video: {
                width: { ideal: 1280 },
                height: { ideal: 720 },
                facingMode: "user",
              },
            };

            cameraStream = await navigator.mediaDevices.getUserMedia(
              constraints
            );
            $("#camera-stream").get(0).srcObject = cameraStream;
            $("#camera-stream").show();
            $("#capture-photo, #close-camera").show();
            $("#start-camera").hide();
            $("#photo-preview").hide();
          } catch (err) {
            console.error("Camera access error:", err);
            let errorMessage = "Unable to access camera: ";

            if (err.name === "NotAllowedError") {
              errorMessage += "Permission denied. Please allow camera access.";
            } else if (err.name === "NotFoundError") {
              errorMessage += "No camera found on this device.";
            } else {
              errorMessage += err.message;
            }

            Swal.fire({
              title: "Camera Error",
              text: errorMessage,
              icon: "error",
            });
          }
        });

        //  Enhanced Capture Photo with validation
        $("#capture-photo").click(function () {
          try {
            const video = $("#camera-stream").get(0);
            const canvas = $("#snapshot").get(0);
            const context = canvas.getContext("2d");

            if (!video.videoWidth || !video.videoHeight) {
              throw new Error("Video stream not ready");
            }

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            const dataUrl = canvas.toDataURL("image/jpeg", 0.9);

            // Validate the captured image
            if (dataUrl === "data:,") {
              throw new Error("Failed to capture image");
            }

            $("#photo-preview").attr("src", dataUrl).show();
            $("#passportPhotoData").val(dataUrl);

            // Clean up camera stream
            if (cameraStream) {
              cameraStream.getTracks().forEach((track) => track.stop());
              cameraStream = null;
            }

            $("#camera-stream, #capture-photo, #close-camera").hide();
            $("#start-camera").show();
            photoCaptured = true;

            formManager.updateStatus("Photo captured! Saving...", "orange");
            console.log("Calling autoSave() after camera capture...");
            formManager.triggerAutoSave();
          } catch (error) {
            console.error("Photo capture error:", error);
            Swal.fire({
              title: "Capture Error",
              text: "Failed to capture photo: " + error.message,
              icon: "error",
            });
          }
        });

        //  Enhanced Close Camera
        $("#close-camera").click(function () {
          if (cameraStream) {
            cameraStream.getTracks().forEach((track) => track.stop());
            cameraStream = null;
          }
          $("#camera-stream, #capture-photo, #close-camera").hide();
          $("#start-camera").show();
        });

        //  Enhanced Upload Photo from File
        $("#upload-photo-btn").click(function () {
          $("#passportPhoto").click();
        });

        $("#passportPhoto").change(function (e) {
          const file = e.target.files[0];
          if (file) {
            // Validate file type and size
            const validTypes = ["image/jpeg", "image/jpg", "image/png"];
            const maxSize = 5 * 1024 * 1024; // 5MB

            if (!validTypes.includes(file.type)) {
              Swal.fire({
                title: "Invalid File Type",
                text: "Please select a JPEG or PNG image.",
                icon: "error",
              });
              return;
            }

            if (file.size > maxSize) {
              Swal.fire({
                title: "File Too Large",
                text: "Please select an image smaller than 5MB.",
                icon: "error",
              });
              return;
            }

            const reader = new FileReader();
            reader.onload = function (event) {
              $("#photo-preview").attr("src", event.target.result).show();
              $("#passportPhotoData").val(event.target.result);

              // Clean up camera if active
              if (cameraStream) {
                cameraStream.getTracks().forEach((track) => track.stop());
                cameraStream = null;
                $("#camera-stream, #capture-photo, #close-camera").hide();
                $("#start-camera").show();
              }

              photoCaptured = false;
              formManager.updateStatus("Photo uploaded! Saving...", "orange");
              console.log("Calling autoSave() after photo upload...");
              formManager.triggerAutoSave();
            };

            reader.onerror = function () {
              Swal.fire({
                title: "File Read Error",
                text: "Failed to read the selected file.",
                icon: "error",
              });
            };

            reader.readAsDataURL(file);
          }
        });

        /* ===================================================
         * Enhanced Event Bindings
         * =================================================== */

        const bindEvents = () => {
          // Bind the click events to add new sections
          $("#add-institution").on("click", addInstitution);
          $("#add-neighbor").on("click", addNeighbor);
          $("#add-family").on("click", addFamily);
          $("#add-employment").on("click", addEmployment);

          // Enhanced input change detection
          $(document).on(
            "input change",
            "input, select, textarea",
            function () {
              formManager.triggerAutoSave();
            }
          );

          // Enhanced form submission with validation
          $("#unifiedForm").on("submit", async function (e) {
            e.preventDefault();

            try {
              // Show loading state
              Swal.fire({
                title: "Submitting...",
                text: "Please wait while we save your information.",
                allowOutsideClick: false,
                didOpen: () => {
                  Swal.showLoading();
                },
              });

              // Force save before submission
              await formManager.forceSave();

              // Close loading and show success
              Swal.fire({
                title: "Success!",
                text: "Your form has been submitted successfully.",
                icon: "success",
                confirmButtonText: "OK",
              });
            } catch (error) {
              Swal.fire({
                title: "Submission Error",
                text: "Failed to submit form. Your data has been saved locally and will be retried automatically.",
                icon: "error",
                confirmButtonText: "OK",
              });
            }
          });
        };

        // Initialize all event bindings
        bindEvents();

        // Add periodic sync for offline changes
        setInterval(() => {
          if (formManager.state.isOnline && formManager.state.pendingChanges) {
            const lastAttempt = formManager.state.lastSaveAttempt;
            const now = new Date();

            // If no recent save attempt, try to sync
            if (!lastAttempt || now - lastAttempt > 60000) {
              // 1 minute
              console.log("Periodic sync attempt...");
              formManager.performAutoSave();
            }
          }
        }, 30000); // Check every 30 seconds
      });
    </script>
  </body>
</html>
