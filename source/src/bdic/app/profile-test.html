<!DOCTYPE html>
<html lang="en">
  <meta http-equiv="content-type" content="text/html;charset=UTF-8" />
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="keywords" content="dashboard" />
    <meta name="robots" content="index, follow" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta property="og:image" content="social-image.html" />
    <meta name="format-detection" content="telephone=no" />
    <title>
      Benue State Integrated Citizenship and Resident Identity Registration
      Management System
    </title>
    <!-- Favicon icon -->
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/assets/images/benue-state-logo.png"
    />
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <link
      rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link
      href="vendor/bootstrap-select/dist/css/bootstrap-select.min.css"
      rel="stylesheet"
    />
    <link href="css/style.css" rel="stylesheet" />
    <link rel="stylesheet" href="app.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <script src="../../unpkg.com/sweetalert%402.1.2/dist/sweetalert.min.js"></script>
    <link href="vendor/sweetalert2/dist/sweetalert2.min.css" rel="stylesheet" />
    <script src="../../ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

    <style>
      body {
        font-size: 16px !important;
      }
      .error-message {
        color: red;
        font-size: 0.875rem;
        display: none;
      }
      .form-control.error {
        border-color: red;
      }
      /* .form-section {
        display: none;
      } */
      .form-section.active {
        display: block;
      }
      .camera-upload-box video,
      .camera-upload-box canvas,
      .camera-upload-box img {
        border-radius: 8px;
        margin-bottom: 10px;
      }

      .card-header-gradient {
        background: linear-gradient(to right, #16a34a, #15803d);
        color: white;
      }
      .progress {
        height: 8px;
        background-color: #166534;
      }
      .progress-bar {
        background-color: white;
      }
      .form-section {
        display: none;
      }
      .form-section.active {
        display: block;
      }
      .step-icon {
        padding: 8px;
        background-color: rgba(255, 255, 255, 0.2);
        border-radius: 8px;
      }
      .neighbor-item,
      .family-item,
      .employment-item,
      .institution-item {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
      }
      .btn-green {
        background-color: #16a34a;
        color: white;
      }
      .btn-green:hover {
        background-color: #15803d;
        color: white;
      }
      .btn-outline-green {
        border-color: #16a34a;
        color: #16a34a;
      }
      .btn-outline-green:hover {
        background-color: #16a34a;
        color: white;
      }

      /* //////////////////////////////////////////////// */
      .status-indicator {
        position: fixed;
        top: 10px;
        right: 10px;
        padding: 8px 12px;
        border-radius: 4px;
        font-weight: bold;
        z-index: 1000;
      }
      .status-saving {
        background: #ffc107;
        color: #000;
      }
      .status-saved {
        background: #28a745;
        color: #fff;
      }
      .status-error {
        background: #dc3545;
        color: #fff;
      }
    </style>
  </head>
  <body>
    <!--*******************
        Preloader start
    ********************-->
    <div id="preloader">
      <div class="sk-three-bounce">
        <div class="sk-child sk-bounce1"></div>
        <div class="sk-child sk-bounce2"></div>
        <div class="sk-child sk-bounce3"></div>
      </div>
    </div>
    <!--*******************
        Preloader end
    ********************-->

    <!-- Sidebar -->
    <div class="sidebar">
      <div class="d-flex flex-column h-100">
        <!-- Sidebar Header -->
        <div class="p-4 border-bottom">
          <div class="d-flex align-items-center">
            <img
              src="/assets/images/benue-state-logo.png"
              alt="Benue State Logo"
              class="me-3"
              width="40"
            />
            <div>
              <h5 class="mb-0 fw-bold">BICRIRMS</h5>
              <small class="text-muted" style="font-size: 0.8rem"
                >Identity Management</small
              >
            </div>
          </div>
        </div>

        <!-- Sidebar Content -->
        <div class="flex-grow-1 py-3 px-4 overflow-auto" id="sidebar-links">
          <div class="mb-5 p-2 text-muted">
            <h6
              id="sidebar-user-label"
              class="text-uppercase text-muted small mb-3 mt-3"
            >
              User
            </h6>

            <ul class="nav flex-column">
              <li class="nav-item user-menu">
                <a
                  href="user-dasboard.html"
                  class="nav-link d-flex align-items-center"
                >
                  <i
                    class="bi bi-speedometer2 me-2 me-3 fs-5 text-secondary"
                  ></i>
                  <span> Dashboard</span>
                </a>
              </li>
              <li class="nav-item super-admin-menu">
                <a href="index.html" class="nav-link d-flex align-items-center">
                  <i
                    class="bi bi-speedometer2 me-2 me-3 fs-5 text-secondary"
                  ></i>
                  <span> Dashboard</span>
                </a>
              </li>
              <li class="nav-item kindred_head">
                <a
                  href="kindred-dasboard.html"
                  class="nav-link d-flex align-items-center"
                >
                  <i
                    class="bi bi-speedometer2 me-2 me-3 fs-5 text-secondary"
                  ></i>
                  <span> Dashboard</span>
                </a>
              </li>
              <li class="nav-item super-admin-menu">
                <a
                  href="approvals.html"
                  class="nav-link d-flex align-items-center"
                >
                  <i class="bi-check-circle fs-5 me-3 text-secodary"></i>
                  <span>Approvals</span>
                </a>
              </li>
              <li class="nav-item super-admin-menu">
                <a
                  href="all-request.html"
                  class="nav-link d-flex align-items-center"
                >
                  <i class="bi bi-file-text text-secondary me-3 fs-5"></i>
                  <span>Certificate Requests</span>
                </a>
              </li>
              <li class="nav-item super-admin-menu">
                <a
                  href="all-card.html"
                  class="nav-link d-flex align-items-center"
                >
                  <i class="bi bi-credit-card text-secondary me-3 fs-5"></i>
                  <span>Card Requests</span>
                </a>
              </li>
              <li class="nav-item super-admin-menu">
                <a
                  href="citizens.html"
                  class="nav-link d-flex align-items-center"
                >
                  <i class="bi-people fs-5 text-secondary me-3"></i>
                  <span>Users</span>
                </a>
              </li>
              <li class="nav-item super-admin-menu">
                <a
                  href="kindred.html"
                  class="nav-link d-flex align-items-center"
                >
                  <i class="bi-diagram-3 me-3"></i>
                  <span>Kindreds</span>
                </a>
              </li>
              <li class="nav-item user-menu">
                <a href="card.html" class="nav-link d-flex align-items-center">
                  <i class="bi bi-credit-card text-secondary me-3 fs-5"></i>
                  <span>Request Card</span>
                </a>
              </li>
              <li class="nav-item user-menu">
                <a
                  href="certificate.html"
                  class="nav-link d-flex align-items-center"
                >
                  <i class="bi bi-file-text text-primary me-3 fs-5"></i>
                  <span>Request Certificate</span>
                </a>
              </li>
              <li class="nav-item user-menu">
                <a
                  href="request.html"
                  class="nav-link d-flex align-items-center"
                >
                  <i class="bi bi-file-text text-secodary me-3 fs-5"></i>
                  <span>View Certificate Status</span>
                </a>
              </li>
              <li class="nav-item user-menu">
                <a
                  href="idcard.html"
                  class="nav-link d-flex align-items-center"
                >
                  <i class="bi bi-credit-card fs-5 text-secodary me-3"></i>
                  <span>View Card Status</span>
                </a>
              </li>
              <li class="nav-item kindred_head">
                <a
                  href="kindred-head.html"
                  class="nav-link d-flex align-items-center"
                >
                  <i class="bi-check-circle fs-5 me-3 text-secodary"></i>
                  <span>View Certificate Request</span>
                </a>
              </li>
              <li class="nav-item support-admin-menu">
                <a
                  href="user-kindred.html"
                  class="nav-link d-flex align-items-center"
                >
                  <i class="bi bi-file-text text-secondary me-3 fs-5"></i>
                  <span>Kindreds</span>
                </a>
              </li>
              <li class="nav-item support-admin-menu">
                <a
                  href="support-admin-lga.html"
                  class="nav-link d-flex align-items-center"
                >
                  <i class="bi bi-file-text text-secondary me-3 fs-5"></i>
                  <span>Support Admin LGA</span>
                </a>
              </li>
              <li class="nav-item">
                <a
                  href="profile.html"
                  class="nav-link d-flex align-items-center"
                >
                  <i class="bi bi-person text-secodary fs-5 me-3"></i>
                  <span>User Account</span>
                </a>
              </li>
            </ul>
          </div>

          <div>
            <h6 class="text-uppercase text-muted small mb-3">Account</h6>
            <ul class="nav flex-column">
              <li class="nav-item mb-1">
                <a href="#" class="nav-link d-flex align-items-center">
                  <i class="fas fa-cog me-3"></i>
                  <span>Settings</span>
                </a>
              </li>
              <li class="nav-item">
                <a
                  href="../../..//auth/login.html"
                  class="nav-link d-flex align-items-center"
                >
                  <i class="fas fa-sign-out-alt me-3"></i>
                  <span onclick="logout(this)">Logout</span>
                </a>
              </li>
            </ul>
          </div>
        </div>
        <div class="overlay" id="sidebar-overlay"></div>

        <!-- Sidebar Footer -->
        <div class="p-3 border-top text-center">
          <small class="text-muted">Powered by BDIC</small>
          <p class="small text-muted mb-0">© 2025 All Rights Reserved</p>
        </div>
      </div>
    </div>

    <!--**********************************
            Sidebar end
        ***********************************-->

    <!--**********************************
            Content body start
        ***********************************-->
    <div class="main-content">
      <!-- Header -->
      <header class="navbar navbar-expand-lg bg-white shadow-sm px-4 py-3">
        <div class="container-fluid">
          <button class="btn d-lg-none" id="sidebarToggle">
            <i class="fas fa-bars"></i>
          </button>

          <div class="d-none d-md-block align-items-center">
            <h5 class="mb-0 me-2 dashboard_bar">Profile</h5>
            <small class="text-muted"
              >Welcome back, <span id="header-user-label"> User </span>
            </small>
          </div>

          <div class="ms-auto d-flex align-items-center">
            <div class="d-none d-md-flex position-relative me-3">
              <i
                class="fas fa-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"
              ></i>
              <input
                type="search"
                class="form-control ps-5"
                id="searchInput"
                placeholder="Search here..."
                onkeyup="searchTable()"
                style="width: 250px"
              />
            </div>

            <div class="dropdown me-3">
              <button class="btn position-relative" data-bs-toggle="dropdown">
                <i class="fas fa-bell"></i>
                <span
                  class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger notification-badge"
                  >3</span
                >
              </button>
              <div
                class="dropdown-menu dropdown-menu-end p-0"
                style="width: 300px"
              >
                <div class="p-3 border-bottom">
                  <h6 class="mb-0">Notifications</h6>
                </div>
                <div class="overflow-auto" style="max-height: 300px">
                  <a href="#" class="dropdown-item p-3 border-bottom">
                    <div class="d-flex justify-content-between">
                      <span class="fw-medium">New Certificate Request</span>
                      <small class="text-muted">5 min ago</small>
                    </div>
                    <small class="text-muted d-block mt-1"
                      >John Doe submitted a new certificate application</small
                    >
                  </a>
                  <a href="#" class="dropdown-item p-3 border-bottom">
                    <div class="d-flex justify-content-between">
                      <span class="fw-medium">Card Ready for Pickup</span>
                      <small class="text-muted">1 hour ago</small>
                    </div>
                    <small class="text-muted d-block mt-1"
                      >ID Card for Jane Smith is ready for collection</small
                    >
                  </a>
                  <a href="#" class="dropdown-item p-3">
                    <div class="d-flex justify-content-between">
                      <span class="fw-medium">System Update</span>
                      <small class="text-muted">2 hours ago</small>
                    </div>
                    <small class="text-muted d-block mt-1"
                      >Database backup completed successfully</small
                    >
                  </a>
                </div>
              </div>
            </div>

            <div class="dropdown">
              <button class="btn p-0" data-bs-toggle="dropdown">
                <div class="avatar">AD</div>
              </button>
              <div class="dropdown-menu dropdown-menu-end">
                <div class="px-4 py-3">
                  <h6 class="mb-0">Administrator</h6>
                  <small class="text-muted">admin@benue.gov.ng</small>
                </div>
                <div class="dropdown-divider"></div>
                <a href="profile.html" class="dropdown-item"
                  ><i class="fas fa-user me-2"></i> Profile</a
                >
                <a href="#" class="dropdown-item"
                  ><i class="fas fa-cog me-2"></i> Settings</a
                >
                <div class="dropdown-divider"></div>
                <a
                  href="../../../auth/login.html"
                  class="dropdown-item text-danger"
                  ><i class="fas fa-sign-out-alt me-2"></i>
                  <span onclick="logout(this)"> Logout </span>
                </a>
              </div>
            </div>
          </div>
        </div>
      </header>
      <div class="container-fluid max-w-6xl mx-auto p-6 py-4">
        <div class="card shadow-lg border-0 bg-white">
          <div class="card-header card-header-gradient rounded-top">
            <div class="d-flex align-items-center">
              <div class="step-icon me-3">
                <i class="bi bi-person" id="current-step-icon"></i>
              </div>
              <div>
                <h2 class="card-title mb-0 text-white" id="current-step-title">
                  Profile Details
                </h2>
                <p
                  class="card-text text-white mb-0"
                  id="current-step-description"
                >
                  Step 1 of 10
                </p>
              </div>
            </div>

            <!-- Progress indicator -->
            <div class="mt-4">
              <div class="progress">
                <div
                  class="progress-bar"
                  id="progress-bar"
                  style="width: 10%; color: #dee2e6"
                ></div>
              </div>
            </div>
          </div>

          <form
            class="profile-form"
            id="unifiedForm"
            enctype="multipart/form-data"
          >
            <div class="card-body p-8">
              <!-- Profile Details Section -->
              <div class="form-section active" id="profile-section">
                <div class="row g-4">
                  <div class="col-md-6">
                    <label for="first_name" class="form-label"
                      >First Name</label
                    >
                    <input
                      type="text"
                      class="form-control bg-light"
                      id="first_name"
                      name="firstname"
                      readonly
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="lastname" class="form-label">Last Name</label>
                    <input
                      type="text"
                      class="form-control bg-light"
                      id="lastname"
                      name="lastname"
                      readonly
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="middlename" class="form-label"
                      >Middle Name</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="middlename"
                      name="middlename"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="gender" class="form-label">Gender</label>
                    <select class="form-select" name="gender">
                      <option selected disabled>Select gender</option>
                      <option value="male">Male</option>
                      <option value="female">Female</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label for="maritalStatus" class="form-label"
                      >Marital Status</label
                    >
                    <select class="form-select" name="maritalStatus">
                      <option selected disabled>Select marital status</option>
                      <option value="single">Single</option>
                      <option value="married">Married</option>
                      <option value="divorced">Divorced</option>
                      <option value="widowed">Widowed</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label for="DOB" class="form-label">Date of Birth</label>
                    <input
                      type="date"
                      class="form-control"
                      id="DOB"
                      name="DOB"
                      min="1900-01-01"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="stateOfOrigin" class="form-label"
                      >State of Origin</label
                    >
                    <input
                      type="text"
                      class="form-control bg-light"
                      id="stateOfOrigin"
                      name="stateOfOrigin"
                      readonly
                    />
                    <!-- onchange="updateLocalGovernmentsOfOrigin()" -->
                  </div>
                  <div class="col-md-6">
                    <label for="lgaOfOrigin" class="form-label"
                      >Local Government of Origin</label
                    >
                    <input
                      class="form-control bg-light"
                      name="lgaOfOrigin"
                      id="lgaOfOrigin"
                      readonly
                    />
                    <!-- class="form-select" -->
                    <!-- <option value="">Select Local Government</option> -->
                    <!-- </input> -->
                  </div>
                  <div class="col-md-6">
                    <label for="nationality" class="form-label"
                      >Nationality</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="nationality"
                      name="nationality"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="community" class="form-label">Community</label>
                    <input
                      type="text"
                      class="form-control"
                      id="community"
                      name="community"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="religion" class="form-label">Religion</label>
                    <select class="form-select" name="religion">
                      <option selected disabled>Select religion</option>
                      <option value="christian">Christian</option>
                      <option value="muslim">Muslim</option>
                      <option value="others">Others</option>
                    </select>
                  </div>
                </div>

                <div class="mt-4">
                  <label class="form-label d-flex align-items-center">
                    <i class="bi bi-camera me-2"></i>
                    Recent Passport Photograph
                    <span class="text-danger ms-1">*</span>
                  </label>
                  <div
                    class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center bg-gray-100"
                  >
                    <i class="bi bi-camera text-gray-500 fs-1 mb-3"></i>
                    <div class="d-flex flex-column align-items-center">
                      <video
                        id="camera-stream"
                        width="100%"
                        height="200"
                        autoplay
                        playsinline
                        style="display: none; border-radius: 8px"
                      ></video>
                      <canvas
                        id="snapshot"
                        width="300"
                        height="200"
                        style="display: none"
                      ></canvas>
                      <img
                        id="photo-preview"
                        src=""
                        alt="Passport Preview"
                        class="img-thumbnail mb-2"
                        style="display: none; max-width: 100%; height: auto"
                      />
                      <div class="btn-group mb-2">
                        <button
                          type="button"
                          class="btn btn-outline-primary"
                          id="start-camera"
                        >
                          Open Camera
                        </button>
                        <button
                          type="button"
                          class="btn btn-outline-success"
                          id="capture-photo"
                          style="display: none"
                        >
                          Capture
                        </button>
                        <button
                          type="button"
                          class="btn btn-outline-danger"
                          id="close-camera"
                          style="display: none"
                        >
                          Close Camera
                        </button>
                      </div>
                      <input
                        type="file"
                        id="passportPhoto"
                        name="passportPhoto"
                        accept="image/*"
                        class="d-none"
                      />
                      <small class="text-muted d-block"
                        >Or
                        <button
                          type="button"
                          class="btn btn-link p-0"
                          id="upload-photo-btn"
                        >
                          Upload Photo
                        </button>
                        instead.</small
                      >
                      <input
                        type="hidden"
                        name="passportPhotoData"
                        id="passportPhotoData"
                      />
                    </div>
                  </div>
                </div>
              </div>

              <!-- Residential Address Section -->
              <div class="form-section" id="address-section">
                <div class="row g-4">
                  <div class="col-md-6">
                    <label for="house_number" class="form-label"
                      >House Number</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="house_number"
                      name="house_number"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="street_name" class="form-label"
                      >Street Name</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="street_name"
                      name="street_name"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="nearest_bus_stop_landmark" class="form-label"
                      >Nearest Bus-Stop/Landmark</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="nearest_bus_stop_landmark"
                      name="nearest_bus_stop_landmark"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="stateOfResidence" class="form-label"
                      >State of Residence</label
                    >
                    <select
                      class="form-select"
                      name="stateOfResidence"
                      id="stateOfResidence"
                      onchange="updateLocalGovernmentsOfResidence()"
                    >
                      <option selected disabled>Select State</option>
                      <option value="adamawa">Adamawa</option>
                      <option value="akwa-ibom">Akwa Ibom</option>
                      <option value="anambra">Anambra</option>
                      <option value="abia">Abia</option>
                      <option value="bauchi">Bauchi</option>
                      <option value="benue">Benue</option>
                      <option value="borno">Borno</option>
                      <option value="bayelsa">Bayelsa</option>
                      <option value="delta">Delta</option>
                      <option value="ebonyi">Ebonyi</option>
                      <option value="edo">Edo</option>
                      <option value="enugu">Enugu</option>
                      <option value="abuja">Abuja</option>
                      <option value="gombe">Gombe</option>
                      <option value="jigawa">Jigawa</option>
                      <option value="ekiti">Ekiti</option>
                      <option value="lagos">Lagos</option>
                      <option value="oyo">Oyo</option>
                      <option value="imo">Imo</option>
                      <option value="kaduna">Kaduna</option>
                      <option value="kebbi">Kebbi</option>
                      <option value="kano">Kano</option>
                      <option value="kogi">Kogi</option>
                      <option value="osun">Osun</option>
                      <option value="sokoto">Sokoto</option>
                      <option value="plateau">Plateau</option>
                      <option value="taraba">Taraba</option>
                      <option value="yobe">Yobe</option>
                      <option value="zamfara">Zamfara</option>
                      <option value="katsina">Katsina</option>
                      <option value="kwara">Kwara</option>
                      <option value="nasarawa">Nasarawa</option>
                      <option value="niger">Niger</option>
                      <option value="rivers">Rivers</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label for="lgaOfResidence" class="form-label"
                      >Local Government of Residence</label
                    >
                    <select
                      class="form-select"
                      name="lgaOfResidence"
                      id="lgaOfResidence"
                    >
                      <option selected disabled>Select Local Government</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label for="countryOfResidence" class="form-label"
                      >Country of Residence</label
                    >
                    <select class="form-select" name="countryOfResidence">
                      <option selected disabled>Select Country</option>
                      <option value="nigeria">Nigeria</option>
                      <option value="ghana">Ghana</option>
                      <option value="other">Other</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Identity Information Section -->
              <div class="form-section" id="identity-section">
                <div class="row g-4">
                  <div class="col-md-6">
                    <label for="identification" class="form-label"
                      >Identification Type</label
                    >
                    <select
                      class="form-select"
                      name="identification"
                      id="identification"
                    >
                      <option selected disabled>
                        Select identification type
                      </option>
                      <option value="national_id">National ID</option>
                      <option value="driver_licence">Driver Licence</option>
                      <option value="international_passport">
                        INT'L Passport
                      </option>
                      <option value="voters_card">Voter's Card</option>
                      <option value="others">Others</option>
                    </select>

                    <div
                      class="mt-3"
                      id="other-identification-container"
                      style="display: none"
                    >
                      <label for="other_identification" class="form-label"
                        >Specify Other Identification</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="other_identification"
                        name="other_identification"
                        placeholder="Please specify"
                      />
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label for="id_number" class="form-label">ID Number</label>
                    <input
                      type="text"
                      class="form-control"
                      id="id_number"
                      name="id_number"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="issue_date" class="form-label"
                      >Issue Date</label
                    >
                    <input
                      type="date"
                      class="form-control"
                      id="issue_date"
                      name="issue_date"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="expiry_date" class="form-label"
                      >Expiry Date</label
                    >
                    <input
                      type="date"
                      class="form-control"
                      id="expiry_date"
                      name="expiry_date"
                    />
                  </div>
                </div>
              </div>

              <!-- Next of Kin Section -->
              <div class="form-section" id="nok-section">
                <div class="row g-4">
                  <div class="col-md-6">
                    <label for="nok_surname" class="form-label">Surname</label>
                    <input
                      type="text"
                      class="form-control"
                      id="nok_surname"
                      name="nok_surname"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="nok_firstname" class="form-label"
                      >First Name</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="nok_firstname"
                      name="nok_firstname"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="nok_middlename" class="form-label"
                      >Middle Name</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="nok_middlename"
                      name="nok_middlename"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="nok_relationship" class="form-label"
                      >Relationship</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="nok_relationship"
                      name="nok_relationship"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="nok_countryOfResidence" class="form-label"
                      >Country of Residence</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="nok_countryOfResidence"
                      name="nok_countryOfResidence"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="nok_stateOfResidence" class="form-label"
                      >State of Residence</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="nok_stateOfResidence"
                      name="nok_stateOfResidence"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="nok_lgaOfResidence" class="form-label"
                      >LGA of Residence</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="nok_lgaOfResidence"
                      name="nok_lgaOfResidence"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="nok_cityOfResidence" class="form-label"
                      >City/Town of Residence</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="nok_cityOfResidence"
                      name="nok_cityOfResidence"
                    />
                  </div>
                  <div class="col-md-12">
                    <label for="nok_address" class="form-label">Address</label>
                    <input
                      type="text"
                      class="form-control"
                      id="nok_address"
                      name="nok_address"
                    />
                  </div>
                </div>
              </div>

              <!-- Contact Details (Neighbors) Section -->
              <div class="form-section" id="contacts-section">
                <h5 class="text-lg font-semibold mb-4">
                  Neighbors' Contact Details
                </h5>

                <div id="neighbors-container">
                  <div class="neighbor-item" data-id="0">
                    <div
                      class="d-flex justify-content-between align-items-center mb-3"
                    >
                      <label class="form-label">Neighbor 1</label>
                      <button
                        type="button"
                        class="btn btn-outline-danger btn-sm remove-neighbor"
                        style="display: none"
                      >
                        <i class="bi bi-dash"></i>
                      </button>
                    </div>
                    <div class="row g-3">
                      <div class="col-md-4">
                        <input
                          type="text"
                          class="form-control"
                          name="neighbor_name_0"
                          placeholder="Full Name"
                        />
                      </div>
                      <div class="col-md-4">
                        <input
                          type="text"
                          class="form-control"
                          name="neighbor_address_0"
                          placeholder="Residential Address"
                        />
                      </div>
                      <div class="col-md-4">
                        <input
                          type="tel"
                          class="form-control"
                          name="neighbor_phone_0"
                          placeholder="Phone Number"
                        />
                      </div>
                    </div>
                  </div>
                </div>

                <button
                  type="button"
                  class="btn btn-outline-green mt-3"
                  id="add-neighbor"
                >
                  <i class="bi bi-plus"></i>
                  <span>Add Another Neighbor</span>
                </button>

                <p
                  class="text-danger small mt-2"
                  id="neighbor-max-message"
                  style="display: none"
                >
                  Maximum of 5 neighbors reached.
                </p>
              </div>

              <!-- Family Contact Details Section -->
              <div class="form-section" id="family-section">
                <h5 class="text-lg font-semibold mb-4">
                  Family Contact Details
                </h5>

                <div id="family-members-container">
                  <div class="family-item" data-id="0">
                    <div
                      class="d-flex justify-content-between align-items-center mb-3"
                    >
                      <label class="form-label">Family Member 1</label>
                      <button
                        type="button"
                        class="btn btn-outline-danger btn-sm remove-family-member"
                        style="display: none"
                      >
                        <i class="bi bi-dash"></i>
                      </button>
                    </div>
                    <div class="row g-3">
                      <div class="col-md-3">
                        <input
                          type="text"
                          class="form-control"
                          name="family_name_0"
                          placeholder="Full Name"
                        />
                      </div>
                      <div class="col-md-3">
                        <input
                          type="text"
                          class="form-control"
                          name="family_relationship_0"
                          placeholder="Relationship"
                        />
                      </div>
                      <div class="col-md-3">
                        <input
                          type="text"
                          class="form-control"
                          name="family_address_0"
                          placeholder="Residential Address"
                        />
                      </div>
                      <div class="col-md-3">
                        <input
                          type="tel"
                          class="form-control"
                          name="family_phone_0"
                          placeholder="Phone Number"
                        />
                      </div>
                    </div>
                  </div>
                </div>

                <button
                  type="button"
                  class="btn btn-outline-green mt-3"
                  id="add-family-member"
                >
                  <i class="bi bi-plus"></i>
                  <span>Add Another Family Member</span>
                </button>

                <p
                  class="text-danger small mt-2"
                  id="family-max-message"
                  style="display: none"
                >
                  Maximum of 5 family members reached.
                </p>
              </div>

              <!-- Business Details Section -->
              <div class="form-section" id="business-section">
                <div class="row g-4">
                  <div class="col-md-6">
                    <label for="biz_name" class="form-label"
                      >Business Name</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="biz_name"
                      name="biz_name"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="biz_type" class="form-label"
                      >Business Type</label
                    >
                    <select class="form-select" name="biz_type">
                      <option selected disabled>Select business type</option>
                      <option value="sole_proprietorship">
                        Sole Proprietorship
                      </option>
                      <option value="partnership">Partnership</option>
                      <option value="limited_liability_company">
                        Limited Liability Company
                      </option>
                      <option value="corporation">Corporation</option>
                      <option value="cooperative">Cooperative</option>
                      <option value="others">Others</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label for="registration_number" class="form-label"
                      >Business Registration Number (if applicable)</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="registration_number"
                      name="registration_number"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="biz_address" class="form-label"
                      >Business Address</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="biz_address"
                      name="biz_address"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="nature_of_business" class="form-label"
                      >Nature of Business</label
                    >
                    <select
                      class="form-select"
                      id="nature_of_business"
                      name="nature_of_business"
                    >
                      <option selected disabled>
                        Select nature of business
                      </option>
                      <option value="retail">Retail</option>
                      <option value="manufacturing">Manufacturing</option>
                      <option value="ict">ICT</option>
                      <option value="agriculture">Agriculture</option>
                      <option value="others">Others</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label for="numberOfYears" class="form-label"
                      >Years in Operation</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="numberOfYears"
                      name="numberOfYears"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="numberOfEmployees" class="form-label"
                      >Number of Employees (if applicable)</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="numberOfEmployees"
                      name="numberOfEmployees"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="annualRevenue" class="form-label"
                      >Annual Revenue (Optional)</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="annualRevenue"
                      name="annualRevenue"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="TIN" class="form-label"
                      >Tax Identification Number (TIN) (if applicable)</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="TIN"
                      name="TIN"
                      maxlength="11"
                      minlength="11"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="biz_phone" class="form-label"
                      >Mobile Number</label
                    >
                    <input
                      type="tel"
                      class="form-control"
                      id="biz_phone"
                      name="biz_phone"
                      maxlength="11"
                      placeholder="Enter a valid Nigerian phone number"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="biz_email" class="form-label">Email</label>
                    <input
                      type="email"
                      class="form-control"
                      id="biz_email"
                      name="biz_email"
                    />
                  </div>
                </div>
              </div>

              <!-- Employment History Section -->
              <div class="form-section" id="employment-section">
                <h5 class="text-lg font-semibold mb-4">
                  Employment History Details
                </h5>

                <div id="employment-history-container">
                  <div class="employment-item" data-id="0">
                    <div
                      class="d-flex justify-content-between align-items-center mb-3"
                    >
                      <label class="form-label">Employment 1</label>
                      <button
                        type="button"
                        class="btn btn-outline-danger btn-sm remove-employment"
                        style="display: none"
                      >
                        <i class="bi bi-dash"></i>
                      </button>
                    </div>

                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label">Company Name</label>
                        <input
                          type="text"
                          class="form-control"
                          name="companyName_0"
                          placeholder="Enter company name"
                        />
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Address</label>
                        <input
                          type="text"
                          class="form-control"
                          name="employment_address_0"
                          placeholder="Enter company address"
                        />
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Designation</label>
                        <input
                          type="text"
                          class="form-control"
                          name="designation_0"
                          placeholder="Enter your designation"
                        />
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Start Year</label>
                        <input
                          type="date"
                          class="form-control"
                          name="startYear_0"
                          placeholder="Enter start year"
                        />
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">End Year</label>
                        <input
                          type="date"
                          class="form-control"
                          name="endYear_0"
                          placeholder="Enter end year"
                        />
                        <p class="text-muted small mt-1">
                          Leave blank if this is your current employment.
                        </p>
                      </div>
                      <div class="col-md-6">
                        <div class="form-check">
                          <input
                            class="form-check-input"
                            type="checkbox"
                            id="isCurrentEmployment_0"
                            name="isCurrentEmployment_0"
                          />
                          <label
                            class="form-check-label"
                            for="isCurrentEmployment_0"
                          >
                            This is my current employment
                          </label>
                        </div>
                      </div>
                    </div>

                    <div class="mt-3">
                      <label class="form-label">Description of Company</label>
                      <textarea
                        class="form-control"
                        name="employment_description_0"
                        rows="3"
                        placeholder="Describe the company"
                      ></textarea>
                    </div>
                  </div>
                </div>

                <button
                  type="button"
                  class="btn btn-outline-green mt-3"
                  id="add-employment"
                >
                  <i class="bi bi-plus"></i>
                  <span>Add Another Employment</span>
                </button>
                <p
                  class="text-danger small mt-2"
                  id="employment-max-message"
                  style="display: none"
                >
                  Maximum of 5 Employment reached.
                </p>
              </div>

              <!-- Education Details Section -->
              <div class="form-section" id="education-section">
                <!-- Primary School -->
                <div class="border rounded p-4 mb-4">
                  <h5 class="text-lg font-semibold">Primary School</h5>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Name of Primary School</label>
                      <input
                        type="text"
                        class="form-control"
                        name="primarySchool_name"
                      />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label"
                        >Address of Primary School</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        name="primarySchool_address"
                      />
                    </div>
                    <div class="col-md-12">
                      <label class="form-label">Year of Attendance</label>
                      <input
                        type="text"
                        class="form-control"
                        name="primarySchool_yearOfAttendance"
                      />
                    </div>
                  </div>
                </div>

                <!-- Secondary School -->
                <div class="border rounded p-4 mb-4">
                  <h5 class="text-lg font-semibold">Secondary School</h5>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Name of Secondary School</label>
                      <input
                        type="text"
                        class="form-control"
                        name="secondarySchool_name"
                      />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label"
                        >Address of Secondary School</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        name="secondarySchool_address"
                      />
                    </div>
                    <div class="col-md-12">
                      <label class="form-label">Year of Attendance</label>
                      <input
                        type="text"
                        class="form-control"
                        name="secondarySchool_yearOfAttendance"
                      />
                    </div>
                  </div>
                </div>

                <!-- Tertiary Institutions -->
                <div class="mb-4">
                  <h5 class="text-lg font-semibold">Tertiary Institution(s)</h5>

                  <div id="tertiary-institutions-container">
                    <div class="institution-item border rounded p-4 mt-3">
                      <div
                        class="d-flex justify-content-between align-items-center mb-3"
                      >
                        <label class="form-label">Tertiary Institution 1</label>
                        <button
                          type="button"
                          class="btn btn-outline-danger btn-sm remove-institution"
                          style="display: none"
                        >
                          <i class="bi bi-dash"></i>
                        </button>
                      </div>

                      <div class="row g-3">
                        <div class="col-md-6">
                          <input
                            type="text"
                            class="form-control"
                            name="tertiaryInstitution_name_0"
                            placeholder="Name of Tertiary Institution"
                          />
                        </div>
                        <div class="col-md-6">
                          <input
                            type="text"
                            class="form-control"
                            name="tertiaryInstitution_address_0"
                            placeholder="Address of Tertiary Institution"
                          />
                        </div>
                        <div class="col-md-6">
                          <input
                            type="text"
                            class="form-control"
                            name="tertiaryInstitution_certificate_0"
                            placeholder="Certificate Obtained"
                          />
                        </div>
                        <div class="col-md-6">
                          <input
                            type="text"
                            class="form-control"
                            name="tertiaryInstitution_matricNo_0"
                            placeholder="Matriculation Number"
                          />
                        </div>
                        <div class="col-md-12">
                          <input
                            type="text"
                            class="form-control"
                            name="tertiaryInstitution_year_0"
                            placeholder="Year of Attendance"
                          />
                        </div>
                      </div>
                    </div>
                  </div>

                  <button
                    type="button"
                    class="btn btn-outline-green mt-3"
                    id="add-institution"
                  >
                    <i class="bi bi-plus"></i>
                    <span>Add Another Institution</span>
                  </button>
                </div>
              </div>

              <!-- Health Information Section -->
              <div class="form-section" id="health-section">
                <div class="row g-4">
                  <div class="col-md-4">
                    <label for="bloodGroup" class="form-label"
                      >Blood Group</label
                    >
                    <select
                      class="form-select"
                      name="bloodGroup"
                      id="bloodGroup"
                    >
                      <option selected disabled>Select blood group</option>
                      <option value="A+">A+</option>
                      <option value="A-">A-</option>
                      <option value="B+">B+</option>
                      <option value="B-">B-</option>
                      <option value="AB+">AB+</option>
                      <option value="AB-">AB-</option>
                      <option value="O+">O+</option>
                      <option value="O-">O-</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label for="genotype" class="form-label">Genotype</label>
                    <select class="form-select" name="genotype" id="genotype">
                      <option selected disabled>Select genotype</option>
                      <option value="AA">AA</option>
                      <option value="AS">AS</option>
                      <option value="SS">SS</option>
                      <option value="AC">AC</option>
                      <option value="SC">SC</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label for="disabilityStatus" class="form-label"
                      >Disability Status</label
                    >
                    <select class="form-select" name="disabilityStatus">
                      <option selected disabled>
                        Select disability status
                      </option>
                      <option value="none">None</option>
                      <option value="physical">Physical</option>
                      <option value="visual">Visual</option>
                      <option value="hearing">Hearing</option>
                      <option value="other">Other</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <div class="card-footer bg-light rounded-bottom p-4">
              <div class="d-flex justify-content-between w-100">
                <button
                  type="button"
                  class="btn btn-outline-secondary"
                  id="prev-step"
                  disabled
                >
                  <i class="bi bi-chevron-left"></i>
                  <span>Previous</span>
                </button>

                <button
                  type="submit"
                  class="btn btn-green"
                  id="submit-btn"
                  style="display: none"
                >
                  Submit Form
                </button>
                <button type="button" class="btn btn-green" id="next-step">
                  <span>Next</span>
                  <i class="bi bi-chevron-right"></i>
                </button>
              </div>
            </div>
            <div id="autoSaveStatus"></div>
          </form>
        </div>
      </div>

      <!-- Bootstrap JS Bundle with Popper -->
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

      <!-- <script>
        $(document).ready(function () {
          // Form steps data
          const steps = [
            { id: "profile", title: "Profile Details", icon: "bi-person" },
            { id: "address", title: "Residential Address", icon: "bi-geo-alt" },
            { id: "identity", title: "Identification", icon: "bi-credit-card" },
            { id: "nok", title: "Next of Kin", icon: "bi-people" },
            { id: "contacts", title: "Contact Details", icon: "bi-telephone" },
            { id: "family", title: "Family Details", icon: "bi-people" },
            { id: "business", title: "Business Details", icon: "bi-briefcase" },
            {
              id: "employment",
              title: "Employment History",
              icon: "bi-briefcase",
            },
            {
              id: "education",
              title: "Education Details",
              icon: "bi-mortarboard",
            },
            { id: "health", title: "Health Information", icon: "bi-heart" },
          ];

          let currentStep = 0;
          let neighborsCount = 1;
          let familyMembersCount = 1;
          let employmentHistoryCount = 1;
          let tertiaryInstitutionsCount = 1;

          // Initialize form
          updateStepDisplay();

          // Identification type change handler
          $("#identification").change(function () {
            const value = $(this).val();
            if (value === "others") {
              $("#other-identification-container").show();
            } else {
              $("#other-identification-container").hide();
            }
          });

          // Add neighbor handler
          $("#add-neighbor").click(function () {
            if (neighborsCount < 5) {
              neighborsCount++;
              const newIndex = neighborsCount - 1;

              const neighborHtml = `
                        <div class="neighbor-item">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <label class="form-label">Neighbor ${neighborsCount}</label>
                                <button type="button" class="btn btn-outline-danger btn-sm remove-neighbor">
                                    <i class="bi bi-dash"></i>
                                </button>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <input type="text" class="form-control" name="neighbor_name_${newIndex}" placeholder="Full Name">
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" name="neighbor_address_${newIndex}" placeholder="Residential Address">
                                </div>
                                <div class="col-md-4">
                                    <input type="tel" class="form-control" name="neighbor_phone_${newIndex}" placeholder="Phone Number">
                                </div>
                            </div>
                        </div>
                    `;

              $("#neighbors-container").append(neighborHtml);

              if (neighborsCount === 5) {
                $("#neighbor-max-message").show();
                $("#add-neighbor").prop("disabled", true);
              }

              // Show remove buttons for all items if count > 1
              if (neighborsCount > 1) {
                $(".remove-neighbor").show();
              }
            }
          });

          // Remove neighbor handler (delegated)
          $("#neighbors-container").on(
            "click",
            ".remove-neighbor",
            function () {
              if (neighborsCount > 1) {
                $(this).closest(".neighbor-item").remove();
                neighborsCount--;

                // Renumber remaining neighbors
                $(".neighbor-item").each(function (index) {
                  $(this)
                    .find(".form-label")
                    .text(`Neighbor ${index + 1}`);
                  $(this)
                    .find("input")
                    .each(function () {
                      const name = $(this)
                        .attr("name")
                        .replace(/_(\d+)_/, `_${index}_`);
                      $(this).attr("name", name);
                    });
                });

                if (neighborsCount < 5) {
                  $("#neighbor-max-message").hide();
                  $("#add-neighbor").prop("disabled", false);
                }

                // Hide remove button if only one item left
                if (neighborsCount === 1) {
                  $(".remove-neighbor").hide();
                }
              }
            }
          );

          // Add family member handler
          $("#add-family-member").click(function () {
            if (familyMembersCount < 5) {
              familyMembersCount++;
              const newIndex = familyMembersCount - 1;

              const familyHtml = `
                        <div class="family-item">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <label class="form-label">Family Member ${familyMembersCount}</label>
                                <button type="button" class="btn btn-outline-danger btn-sm remove-family-member">
                                    <i class="bi bi-dash"></i>
                                </button>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <input type="text" class="form-control" name="family_name_${newIndex}" placeholder="Full Name">
                                </div>
                                <div class="col-md-3">
                                    <input type="text" class="form-control" name="family_relationship_${newIndex}" placeholder="Relationship">
                                </div>
                                <div class="col-md-3">
                                    <input type="text" class="form-control" name="family_address_${newIndex}" placeholder="Residential Address">
                                </div>
                                <div class="col-md-3">
                                    <input type="tel" class="form-control" name="family_phone_${newIndex}" placeholder="Phone Number">
                                </div>
                            </div>
                        </div>
                    `;

              $("#family-members-container").append(familyHtml);

              if (familyMembersCount === 5) {
                $("#family-max-message").show();
                $("#add-family-member").prop("disabled", true);
              }

              // Show remove buttons for all items if count > 1
              if (familyMembersCount > 1) {
                $(".remove-family-member").show();
              }
            }
          });

          // Remove family member handler (delegated)
          $("#family-members-container").on(
            "click",
            ".remove-family-member",
            function () {
              if (familyMembersCount > 1) {
                $(this).closest(".family-item").remove();
                familyMembersCount--;

                // Renumber remaining family members
                $(".family-item").each(function (index) {
                  $(this)
                    .find(".form-label")
                    .text(`Family Member ${index + 1}`);
                  $(this)
                    .find("input")
                    .each(function () {
                      const name = $(this)
                        .attr("name")
                        .replace(/_(\d+)_/, `_${index}_`);
                      $(this).attr("name", name);
                    });
                });

                if (familyMembersCount < 5) {
                  $("#family-max-message").hide();
                  $("#add-family-member").prop("disabled", false);
                }

                // Hide remove button if only one item left
                if (familyMembersCount === 1) {
                  $(".remove-family-member").hide();
                }
              }
            }
          );

          // Add employment handler
          $("#add-employment").click(function () {
            employmentHistoryCount++;
            const newIndex = employmentHistoryCount - 1;

            const employmentHtml = `
                    <div class="employment-item">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <label class="form-label">Employment ${employmentHistoryCount}</label>
                            <button type="button" class="btn btn-outline-danger btn-sm remove-employment">
                                <i class="bi bi-dash"></i>
                            </button>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Company Name</label>
                                <input type="text" class="form-control" name="companyName_${newIndex}" placeholder="Enter company name">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Address</label>
                                <input type="text" class="form-control" name="employment_address_${newIndex}" placeholder="Enter company address">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Designation</label>
                                <input type="text" class="form-control" name="designation_${newIndex}" placeholder="Enter your designation">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Start Year</label>
                                <input type="number" class="form-control" name="startYear_${newIndex}" placeholder="Enter start year">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">End Year</label>
                                <input type="number" class="form-control" name="endYear_${newIndex}" placeholder="Enter end year">
                                <p class="text-muted small mt-1">Leave blank if this is your current employment.</p>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="isCurrentEmployment_${newIndex}" name="isCurrentEmployment_${newIndex}">
                                    <label class="form-check-label" for="isCurrentEmployment_${newIndex}">
                                        This is my current employment
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="mt-3">
                            <label class="form-label">Description of Company</label>
                            <textarea class="form-control" name="employment_description_${newIndex}" rows="3" placeholder="Describe the company"></textarea>
                        </div>
                    </div>
                `;

            $("#employment-history-container").append(employmentHtml);

            // Show remove buttons for all items if count > 1
            if (employmentHistoryCount > 1) {
              $(".remove-employment").show();
            }
          });

          // Remove employment handler (delegated)
          $("#employment-history-container").on(
            "click",
            ".remove-employment",
            function () {
              if (employmentHistoryCount > 1) {
                $(this).closest(".employment-item").remove();
                employmentHistoryCount--;

                // Renumber remaining employments
                $(".employment-item").each(function (index) {
                  $(this)
                    .find(".form-label")
                    .text(`Employment ${index + 1}`);
                  $(this)
                    .find("input, textarea")
                    .each(function () {
                      const name = $(this)
                        .attr("name")
                        .replace(/_(\d+)_/, `_${index}_`);
                      $(this).attr("name", name);
                      if ($(this).attr("id")) {
                        const id = $(this)
                          .attr("id")
                          .replace(/_(\d+)$/, `_${index}`);
                        $(this).attr("id", id);
                      }
                    });
                  $(this)
                    .find("label")
                    .each(function () {
                      const forAttr = $(this).attr("for");
                      if (forAttr) {
                        const newFor = forAttr.replace(/_(\d+)$/, `_${index}`);
                        $(this).attr("for", newFor);
                      }
                    });
                });

                // Hide remove button if only one item left
                if (employmentHistoryCount === 1) {
                  $(".remove-employment").hide();
                }
              }
            }
          );

          // Add institution handler
          $("#add-institution").click(function () {
            tertiaryInstitutionsCount++;
            const newIndex = tertiaryInstitutionsCount - 1;

            const institutionHtml = `
                    <div class="institution-item border rounded p-4 mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <label class="form-label">Tertiary Institution ${tertiaryInstitutionsCount}</label>
                            <button type="button" class="btn btn-outline-danger btn-sm remove-institution">
                                <i class="bi bi-dash"></i>
                            </button>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <input type="text" class="form-control" name="tertiaryInstitution_name_${newIndex}" placeholder="Name of Tertiary Institution">
                            </div>
                            <div class="col-md-6">
                                <input type="text" class="form-control" name="tertiaryInstitution_address_${newIndex}" placeholder="Address of Tertiary Institution">
                            </div>
                            <div class="col-md-6">
                                <input type="text" class="form-control" name="tertiaryInstitution_certificate_${newIndex}" placeholder="Certificate Obtained">
                            </div>
                            <div class="col-md-6">
                                <input type="text" class="form-control" name="tertiaryInstitution_matricNo_${newIndex}" placeholder="Matriculation Number">
                            </div>
                            <div class="col-md-12">
                                <input type="text" class="form-control" name="tertiaryInstitution_year_${newIndex}" placeholder="Year of Attendance">
                            </div>
                        </div>
                    </div>
                `;

            $("#tertiary-institutions-container").append(institutionHtml);

            // Show remove buttons for all items if count > 1
            if (tertiaryInstitutionsCount > 1) {
              $(".remove-institution").show();
            }
          });

          // Remove institution handler (delegated)
          $("#tertiary-institutions-container").on(
            "click",
            ".remove-institution",
            function () {
              if (tertiaryInstitutionsCount > 1) {
                $(this).closest(".institution-item").remove();
                tertiaryInstitutionsCount--;

                // Renumber remaining institutions
                $(".institution-item").each(function (index) {
                  $(this)
                    .find(".form-label")
                    .text(`Tertiary Institution ${index + 1}`);
                  $(this)
                    .find("input")
                    .each(function () {
                      const name = $(this)
                        .attr("name")
                        .replace(/_(\d+)_/, `_${index}_`);
                      $(this).attr("name", name);
                    });
                });

                // Hide remove button if only one item left
                if (tertiaryInstitutionsCount === 1) {
                  $(".remove-institution").hide();
                }
              }
            }
          );

          // Next step handler
          $("#next-step").click(function () {
            if (currentStep < steps.length - 1) {
              currentStep++;
              updateStepDisplay();
            }
          });

          // Previous step handler
          $("#prev-step").click(function () {
            if (currentStep > 0) {
              currentStep--;
              updateStepDisplay();
            }
          });

          // Form submit handler
          $("#unifiedForm").submit(function (e) {
            e.preventDefault();
          });

          // Update step display
          function updateStepDisplay() {
            // Hide all sections
            $(".form-section").removeClass("active");

            // Show current section
            $(`#${steps[currentStep].id}-section`).addClass("active");

            // Update step info in header
            $("#current-step-title").text(steps[currentStep].title);
            $("#current-step-description").text(
              `Step ${currentStep + 1} of ${steps.length}`
            );
            $("#current-step-icon")
              .removeClass()
              .addClass(`bi ${steps[currentStep].icon}`);

            // Update progress bar
            const progressPercent = ((currentStep + 1) / steps.length) * 100;
            $("#progress-bar").css("width", `${progressPercent}%`);

            // Update navigation buttons
            if (currentStep === 0) {
              $("#prev-step").prop("disabled", true);
            } else {
              $("#prev-step").prop("disabled", false);
            }

            if (currentStep === steps.length - 1) {
              $("#next-step").hide();
              $("#submit-btn").show();
            } else {
              $("#next-step").show();
              $("#submit-btn").hide();
            }
          }
        });
      </script>
      <script>
        $(document).ready(function () {
          // Hold state for counts and the auto-save timer.
          const state = {
            autoSaveTimer: null,
            institutionCount: 0,
            neighborCount: 0,
            familyCount: 0,
            employmentCount: 0,
          };

          // Utility function to set input values
          const setInputValue = (id, value) => {
            const element = document.getElementById(id);
            if (element) element.value = value || "";
          };

          /* ===================================================
           * Field Addition Functions
           * =================================================== */

          // Add a new tertiary institution section.
          const addInstitution = (institutionData = {}) => {
            const container = $("#tertiary-institution-container");
            // Calculate the index from the number of current institutions.
            const index = container.find(".institution-fields").length;

            const newInstitutionFields = `
    <div class="institution-fields m-b30">
      <label class="form-label">Tertiary Institution ${index + 1}</label>
      <input
        type="text"
        class="form-control"
        name="educationalHistory.tertiaryInstitutions[${index}].name"
        placeholder="Name of Tertiary Institution"
        value="${institutionData.name || ""}"
        
      />
      <input
        type="text"
        class="form-control"
        name="educationalHistory.tertiaryInstitutions[${index}].address"
        placeholder="Address of Tertiary Institution"
        value="${institutionData.address || ""}"
        
      />
      <input
        type="text"
        class="form-control"
        name="educationalHistory.tertiaryInstitutions[${index}].certificateObtained"
        placeholder="Certificate Obtained"
        value="${institutionData.certificateObtained || ""}"
        
      />
      <input
        type="text"
        class="form-control"
        name="educationalHistory.tertiaryInstitutions[${index}].matricNo"
        placeholder="Matriculation Number"
        value="${institutionData.matricNo || ""}"
        
      />
      <input
        type="text"
        class="form-control"
        name="educationalHistory.tertiaryInstitutions[${index}].yearOfAttendance"
        placeholder="Year of Attendance"
        value="${institutionData.yearOfAttendance || ""}"
        
      />
    </div>`;
            container.append(newInstitutionFields);
            state.institutionCount++;

            // Validate the newly added fields before auto-saving
            validateAndAutoSaveIntitution(container, index);
          };

          // Function to validate the newly added institution fields and trigger auto-save if valid
          const validateAndAutoSaveIntitution = (container, index) => {
            const fields = container
              .find(`.institution-fields:nth-child(${index + 1})`)
              .find("input");
            let isValid = true;

            fields.each(function () {
              if (!$(this).val().trim()) {
                isValid = false;
                return false; // Exit the loop early if any field is empty
              }
            });

            if (isValid) {
              autoSave();
            } else {
              console.log("Please fill out all required fields before saving.");
            }
          };

          // Add a new family section.
          const addFamily = (familyData = {}) => {
            const container = $("#family-container");
            // Calculate the index from the number of current institutions.
            const index = container.find(".family-item").length;

            const newFamilyFields = `
    <div class="family-item m-b30">
      <label class="form-label">Family ${index + 1}</label>
      <input 
        type="text" 
        class="form-control m-b10 family-name" 
        name="family_name[]" 
        placeholder="Full Name" 
        value="${familyData.name || ""}"
         />

      <input
        type="text" 
        class="form-control m-b10 family-relationship" 
        name="family_relationship[]" 
        placeholder="Relationship" 
        value="${familyData.relationship || ""}"
         />

      <input 
        type="tel" 
        class="form-control family-phone" 
        name="family_phone[]" 
        placeholder="Phone Number" 
        value="${familyData.phone || ""}"
         />

      <input 
        type="text" 
        class="form-control family-address" 
        name="family_address[]" 
        placeholder="Residential Address" 
        value="${familyData.address || ""}"
         />
    </div>`;

            container.append(newFamilyFields);
            state.familyCount++;

            if (state.familyCount === 5) {
              $("#add-family")
                .prop("disabled", true)
                .text("Maximum family reached")
                .removeClass("btn-primary")
                .addClass("btn-secondary");
            }

            // Trigger auto-save after adding new fields
            autoSaveFamily();
          };

          // Existing auto-save function (modified to validate family data)
          const autoSaveFamily = () => {
            // Validate family data before saving
            if (validateFamilyData()) {
              console.log(
                "All family fields are valid. Proceeding with auto-save..."
              );
              autoSave();
            } else {
              console.log(
                "Some family fields are incomplete. Auto-save skipped."
              );
            }
          };

          // Helper function to validate family data
          const validateFamilyData = () => {
            const familyContainer = $("#family-container");
            const familyFields = familyContainer.find(".family-item");
            let allFieldsValid = true;

            familyFields.each((index, field) => {
              const name = $(field).find(".family-name").val().trim();
              const relationship = $(field)
                .find(".family-relationship")
                .val()
                .trim();
              const phone = $(field).find(".family-phone").val().trim();
              const address = $(field).find(".family-address").val().trim();

              if (!name || !relationship || !phone || !address) {
                allFieldsValid = false;
                return false; // Exit the loop early if any field is invalid
              }
            });

            return allFieldsValid;
          };

          // // Add a new neighbor section.
          const addNeighbor = (neighborData = {}) => {
            const container = $("#neighbors-container");
            const index = container.find(".neighbor-fields").length;

            const newNeighborFields = `
      <div class="neighbor-fields m-b30">
        <label class="form-label">Neighbor ${index + 1}</label>
        <input 
          type="text" 
          class="form-control m-b10 neighbor-name" 
          name="neighbor_name[]" 
          placeholder="Full Name" 
          value="${neighborData.name || ""}"
           />
  
        <input 
          type="text" 
          class="form-control m-b10 neighbor-address" 
          name="neighbor_address[]" 
          placeholder="Residential Address" 
          value="${neighborData.address || ""}"
           />
  
        <input 
          type="tel" 
          class="form-control neighbor-phone" 
          name="neighbor_phone[]" 
          placeholder="Phone Number" 
          value="${neighborData.phone || ""}"
           />
      </div>`;

            container.append(newNeighborFields);
            state.neighborCount++;

            if (state.neighborCount === 5) {
              $("#add-neighbor")
                .prop("disabled", true)
                .text("Maximum neighbors reached")
                .removeClass("btn-primary")
                .addClass("btn-secondary");
            }

            // Attach event listeners to the new fields for auto-save validation
            const newFields = container.find(".neighbor-fields").last();
            newFields.find("input").on("input", function () {
              validateAndAutoSave(newFields);
            });
          };

          // Function to validate and auto-save only if all fields are filled
          const validateAndAutoSave = (neighborFields) => {
            const name = neighborFields.find(".neighbor-name").val().trim();
            const address = neighborFields
              .find(".neighbor-address")
              .val()
              .trim();
            const phone = neighborFields.find(".neighbor-phone").val().trim();

            if (name && address && phone) {
              autoSave(); // Trigger auto-save only if all fields are complete
            }
          };

          // Add a new employment section.
          const addEmployment = (employmentData = {}) => {
            const container = $("#employment-history-container");
            // Calculate the index from the number of current employment.
            const index = container.find(".employment-fields").length;
            const newEmploymentFields = `
      <div class="employment-fields m-b30">
        <label class="form-label">Employment ${index + 1}</label> 
        <input
          type="text"
          class="form-control"
          name="companyName[]"
          placeholder="Company Name"
          value="${employmentData.companyName || ""}"
          
        />
        <input
          type="text"
          class="form-control"
          name="address[]"
          placeholder="Company Address"
          value="${employmentData.address || ""}"
          
        />
        <input
          type="text"
          class="form-control"  
          name="designation[]"
          placeholder="Designation"
          value="${employmentData.designation || ""}"
          
          />
          <input
          type="number"
          class="form-control"
          name="startYear[]"
          placeholder="Start Year"
          value="${employmentData.startYear || ""}"
          
          />
          <div>
          <input
          type="number"
          class="form-control"
          name="endYear[]"
          placeholder="End Year"
          value="${employmentData.endYear || ""}"
          
          />
           <small class="form-text text-muted">Leave blank if this is your current employment.</small>
          </div>
          
          <div class="form-check">
          <input
          type="checkbox"
          class="form-check-input"
          name="isCurrentEmployment[]"
          value="${employmentData.isCurrentEmployment || ""}"
          />
             <label class="form-check-label"for="isCurrentEmployment">This is my current employment</label>
          </div>
           <div>
            <label for="description">Description of Company</label>
          <textarea
          class="form-control"
          name="description[]"
          placeholder="Job Description"
          value="${employmentData.description || ""}"
          
          >
          </textarea>
         </div>
      </div>`;
            container.append(newEmploymentFields);
            state.employmentCount++;

            // Validate and auto-save only if all required fields are filled
            validateAndAutoSaveEmployment();
          };

          const validateAndAutoSaveEmployment = () => {
            const container = $("#employment-history-container");
            const employmentFields = container.find(".employment-fields");

            let isComplete = true;

            employmentFields.each(function () {
              const fields = $(this).find(
                "input[required], textarea[required]"
              );
              fields.each(function () {
                if (!$(this).val()) {
                  isComplete = false;
                  return false; // Exit the loop early if any field is empty
                }
              });

              if (!isComplete) {
                return false; // Exit the outer loop early if any field is empty
              }
            });

            if (isComplete) {
              autoSave();
            }
          };

          /* ===================================================
           * Data Population Logic (Updated)
           * =================================================== */

          const populateTertiaryInstitutions = (institutions) => {
            const container = $("#tertiary-institution-container");
            container.empty(); // Clear existing fields

            if (institutions && institutions.length > 0) {
              institutions.forEach((institution) =>
                addInstitution(institution)
              );
            } else {
              // Add at least one empty institution field
              addInstitution();
            }
          };

          const populateFamily = (family) => {
            const container = $("#family-container");
            container.empty(); // Clear existing fields

            if (family && family.length > 0) {
              family.forEach((fam) => addFamily(fam));
            } else {
              // Add at least one empty family field
              addFamily();
            }
          };

          const populateNeighbors = (neighbors) => {
            const container = $("#neighbors-container");
            container.empty(); // Clear existing fields

            if (neighbors && neighbors.length > 0) {
              neighbors.forEach((neighbor) => addNeighbor(neighbor));
            } else {
              // Add at least one empty family field
              addNeighbor();
            }
          };

          const populateEmploymentHistory = (employments) => {
            const container = $("#employment-history-container");
            container.empty(); // Clear existing fields

            if (employments && employments.length > 0) {
              employments.forEach((employment) => addEmployment(employment));
            } else {
              // Add at least one empty employment field
              addEmployment();
            }
          };

          // Modified AJAX success handler
          const handleProfileDataSuccess = (data) => {
            // ... existing population code for other fields ...

            // Handle educational history
            if (data.educationalHistory) {
              // Primary and secondary school population (keep existing code)

              // Tertiary institutions - use our new method
              populateTertiaryInstitutions(
                data.educationalHistory.tertiaryInstitutions
              );
            }

            // Update institution count state
            state.institutionCount = $(
              "#tertiary-institution-container .institution-fields"
            ).length;

            if (data.family) {
              populateFamily(data.family);
              // ... rest of existing population code ...
            }
            state.familyCount = $(
              "#neighbors-container .neighbor-fields"
            ).length;

            if (data.neighbor) {
              populateNeighbors(data.neighbor);
              // ... rest of existing population code ...
            }
            state.neighborCount = $(
              "#neighbors-container .neighbor-fields"
            ).length;

            if (data.employmentHistory) {
              populateEmploymentHistory(data.employmentHistory);
              // ... rest of existing population code ...
            }
            state.employmentCount = $(
              "#employment-history-container .employment-fields"
            ).length;
          };

          // Modified AJAX call
          $.ajax({
            url: `${BACKEND_URL}/users/${user.id}`,
            method: "GET",
            headers: { Authorization: `Bearer ${token}` },
            success: handleProfileDataSuccess,
            error: function (error) {
              // ... existing error handling ...
            },
          });

          /* ===================================================
           * Data Collection
           * =================================================== */

          const collectFormData = () => {
            // Initialize FormData (this will also capture file uploads)
            const formData = new FormData();

            // List of simple fields by their IDs.
            const fields = [
              "middlename",
              "lastname",
              "nationality",
              "community",
              "religion",
              "gender",
              "stateOfOrigin",
              "DOB",
              "countryOfResidence",
              "lgaOfOrigin",
              "maritalStatus",
              "house_number",
              "street_name",
              "nearest_bus_stop_landmark",
              "city_town",
              "stateOfResidence",
              "lgaOfResidence",
              "id_number",
              "issue_date",
              "expiry_date",
            ];
            fields.forEach((field) => {
              const value = $(`#${field}`).val() || "";
              formData.append(field, value);
            });

            // Build the next-of-kin object.
            const nextOfKin = {
              nok_surname: $("#nok_surname").val().trim(),
              nok_firstname: $("#nok_firstname").val().trim(),
              nok_middlename: $("#nok_middlename").val().trim(),
              nok_relationship: $("#nok_relationship").val().trim(),
              nok_countryOfResidence: $("#nok_countryOfResidence").val().trim(),
              nok_stateOfResidence: $("#nok_stateOfResidence").val().trim(),
              nok_lgaOfResidence: $("#nok_lgaOfResidence").val().trim(),
              nok_cityOfResidence: $("#nok_cityOfResidence").val().trim(),
              nok_address: $("#nok_address").val().trim(),
            };

            // Build the health info object.
            const healthInfo = {
              bloodGroup: $("#bloodGroup").val(),
              genotype: $("#genotype").val(),
              disabilityStatus: $("#disabilityStatus").val(),
            };

            // Build the business object.
            const business = {
              biz_name: $("#biz_name").val().trim(),
              biz_type: $("#biz_type").val(),
              registration_number: $("#registration_number").val().trim(),
              biz_address: $("#biz_address").val().trim(),
              // nature_of_business: $("#nature_of_business").val().trim(),
              nature_of_business: $("#nature_of_bussiness").val()
                ? $("#nature_of_business").val().trim()
                : "",
              numberOfYears: $("#numberOfYears").val().trim(),
              numberOfEmployees: $("#numberOfEmployees").val().trim(),
              annualRevenue: $("#annualRevenue").val().trim(),
              TIN: $("#TIN").val().trim(),
              biz_phone: $("#biz_phone").val().trim(),
              biz_email: $("#biz_email").val().trim(),
            };

            // Collect neighbor entries.
            const neighbor = [];
            $(".neighbor-fields").each(function () {
              neighbor.push({
                name: $(this).find('input[name="neighbor_name[]"]').val(),
                address: $(this).find('input[name="neighbor_address[]"]').val(),
                phone: $(this).find('input[name="neighbor_phone[]"]').val(),
              });
            });

            // Collect family entries.
            const family = [];
            $(".family-item").each(function () {
              family.push({
                name: $(this).find('input[name="family_name[]"]').val(),
                relationship: $(this)
                  .find('input[name="family_relationship[]"]')
                  .val(),
                phone: $(this).find('input[name="family_phone[]"]').val(),
                address: $(this).find('input[name="family_address[]"]').val(),
              });
            });

            // Build educational history.
            const educationalHistory = {
              primarySchool: {
                name: $('input[name="primarySchool.name"]').val(),
                address: $('input[name="primarySchool.address"]').val(),
                yearOfAttendance: $(
                  'input[name="primarySchool.yearOfAttendance"]'
                ).val(),
              },
              secondarySchool: {
                name: $('input[name="secondarySchool.name"]').val(),
                address: $('input[name="secondarySchool.address"]').val(),
                yearOfAttendance: $(
                  'input[name="secondarySchool.yearOfAttendance"]'
                ).val(),
              },
              tertiaryInstitutions: [],
            };

            $(".institution-fields").each(function (index) {
              const institution = {
                name: $(this)
                  .find(
                    `input[name="educationalHistory.tertiaryInstitutions[${index}].name"]`
                  )
                  .val(),
                address: $(this)
                  .find(
                    `input[name="educationalHistory.tertiaryInstitutions[${index}].address"]`
                  )
                  .val(),
                certificateObtained: $(this)
                  .find(
                    `input[name="educationalHistory.tertiaryInstitutions[${index}].certificateObtained"]`
                  )
                  .val(),
                matricNo: $(this)
                  .find(
                    `input[name="educationalHistory.tertiaryInstitutions[${index}].matricNo"]`
                  )
                  .val(),
                yearOfAttendance: $(this)
                  .find(
                    `input[name="educationalHistory.tertiaryInstitutions[${index}].yearOfAttendance"]`
                  )
                  .val(),
              };
              educationalHistory.tertiaryInstitutions.push(institution);
            });

            // Employment History
            const employmentHistory = [];
            $(".employment-fields").each(function () {
              employmentHistory.push({
                companyName: $(this).find('input[name="companyName[]"]').val(),
                address: $(this).find('input[name="address[]"]').val(),
                designation: $(this).find('input[name="designation[]"]').val(),
                startYear: $(this).find('input[name="startYear[]"]').val(),
                endYear: $(this).find('input[name="endYear[]"]').val(),
                isCurrentEmployment: $(this)
                  .find('input[name="isCurrentEmployment[]"]')
                  .is(":checked"),
                description: $(this)
                  .find('textarea[name="description[]"]')
                  .val(),
              });
            });

            // Return both the FormData (with file uploads) and our JSON–ready objects.
            return {
              formData,
              nextOfKin,
              healthInfo,
              business,
              educationalHistory,
              employmentHistory,
              neighbor,
              family,
            };
          };

          

          /* ===================================================
           * Auto-Save / Update Handling
           * =================================================== */
          let cameraStream = null;
          let photoCaptured = false;

          // Utility: Convert dataURL to File
          function dataURLtoFile(dataurl, filename) {
            const arr = dataurl.split(",");
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while (n--) {
              u8arr[n] = bstr.charCodeAt(n);
            }
            return new File([u8arr], filename, { type: mime });
          }
          const autoSave = async () => {
            try {
              // Collect all the form data.
              let {
                formData,
                nextOfKin,
                healthInfo,
                business,
                educationalHistory,
                employmentHistory,
                neighbor,
                family,
              } = collectFormData();

              // Append the JSON–structured data.
              formData.append("nextOfKin", JSON.stringify(nextOfKin));
              formData.append("healthInfo", JSON.stringify(healthInfo));
              formData.append("business", JSON.stringify(business));
              formData.append(
                "educationalHistory",
                JSON.stringify(educationalHistory)
              );
              formData.append(
                "employmentHistory",
                JSON.stringify(employmentHistory)
              );
              formData.append("neighbor", JSON.stringify(neighbor));
              formData.append("family", JSON.stringify(family));

              // Handle identification – use the alternative input if "others" is selected.
              const selectedValue = $("#identification").val();
              const otherValue = $("#other-identification").val();
              const finalIdentification =
                selectedValue === "others" ? otherValue : selectedValue;
              formData.append("identification", finalIdentification);

              const canvas = $("#snapshot").get(0);
              const dataURL = canvas.toDataURL("image/jpeg", 0.9);
              const passportPhotoFile = $("#passportPhoto")[0]?.files[0];

              // console.log("photoCaptured:", photoCaptured);
              // console.log("passportPhotoFile:", passportPhotoFile);
              // console.log("dataURL from canvas:", dataURL);

              if (photoCaptured && dataURL) {
                formData.append(
                  "passportPhoto",
                  dataURLtoFile(dataURL, "captured-passport.jpg")
                );
              } else if (passportPhotoFile) {
                formData.append("passportPhoto", passportPhotoFile);
              }

              // Send the PUT request to update the user.
              const response = await fetch(`${BACKEND_URL}/users/${user.id}`, {
                method: "PUT",
                headers: {
                  Authorization: `Bearer ${token}`,
                },
                body: formData,
              });

              if (response.ok) {
                console.log("Auto-save successful");
                $("#autoSaveStatus").text("Saved").css("color", "green");
              } else {
                console.error("Auto-save failed", response.statusText);
                $("#autoSaveStatus").text("Failed to save").css("color", "red");
              }
            } catch (error) {
              console.log("Auto-save error:", error.message);
              console.error("Auto-save error:", error);
              $("#autoSaveStatus").text("Failed to save").css("color", "red");
            }
          };
          // ✅ Camera Start
          $("#start-camera").click(function () {
            navigator.mediaDevices
              .getUserMedia({ video: true })
              .then(function (stream) {
                cameraStream = stream;
                $("#camera-stream").get(0).srcObject = stream;
                $("#camera-stream").show();
                $("#capture-photo, #close-camera").show();
                $("#start-camera").hide();
                $("#photo-preview").hide();
              })
              .catch(function (err) {
                alert("Unable to access camera: " + err);
              });
          });
          // ✅ Capture Photo & Trigger AutoSave
          $("#capture-photo").click(function () {
            const video = $("#camera-stream").get(0);
            const canvas = $("#snapshot").get(0);
            const context = canvas.getContext("2d");

            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            const dataUrl = canvas.toDataURL("image/jpeg", 0.9);
            $("#photo-preview").attr("src", dataUrl).show();
            $("#passportPhotoData").val(dataUrl);

            if (cameraStream) {
              cameraStream.getTracks().forEach((track) => track.stop());
              cameraStream = null;
            }

            $("#camera-stream, #capture-photo, #close-camera").hide();
            $("#start-camera").show();
            photoCaptured = true;

            $("#autoSaveStatus")
              .text("Photo captured! Saving...")
              .css("color", "orange");
            console.log("Calling autoSave() after camera capture...");
            autoSave();
          });

          // ✅ Close Camera Manually
          $("#close-camera").click(function () {
            if (cameraStream) {
              cameraStream.getTracks().forEach((track) => track.stop());
              cameraStream = null;
            }
            $("#camera-stream, #capture-photo, #close-camera").hide();
            $("#start-camera").show();
          });

          // ✅ Upload Photo from File
          $("#upload-photo-btn").click(function () {
            $("#passportPhoto").click();
          });

          $("#passportPhoto").change(function (e) {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = function (event) {
                $("#photo-preview").attr("src", event.target.result).show();
                $("#passportPhotoData").val(event.target.result);

                if (cameraStream) {
                  cameraStream.getTracks().forEach((track) => track.stop());
                  cameraStream = null;
                  $("#camera-stream, #capture-photo, #close-camera").hide();
                  $("#start-camera").show();
                }
                photoCaptured = false; // File upload is NOT photoCaptured
                $("#autoSaveStatus")
                  .text("Photo uploaded! Saving...")
                  .css("color", "orange");
                console.log("Calling autoSave() after photo upload...");
                autoSave();
              };
              reader.readAsDataURL(file);
            }
          });

          /* ===================================================
           * Event Bindings
           * =================================================== */

          const bindEvents = () => {
            // Bind the click events to add new sections.
            $("#add-institution").on("click", addInstitution);
            $("#add-neighbor").on("click", addNeighbor);
            $("#add-family").on("click", addFamily);
            $("#add-employment").on("click", addEmployment);

            $(document).on(
              "input change",
              "input, select, textarea",
              function () {
                clearTimeout(state.autoSaveTimer);
                $("#autoSaveStatus").text("Saving...").css("color", "blue");
                state.autoSaveTimer = setTimeout(autoSave, 1000); // 1-second debounce
              }
            );

            // For final submission – prevent default and trigger auto-save.
            $("#unifiedForm").on("submit", function (e) {
              console.log("cool");
              e.preventDefault();
              // autoSave();
              autoSave().then(() => {
                Swal.fire({
                  title: "Success!",
                  text: "Your form has been submitted successfully.",
                  confirmButtonText: "OK",
                });
              });
            });
          };

          // Initialize all event bindings.
          bindEvents();
        });
      </script> -->

      <div id="autoSaveStatus" class="status-indicator">Ready</div>
      <script>
        $(document).ready(function () {
          // Form steps data
          const steps = [
            { id: "profile", title: "Profile Details", icon: "bi-person" },
            { id: "address", title: "Residential Address", icon: "bi-geo-alt" },
            { id: "identity", title: "Identification", icon: "bi-credit-card" },
            { id: "nok", title: "Next of Kin", icon: "bi-people" },
            { id: "contacts", title: "Contact Details", icon: "bi-telephone" },
            { id: "family", title: "Family Details", icon: "bi-people" },
            { id: "business", title: "Business Details", icon: "bi-briefcase" },
            {
              id: "employment",
              title: "Employment History",
              icon: "bi-briefcase",
            },
            {
              id: "education",
              title: "Education Details",
              icon: "bi-mortarboard",
            },
            { id: "health", title: "Health Information", icon: "bi-heart" },
          ];

          let currentStep = 0;

          // Use unique IDs instead of indices to prevent renumbering issues
          let nextNeighborId = 1;
          let nextFamilyId = 1;
          let nextEmploymentId = 1;
          let nextInstitutionId = 1;

          // Keep track of active items
          const activeNeighbors = new Set();
          const activeFamilyMembers = new Set();
          const activeEmployments = new Set();
          const activeInstitutions = new Set();

          // Initialize form
          updateStepDisplay();

          // Initialize first items
          activeNeighbors.add(0);
          activeFamilyMembers.add(0);
          activeEmployments.add(0);
          activeInstitutions.add(0);

          // Identification type change handler
          $("#identification").change(function () {
            const value = $(this).val();
            $("#other-identification-container").toggle(value === "others");
          });

          // Generic function to create item HTML
          function createNeighborHTML(id, displayNumber) {
            return `
          <div class="neighbor-item" data-id="${id}">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <label class="form-label">Neighbor ${displayNumber}</label>
              <button type="button" class="btn btn-outline-danger btn-sm remove-neighbor" data-id="${id}">
                <i class="bi bi-dash"></i>
              </button>
            </div>
            <div class="row g-3">
              <div class="col-md-4">
                <input type="text" class="form-control" name="neighbor_name_${id}" placeholder="Full Name">
              </div>
              <div class="col-md-4">
                <input type="text" class="form-control" name="neighbor_address_${id}" placeholder="Residential Address">
              </div>
              <div class="col-md-4">
                <input type="tel" class="form-control" name="neighbor_phone_${id}" placeholder="Phone Number">
              </div>
            </div>
          </div>
        `;
          }

          function createFamilyHTML(id, displayNumber) {
            return `
          <div class="family-item" data-id="${id}">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <label class="form-label">Family Member ${displayNumber}</label>
              <button type="button" class="btn btn-outline-danger btn-sm remove-family-member" data-id="${id}">
                <i class="bi bi-dash"></i>
              </button>
            </div>
            <div class="row g-3">
              <div class="col-md-3">
                <input type="text" class="form-control" name="family_name_${id}" placeholder="Full Name">
              </div>
              <div class="col-md-3">
                <input type="text" class="form-control" name="family_relationship_${id}" placeholder="Relationship">
              </div>
              <div class="col-md-3">
                <input type="text" class="form-control" name="family_address_${id}" placeholder="Residential Address">
              </div>
              <div class="col-md-3">
                <input type="tel" class="form-control" name="family_phone_${id}" placeholder="Phone Number">
              </div>
            </div>
          </div>
        `;
          }

          function createEmploymentHTML(id, displayNumber) {
            return `
          <div class="employment-item" data-id="${id}">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <label class="form-label">Employment ${displayNumber}</label>
              <button type="button" class="btn btn-outline-danger btn-sm remove-employment" data-id="${id}">
                <i class="bi bi-dash"></i>
              </button>
            </div>

            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Company Name</label>
                <input type="text" class="form-control" name="companyName_${id}" placeholder="Enter company name">
              </div>
              <div class="col-md-6">
                <label class="form-label">Address</label>
                <input type="text" class="form-control" name="employment_address_${id}" placeholder="Enter company address">
              </div>
              <div class="col-md-6">
                <label class="form-label">Designation</label>
                <input type="text" class="form-control" name="designation_${id}" placeholder="Enter your designation">
              </div>
              <div class="col-md-6">
                <label class="form-label">Start Year</label>
                <input type="date" class="form-control" name="startYear_${id}" placeholder="Enter start year">
              </div>
              <div class="col-md-6">
                <label class="form-label">End Year</label>
                <input type="date" class="form-control" name="endYear_${id}" placeholder="Enter end year">
                <p class="text-muted small mt-1">Leave blank if this is your current employment.</p>
              </div>
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="isCurrentEmployment_${id}" name="isCurrentEmployment_${id}">
                  <label class="form-check-label" for="isCurrentEmployment_${id}">
                    This is my current employment
                  </label>
                </div>
              </div>
            </div>

            <div class="mt-3">
              <label class="form-label">Description of Company</label>
              <textarea class="form-control" name="employment_description_${id}" rows="3" placeholder="Describe the company"></textarea>
            </div>
          </div>
        `;
          }

          function createInstitutionHTML(id, displayNumber) {
            return `
          <div class="institution-item border rounded p-4 mt-3" data-id="${id}">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <label class="form-label">Tertiary Institution ${displayNumber}</label>
              <button type="button" class="btn btn-outline-danger btn-sm remove-institution" data-id="${id}">
                <i class="bi bi-dash"></i>
              </button>
            </div>

            <div class="row g-3">
              <div class="col-md-6">
                <input type="text" class="form-control" name="tertiaryInstitution_name_${id}" placeholder="Name of Tertiary Institution">
              </div>
              <div class="col-md-6">
                <input type="text" class="form-control" name="tertiaryInstitution_address_${id}" placeholder="Address of Tertiary Institution">
              </div>
              <div class="col-md-6">
                <input type="text" class="form-control" name="tertiaryInstitution_certificate_${id}" placeholder="Certificate Obtained">
              </div>
              <div class="col-md-6">
                <input type="text" class="form-control" name="tertiaryInstitution_matricNo_${id}" placeholder="Matriculation Number">
              </div>
              <div class="col-md-12">
                <input type="text" class="form-control" name="tertiaryInstitution_year_${id}" placeholder="Year of Attendance">
              </div>
            </div>
          </div>
        `;
          }

          // Function to update display numbers without changing form names
          function updateDisplayNumbers(
            containerSelector,
            itemSelector,
            labelPrefix,
            activeSet
          ) {
            const items = $(containerSelector).find(itemSelector);
            items.each(function (index) {
              $(this)
                .find(".form-label")
                .first()
                .text(`${labelPrefix} ${index + 1}`);
            });

            // Update remove button visibility
            const removeButtons = $(containerSelector).find(
              ".btn-outline-danger"
            );
            removeButtons.toggle(activeSet.size > 1);
          }

          // Remove neighbor handler (delegated)
          $("#neighbors-container").on(
            "click",
            ".remove-neighbor",
            function () {
              const id = parseInt($(this).data("id"));
              if (activeNeighbors.size > 1) {
                $(this).closest(".neighbor-item").remove();
                activeNeighbors.delete(id);

                // Update UI state
                $("#neighbor-max-message").hide();
                $("#add-neighbor").prop("disabled", false);
                updateDisplayNumbers(
                  "#neighbors-container",
                  ".neighbor-item",
                  "Neighbor",
                  activeNeighbors
                );
              }
            }
          );

          // Add family member handler
          $("#add-family-member").click(function () {
            if (activeFamilyMembers.size < 5) {
              const id = nextFamilyId++;
              activeFamilyMembers.add(id);

              const familyHtml = createFamilyHTML(id, activeFamilyMembers.size);
              $("#family-members-container").append(familyHtml);

              // Update UI state
              $("#family-max-message").toggle(activeFamilyMembers.size >= 5);
              $("#add-family-member").prop(
                "disabled",
                activeFamilyMembers.size >= 5
              );
              updateDisplayNumbers(
                "#family-members-container",
                ".family-item",
                "Family Member",
                activeFamilyMembers
              );
            }
          });

          // Remove family member handler (delegated)
          $("#family-members-container").on(
            "click",
            ".remove-family-member",
            function () {
              const id = parseInt($(this).data("id"));
              if (activeFamilyMembers.size > 1) {
                $(this).closest(".family-item").remove();
                activeFamilyMembers.delete(id);

                // Update UI state
                $("#family-max-message").hide();
                $("#add-family-member").prop("disabled", false);
                updateDisplayNumbers(
                  "#family-members-container",
                  ".family-item",
                  "Family Member",
                  activeFamilyMembers
                );
              }
            }
          );

          // Remove employment handler (delegated)
          $("#employment-history-container").on(
            "click",
            ".remove-employment",
            function () {
              const id = parseInt($(this).data("id"));
              if (activeEmployments.size > 1) {
                $(this).closest(".employment-item").remove();
                activeEmployments.delete(id);

                updateDisplayNumbers(
                  "#employment-history-container",
                  ".employment-item",
                  "Employment",
                  activeEmployments
                );
              }
            }
          );

          // Add institution handler
          $("#add-institution").click(function () {
            const id = nextInstitutionId++;
            activeInstitutions.add(id);

            const institutionHtml = createInstitutionHTML(
              id,
              activeInstitutions.size
            );
            $("#tertiary-institutions-container").append(institutionHtml);

            updateDisplayNumbers(
              "#tertiary-institutions-container",
              ".institution-item",
              "Tertiary Institution",
              activeInstitutions
            );
          });

          // Remove institution handler (delegated)
          $("#tertiary-institutions-container").on(
            "click",
            ".remove-institution",
            function () {
              const id = parseInt($(this).data("id"));
              if (activeInstitutions.size > 1) {
                $(this).closest(".institution-item").remove();
                activeInstitutions.delete(id);

                updateDisplayNumbers(
                  "#tertiary-institutions-container",
                  ".institution-item",
                  "Tertiary Institution",
                  activeInstitutions
                );
              }
            }
          );

          // Next step handler
          $("#next-step").click(function () {
            if (currentStep < steps.length - 1) {
              currentStep++;
              updateStepDisplay();
            }
          });

          // Previous step handler
          $("#prev-step").click(function () {
            if (currentStep > 0) {
              currentStep--;
              updateStepDisplay();
            }
          });

          // Form submit handler
          $("#unifiedForm").submit(function (e) {
            e.preventDefault();
            // Add your form submission logic here
            console.log("Form submitted");
          });

          // Update step display
          function updateStepDisplay() {
            // Hide all sections
            $(".form-section").removeClass("active");

            // Show current section
            $(`#${steps[currentStep].id}-section`).addClass("active");

            // Update step info in header
            $("#current-step-title").text(steps[currentStep].title);
            $("#current-step-description").text(
              `Step ${currentStep + 1} of ${steps.length}`
            );
            $("#current-step-icon")
              .removeClass()
              .addClass(`bi ${steps[currentStep].icon}`);

            // Update progress bar
            const progressPercent = ((currentStep + 1) / steps.length) * 100;
            $("#progress-bar").css("width", `${progressPercent}%`);

            // Update navigation buttons
            $("#prev-step").prop("disabled", currentStep === 0);

            if (currentStep === steps.length - 1) {
              $("#next-step").hide();
              $("#submit-btn").show();
            } else {
              $("#next-step").show();
              $("#submit-btn").hide();
            }
          }
          // });

          // $(document).ready(function () {
          // Hold state for counts and the auto-save timer.
          const state = {
            autoSaveTimer: null,
            institutionCount: 0,
            neighborCount: 0,
            familyCount: 0,
            employmentCount: 0,
            isDataLoaded: false, // Flag to prevent premature auto-saves
            pendingSave: false, // Flag to prevent concurrent saves
          };

          // Utility function to set input values safely
          const setInputValue = (id, value) => {
            const element = document.getElementById(id);
            if (element) {
              element.value = value || "";
            }
          };

          // Debounced auto-save function
          const debouncedAutoSave = (() => {
            let timeoutId;
            return (delay = 1000) => {
              clearTimeout(timeoutId);
              $("#autoSaveStatus").text("Saving...").css("color", "blue");
              timeoutId = setTimeout(() => {
                if (state.isDataLoaded) {
                  formManager.performAutoSave();
                }
              }, delay);
            };
          })();

          /* ===================================================
           * Field Addition Functions (Improved)
           * =================================================== */

          // Add a new tertiary institution section with better validation
          const addInstitution = (institutionData = {}) => {
            const container = $("#tertiary-institution-container");
            const index = container.find(".institution-fields").length;

            const newInstitutionFields = `
          <div class="institution-fields m-b30" data-index="${index}">
            <label class="form-label">Tertiary Institution ${index + 1}</label>
            <input
              type="text"
              class="form-control institution-input"
              name="educationalHistory.tertiaryInstitutions[${index}].name"
              placeholder="Name of Tertiary Institution"
              value="${escapeHtml(institutionData.name || "")}"
              data-field="name"
            />
            <input
              type="text"
              class="form-control institution-input"
              name="educationalHistory.tertiaryInstitutions[${index}].address"
              placeholder="Address of Tertiary Institution"
              value="${escapeHtml(institutionData.address || "")}"
              data-field="address"
            />
            <input
              type="text"
              class="form-control institution-input"
              name="educationalHistory.tertiaryInstitutions[${index}].certificateObtained"
              placeholder="Certificate Obtained"
              value="${escapeHtml(institutionData.certificateObtained || "")}"
              data-field="certificateObtained"
            />
            <input
              type="text"
              class="form-control institution-input"
              name="educationalHistory.tertiaryInstitutions[${index}].matricNo"
              placeholder="Matriculation Number"
              value="${escapeHtml(institutionData.matricNo || "")}"
              data-field="matricNo"
            />
            <input
              type="text"
              class="form-control institution-input"
              name="educationalHistory.tertiaryInstitutions[${index}].yearOfAttendance"
              placeholder="Year of Attendance"
              value="${escapeHtml(institutionData.yearOfAttendance || "")}"
              data-field="yearOfAttendance"
            />
            <button type="button" class="btn btn-danger btn-sm remove-institution mt-2">Remove</button>
          </div>`;

            container.append(newInstitutionFields);
            state.institutionCount++;

            // Bind remove button event
            container
              .find(".remove-institution")
              .last()
              .on("click", function () {
                $(this).closest(".institution-fields").remove();
                state.institutionCount--;
                reindexInstitutions();
              });

            // Only trigger auto-save if data is already loaded (not during initial population)
            if (state.isDataLoaded) {
              debouncedAutoSave();
            }
          };

          // Reindex institutions after removal
          const reindexInstitutions = () => {
            $("#tertiary-institution-container .institution-item").each(
              function (newIndex) {
                $(this).attr("data-index", newIndex);
                $(this)
                  .find("label")
                  .text(`Tertiary Institution ${newIndex + 1}`);
                $(this)
                  .find("input")
                  .each(function () {
                    const currentName = $(this).attr("name");
                    if (
                      currentName &&
                      currentName.includes("tertiaryInstitutions")
                    ) {
                      const newName = currentName.replace(
                        /\[\d+\]/,
                        `[${newIndex}]`
                      );
                      $(this).attr("name", newName);
                    }
                  });
              }
            );
          };

          // Add a new family section with improved validation
          const addFamily = (familyData = {}) => {
            if (state.familyCount >= 5) {
              console.warn("Maximum family members reached");
              return;
            }

            const container = $("#family-members-container");
            const id = state.familyCount;
            const html = createFamilyHTML(id, id + 1);

            container.append(html);
            state.familyCount++;

            // Populate values if available
            $(`input[name="family_name_${id}"]`).val(familyData.name || "");
            $(`input[name="family_relationship_${id}"]`).val(
              familyData.relationship || ""
            );
            $(`input[name="family_phone_${id}"]`).val(familyData.phone || "");
            $(`input[name="family_adress_${id}"]`).val(
              familyData.address || ""
            );

            // Bind remove button event
            container
              .find(".remove-family")
              .last()
              .on("click", function () {
                $(this).closest(".family-item").remove();
                state.familyCount--;
                updateFamilyButtonState();
                reindexFamily();
              });
            updateFamilyButtonState();

            if (state.isDataLoaded) {
              debouncedAutoSave();
            }
          };

          // Update family button state
          const updateFamilyButtonState = () => {
            const addButton = $("#add-family-member");
            if (state.familyCount >= 5) {
              addButton
                .prop("disabled", true)
                .text("Maximum family reached")
                .removeClass("btn-primary")
                .addClass("btn-secondary");
            } else {
              addButton
                .prop("disabled", false)
                .text("Add Family Member")
                .removeClass("btn-secondary")
                .addClass("btn-primary");
            }
          };

          // Reindex family after removal
          const reindexFamily = () => {
            $("#family-members-container .family-item").each(function (
              newIndex
            ) {
              $(this).attr("data-index", newIndex);
              $(this)
                .find("label")
                .text(`Family ${newIndex + 1}`);
            });
          };

          const addNeighbor = (neighborData = {}) => {
            if (state.neighborCount >= 5) {
              console.warn("Maximum neighbors reached");
              return;
            }

            const container = $("#neighbors-container");
            const id = state.neighborCount;
            const html = createNeighborHTML(id, id + 1);

            container.append(html);
            state.neighborCount++;

            // Populate values if available
            $(`input[name="neighbor_name_${id}"]`).val(neighborData.name || "");
            $(`input[name="neighbor_address_${id}"]`).val(
              neighborData.address || ""
            );
            $(`input[name="neighbor_phone_${id}"]`).val(
              neighborData.phone || ""
            );

            // Attach remove handler
            container
              .find(".remove-neighbor")
              .last()
              .on("click", function () {
                $(this).closest(".neighbor-item").remove();
                state.neighborCount--;
                updateNeighborButtonState();
                reindexNeighbors(); // Optional
              });

            updateNeighborButtonState();

            if (state.isDataLoaded) {
              debouncedAutoSave();
            }
          };

          // Update neighbor button state
          const updateNeighborButtonState = () => {
            const addButton = $("#add-neighbor");
            if (state.neighborCount >= 5) {
              addButton
                .prop("disabled", true)
                .text("Maximum neighbors reached")
                .removeClass("btn-primary")
                .addClass("btn-secondary");
            } else {
              addButton
                .prop("disabled", false)
                .text("+ Add Another Neighbor")
                .removeClass("btn-secondary")
                .addClass("btn btn-outline-green");
            }
          };

          // Reindex neighbors after removal
          const reindexNeighbors = () => {
            $("#neighbors-container .neighbor-item").each(function (newIndex) {
              $(this).attr("data-index", newIndex);
              $(this)
                .find("label")
                .text(`Neighbor ${newIndex + 1}`);
            });
          };

          // Add a new employment section with improved validation
          const addEmployment = (employmentData = {}) => {
            if (state.employmentCount >= 5) {
              console.warn("Maximum family members reached");
              return;
            }
            const container = $("#employment-history-container");

            const id = state.employmentCount;
            const html = createEmploymentHTML(id, id + 1);

            // Populate values if available
            $(`input[name="companyName_${id}"]`).val(
              employmentData.companyName || ""
            );
            $(`input[name="employment_address_${id}"]`).val(
              employmentData.address || ""
            );
            $(`input[name="designation_${id}"]`).val(
              employmentData.designation || ""
            );
            $(`input[name="startYear_${id}"]`).val(
              employmentData.startYear || ""
            );
            $(`input[name="endYear_${id}"]`).val(employmentData.endYear || "");
            $(`input[name="isCurrentEmployment_${id}"]`).val(
              employmentData.isCurrentEmployment || ""
            );

            container.append(html);
            state.employmentCount++;

            // Bind remove button event
            container
              .find(".remove-employment")
              .last()
              .on("click", function () {
                $(this).closest(".employment-item").remove();
                state.employmentCount--;
                reindexEmployment();
              });
            updateEmploymentButtonState();

            if (state.isDataLoaded) {
              debouncedAutoSave();
            }
          };
          // Update family button state
          const updateEmploymentButtonState = () => {
            const addButton = $("#add-employment");
            if (state.employmentCount >= 5) {
              addButton
                .prop("disabled", true)
                .text("Maximum Employment reached")
                .removeClass("btn-primary")
                .addClass("btn-secondary");
            } else {
              addButton
                .prop("disabled", false)
                .text("+ Add Another Employment")
                .removeClass("btn-secondary")
                .addClass("btn-primary");
            }
          };

          // Reindex employment after removal
          const reindexEmployment = () => {
            $("#employment-history-container .employment-item").each(function (
              newIndex
            ) {
              $(this).attr("data-index", newIndex);
              $(this)
                .find("label")
                .text(`Employment ${newIndex + 1}`);
            });
          };

          // Utility function to escape HTML to prevent XSS
          const escapeHtml = (text) => {
            if (!text) return "";
            const map = {
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#039;",
            };
            return text.replace(/[&<>"']/g, (m) => map[m]);
          };

          /* ===================================================
           * Data Population Logic (Improved with Safety Checks)
           * =================================================== */

          // Updated populateNeighbors function
          const populateNeighbors = (neighbors) => {
            const container = $("#neighbors-container");
            container.empty();

            try {
              if (neighbors && neighbors.length > 0) {
                neighbors.forEach((neighbor, index) => {
                  const neighborHtml = createNeighborHTML(index, index + 1);
                  container.append(neighborHtml);

                  // Set values from database
                  $(`input[name="neighbor_name_${index}"]`).val(
                    neighbor.name || ""
                  );
                  $(`input[name="neighbor_address_${index}"]`).val(
                    neighbor.address || ""
                  );
                  $(`input[name="neighbor_phone_${index}"]`).val(
                    neighbor.phone || ""
                  );
                });
              } else {
                // Add default empty neighbor
                addNeighbor();
              }
            } catch (error) {
              console.error("Error in populateNeighbors:", error);
            }
          };

          // Updated populateFamily function
          const populateFamily = (family) => {
            const container = $("#family-members-container");
            container.empty();

            if (family && family.length > 0) {
              family.forEach((member, index) => {
                const familyHtml = createFamilyHTML(index, index + 1);
                container.append(familyHtml);

                // Set values from database
                $(`input[name="family_name_${index}"]`).val(member.name || "");
                $(`input[name="family_relationship_${index}"]`).val(
                  member.relationship || ""
                );
                $(`input[name="family_address_${index}"]`).val(
                  member.address || ""
                );
                $(`input[name="family_phone_${index}"]`).val(
                  member.phone || ""
                );
              });
            } else {
              // Add default empty family member
              addFamily();
            }
          };

          // Updated populateEmploymentHistory function
          const populateEmploymentHistory = (employments) => {
            const container = $("#employment-history-container");
            container.empty();

            if (employments && employments.length > 0) {
              employments.forEach((employment, index) => {
                const employmentHtml = createEmploymentHTML(index, index + 1);
                container.append(employmentHtml);

                // Set values from database
                $(`input[name="companyName_${index}"]`).val(
                  employment.companyName || ""
                );
                $(`input[name="employment_address_${index}"]`).val(
                  employment.address || ""
                );
                $(`input[name="designation_${index}"]`).val(
                  employment.designation || ""
                );
                $(`input[name="startYear_${index}"]`).val(
                  employment.startYear || ""
                );
                $(`input[name="endYear_${index}"]`).val(
                  employment.endYear || ""
                );
                $(`input[name="isCurrentEmployment_${index}"]`).prop(
                  "checked",
                  employment.isCurrentEmployment || false
                );
                $(`textarea[name="employment_description_${index}"]`).val(
                  employment.description || ""
                );
              });
            } else {
              // Add default empty employment
              addEmployment();
            }
          };

          // Updated populateTertiaryInstitutions function
          const populateTertiaryInstitutions = (institutions) => {
            const container = $("#tertiary-institutions-container");
            container.empty();

            if (institutions && institutions.length > 0) {
              institutions.forEach((institution, index) => {
                const institutionHtml = createInstitutionHTML(index, index + 1);
                container.append(institutionHtml);

                // Set values from database
                $(`input[name="tertiaryInstitution_name_${index}"]`).val(
                  institution.name || ""
                );
                $(`input[name="tertiaryInstitution_address_${index}"]`).val(
                  institution.address || ""
                );
                $(`input[name="tertiaryInstitution_certificate_${index}"]`).val(
                  institution.certificateObtained || ""
                );
                $(`input[name="tertiaryInstitution_matricNo_${index}"]`).val(
                  institution.matricNo || ""
                );
                $(`input[name="tertiaryInstitution_year_${index}"]`).val(
                  institution.yearOfAttendance || ""
                );
              });
            } else {
              // Add default empty institution
              addInstitution();
            }
          };

          const handleProfileDataSuccess = (data) => {
            console.log("data", data);
            try {
              // Set flag to prevent auto-saves during population
              state.isDataLoaded = false;

              // Populate other fields safely
              if (data) {
                // Handle educational history
                if (data.educationalHistory) {
                  // Primary and secondary school population
                  $('input[name="primarySchool_name"]').val(
                    data.educationalHistory.primarySchool?.name || ""
                  );
                  $('input[name="primarySchool_address"]').val(
                    data.educationalHistory.primarySchool?.address || ""
                  );
                  $('input[name="primarySchool_yearOfAttendance"]').val(
                    data.educationalHistory.primarySchool?.yearOfAttendance ||
                      ""
                  );

                  $('input[name="secondarySchool_name"]').val(
                    data.educationalHistory.secondarySchool?.name || ""
                  );
                  $('input[name="secondarySchool_address"]').val(
                    data.educationalHistory.secondarySchool?.address || ""
                  );
                  $('input[name="secondarySchool_yearOfAttendance"]').val(
                    data.educationalHistory.secondarySchool?.yearOfAttendance ||
                      ""
                  );

                  // Tertiary institutions
                  populateTertiaryInstitutions(
                    data.educationalHistory.tertiaryInstitutions || []
                  );
                }

                // Populate family data
                populateFamily(data.family || []);

                // Populate neighbor data
                populateNeighbors(data.neighbor || []);

                // Populate employment history
                populateEmploymentHistory(data.employmentHistory || []);
              }

              // Set flag to allow auto-saves after population is complete
              state.isDataLoaded = true;

              console.log("Profile data populated successfully");
            } catch (error) {
              console.error("Error populating profile data:", error);
              state.isDataLoaded = true; // Still allow saves even if population fails
            }
          };

          // Improved AJAX call with better error handling
          const loadProfileData = () => {
            if (!user || !user.id || !token) {
              console.error("Missing user data or token");
              state.isDataLoaded = true; // Allow saves even without loaded data
              return;
            }

            $.ajax({
              url: `${BACKEND_URL}/users/${user.id}`,
              method: "GET",
              headers: { Authorization: `Bearer ${token}` },
              timeout: 10000, // 10 second timeout
              success: handleProfileDataSuccess,
              error: function (xhr, status, error) {
                console.error("Failed to load profile data:", {
                  status: xhr.status,
                  statusText: xhr.statusText,
                  error: error,
                });

                // Still allow the form to function even if data loading fails
                state.isDataLoaded = true;

                // Add default empty fields if no data was loaded
                if (
                  $("#tertiary-institution-container .institution-item")
                    .length === 0
                ) {
                  addInstitution();
                }
                if ($("#family-container .family-item").length === 0) {
                  addFamily();
                }
                if ($("#neighbors-container .neighbor-item").length === 0) {
                  addNeighbor();
                }
                if (
                  $("#employment-history-container .employment-item").length ===
                  0
                ) {
                  addEmployment();
                }
              },
            });
          };

          loadProfileData();

          /* ===================================================
           * Data Collection (Improved)
           * =================================================== */

          /* ===================================================
           * Auto-Save / Update Handling (Improved)
           * =================================================== */
          let cameraStream = null;
          let photoCaptured = false;

          // Utility: Convert dataURL to File
          function dataURLtoFile(dataurl, filename) {
            try {
              const arr = dataurl.split(",");
              const mime = arr[0].match(/:(.*?);/)[1];
              const bstr = atob(arr[1]);
              let n = bstr.length;
              const u8arr = new Uint8Array(n);
              while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
              }
              return new File([u8arr], filename, { type: mime });
            } catch (error) {
              console.error("Error converting dataURL to file:", error);
              return null;
            }
          }

          // Enhanced Auto-Save System with Data Loss Prevention
          class FormDataManager {
            constructor() {
              this.state = {
                autoSaveTimer: null,
                retryTimer: null,
                maxRetries: 3,
                retryDelay: 2000,
                currentRetryCount: 0,
                lastSaveAttempt: null,
                pendingChanges: false,
                isOnline: navigator.onLine,
                formData: new Map(),
                lastKnownGoodState: null,
              };

              this.initializeNetworkMonitoring();
              this.initializePageUnloadProtection();
              // this.loadPersistedData();
              this.initialize();
            }

            // Network monitoring to detect connectivity issues
            initializeNetworkMonitoring() {
              window.addEventListener("online", () => {
                console.log("Connection restored");
                this.state.isOnline = true;
                this.updateStatus(
                  "Connection restored. Syncing data...",
                  "blue"
                );
                if (this.state.pendingChanges) {
                  this.performAutoSave();
                }
              });

              window.addEventListener("offline", () => {
                console.log("Connection lost");
                this.state.isOnline = false;
                this.updateStatus("Offline - changes saved locally", "orange");
              });
            }

            // Prevent data loss on page unload
            initializePageUnloadProtection() {
              window.addEventListener("beforeunload", (e) => {
                if (this.state.pendingChanges) {
                  // Save to local storage as backup
                  this.saveToLocalStorage();

                  // Show confirmation dialog
                  const message =
                    "You have unsaved changes. Are you sure you want to leave?";
                  e.returnValue = message;
                  return message;
                }
              });

              // Handle page visibility changes (mobile browsers)
              document.addEventListener("visibilitychange", () => {
                if (
                  document.visibilityState === "hidden" &&
                  this.state.pendingChanges
                ) {
                  this.saveToLocalStorage();
                  if (this.state.isOnline) {
                    this.performAutoSave(true); // Force immediate save
                  }
                }
              });
            }

            // Load persisted data from local storage

            async loadPersistedData() {
              try {
                const saved = localStorage.getItem("formData_backup");
                if (!saved) return null;

                const parsed = JSON.parse(saved);
                if (!parsed?.data) {
                  console.error("Invalid backup structure");
                  return null;
                }

                // Verify data freshness
                const timestamp = new Date(parsed.timestamp);
                if (new Date() - timestamp > 24 * 60 * 60 * 1000) {
                  localStorage.removeItem("formData_backup");
                  return null;
                }

                console.log("Loaded backup data:", parsed.data); // Debug
                return parsed.data; // Return JUST the data object
              } catch (error) {
                console.error("Load failed:", error);
                return null;
              }
            }

            // Show dialog to recover unsaved data

            // Modify your initialization to wait for DOM ready
            async initialize() {
              await new Promise((resolve) => $(document).ready(resolve));

              const backupData = await this.loadPersistedData();
              if (backupData) {
                this.showDataRecoveryDialog(backupData);
              }

              this.initializeNetworkMonitoring();
              this.initializePageUnloadProtection();
            }

            showDataRecoveryDialog(backupData) {
              console.log("Dialog received backupData:", backupData); // DEBUG

              Swal.fire({
                title: "Recover Unsaved Changes?",
                text: "We found unsaved changes from your previous session.",
                icon: "question",
                showCancelButton: true,
                confirmButtonText: "Restore",
                cancelButtonText: "Discard",
              }).then((result) => {
                if (result.value === true) {
                  console.log("Attempting restoration with:", backupData); // DEBUG
                  this.restoreFormData(backupData);
                } else {
                  localStorage.removeItem("formData_backup");
                }
              });
            }

            // Update your loadPersistedData method to extract the data object
            loadPersistedData() {
              try {
                const savedData = localStorage.getItem("formData_backup");
                if (!savedData) return null;

                const parsed = JSON.parse(savedData);
                console.log("Parsed backup:", parsed); // Debug log

                if (!parsed?.data) {
                  console.error(
                    "Invalid backup structure - missing data property"
                  );
                  return null;
                }

                // Verify timestamp if needed
                return parsed.data; // Return JUST the data object
              } catch (error) {
                console.error("Failed to load backup:", error);
                return null;
              }
            }

            // Update your restoreFormData to ensure proper this binding
            restoreFormData(data) {
              if (!data) {
                console.error("No data provided to restore");
                return;
              }

              console.group("Full Restoration Debug");
              console.log("Data being restored:", data); // Debug log

              // 1. Restore Main Form Fields
              if (data.formData) {
                console.log("Restoring form fields:", data.formData);
                Object.entries(data.formData).forEach(([key, value]) => {
                  const $field = $(`#${key}`);
                  if ($field.length) {
                    $field.val(value || "");
                    console.log(`Set #${key} =`, value);
                  } else {
                    console.warn(`Field not found: #${key}`);
                  }
                });
              }

              // 2. Restore Next of Kin
              if (data.nextOfKin) {
                console.log("Restoring next of kin:", data.nextOfKin);
                Object.entries(data.nextOfKin).forEach(([key, value]) => {
                  console.log(key, value);
                  const $field = $(`#nok_${key}`);
                  if ($field.length) {
                    $field.val(value || "");
                    console.log(`Set #nok_${key} =`, value);
                  } else {
                    console.warn(`Field not found: #nok_${key}`);
                  }
                });
              }

              // 3. Restore Neighbors
              // Update the neighbor restoration code in restoreFormData()
              if (data.neighbor?.length) {
                console.log("Restoring neighbors:", data.neighbor);

                data.neighbor.forEach((neighbor, index) => {
                  // Use index directly (starts from 0)
                  $(`input[name="neighbor_name_${index}"]`).val(
                    neighbor.name || ""
                  );
                  $(`input[name="neighbor_address_${index}"]`).val(
                    neighbor.address || ""
                  );
                  $(`input[name="neighbor_phone_${index}"]`).val(
                    neighbor.phone || ""
                  );
                });
              }
              // 4. Restore Family Members

              if (data.family?.length) {
                data.family.forEach((member, index) => {
                  // Use index directly (0-based)
                  const fields = {
                    name: $(`input[name="family_name_${index}"]`),
                    relationship: $(
                      `input[name="family_relationship_${index}"]`
                    ),
                    phone: $(`input[name="family_phone_${index}"]`),
                    address: $(`input[name="family_address_${index}"]`),
                  };

                  Object.entries(fields).forEach(([type, $field]) => {});

                  // Set values for existing fields
                  if (fields.name.length) fields.name.val(member.name || "");
                  if (fields.relationship.length)
                    fields.relationship.val(member.relationship || "");
                  if (fields.phone.length) fields.phone.val(member.phone || "");
                  if (fields.address.length)
                    fields.address.val(member.address || "");
                });

                console.groupEnd();
              }

              // 5. Restore Business Info
              if (data.business) {
                Object.entries(data.business).forEach(([key, value]) => {
                  const $field = $(`#${key}`);
                  if ($field.length) {
                    $field.val(value || "");
                    console.log(`Set #${key} =`, value);
                  }
                });
              }

              // 6. Restore Employment History (0-based indexing)
              if (data.employmentHistory?.length) {
                console.group("Restoring Employment History");
                console.log(
                  "Employment data to restore:",
                  data.employmentHistory
                );

                data.employmentHistory.forEach((job, index) => {
                  const fields = {
                    companyName: $(`input[name="companyName_${index}"]`),
                    address: $(`input[name="employment_address_${index}"]`),
                    designation: $(`input[name="designation_${index}"]`),
                    startYear: $(`input[name="startYear_${index}"]`),
                    endYear: $(`input[name="endYear_${index}"]`),
                    isCurrentEmployment: $(
                      `input[name="isCurrentEmployment_${index}"]`
                    ),
                    description: $(
                      `textarea[name="employment_description_${index}"]`
                    ),
                  };

                  // Debug: Verify fields exist
                  console.log(`\nJob ${index} fields check:`);
                  Object.entries(fields).forEach(([field, $el]) => {
                    console.log(
                      `- ${field}_${index}:`,
                      $el.length ? "Exists" : "MISSING"
                    );
                  });

                  // Set values for existing fields
                  if (fields.companyName.length)
                    fields.companyName.val(job.companyName || "");
                  if (fields.address.length)
                    fields.address.val(job.address || "");
                  if (fields.designation.length)
                    fields.designation.val(job.designation || "");
                  if (fields.startYear.length)
                    fields.startYear.val(job.startYear || "");
                  if (fields.endYear.length)
                    fields.endYear.val(job.endYear || "");
                  if (fields.isCurrentEmployment.length) {
                    fields.isCurrentEmployment.prop(
                      "checked",
                      job.isCurrentEmployment || false
                    );
                  }
                  if (fields.description.length)
                    fields.description.val(job.description || "");

                  console.log(`Restored job ${index}:`, {
                    company: job.companyName,
                    position: job.designation,
                    current: job.isCurrentEmployment,
                  });
                });
                console.groupEnd();
              }

              // 7. Restore Education History
              if (data.educationalHistory) {
                console.group("Restoring Education History");
                console.log(
                  "Education data to restore:",
                  data.educationalHistory
                );

                // Primary School
                const primaryFields = {
                  name: $('input[name="primarySchool_name"]'),
                  address: $('input[name="primarySchool_address"]'),
                  year: $('input[name="primarySchool_yearOfAttendance"]'),
                };

                console.log("\nPrimary School fields check:");
                Object.entries(primaryFields).forEach(([field, $el]) => {
                  console.log(
                    `- primary_${field}:`,
                    $el.length ? "Exists" : "MISSING"
                  );
                });

                if (primaryFields.name.length)
                  primaryFields.name.val(
                    data.educationalHistory.primarySchool?.name || ""
                  );
                if (primaryFields.address.length)
                  primaryFields.address.val(
                    data.educationalHistory.primarySchool?.address || ""
                  );
                if (primaryFields.year.length)
                  primaryFields.year.val(
                    data.educationalHistory.primarySchool?.yearOfAttendance ||
                      ""
                  );

                // Secondary School
                const secondaryFields = {
                  name: $('input[name="secondarySchool_name"]'),
                  address: $('input[name="secondarySchool_address"]'),
                  year: $('input[name="secondarySchool_yearOfAttendance"]'),
                };

                console.log("\nSecondary School fields check:");
                Object.entries(secondaryFields).forEach(([field, $el]) => {
                  console.log(
                    `- secondary_${field}:`,
                    $el.length ? "Exists" : "MISSING"
                  );
                });

                if (secondaryFields.name.length)
                  secondaryFields.name.val(
                    data.educationalHistory.secondarySchool?.name || ""
                  );
                if (secondaryFields.address.length)
                  secondaryFields.address.val(
                    data.educationalHistory.secondarySchool?.address || ""
                  );
                if (secondaryFields.year.length)
                  secondaryFields.year.val(
                    data.educationalHistory.secondarySchool?.yearOfAttendance ||
                      ""
                  );

                // Tertiary Institutions (0-based indexing)
                if (data.educationalHistory.tertiaryInstitutions?.length) {
                  console.log("\nRestoring Tertiary Institutions:");
                  data.educationalHistory.tertiaryInstitutions.forEach(
                    (inst, index) => {
                      const fields = {
                        name: $(
                          `input[name="tertiaryInstitution_name_${index}"]`
                        ),
                        address: $(
                          `input[name="tertiaryInstitution_address_${index}"]`
                        ),
                        certificate: $(
                          `input[name="tertiaryInstitution_certificate_${index}"]`
                        ),
                        matricNo: $(
                          `input[name="tertiaryInstitution_matricNo_${index}"]`
                        ),
                        year: $(
                          `input[name="tertiaryInstitution_year_${index}"]`
                        ),
                      };

                      console.log(`\nInstitution ${index} fields check:`);
                      Object.entries(fields).forEach(([field, $el]) => {
                        console.log(
                          `- tertiary_${field}_${index}:`,
                          $el.length ? "Exists" : "MISSING"
                        );
                      });

                      if (fields.name.length) fields.name.val(inst.name || "");
                      if (fields.address.length)
                        fields.address.val(inst.address || "");
                      if (fields.certificate.length)
                        fields.certificate.val(inst.certificateObtained || "");
                      if (fields.matricNo.length)
                        fields.matricNo.val(inst.matricNo || "");
                      if (fields.year.length)
                        fields.year.val(inst.yearOfAttendance || "");

                      console.log(`Restored institution ${index}:`, inst.name);
                    }
                  );
                }
                console.groupEnd();
              }
              this.state.pendingChanges = true;
              console.log("Restoration complete");
              console.groupEnd();
            }

            // Save form data to local storage as backup
            saveToLocalStorage() {
              try {
                const collected = this.collectFormData();
                console.log("collected", collected);

                // PROPERLY convert FormData to plain object
                const formDataObj = {};
                if (collected.formData instanceof FormData) {
                  collected.formData.forEach((value, key) => {
                    formDataObj[key] = value;
                  });
                }

                const backupData = {
                  data: {
                    formData: formDataObj, // Use converted object
                    nextOfKin: collected.nextOfKin,
                    healthInfo: collected.healthInfo,
                    business: collected.business,
                    educationalHistory: collected.educationalHistory,
                    employmentHistory: collected.employmentHistory,
                    neighbor: collected.neighbor,
                    family: collected.family,
                  },
                  timestamp: new Date().toISOString(),
                };

                localStorage.setItem(
                  "formData_backup",
                  JSON.stringify(backupData)
                );
                console.log("Saved backup:", backupData); // Debug log
              } catch (error) {
                console.error("Save failed:", error);
              }
            }

            // Collect all form data
            collectFormData = () => {
              // Initialize FormData (this will also capture file uploads)
              const formData = new FormData();

              // List of simple fields by their IDs.
              const fields = [
                "middlename",
                "lastname",
                "nationality",
                "community",
                "religion",
                "gender",
                "stateOfOrigin",
                "DOB",
                "countryOfResidence",
                "lgaOfOrigin",
                "maritalStatus",
                "house_number",
                "street_name",
                "nearest_bus_stop_landmark",
                "city_town",
                "stateOfResidence",
                "lgaOfResidence",
                "id_number",
                "issue_date",
                "expiry_date",
              ];
              fields.forEach((field) => {
                const value = $(`#${field}`).val() || "";
                formData.append(field, value);
              });

              // Build the next-of-kin object.
              const nextOfKin = {
                nok_surname: $("#nok_surname").val().trim(),
                nok_firstname: $("#nok_firstname").val().trim(),
                nok_middlename: $("#nok_middlename").val().trim(),
                nok_relationship: $("#nok_relationship").val().trim(),
                nok_countryOfResidence: $("#nok_countryOfResidence")
                  .val()
                  .trim(),
                nok_stateOfResidence: $("#nok_stateOfResidence").val().trim(),
                nok_lgaOfResidence: $("#nok_lgaOfResidence").val().trim(),
                nok_cityOfResidence: $("#nok_cityOfResidence").val().trim(),
                nok_address: $("#nok_address").val().trim(),
              };

              // Build the health info object.
              const healthInfo = {
                bloodGroup: $("#bloodGroup").val(),
                genotype: $("#genotype").val(),
                disabilityStatus: $("#disabilityStatus").val(),
              };

              // Build the business object.
              const business = {
                biz_name: $("#biz_name").val().trim(),
                biz_type: $("#biz_type").val(),
                registration_number: $("#registration_number").val().trim(),
                biz_address: $("#biz_address").val().trim(),
                // nature_of_business: $("#nature_of_business").val().trim(),
                nature_of_business: $("#nature_of_bussiness").val()
                  ? $("#nature_of_business").val().trim()
                  : "",
                numberOfYears: $("#numberOfYears").val().trim(),
                numberOfEmployees: $("#numberOfEmployees").val().trim(),
                annualRevenue: $("#annualRevenue").val().trim(),
                TIN: $("#TIN").val().trim(),
                biz_phone: $("#biz_phone").val().trim(),
                biz_email: $("#biz_email").val().trim(),
              };

              // Collect neighbors data
              const neighbor = [];
              $(".neighbor-item").each(function (index) {
                const id = $(this).data("id");
                neighbor.push({
                  name: $(this).find(`input[name="neighbor_name_${id}"]`).val(),
                  address: $(this)
                    .find(`input[name="neighbor_address_${id}"]`)
                    .val(),
                  phone: $(this)
                    .find(`input[name="neighbor_phone_${id}"]`)
                    .val(),
                });
              });
              // formData.append("neighbor", JSON.stringify(neighbor));

              // Collect family members data
              const family = [];
              $(".family-item").each(function (index) {
                const id = $(this).data("id");
                family.push({
                  name: $(this).find(`input[name="family_name_${id}"]`).val(),
                  relationship: $(this)
                    .find(`input[name="family_relationship_${id}"]`)
                    .val(),
                  phone: $(this).find(`input[name="family_phone_${id}"]`).val(),
                  address: $(this)
                    .find(`input[name="family_address_${id}"]`)
                    .val(),
                });
              });
              // formData.append("family", JSON.stringify(family));

              // Collect employment history
              const employmentHistory = [];
              $(".employment-item").each(function (index) {
                const id = $(this).data("id");
                employmentHistory.push({
                  companyName: $(this)
                    .find(`input[name="companyName_${id}"]`)
                    .val(),
                  address: $(this)
                    .find(`input[name="employment_address_${id}"]`)
                    .val(),
                  designation: $(this)
                    .find(`input[name="designation_${id}"]`)
                    .val(),
                  startYear: $(this)
                    .find(`input[name="startYear_${id}"]`)
                    .val(),
                  endYear: $(this).find(`input[name="endYear_${id}"]`).val(),
                  isCurrentEmployment: $(this)
                    .find(`input[name="isCurrentEmployment_${id}"]`)
                    .is(":checked"),
                  description: $(this)
                    .find(`textarea[name="employment_description_${id}"]`)
                    .val(),
                });
              });
              // formData.append(
              //   "employmentHistory",
              //   JSON.stringify(employmentHistory)
              // );

              // Collect education data
              const educationalHistory = {
                primarySchool: {
                  name: $('input[name="primarySchool_name"]').val(),
                  address: $('input[name="primarySchool_address"]').val(),
                  yearOfAttendance: $(
                    'input[name="primarySchool_yearOfAttendance"]'
                  ).val(),
                },
                secondarySchool: {
                  name: $('input[name="secondarySchool_name"]').val(),
                  address: $('input[name="secondarySchool_address"]').val(),
                  yearOfAttendance: $(
                    'input[name="secondarySchool_yearOfAttendance"]'
                  ).val(),
                },
                tertiaryInstitutions: [],
              };

              $(".institution-item").each(function (index) {
                const id = $(this).data("id");
                educationalHistory.tertiaryInstitutions.push({
                  name: $(this)
                    .find(`input[name="tertiaryInstitution_name_${id}"]`)
                    .val(),
                  address: $(this)
                    .find(`input[name="tertiaryInstitution_address_${id}"]`)
                    .val(),
                  certificateObtained: $(this)
                    .find(`input[name="tertiaryInstitution_certificate_${id}"]`)
                    .val(),
                  matricNo: $(this)
                    .find(`input[name="tertiaryInstitution_matricNo_${id}"]`)
                    .val(),
                  yearOfAttendance: $(this)
                    .find(`input[name="tertiaryInstitution_year_${id}"]`)
                    .val(),
                });
              });
              // formData.append(
              //   "educationalHistory",
              //   JSON.stringify(educationalHistory)
              // );

              // Return both the FormData (with file uploads) and our JSON–ready objects.
              return {
                formData,
                nextOfKin,
                healthInfo,
                business,
                educationalHistory,
                employmentHistory,
                neighbor,
                family,
              };
            };

            // Enhanced auto-save with retry mechanism
            async performAutoSave(forceImmediate = false) {
              if (!this.state.isOnline && !forceImmediate) {
                this.saveToLocalStorage();
                this.updateStatus("Offline - saved locally", "orange");
                return;
              }

              this.state.lastSaveAttempt = new Date();

              try {
                // Collect all the form data.
                const {
                  formData,
                  nextOfKin,
                  healthInfo,
                  business,
                  educationalHistory,
                  employmentHistory,
                  neighbor,
                  family,
                } = this.collectFormData();

                // Append the JSON–structured data.
                formData.append("nextOfKin", JSON.stringify(nextOfKin));
                formData.append("healthInfo", JSON.stringify(healthInfo));
                formData.append("business", JSON.stringify(business));
                formData.append(
                  "educationalHistory",
                  JSON.stringify(educationalHistory)
                );
                formData.append(
                  "employmentHistory",
                  JSON.stringify(employmentHistory)
                );
                formData.append("neighbor", JSON.stringify(neighbor));
                formData.append("family", JSON.stringify(family));

                // Handle identification – use the alternative input if "others" is selected.
                const selectedValue = $("#identification").val();
                const otherValue = $("#other-identification").val();
                const finalIdentification =
                  selectedValue === "others" ? otherValue : selectedValue;
                formData.append("identification", finalIdentification);

                const canvas = $("#snapshot").get(0);
                const dataURL = canvas.toDataURL("image/jpeg", 0.9);
                const passportPhotoFile = $("#passportPhoto")[0]?.files[0];

                // console.log("photoCaptured:", photoCaptured);
                // console.log("passportPhotoFile:", passportPhotoFile);
                // console.log("dataURL from canvas:", dataURL);

                if (photoCaptured && dataURL) {
                  formData.append(
                    "passportPhoto",
                    dataURLtoFile(dataURL, "captured-passport.jpg")
                  );
                } else if (passportPhotoFile) {
                  formData.append("passportPhoto", passportPhotoFile);
                }

                // Perform the save operation
                const response = await this.saveWithRetry(formData);

                if (response.ok) {
                  this.onSaveSuccess();
                } else {
                  throw new Error(
                    `Server error: ${response.status} ${response.statusText}`
                  );
                }
              } catch (error) {
                this.onSaveError(error);
              }
            }

            // Save with retry mechanism
            async saveWithRetry(formData, retryCount = 0) {
              try {
                // const token =
                //   localStorage.getItem("token") ||
                //   sessionStorage.getItem("authToken");
                // console.log(token);
                if (!token) {
                  throw new Error("Authentication token not found");
                }

                // const user = JSON.parse(
                //   localStorage.getItem("user") ||
                //     sessionStorage.getItem("user") ||
                //     "{}"
                // );
                if (!user.id) {
                  throw new Error("User ID not found");
                }

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout

                const response = await fetch(
                  `${BACKEND_URL}/users/${user.id}`,
                  {
                    method: "PUT",
                    headers: {
                      Authorization: `Bearer ${token}`,
                    },
                    body: formData,
                    signal: controller.signal,
                  }
                );

                clearTimeout(timeoutId);
                return response;
              } catch (error) {
                if (retryCount < this.state.maxRetries) {
                  console.log(
                    `Save attempt ${retryCount + 1} failed, retrying in ${
                      this.state.retryDelay
                    }ms...`
                  );
                  this.updateStatus(
                    `Save failed, retrying... (${retryCount + 1}/${
                      this.state.maxRetries
                    })`,
                    "orange"
                  );

                  await new Promise((resolve) =>
                    setTimeout(resolve, this.state.retryDelay)
                  );
                  return this.saveWithRetry(formData, retryCount + 1);
                }
                throw error;
              }
            }

            // Handle successful save
            onSaveSuccess() {
              console.log("Auto-save successful");
              this.updateStatus("Saved", "green");
              this.state.pendingChanges = false;
              this.state.currentRetryCount = 0;
              this.state.lastKnownGoodState = this.collectFormData();

              // Remove local storage backup after successful save
              localStorage.removeItem("formData_backup");

              // Clear any retry timers
              if (this.state.retryTimer) {
                clearTimeout(this.state.retryTimer);
                this.state.retryTimer = null;
              }
            }

            // Handle save errors
            onSaveError(error) {
              console.error("Auto-save error:", error);

              // Save to local storage as fallback
              this.saveToLocalStorage();

              if (error.name === "AbortError") {
                this.updateStatus("Save timed out - saved locally", "red");
              } else if (!this.state.isOnline) {
                this.updateStatus("Offline - saved locally", "orange");
              } else {
                this.updateStatus("Failed to save - saved locally", "red");
              }

              // Schedule retry if online
              if (
                this.state.isOnline &&
                this.state.currentRetryCount < this.state.maxRetries
              ) {
                this.state.retryTimer = setTimeout(() => {
                  this.performAutoSave();
                }, this.state.retryDelay * (this.state.currentRetryCount + 1));
              }
            }

            // Update status indicator
            updateStatus(message, color) {
              $("#autoSaveStatus").text(message).css("color", color);
            }

            // Convert base64 to blob for efficient transmission
            base64ToBlob(base64String) {
              const parts = base64String.split(",");
              const contentType = parts[0].match(/:(.*?);/)[1];
              const raw = window.atob(parts[1]);
              const rawLength = raw.length;
              const uint8Array = new Uint8Array(rawLength);

              for (let i = 0; i < rawLength; ++i) {
                uint8Array[i] = raw.charCodeAt(i);
              }

              return new Blob([uint8Array], { type: contentType });
            }

            // Debounced auto-save trigger
            triggerAutoSave() {
              this.state.pendingChanges = true;
              clearTimeout(this.state.autoSaveTimer);
              this.updateStatus("Saving...", "blue");

              this.state.autoSaveTimer = setTimeout(() => {
                this.performAutoSave();
              }, 1000); // 1-second debounce
            }

            // Force immediate save (for critical operations)
            async forceSave() {
              clearTimeout(this.state.autoSaveTimer);
              this.updateStatus("Saving...", "blue");
              await this.performAutoSave(true);
            }
          }

          // Initialize the form data manager
          const formManager = new FormDataManager();

          // Camera and photo handling with enhanced error handling
          // let cameraStream = null;
          // let photoCaptured = false;

          // ✅ Enhanced Camera Start
          $("#start-camera").click(async function () {
            try {
              const constraints = {
                video: {
                  width: { ideal: 1280 },
                  height: { ideal: 720 },
                  facingMode: "user",
                },
              };

              cameraStream = await navigator.mediaDevices.getUserMedia(
                constraints
              );
              $("#camera-stream").get(0).srcObject = cameraStream;
              $("#camera-stream").show();
              $("#capture-photo, #close-camera").show();
              $("#start-camera").hide();
              $("#photo-preview").hide();
            } catch (err) {
              console.error("Camera access error:", err);
              let errorMessage = "Unable to access camera: ";

              if (err.name === "NotAllowedError") {
                errorMessage +=
                  "Permission denied. Please allow camera access.";
              } else if (err.name === "NotFoundError") {
                errorMessage += "No camera found on this device.";
              } else {
                errorMessage += err.message;
              }

              Swal.fire({
                title: "Camera Error",
                text: errorMessage,
                icon: "error",
              });
            }
          });

          // ✅ Enhanced Capture Photo with validation
          $("#capture-photo").click(function () {
            try {
              const video = $("#camera-stream").get(0);
              const canvas = $("#snapshot").get(0);
              const context = canvas.getContext("2d");

              if (!video.videoWidth || !video.videoHeight) {
                throw new Error("Video stream not ready");
              }

              canvas.width = video.videoWidth;
              canvas.height = video.videoHeight;
              context.drawImage(video, 0, 0, canvas.width, canvas.height);

              const dataUrl = canvas.toDataURL("image/jpeg", 0.9);

              // Validate the captured image
              if (dataUrl === "data:,") {
                throw new Error("Failed to capture image");
              }

              $("#photo-preview").attr("src", dataUrl).show();
              $("#passportPhotoData").val(dataUrl);

              // Clean up camera stream
              if (cameraStream) {
                cameraStream.getTracks().forEach((track) => track.stop());
                cameraStream = null;
              }

              $("#camera-stream, #capture-photo, #close-camera").hide();
              $("#start-camera").show();
              photoCaptured = true;

              formManager.updateStatus("Photo captured! Saving...", "orange");
              console.log("Calling autoSave() after camera capture...");
              formManager.triggerAutoSave();
            } catch (error) {
              console.error("Photo capture error:", error);
              Swal.fire({
                title: "Capture Error",
                text: "Failed to capture photo: " + error.message,
                icon: "error",
              });
            }
          });

          // ✅ Enhanced Close Camera
          $("#close-camera").click(function () {
            if (cameraStream) {
              cameraStream.getTracks().forEach((track) => track.stop());
              cameraStream = null;
            }
            $("#camera-stream, #capture-photo, #close-camera").hide();
            $("#start-camera").show();
          });

          // ✅ Enhanced Upload Photo from File
          $("#upload-photo-btn").click(function () {
            $("#passportPhoto").click();
          });

          $("#passportPhoto").change(function (e) {
            const file = e.target.files[0];
            if (file) {
              // Validate file type and size
              const validTypes = ["image/jpeg", "image/jpg", "image/png"];
              const maxSize = 5 * 1024 * 1024; // 5MB

              if (!validTypes.includes(file.type)) {
                Swal.fire({
                  title: "Invalid File Type",
                  text: "Please select a JPEG or PNG image.",
                  icon: "error",
                });
                return;
              }

              if (file.size > maxSize) {
                Swal.fire({
                  title: "File Too Large",
                  text: "Please select an image smaller than 5MB.",
                  icon: "error",
                });
                return;
              }

              const reader = new FileReader();
              reader.onload = function (event) {
                $("#photo-preview").attr("src", event.target.result).show();
                $("#passportPhotoData").val(event.target.result);

                // Clean up camera if active
                if (cameraStream) {
                  cameraStream.getTracks().forEach((track) => track.stop());
                  cameraStream = null;
                  $("#camera-stream, #capture-photo, #close-camera").hide();
                  $("#start-camera").show();
                }

                photoCaptured = false;
                formManager.updateStatus("Photo uploaded! Saving...", "orange");
                console.log("Calling autoSave() after photo upload...");
                formManager.triggerAutoSave();
              };

              reader.onerror = function () {
                Swal.fire({
                  title: "File Read Error",
                  text: "Failed to read the selected file.",
                  icon: "error",
                });
              };

              reader.readAsDataURL(file);
            }
          });

          /* ===================================================
           * Enhanced Event Bindings
           * =================================================== */

          const bindEvents = () => {
            // Bind the click events to add new sections
            $("#add-institution").on("click", addInstitution);
            $("#add-neighbor").on("click", addNeighbor);
            $("#add-family").on("click", addFamily);
            $("#add-employment").on("click", addEmployment);

            // Enhanced input change detection
            $(document).on(
              "input change",
              "input, select, textarea",
              function () {
                formManager.triggerAutoSave();
              }
            );

            // Enhanced form submission with validation
            $("#unifiedForm").on("submit", async function (e) {
              e.preventDefault();

              try {
                // Show loading state
                Swal.fire({
                  title: "Submitting...",
                  text: "Please wait while we save your information.",
                  allowOutsideClick: false,
                  didOpen: () => {
                    Swal.showLoading();
                  },
                });

                // Force save before submission
                await formManager.forceSave();

                // Close loading and show success
                Swal.fire({
                  title: "Success!",
                  text: "Your form has been submitted successfully.",
                  icon: "success",
                  confirmButtonText: "OK",
                });
              } catch (error) {
                Swal.fire({
                  title: "Submission Error",
                  text: "Failed to submit form. Your data has been saved locally and will be retried automatically.",
                  icon: "error",
                  confirmButtonText: "OK",
                });
              }
            });
          };

          // Initialize all event bindings
          bindEvents();

          // Add periodic sync for offline changes
          setInterval(() => {
            if (
              formManager.state.isOnline &&
              formManager.state.pendingChanges
            ) {
              const lastAttempt = formManager.state.lastSaveAttempt;
              const now = new Date();

              // If no recent save attempt, try to sync
              if (!lastAttempt || now - lastAttempt > 60000) {
                // 1 minute
                console.log("Periodic sync attempt...");
                formManager.performAutoSave();
              }
            }
          }, 30000); // Check every 30 seconds
        });
      </script>

      <script>
        document.querySelectorAll(".next-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const nextSection = document.getElementById(btn.dataset.next);
            btn.closest(".form-section").style.display = "none";
            nextSection.style.display = "block";
          });
        });

        document.querySelectorAll(".prev-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const prevSection = document.getElementById(btn.dataset.prev);
            btn.closest(".form-section").style.display = "none";
            prevSection.style.display = "block";
          });
        });
      </script>

      <script>
        document.querySelectorAll(".next-btn").forEach((button) => {
          button.addEventListener("click", () => {
            const currentSection = button.closest(".form-section");
            const nextSectionId = button.getAttribute("data-next");
            const nextSection = document.getElementById(nextSectionId);

            // Validate the current form section
            if (validateForm(currentSection)) {
              currentSection.classList.remove("active");
              nextSection.classList.add("active");
            }
          });
        });

        function validateForm(section) {
          let isValid = true;
          section.querySelectorAll("input, select").forEach((field) => {
            const errorMessage = field.nextElementSibling;
            if (field.hasAttribute("required") && !field.value.trim()) {
              field.classList.add("error");
              if (errorMessage) errorMessage.style.display = "block";
              isValid = false;
            } else {
              field.classList.remove("error");
              if (errorMessage) errorMessage.style.display = "none";
            }
          });
          return isValid;
        }
      </script>

      <script>
        function logout() {
          localStorage.removeItem("token");
        }
      </script>
    </div>
    <!--**********************************
            Content body end
        ***********************************-->

    <!--**********************************
            Footer start
        ***********************************-->
    <div class="footer">
      <div class="copyright">
        <p>Copyright ©BDIC Ltd 2025. All rights reserved.</p>
      </div>
    </div>

    <!--**********************************
            Footer end
        ***********************************-->

    <!--**********************************
        Scripts
    ***********************************-->
    <!-- Required vendors -->
    <script src="vendor/sweetalert2/dist/sweetalert2.min.js"></script>
    <script src="js/plugins-init/sweetalert.init.js"></script>
    <script src="vendor/global/global.min.js"></script>
    <script src="vendor/bootstrap-select/dist/js/bootstrap-select.min.js"></script>
    <script src="vendor/chart.js/Chart.bundle.min.js"></script>
    <script src="vendor/bootstrap-datetimepicker/js/moment.js"></script>
    <script src="vendor/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js"></script>

    <script src="js/custom.min.js"></script>
    <script src="js/deznav-init.js"></script>
    <script src="js/demo.js"></script>
    <script type="text/javascript" src="../../../js/index.js"></script>
  </body>
</html>
  function createEmploymentHTML(id, displayNumber) {
            return `
          <div class="employment-item" data-id="${id}">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <label class="form-label">Employment ${displayNumber}</label>
              <button type="button" class="btn btn-outline-danger btn-sm remove-employment" data-id="${id}">
                <i class="bi bi-dash"></i>
              </button>
              
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Company Name</label>
              </div>
                <input type="text" class="form-control" name="companyName_${id}" placeholder="Enter company name">
              </div>
              <div class="col-md-6">
                <label class="form-label">Address</label>
                <input type="text" class="form-control" name="employment_address_${id}" placeholder="Enter company address">
              </div>
              <div class="col-md-6">
                <label class="form-label">Designation</label>
                <input type="text" class="form-control" name="designation_${id}" placeholder="Enter your designation">
              </div>
              <div class="col-md-6">
                <label class="form-label">Start Year</label>
                <input type="date" class="form-control" name="startYear_${id}" placeholder="Enter start year">
              </div>
              <div class="col-md-6">
                <label class="form-label">End Year</label>
                <input type="date" class="form-control" name="endYear_${id}" placeholder="Enter end year">
                <p class="text-muted small mt-1">Leave blank if this is your current employment.</p>
              </div>
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="isCurrentEmployment_${id}" name="isCurrentEmployment_${id}">
                  <label class="form-check-label" for="isCurrentEmployment_${id}">
                    This is my current employment
                  </label>
                </div>
              </div>
            </div>

            <div class="mt-3">
              <label class="form-label">Description of Company</label>
              <textarea class="form-control" name="employment_description_${id}" rows="3" placeholder="Describe the company"></textarea>
            </div>
          </div>
        `;
          }

             function createFamilyHTML(id, displayNumber) {
            return `
          <div class="family-item" data-id="${id}">
         
             <div class="d-flex justify-content-between align-items-center mb-3">
            <label class="form-label">Family Member ${displayNumber}</labe
             <div>
                <span class="badge bg-warning verification-status" id="family-status-${id}">Pending</span>
              <button type="button" class="btn btn-outline-danger btn-sm remove-family-member" data-id="${id}">
                <i class="bi bi-dash"></i>
              </button>
             </div>
            </div>
            <div class="row g-3">
              <div class="col-md-3">
                <input type="text" class="form-control" name="family_name_${id}" placeholder="Full Name">
              </div>
              <div class="col-md-3">
                <input type="text" class="form-control" name="family_relationship_${id}" placeholder="Relationship">
              </div>
              <div class="col-md-3">
                <input type="text" class="form-control" name="family_address_${id}" placeholder="Residential Address">
              </div>
              <div class="col-md-3">

                <input type="tel" class="form-control" name="family_phone_${id}" placeholder="Phone Number">
             
         
              </div>
            </div>
          </div>
        `;
          }

          function createEmploymentHTML(id, displayNumber) {
            return `
          <div class="employment-item" data-id="${id}">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <label class="form-label">Employment ${displayNumber}</label>
              <button type="button" class="btn btn-outline-danger btn-sm remove-employment" data-id="${id}">
                <i class="bi bi-dash"></i>
              </button>
              
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Company Name</label>
              </div>
                <input type="text" class="form-control" name="companyName_${id}" placeholder="Enter company name">
              </div>
              <div class="col-md-6">
                <label class="form-label">Address</label>
                <input type="text" class="form-control" name="employment_address_${id}" placeholder="Enter company address">
              </div>
              <div class="col-md-6">
                <label class="form-label">Designation</label>
                <input type="text" class="form-control" name="designation_${id}" placeholder="Enter your designation">
              </div>
              <div class="col-md-6">
                <label class="form-label">Start Year</label>
                <input type="date" class="form-control" name="startYear_${id}" placeholder="Enter start year">
              </div>
              <div class="col-md-6">
                <label class="form-label">End Year</label>
                <input type="date" class="form-control" name="endYear_${id}" placeholder="Enter end year">
                <p class="text-muted small mt-1">Leave blank if this is your current employment.</p>
              </div>
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="isCurrentEmployment_${id}" name="isCurrentEmployment_${id}">
                  <label class="form-check-label" for="isCurrentEmployment_${id}">
                    This is my current employment
                  </label>
                </div>
              </div>
            </div>

            <div class="mt-3">
              <label class="form-label">Description of Company</label>
              <textarea class="form-control" name="employment_description_${id}" rows="3" placeholder="Describe the company"></textarea>
            </div>
          </div>
        `;
          }
 function initVerificationReview(isInitialLoad = false) {
          // Function to populate verification status in review section
          //   function populateVerificationStatus() {
          //     // Get all neighbors and their status
          //     const neighbors = [];
          //     $(".neighbor-item").each(function (index) {
          //       const id = $(this).data("id");
          //       const name = $(this)
          //         .find(`input[name="neighbor_name_${id}"]`)
          //         .val();
          //       const phone = $(this)
          //         .find(`input[name="neighbor_phone_${id}"]`)
          //         .val();
          //       const statusElement = $(`#neighbor-status-${id}`);
          //       const status = statusElement.length
          //         ? statusElement.text()
          //         : "Pending";

          //       neighbors.push({ id, name, phone, status });
          //     });

          //     // Get all family members and their status
          //     const familyMembers = [];
          //     $(".family-item").each(function (index) {
          //       const id = $(this).data("id");
          //       const name = $(this)
          //         .find(`input[name="family_name_${id}"]`)
          //         .val();
          //       const phone = $(this)
          //         .find(`input[name="family_phone_${id}"]`)
          //         .val();
          //       const statusElement = $(`#family-status-${id}`);
          //       const status = statusElement.length
          //         ? statusElement.text()
          //         : "Pending";

          //       familyMembers.push({ id, name, phone, status });
          //     });

          //     // Populate neighbors status
          //     const neighborContainer = $("#neighbor-verification-status");
          //     neighborContainer.empty();

          //     if (neighbors.length === 0) {
          //       neighborContainer.append(
          //         '<p class="text-muted">No neighbors added</p>'
          //       );
          //     } else {
          //       neighbors.forEach((neighbor) => {
          //         neighborContainer.append(`
          //   <div class="d-flex justify-content-between align-items-center mb-2 border-bottom pb-2">
          //     <div>
          //       <span class="fw-medium">${
          //         neighbor.name || "Unnamed neighbor"
          //       }</span>
          //       <div class="text-muted small">${
          //         neighbor.phone || "No phone provided"
          //       }</div>
          //     </div>
          //     <span class="badge ${getStatusBadgeClass(neighbor.status)}">
          //       ${neighbor.status}
          //     </span>
          //   </div>
          // `);
          //       });
          //     }

          //     // Populate family members status
          //     const familyContainer = $("#family-verification-status");
          //     familyContainer.empty();

          //     if (familyMembers.length === 0) {
          //       familyContainer.append(
          //         '<p class="text-muted">No family members added</p>'
          //       );
          //     } else {
          //       familyMembers.forEach((member) => {
          //         familyContainer.append(`
          //   <div class="d-flex justify-content-between align-items-center mb-2 border-bottom pb-2">
          //     <div>
          //       <span class="fw-medium">${
          //         member.name || "Unnamed family member"
          //       }</span>
          //       <div class="text-muted small">${
          //         member.phone || "No phone provided"
          //       }</div>
          //     </div>
          //     <span class="badge ${getStatusBadgeClass(member.status)}">
          //       ${member.status}
          //     </span>
          //   </div>
          // `);
          //       });
          //     }
          //   }

          // Use sessionStorage to maintain verification state
          const storageKey = `verificationState-${user.id}`;

          function saveVerificationState(data) {
            sessionStorage.setItem(
              storageKey,
              JSON.stringify({
                timestamp: new Date().getTime(),
                data,
              })
            );
          }

          function loadVerificationState() {
            const saved = sessionStorage.getItem(storageKey);
            return saved ? JSON.parse(saved) : null;
          }

          async function populateVerificationStatus(forceRefresh = false) {
            const savedState = loadVerificationState();
            const shouldUseCache =
              savedState &&
              !forceRefresh &&
              new Date().getTime() - savedState.timestamp < 30000; // 30 second cache

            if (shouldUseCache) {
              renderVerificationStatus(savedState.data);
              return;
            }

            try {
              const response = await fetch(`${BACKEND_URL}/users/${user.id}`, {
                headers: { Authorization: `Bearer ${token}` },
              });

              if (!response.ok)
                throw new Error("Failed to fetch verification status");

              const userData = await response.json();

              saveVerificationState(userData);
              renderVerificationStatus(userData);
            } catch (error) {
              console.error("Error loading verification status:", error);
              if (savedState) renderVerificationStatus(savedState.data);
            }
          }

          function renderVerificationStatus(userData) {
            // Render neighbors status
            const neighborContainer = $(
              "#neighbor-verification-status"
            ).empty();
            userData.neighbor?.forEach((neighbor, index) => {
              neighborContainer.append(`
        <div class="d-flex justify-content-between align-items-center mb-2 border-bottom pb-2">
          <div>
            <span class="fw-medium">${
              neighbor.fullName || "Neighbor " + (index + 1)
            }</span>
            <div class="text-muted small">${neighbor.phone || "No phone"}</div>
          </div>
          <span class="badge ${getStatusBadgeClass(neighbor.status)}">
            ${neighbor.status || "Pending"}
          </span>
        </div>
      `);
            });

            // Render family members status
            const familyContainer = $("#family-verification-status").empty();
            userData.family?.forEach((member, index) => {
              familyContainer.append(`
        <div class="d-flex justify-content-between align-items-center mb-2 border-bottom pb-2">
          <div>
            <span class="fw-medium">${
              member.fullName || "Family " + (index + 1)
            }</span>
            <div class="text-muted small">${member.phone || "No phone"}</div>
          </div>
          <span class="badge ${getStatusBadgeClass(member.status)}">
            ${member.status || "Pending"}
          </span>
        </div>
      `);
            });
          }

          // Helper function to get appropriate badge class based on status
          function getStatusBadgeClass(status) {
            status = status.toLowerCase();
            if (status === "verified") return "bg-success";
            if (status === "denied") return "bg-danger";
            return "bg-warning";
          }

          // Function to initiate verification
          async function initiateVerification() {
            try {
              // Show loading state
              $("#initiate-verification").prop("disabled", true).html(`
        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        Initiating...
      `);

              $("#verification-status").html(`
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          Initiating verification process...
        </div>
      `);

              const response = await fetch(
                `${BACKEND_URL}/users/${user.id}/initiate-verification`,
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                  },
                }
              );

              if (!response.ok) {
                throw new Error(
                  (await response.text()) || "Failed to initiate verification"
                );
              }

              const result = await response.json();

              // Show success message
              $("#verification-status").html(`
        <div class="alert alert-success">
          <i class="bi bi-check-circle me-2"></i>
          Verification initiated successfully! Reference contacts will receive verification messages.
        </div>
      `);

              // Update verification status badges
              updateVerificationStatuses();

              // Refresh the review section
              populateVerificationStatus();
            } catch (error) {
              console.error("Verification error:", error);
              $("#verification-status").html(`
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Error initiating verification: ${error.message}
        </div>
      `);
            } finally {
              // Reset button state
              $("#initiate-verification").prop("disabled", false).html(`
        <i class="bi bi-send-check me-2"></i>Initiate Verification
      `);
            }
          }

          // Function to update verification status badges
          async function updateVerificationStatuses() {
            try {
              const response = await fetch(`${BACKEND_URL}/users/${user.id}`, {
                headers: {
                  Authorization: `Bearer ${token}`,
                },
              });

              if (!response.ok) {
                throw new Error("Failed to fetch user data");
              }

              const userData = await response.json();

              // Update neighbor verification statuses
              if (userData.neighbor && userData.neighbor.length) {
                userData.neighbor.forEach((neighbor, index) => {
                  const statusBadge = $(`#neighbor-status-${index}`);
                  if (statusBadge.length) {
                    statusBadge.removeClass("bg-warning bg-success bg-danger");
                    if (neighbor.status === "VERIFIED") {
                      statusBadge.addClass("bg-success").text("Verified");
                    } else if (neighbor.status === "DENIED") {
                      statusBadge.addClass("bg-danger").text("Denied");
                    } else {
                      statusBadge.addClass("bg-warning").text("Pending");
                    }
                  }
                });
              }

              // Update family verification statuses
              if (userData.family && userData.family.length) {
                userData.family.forEach((family, index) => {
                  const statusBadge = $(`#family-status-${index}`);
                  if (statusBadge.length) {
                    statusBadge.removeClass("bg-warning bg-success bg-danger");
                    if (family.status === "VERIFIED") {
                      statusBadge.addClass("bg-success").text("Verified");
                    } else if (family.status === "DENIED") {
                      statusBadge.addClass("bg-danger").text("Denied");
                    } else {
                      statusBadge.addClass("bg-warning").text("Pending");
                    }
                  }
                });
              }
            } catch (error) {
              console.error("Error updating verification statuses:", error);
            }
          }

          // Bind the initiate verification button
          $("#initiate-verification").click(initiateVerification);

          // Update verification status when review section is shown
          $("#review-section").on("show", function () {
            populateVerificationStatus();
            updateVerificationStatuses();
          });

          // Initial population if review section is active on load
          if ($("#review-section").hasClass("active")) {
            populateVerificationStatus();
            updateVerificationStatuses();
          }
          // Initialize on page load
          if (isInitialLoad) {
            populateVerificationStatus();
            $("#review-section").on("show", () =>
              populateVerificationStatus(true)
            ); // Force refresh when section shown
          }
        }