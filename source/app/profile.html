<!DOCTYPE html>
<html lang="en">
  <meta http-equiv="content-type" content="text/html;charset=UTF-8" />
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="keywords" content="dashboard" />
    <meta name="robots" content="index, follow" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta property="og:image" content="social-image.html" />
    <meta name="format-detection" content="telephone=no" />
    <title>
      Benue State Integrated Citizenship and Resident Identity Registration
      Management System
    </title>
    <!-- Favicon icon -->
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/assets/images/benue-state-logo.png"
    />
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <link
      rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link
      href="vendor/bootstrap-select/dist/css/bootstrap-select.min.css"
      rel="stylesheet"
    />
    <link href="css/style.css" rel="stylesheet" />
    <link rel="stylesheet" href="app.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <script src="../../unpkg.com/sweetalert%402.1.2/dist/sweetalert.min.js"></script>
    <link href="vendor/sweetalert2/dist/sweetalert2.min.css" rel="stylesheet" />
    <script src="../../ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

    <style>
      body {
        font-size: 16px !important;
      }
      .error-message {
        color: red;
        font-size: 0.875rem;
        display: none;
      }
      .form-control.error {
        border-color: red;
      }
      /* .form-section {
        display: none;
      } */
      .form-section.active {
        display: block;
      }
      .camera-upload-box video,
      .camera-upload-box canvas,
      .camera-upload-box img {
        border-radius: 8px;
        margin-bottom: 10px;
      }

      .card-header-gradient {
        background: linear-gradient(to right, #16a34a, #15803d);
        color: white;
      }
      .progress {
        height: 8px;
        background-color: #166534;
      }
      .progress-bar {
        background-color: white;
      }
      .form-section {
        display: none;
      }
      .form-section.active {
        display: block;
      }
      .step-icon {
        padding: 8px;
        background-color: rgba(255, 255, 255, 0.2);
        border-radius: 8px;
      }
      .neighbor-item,
      .family-item,
      .employment-item,
      .institution-item {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
      }
      .btn-green {
        background-color: #16a34a;
        color: white;
      }
      .btn-green:hover {
        background-color: #15803d;
        color: white;
      }
      .btn-outline-green {
        border-color: #16a34a;
        color: #16a34a;
      }
      .btn-outline-green:hover {
        background-color: #16a34a;
        color: white;
      }

      /* //////////////////////////////////////////////// */
      .status-indicator {
        position: fixed;
        top: 10px;
        right: 10px;
        padding: 8px 12px;
        border-radius: 4px;
        font-weight: bold;
        z-index: 1000;
      }
      .status-saving {
        background: #ffc107;
        color: #000;
      }
      .status-saved {
        background: #28a745;
        color: #fff;
      }
      .status-error {
        background: #dc3545;
        color: #fff;
      }
    </style>
  </head>
  <body>
    <!--*******************
        Preloader start
    ********************-->
    <div id="preloader">
      <div class="sk-three-bounce">
        <div class="sk-child sk-bounce1"></div>
        <div class="sk-child sk-bounce2"></div>
        <div class="sk-child sk-bounce3"></div>
      </div>
    </div>
    <!--*******************
        Preloader end
    ********************-->

    <!-- Sidebar -->
    <div class="sidebar">
      <div class="d-flex flex-column h-100">
        <!-- Sidebar Header -->
        <div class="p-4 border-bottom">
          <div class="d-flex align-items-center">
            <img
              src="/assets/images/benue-state-logo.png"
              alt="Benue State Logo"
              class="me-3"
              width="40"
            />
            <div>
              <h5 class="mb-0 fw-bold">BICRIRMS</h5>
              <small class="text-muted" style="font-size: 0.8rem"
                >Identity Management</small
              >
            </div>
          </div>
        </div>

        <!-- Sidebar Content -->
        <div class="flex-grow-1 py-3 px-4 overflow-auto" id="sidebar-links">
          <div class="mb-5 p-2 text-muted">
            <h6
              id="sidebar-user-label"
              class="text-uppercase text-muted small mb-3 mt-3"
            >
              User
            </h6>

            <ul class="nav flex-column">
              <li class="nav-item user-menu">
                <a
                  href="user-dasboard.html"
                  class="nav-link d-flex align-items-center"
                >
                  <i
                    class="bi bi-speedometer2 me-2 me-3 fs-5 text-secondary"
                  ></i>
                  <span> Dashboard</span>
                </a>
              </li>
              <li class="nav-item super-admin-menu">
                <a href="index.html" class="nav-link d-flex align-items-center">
                  <i
                    class="bi bi-speedometer2 me-2 me-3 fs-5 text-secondary"
                  ></i>
                  <span> Dashboard</span>
                </a>
              </li>
              <li class="nav-item kindred_head">
                <a
                  href="kindred-dasboard.html"
                  class="nav-link d-flex align-items-center"
                >
                  <i
                    class="bi bi-speedometer2 me-2 me-3 fs-5 text-secondary"
                  ></i>
                  <span> Dashboard</span>
                </a>
              </li>
              <li class="nav-item super-admin-menu">
                <a
                  href="approvals.html"
                  class="nav-link d-flex align-items-center"
                >
                  <i class="bi-check-circle fs-5 me-3 text-secodary"></i>
                  <span>Approvals</span>
                </a>
              </li>
              <li class="nav-item super-admin-menu">
                <a
                  href="all-request.html"
                  class="nav-link d-flex align-items-center"
                >
                  <i class="bi bi-file-text text-secondary me-3 fs-5"></i>
                  <span>Certificate Requests</span>
                </a>
              </li>
              <li class="nav-item super-admin-menu">
                <a
                  href="all-card.html"
                  class="nav-link d-flex align-items-center"
                >
                  <i class="bi bi-credit-card text-secondary me-3 fs-5"></i>
                  <span>Card Requests</span>
                </a>
              </li>
              <li class="nav-item super-admin-menu">
                <a href="lgas.html" class="nav-link d-flex align-items-center">
                  <i class="bi bi-file-text text-secondary me-3 fs-5"></i>
                  <span>LGAs</span>
                </a>
              </li>
              <li class="nav-item super-admin-menu">
                <a
                  href="citizens.html"
                  class="nav-link d-flex align-items-center"
                >
                  <i class="bi-people fs-5 text-secondary me-3"></i>
                  <span>Users</span>
                </a>
              </li>
              <li class="nav-item super-admin-menu">
                <a
                  href="kindred.html"
                  class="nav-link d-flex align-items-center"
                >
                  <i class="bi-diagram-3 me-3"></i>
                  <span>Kindreds</span>
                </a>
              </li>
              <li class="nav-item user-menu">
                <a href="card.html" class="nav-link d-flex align-items-center">
                  <i class="bi bi-credit-card text-secondary me-3 fs-5"></i>
                  <span>Request Resident Identity Card</span>
                </a>
              </li>
              <li class="nav-item user-menu">
                <a href="certificate.html" class="nav-link d-flex align-items-center">
                  <i class="bi bi-file-text text-primary me-3 fs-5"></i>
                  <span>Request state of origin certificate</span>
                </a>
              </li>
              <li class="nav-item user-menu">
                <a
                  href="request.html"
                  class="nav-link d-flex align-items-center"
                >
                  <i class="bi bi-file-text text-secodary me-3 fs-5"></i>
                  <span>View Certificate Status</span>
                </a>
              </li>
              <li class="nav-item user-menu">
                <a
                  href="idcard.html"
                  class="nav-link d-flex align-items-center"
                >
                  <i class="bi bi-credit-card fs-5 text-secodary me-3"></i>
                  <span>View Card Status</span>
                </a>
              </li>
              <li class="nav-item kindred_head">
                <a
                  href="kindred-head.html"
                  class="nav-link d-flex align-items-center"
                >
                  <i class="bi-check-circle fs-5 me-3 text-secodary"></i>
                  <span>View Certificate Request</span>
                </a>
              </li>
              <li class="nav-item support-admin-menu">
                <a
                  href="user-kindred.html"
                  class="nav-link d-flex align-items-center"
                >
                  <i class="bi bi-file-text text-secondary me-3 fs-5"></i>
                  <span>Kindreds</span>
                </a>
              </li>
              <li class="nav-item support-admin-menu">
                <a
                  href="support-admin-lga.html"
                  class="nav-link d-flex align-items-center"
                >
                  <i class="bi bi-file-text text-secondary me-3 fs-5"></i>
                  <span>Support Admin LGA</span>
                </a>
              </li>
              <li class="nav-item">
                <a
                  href="profile.html"
                  class="nav-link d-flex align-items-center"
                >
                  <i class="bi bi-person text-secodary fs-5 me-3"></i>
                  <span>User Account</span>
                </a>
              </li>
            </ul>
          </div>

          <div>
            <h6 class="text-uppercase text-muted small mb-3">Account</h6>
            <ul class="nav flex-column">
              <li class="nav-item mb-1">
                <a href="#" class="nav-link d-flex align-items-center">
                  <i class="fas fa-cog me-3"></i>
                  <span>Settings</span>
                </a>
              </li>
              <li class="nav-item">
                <a
                  href="./auth/login.html"
                  class="nav-link d-flex align-items-center"
                >
                  <i class="fas fa-sign-out-alt me-3"></i>
                  <span onclick="logout(this)">Logout</span>
                </a>
              </li>
            </ul>
          </div>
        </div>
        <div class="overlay" id="sidebar-overlay"></div>

        <!-- Sidebar Footer -->
        <div class="p-3 border-top text-center">
          <small class="text-muted">Powered by BDIC</small>
          <p class="small text-muted mb-0">© 2025 All Rights Reserved</p>
        </div>
      </div>
    </div>

    <!--**********************************
            Sidebar end
        ***********************************-->

    <!--**********************************
            Content body start
        ***********************************-->
    <div class="main-content">
      <!-- Header -->
      <header class="navbar navbar-expand-lg bg-white shadow-sm px-4 py-3">
        <div class="container-fluid">
          <button class="btn d-lg-none" id="sidebarToggle">
            <i class="fas fa-bars"></i>
          </button>

          <div class="d-none d-md-block align-items-center">
            <h5 class="mb-0 me-2 dashboard_bar">Profile</h5>
            <small class="text-muted"
              >Welcome back, <span id="header-user-label"> User </span>
            </small>
          </div>
          <div class="ms-auto d-flex d-none d-md-block align-items-center">
            <div class="text-end" id="lga-info">
              <h5 class="mb-1 fw-bold text-primary d-flex align-items-center ">
                <i class="fas fa-landmark me-2 text-secondary"></i>
                <span id="lga-name">Dashboard</span>
              </h5>
              <small class="text-muted">
                Headquater<span id="lga-headquaters" class="fw-semibold text-dark"></span>
              </small>
            </div>
          </div>

          <div class="ms-auto d-flex align-items-center">
            <div class="d-none d-md-flex position-relative me-3">
              <i
                class="fas fa-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"
              ></i>
              <input
                type="search"
                class="form-control ps-5"
                id="searchInput"
                placeholder="Search here..."
                onkeyup="searchTable()"
                style="width: 250px"
              />
            </div>

            <div class="dropdown me-3">
              <button class="btn position-relative" data-bs-toggle="dropdown">
                <i class="fas fa-bell"></i>
                <span
                  class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger notification-badge"
                  >3</span
                >
              </button>
              <div
                class="dropdown-menu dropdown-menu-end p-0"
                style="width: 300px"
              >
                <div class="p-3 border-bottom">
                  <h6 class="mb-0">Notifications</h6>
                </div>
                <div class="overflow-auto" style="max-height: 300px">
                  <a href="#" class="dropdown-item p-3 border-bottom">
                    <div class="d-flex justify-content-between">
                      <span class="fw-medium">New Certificate Request</span>
                      <small class="text-muted">5 min ago</small>
                    </div>
                    <small class="text-muted d-block mt-1"
                      >John Doe submitted a new certificate application</small
                    >
                  </a>
                  <a href="#" class="dropdown-item p-3 border-bottom">
                    <div class="d-flex justify-content-between">
                      <span class="fw-medium">Card Ready for Pickup</span>
                      <small class="text-muted">1 hour ago</small>
                    </div>
                    <small class="text-muted d-block mt-1"
                      >ID Card for Jane Smith is ready for collection</small
                    >
                  </a>
                  <a href="#" class="dropdown-item p-3">
                    <div class="d-flex justify-content-between">
                      <span class="fw-medium">System Update</span>
                      <small class="text-muted">2 hours ago</small>
                    </div>
                    <small class="text-muted d-block mt-1"
                      >Database backup completed successfully</small
                    >
                  </a>
                </div>
              </div>
            </div>

            <div class="dropdown">
              <button class="btn p-0" data-bs-toggle="dropdown">
                <div class="avatar">AD</div>
              </button>
              <div class="dropdown-menu dropdown-menu-end">
                <div class="px-4 py-3">
                  <h6 class="mb-0">Administrator</h6>
                  <small class="text-muted">admin@benue.gov.ng</small>
                </div>
                <div class="dropdown-divider"></div>
                <a href="profile.html" class="dropdown-item"
                  ><i class="fas fa-user me-2"></i> Profile</a
                >
                <a href="#" class="dropdown-item"
                  ><i class="fas fa-cog me-2"></i> Settings</a
                >
                <div class="dropdown-divider"></div>
                <a
                  href="../../../auth/login.html"
                  class="dropdown-item text-danger"
                  ><i class="fas fa-sign-out-alt me-2"></i>
                  <span onclick="logout(this)"> Logout </span>
                </a>
              </div>
            </div>
          </div>
        </div>
      </header>
      <div class="container-fluid max-w-6xl mx-auto p-6 py-4">
        <div class="card shadow-lg border-0 bg-white">
          <div class="card-header card-header-gradient rounded-top">
            <div class="d-flex align-items-center">
              <div class="step-icon me-3">
                <i class="bi bi-person" id="current-step-icon"></i>
              </div>
              <div>
                <h2 class="card-title mb-0 text-white" id="current-step-title">
                  Profile Details
                </h2>
                <p
                  class="card-text text-white mb-0"
                  id="current-step-description"
                >
                  Step 1 of 10
                </p>
              </div>
            </div>

            <!-- Progress indicator -->
            <div class="mt-4">
              <div class="progress">
                <div
                  class="progress-bar"
                  id="progress-bar"
                  style="width: 10%; color: #dee2e6"
                ></div>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Profile Completion</label>
              <div class="progress" style="height: 25px">
                <div
                  id="profileProgressBar"
                  class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                  role="progressbar"
                  style="width: 0%"
                >
                  0%
                </div>
              </div>
            </div>
          </div>

          <form
            class="profile-form"
            id="unifiedForm"
            enctype="multipart/form-data"
          >
            <div class="card-body p-8">
              <!-- Profile Details Section -->
              <div class="form-section active" id="profile-section">
                <div class="row g-4">
                  <div class="col-md-6">
                    <label for="first_name" class="form-label"
                      >First Name</label
                    >
                    <input
                      type="text"
                      class="form-control bg-light"
                      id="first_name"
                      name="firstname"
                      readonly
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="lastname" class="form-label">Last Name</label>
                    <input
                      type="text"
                      class="form-control bg-light"
                      id="lastname"
                      name="lastname"
                      readonly
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="middlename" class="form-label"
                      >Middle Name</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="middlename"
                      name="middlename"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="gender" class="form-label">Gender</label>
                    <select class="form-select" name="gender" id="gender">
                      <option selected disabled>Select gender</option>
                      <option value="male">Male</option>
                      <option value="female">Female</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label for="maritalStatus" class="form-label"
                      >Marital Status</label
                    >
                    <select
                      class="form-select"
                      name="maritalStatus"
                      id="maritalStatus"
                    >
                      <option selected disabled>Select marital status</option>
                      <option value="single">Single</option>
                      <option value="married">Married</option>
                      <option value="divorced">Divorced</option>
                      <option value="widowed">Widowed</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label for="DOB" class="form-label">Date of Birth</label>
                    <input
                      type="date"
                      class="form-control"
                      id="DOB"
                      name="DOB"
                      min="1900-01-01"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="stateOfOrigin" class="form-label"
                      >State of Origin</label
                    >
                    <input
                      type="text"
                      class="form-control bg-light"
                      id="stateOfOrigin"
                      name="stateOfOrigin"
                      readonly
                    />
                    <!-- onchange="updateLocalGovernmentsOfOrigin()" -->
                  </div>
                  <div class="col-md-6">
                    <label for="lgaOfOrigin" class="form-label"
                      >Local Government of Origin</label
                    >
                    <input
                      class="form-control bg-light"
                      name="lgaOfOrigin"
                      id="lgaOfOrigin"
                      readonly
                    />
                    <!-- class="form-select" -->
                    <!-- <option value="">Select Local Government</option> -->
                    <!-- </input> -->
                  </div>
                  <div class="col-md-6">
                    <label for="nationality" class="form-label"
                      >Nationality</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="nationality"
                      name="nationality"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="community" class="form-label">Community</label>
                    <input
                      type="text"
                      class="form-control"
                      id="community"
                      name="community"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="religion" class="form-label"
                      >Religion (Optional)</label
                    >
                    <select class="form-select" name="religion" id="religion">
                      <option selected disabled>Select religion</option>
                      <option value="christian">Christian</option>
                      <option value="muslim">Muslim</option>
                      <option value="others">Others</option>
                    </select>
                  </div>
                </div>

                <div class="mt-4">
                  <label class="form-label d-flex align-items-center">
                    <i class="bi bi-camera me-2"></i>
                    Recent Passport Photograph
                    <span class="text-danger ms-1">*</span>
                  </label>
                  <div
                    class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center bg-gray-100"
                  >
                    <i class="bi bi-camera text-gray-500 fs-1 mb-3"></i>
                    <div class="d-flex flex-column align-items-center">
                      <video
                        id="camera-stream"
                        width="100%"
                        height="200"
                        autoplay
                        playsinline
                        style="display: none; border-radius: 8px"
                      ></video>
                      <canvas
                        id="snapshot"
                        width="300"
                        height="200"
                        style="display: none"
                      ></canvas>
                      <img
                        id="photo-preview"
                        src=""
                        alt="Passport Preview"
                        class="img-thumbnail mb-2"
                        style="display: none; max-width: 100%; height: auto"
                      />
                      <div class="btn-group mb-2">
                        <button
                          type="button"
                          class="btn btn-outline-primary"
                          id="start-camera"
                        >
                          Open Camera
                        </button>
                        <button
                          type="button"
                          class="btn btn-outline-success"
                          id="capture-photo"
                          style="display: none"
                        >
                          Capture
                        </button>
                        <button
                          type="button"
                          class="btn btn-outline-danger"
                          id="close-camera"
                          style="display: none"
                        >
                          Close Camera
                        </button>
                      </div>
                      <input
                        type="file"
                        id="passportPhoto"
                        name="passportPhoto"
                        accept="image/*"
                        class="d-none"
                      />
                      <small class="text-muted d-block"
                        >Or
                        <button
                          type="button"
                          class="btn btn-link p-0"
                          id="upload-photo-btn"
                        >
                          Upload Photo
                        </button>
                        instead.</small
                      >
                      <input
                        type="hidden"
                        name="passportPhotoData"
                        id="passportPhotoData"
                      />
                    </div>
                  </div>
                </div>
              </div>

              <!-- Residential Address Section -->
              <div class="form-section" id="address-section">
                <div class="row g-4">
                  <div class="col-md-6">
                    <label for="house_number" class="form-label"
                      >House Number</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="house_number"
                      name="house_number"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="street_name" class="form-label"
                      >Street Name</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="street_name"
                      name="street_name"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="nearest_bus_stop_landmark" class="form-label"
                      >Nearest Bus-Stop/Landmark</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="nearest_bus_stop_landmark"
                      name="nearest_bus_stop_landmark"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="stateOfResidence" class="form-label"
                      >State of Residence</label
                    >
                    <select
                      class="form-select"
                      name="stateOfResidence"
                      id="stateOfResidence"
                      onchange="updateLocalGovernmentsOfResidence()"
                    >
                      <option selected disabled>Select State</option>
                      <option value="adamawa">Adamawa</option>
                      <option value="akwa-ibom">Akwa Ibom</option>
                      <option value="anambra">Anambra</option>
                      <option value="abia">Abia</option>
                      <option value="bauchi">Bauchi</option>
                      <option value="benue">Benue</option>
                      <option value="borno">Borno</option>
                      <option value="bayelsa">Bayelsa</option>
                      <option value="delta">Delta</option>
                      <option value="ebonyi">Ebonyi</option>
                      <option value="edo">Edo</option>
                      <option value="enugu">Enugu</option>
                      <option value="abuja">Abuja</option>
                      <option value="gombe">Gombe</option>
                      <option value="jigawa">Jigawa</option>
                      <option value="ekiti">Ekiti</option>
                      <option value="lagos">Lagos</option>
                      <option value="oyo">Oyo</option>
                      <option value="imo">Imo</option>
                      <option value="kaduna">Kaduna</option>
                      <option value="kebbi">Kebbi</option>
                      <option value="kano">Kano</option>
                      <option value="kogi">Kogi</option>
                      <option value="osun">Osun</option>
                      <option value="sokoto">Sokoto</option>
                      <option value="plateau">Plateau</option>
                      <option value="taraba">Taraba</option>
                      <option value="yobe">Yobe</option>
                      <option value="zamfara">Zamfara</option>
                      <option value="katsina">Katsina</option>
                      <option value="kwara">Kwara</option>
                      <option value="nasarawa">Nasarawa</option>
                      <option value="niger">Niger</option>
                      <option value="rivers">Rivers</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label for="lgaOfResidence" class="form-label"
                      >Local Government of Residence</label
                    >
                    <select
                      class="form-select"
                      name="lgaOfResidence"
                      id="lgaOfResidence"
                    >
                      <option selected disabled>Select Local Government</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label for="countryOfResidence" class="form-label"
                      >Country of Residence</label
                    >
                    <select
                      class="form-select"
                      name="countryOfResidence"
                      id="countryOfResidence"
                    >
                      <option selected disabled>Select Country</option>
                      <option value="nigeria">Nigeria</option>
                      <option value="ghana">Ghana</option>
                      <option value="other">Other</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="form-section" id="identity-section">
                <div class="row g-4">
                  <div class="col-md-6">
                    <label for="identification" class="form-label"
                      >Identification Type</label
                    >
                    <select
                      class="form-select"
                      name="identification"
                      id="identification"
                      required
                    >
                      <option value="" selected disabled>
                        Select identification type
                      </option>
                      <option value="national_id">National ID</option>
                      <option value="driver_licence">Driver Licence</option>
                      <option value="international_passport">
                        INT'L Passport
                      </option>
                      <option value="voters_card">Voter's Card</option>
                      <option value="others">Others</option>
                    </select>

                    <div
                      class="mt-3"
                      id="other-identification-container"
                      style="display: none"
                    >
                      <label for="other_identification" class="form-label"
                        >Specify Other Identification</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="other_identification"
                        name="other_identification"
                        placeholder="Please specify"
                        required
                      />
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label for="id_number" class="form-label">ID Number</label>
                    <input
                      type="text"
                      class="form-control"
                      id="id_number"
                      name="id_number"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="issue_date" class="form-label"
                      >Issue Date</label
                    >
                    <input
                      type="date"
                      class="form-control"
                      id="issue_date"
                      name="issue_date"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="expiry_date" class="form-label"
                      >Expiry Date</label
                    >
                    <input
                      type="date"
                      class="form-control"
                      id="expiry_date"
                      name="expiry_date"
                    />
                  </div>
                </div>
              </div>
              <!-- Next of Kin Section -->
              <div class="form-section" id="nok-section">
                <div class="row g-4">
                  <div class="col-md-6">
                    <label for="nok_surname" class="form-label">Surname</label>
                    <input
                      type="text"
                      class="form-control"
                      id="nok_surname"
                      name="nok_surname"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="nok_firstname" class="form-label"
                      >First Name</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="nok_firstname"
                      name="nok_firstname"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="nok_middlename" class="form-label"
                      >Middle Name</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="nok_middlename"
                      name="nok_middlename"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="nok_relationship" class="form-label"
                      >Relationship</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="nok_relationship"
                      name="nok_relationship"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="nok_countryOfResidence" class="form-label"
                      >Country of Residence</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="nok_countryOfResidence"
                      name="nok_countryOfResidence"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="nok_stateOfResidence" class="form-label"
                      >State of Residence</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="nok_stateOfResidence"
                      name="nok_stateOfResidence"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="nok_lgaOfResidence" class="form-label"
                      >LGA of Residence</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="nok_lgaOfResidence"
                      name="nok_lgaOfResidence"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="nok_cityOfResidence" class="form-label"
                      >City/Town of Residence</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="nok_cityOfResidence"
                      name="nok_cityOfResidence"
                    />
                  </div>
                  <div class="col-md-12">
                    <label for="nok_address" class="form-label">Address</label>
                    <input
                      type="text"
                      class="form-control"
                      id="nok_address"
                      name="nok_address"
                    />
                  </div>
                </div>
              </div>

              <!-- Contact Details (Neighbors) Section -->
              <div class="form-section" id="contacts-section">
                <h5 class="text-lg font-semibold mb-4">
                  Neighbors' Contact Details
                </h5>

                <div id="neighbors-container">
                  <div class="neighbor-item" data-id="0">
                    <div
                      class="d-flex justify-content-between align-items-center mb-3"
                    >
                      <label class="form-label">Neighbor 1</label>
                      <button
                        type="button"
                        class="btn btn-outline-danger btn-sm remove-neighbor"
                        style="display: none"
                      >
                        <i class="bi bi-dash"></i>
                      </button>
                    </div>
                    <div class="row g-3">
                      <div class="col-md-4">
                        <input
                          type="text"
                          class="form-control"
                          name="neighbor_name_0"
                          placeholder="Full Name"
                        />
                      </div>
                      <div class="col-md-4">
                        <input
                          type="text"
                          class="form-control"
                          name="neighbor_address_0"
                          placeholder="Residential Address"
                        />
                      </div>
                      <div class="col-md-4">
                        <input
                          type="tel"
                          class="form-control"
                          name="neighbor_phone_0"
                          placeholder="Phone Number"
                        />
                      </div>
                    </div>
                  </div>
                </div>

                <button
                  type="button"
                  class="btn btn-outline-green mt-3"
                  id="add-neighbor"
                >
                  <i class="bi bi-plus"></i>
                  <span>Add Another Neighbor</span>
                </button>

                <p
                  class="text-danger small mt-2"
                  id="neighbor-max-message"
                  style="display: none"
                >
                  Maximum of 5 neighbors reached.
                </p>
              </div>

              <!-- Family Contact Details Section -->
              <div class="form-section" id="family-section">
                <h5 class="text-lg font-semibold mb-4">
                  Family Contact Details
                </h5>

                <div id="family-members-container">
                  <div class="family-item" data-id="0">
                    <div
                      class="d-flex justify-content-between align-items-center mb-3"
                    >
                      <label class="form-label">Family Member 1</label>
                      <!-- class="btn btn-outline-danger btn-sm remove-family-member" -->
                      <button
                        type="button"
                        style="display: none"
                        class="btn btn-outline-danger btn-sm remove-family"
                      >
                        <i class="bi bi-dash"></i>
                      </button>
                    </div>
                    <div class="row g-3">
                      <div class="col-md-3">
                        <input
                          type="text"
                          class="form-control"
                          name="family_name_0"
                          placeholder="Full Name"
                        />
                      </div>
                      <div class="col-md-3">
                        <input
                          type="text"
                          class="form-control"
                          name="family_relationship_0"
                          placeholder="Relationship"
                        />
                      </div>
                      <div class="col-md-3">
                        <input
                          type="text"
                          class="form-control"
                          name="family_address_0"
                          placeholder="Residential Address"
                        />
                      </div>
                      <div class="col-md-3">
                        <input
                          type="tel"
                          class="form-control"
                          name="family_phone_0"
                          placeholder="Phone Number"
                        />
                      </div>
                    </div>
                  </div>
                </div>

                <button
                  type="button"
                  class="btn btn-outline-green mt-3"
                  id="add-family-member"
                >
                  <i class="bi bi-plus"></i>
                  <span>Add Another Family Member</span>
                </button>

                <p
                  class="text-danger small mt-2"
                  id="family-max-message"
                  style="display: none"
                >
                  Maximum of 5 family members reached.
                </p>
              </div>

              <!-- Business Details Section -->
              <div class="form-section" id="business-section">
                <div class="row g-4">
                  <div class="col-md-6">
                    <label for="biz_name" class="form-label"
                      >Business Name</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="biz_name"
                      name="biz_name"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="biz_type" class="form-label"
                      >Business Type</label
                    >
                    <select class="form-select" name="biz_type" id="biz_type">
                      <option selected disabled>Select business type</option>
                      <option value="sole_proprietorship">
                        Sole Proprietorship
                      </option>
                      <option value="partnership">Partnership</option>
                      <option value="limited_liability_company">
                        Limited Liability Company
                      </option>
                      <option value="corporation">Corporation</option>
                      <option value="cooperative">Cooperative</option>
                      <option value="others">Others</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label for="registration_number" class="form-label"
                      >Business Registration Number (if applicable)</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="registration_number"
                      name="registration_number"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="biz_address" class="form-label"
                      >Business Address</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="biz_address"
                      name="biz_address"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="nature_of_business" class="form-label"
                      >Nature of Business</label
                    >
                    <select
                      class="form-select"
                      id="nature_of_business"
                      name="nature_of_business"
                    >
                      <option selected disabled>
                        Select nature of business
                      </option>
                      <option value="retail">Retail</option>
                      <option value="manufacturing">Manufacturing</option>
                      <option value="ict">ICT</option>
                      <option value="agriculture">Agriculture</option>
                      <option value="others">Others</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label for="numberOfYears" class="form-label"
                      >Years in Operation</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="numberOfYears"
                      name="numberOfYears"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="numberOfEmployees" class="form-label"
                      >Number of Employees (if applicable)</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="numberOfEmployees"
                      name="numberOfEmployees"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="annualRevenue" class="form-label"
                      >Annual Revenue (Optional)</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="annualRevenue"
                      name="annualRevenue"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="TIN" class="form-label"
                      >Tax Identification Number (TIN) (if applicable)</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="TIN"
                      name="TIN"
                      maxlength="11"
                      minlength="11"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="biz_phone" class="form-label"
                      >Mobile Number</label
                    >
                    <input
                      type="tel"
                      class="form-control"
                      id="biz_phone"
                      name="biz_phone"
                      maxlength="11"
                      placeholder="Enter a valid Nigerian phone number"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="biz_email" class="form-label">Email</label>
                    <input
                      type="email"
                      class="form-control"
                      id="biz_email"
                      name="biz_email"
                    />
                  </div>
                </div>
              </div>

              <!-- Employment History Section -->
              <div class="form-section" id="employment-section">
                <h5 class="text-lg font-semibold mb-4">
                  Employment History Details
                </h5>

                <div id="employment-history-container">
                  <div class="employment-item" data-id="0">
                    <div
                      class="d-flex justify-content-between align-items-center mb-3"
                    >
                      <label class="form-label">Employment 1</label>
                      <button
                        type="button"
                        class="btn btn-outline-danger btn-sm remove-employment"
                        style="display: none"
                      >
                        <i class="bi bi-dash"></i>
                      </button>
                    </div>

                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label">Company Name</label>
                        <input
                          type="text"
                          class="form-control"
                          name="companyName_0"
                          placeholder="Enter company name"
                        />
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Address</label>
                        <input
                          type="text"
                          class="form-control"
                          name="employment_address_0"
                          placeholder="Enter company address"
                        />
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Designation</label>
                        <input
                          type="text"
                          class="form-control"
                          name="designation_0"
                          placeholder="Enter your designation"
                        />
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Start Year</label>
                        <input
                          type="date"
                          class="form-control"
                          name="startYear_0"
                          placeholder="Enter start year"
                        />
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">End Year</label>
                        <input
                          type="date"
                          class="form-control"
                          name="endYear_0"
                          placeholder="Enter end year"
                        />
                        <p class="text-muted small mt-1">
                          Leave blank if this is your current employment.
                        </p>
                      </div>
                      <div class="col-md-6">
                        <div class="form-check">
                          <input
                            class="form-check-input"
                            type="checkbox"
                            id="isCurrentEmployment_0"
                            name="isCurrentEmployment_0"
                          />
                          <label
                            class="form-check-label"
                            for="isCurrentEmployment_0"
                          >
                            This is my current employment
                          </label>
                        </div>
                      </div>
                    </div>

                    <div class="mt-3">
                      <label class="form-label">Description of Company</label>
                      <textarea
                        class="form-control"
                        name="employment_description_0"
                        rows="3"
                        placeholder="Describe the company"
                      ></textarea>
                    </div>
                  </div>
                </div>

                <button
                  type="button"
                  class="btn btn-outline-green mt-3"
                  id="add-employment"
                >
                  <i class="bi bi-plus"></i>
                  <span>Add Another Employment</span>
                </button>
                <p
                  class="text-danger small mt-2"
                  id="employment-max-message"
                  style="display: none"
                >
                  Maximum of 5 Employment reached.
                </p>
              </div>

              <!-- Education Details Section -->
              <div class="form-section" id="education-section">
                <!-- Primary School -->
                <div class="border rounded p-4 mb-4">
                  <h5 class="text-lg font-semibold">Primary School</h5>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Name of Primary School</label>
                      <input
                        type="text"
                        class="form-control"
                        name="primarySchool_name"
                      />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label"
                        >Address of Primary School</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        name="primarySchool_address"
                      />
                    </div>
                    <div class="col-md-12">
                      <label class="form-label">Year of Attendance</label>
                      <input
                        type="text"
                        class="form-control"
                        name="primarySchool_yearOfAttendance"
                      />
                    </div>
                  </div>
                </div>

                <!-- Secondary School -->
                <div class="border rounded p-4 mb-4">
                  <h5 class="text-lg font-semibold">Secondary School</h5>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Name of Secondary School</label>
                      <input
                        type="text"
                        class="form-control"
                        name="secondarySchool_name"
                      />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label"
                        >Address of Secondary School</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        name="secondarySchool_address"
                      />
                    </div>
                    <div class="col-md-12">
                      <label class="form-label">Year of Attendance</label>
                      <input
                        type="text"
                        class="form-control"
                        name="secondarySchool_yearOfAttendance"
                      />
                    </div>
                  </div>
                </div>

                <!-- Tertiary Institutions -->
                <div class="mb-4">
                  <h5 class="text-lg font-semibold">Tertiary Institution(s)</h5>

                  <div id="tertiary-institutions-container">
                    <div class="institution-item border rounded p-4 mt-3">
                      <div
                        class="d-flex justify-content-between align-items-center mb-3"
                      >
                        <label class="form-label">Tertiary Institution 1</label>
                        <button
                          type="button"
                          class="btn btn-outline-danger btn-sm remove-institution"
                          style="display: none"
                        >
                          <i class="bi bi-dash"></i>
                        </button>
                      </div>

                      <div class="row g-3">
                        <div class="col-md-6">
                          <input
                            type="text"
                            class="form-control"
                            name="tertiaryInstitution_name_0"
                            placeholder="Name of Tertiary Institution"
                          />
                        </div>
                        <div class="col-md-6">
                          <input
                            type="text"
                            class="form-control"
                            name="tertiaryInstitution_address_0"
                            placeholder="Address of Tertiary Institution"
                          />
                        </div>
                        <div class="col-md-6">
                          <input
                            type="text"
                            class="form-control"
                            name="tertiaryInstitution_certificate_0"
                            placeholder="Certificate Obtained"
                          />
                        </div>
                        <div class="col-md-6">
                          <input
                            type="text"
                            class="form-control"
                            name="tertiaryInstitution_matricNo_0"
                            placeholder="Matriculation Number"
                          />
                        </div>
                        <div class="col-md-12">
                          <input
                            type="text"
                            class="form-control"
                            name="tertiaryInstitution_year_0"
                            placeholder="Year of Attendance"
                          />
                        </div>
                      </div>
                    </div>
                  </div>

                  <button
                    type="button"
                    class="btn btn-outline-green mt-3"
                    id="add-institution"
                  >
                    <i class="bi bi-plus"></i>
                    <span>Add Another Institution</span>
                  </button>
                </div>
              </div>

              <!-- Health Information Section -->
              <div class="form-section" id="health-section">
                <div class="row g-4">
                  <div class="col-md-4">
                    <label for="bloodGroup" class="form-label"
                      >Blood Group</label
                    >
                    <select
                      class="form-select"
                      name="bloodGroup"
                      id="bloodGroup"
                    >
                      <option selected disabled>Select blood group</option>
                      <option value="A+">A+</option>
                      <option value="A-">A-</option>
                      <option value="B+">B+</option>
                      <option value="B-">B-</option>
                      <option value="AB+">AB+</option>
                      <option value="AB-">AB-</option>
                      <option value="O+">O+</option>
                      <option value="O-">O-</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label for="genotype" class="form-label">Genotype</label>
                    <select class="form-select" name="genotype" id="genotype">
                      <option selected disabled>Select genotype</option>
                      <option value="AA">AA</option>
                      <option value="AS">AS</option>
                      <option value="SS">SS</option>
                      <option value="AC">AC</option>
                      <option value="SC">SC</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label for="disabilityStatus" class="form-label"
                      >Disability Status</label
                    >
                    <select
                      class="form-select"
                      name="disabilityStatus"
                      id="disabilityStatus"
                    >
                      <option selected disabled>
                        Select disability status
                      </option>
                      <option value="none">None</option>
                      <option value="physical">Physical</option>
                      <option value="visual">Visual</option>
                      <option value="hearing">Hearing</option>
                      <option value="other">Other</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="form-section" id="review-section">
                <h4 class="mb-4">
                  <i class="bi bi-check-circle me-2"></i>Review Your Information
                </h4>

                <div class="card mb-4">
                  <div class="card-header bg-light">
                    <h5 class="mb-0">Reference Verification Status</h5>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                      <h6>Neighbors</h6>
                      <div id="neighbor-verification-status" class="ps-3">
                        <!-- Dynamically populated -->
                      </div>
                    </div>

                    <div class="mb-3">
                      <h6>Family Members</h6>
                      <div id="family-verification-status" class="ps-3">
                        <!-- Dynamically populated -->
                      </div>
                    </div>

                    <button
                      type="button"
                      id="initiate-verification"
                      class="btn btn-primary mt-3"
                    >
                      <i class="bi bi-send-check me-2"></i>Initiate Verification
                    </button>
                    <!-- <div id="verification-status" class="mt-2"> -->
                    <div id="verification-status">
                      <div class="alert alert-warning mt-2">
                        <i class="bi bi-info-circle me-2"></i>
                        Add at least one reference with name and phone to enable
                        verification.
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Add other review sections as needed -->
              </div>
            </div>

            <div class="card-footer bg-light rounded-bottom p-4">
              <div class="d-flex justify-content-between w-100">
                <button
                  type="button"
                  class="btn btn-outline-secondary"
                  id="prev-step"
                  disabled
                >
                  <i class="bi bi-chevron-left"></i>
                  <span>Previous</span>
                </button>

                <button
                  type="submit"
                  class="btn btn-green"
                  id="submit-btn"
                  style="display: none"
                >
                  Submit Form
                </button>
                <button type="button" class="btn btn-green" id="next-step">
                  <span>Next</span>
                  <i class="bi bi-chevron-right"></i>
                </button>
              </div>
            </div>
            <div id="autoSaveStatus"></div>
          </form>
        </div>
      </div>

      <!-- Bootstrap JS Bundle with Popper -->
      <div id="autoSaveStatus" class="status-indicator">Ready</div>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

      <script>
        $(document).ready(function () {
          // Form steps data
          const steps = [
            { id: "profile", title: "Profile Details", icon: "bi-person" },
            { id: "address", title: "Residential Address", icon: "bi-geo-alt" },
            { id: "identity", title: "Identification", icon: "bi-credit-card" },
            { id: "nok", title: "Next of Kin", icon: "bi-people" },
            { id: "contacts", title: "Contact Details", icon: "bi-telephone" },
            { id: "family", title: "Family Details", icon: "bi-people" },
            { id: "business", title: "Business Details", icon: "bi-briefcase" },
            {
              id: "employment",
              title: "Employment History",
              icon: "bi-briefcase",
            },
            {
              id: "education",
              title: "Education Details",
              icon: "bi-mortarboard",
            },
            { id: "health", title: "Health Information", icon: "bi-heart" },

            {
              id: "review",
              title: "Review Your Information",
              icon: "bi-heart",
            },
          ];

          let currentStep = 0;

          // Use unique IDs instead of indices to prevent renumbering issues
          let nextNeighborId = 1;
          let nextFamilyId = 1;
          let nextEmploymentId = 1;
          let nextInstitutionId = 1;

          // Keep track of active items
          const activeNeighbors = new Set();
          const activeFamilyMembers = new Set();
          const activeEmployments = new Set();
          const activeInstitutions = new Set();

          // Initialize form
          updateStepDisplay();

          // Initialize first items
          activeNeighbors.add(0);
          activeFamilyMembers.add(0);
          activeEmployments.add(0);
          activeInstitutions.add(0);

          // Identification type change handler
          $("#identification").change(function () {
            const isOthers = $(this).val() === "others";
            $("#other-identification-container").toggle(isOthers);
            $("#other_identification").prop("required", isOthers);
          });

          // Generic function to create item HTML
          function createNeighborHTML(id, displayNumber) {
            return `
      <div class="neighbor-item" data-id="${id}">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <label class="form-label">Neighbor ${displayNumber}</label>
          <button type="button" class="btn btn-outline-danger btn-sm remove-neighbor" data-id="${id}">
            <i class="bi bi-dash"></i>
          </button>
        </div>
        <div class="row g-3">
          <div class="col-md-4">
            <input type="text" class="form-control" name="neighbor_name_${id}" placeholder="Full Name">
          </div>
          <div class="col-md-4">
            <input type="text" class="form-control" name="neighbor_address_${id}" placeholder="Residential Address">
          </div>
          <div class="col-md-4">
            <input type="tel" class="form-control" name="neighbor_phone_${id}" placeholder="Phone Number">
          </div>
        </div>
      </div>
    `;
          }

          function createFamilyHTML(id, displayNumber) {
            return `
      <div class="family-item" data-id="${id}">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <label class="form-label">Family Member ${displayNumber}</label>
          <button type="button" class="btn btn-outline-danger btn-sm remove-family" data-id="${id}">
            <i class="bi bi-dash"></i>
          </button>
        </div>
        <div class="row g-3">
          <div class="col-md-3">
            <input type="text" class="form-control" name="family_name_${id}" placeholder="Full Name">
          </div>
          <div class="col-md-3">
            <input type="text" class="form-control" name="family_relationship_${id}" placeholder="Relationship">
          </div>
          <div class="col-md-3">
            <input type="text" class="form-control" name="family_address_${id}" placeholder="Residential Address">
          </div>
          <div class="col-md-3">
            <input type="tel" class="form-control" name="family_phone_${id}" placeholder="Phone Number">
          </div>
        </div>
      </div>
    `;
          }

          function createEmploymentHTML(id, displayNumber) {
            return `
      <div class="employment-item" data-id="${id}">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <label class="form-label">Employment ${displayNumber}</label>
          <button type="button" class="btn btn-outline-danger btn-sm remove-employment" data-id="${id}">
            <i class="bi bi-dash"></i>
          </button>
        </div>
        <div class="row g-3">
          <div class="col-md-6">
            <input type="text" class="form-control" name="companyName_${id}" placeholder="Enter company name">
          </div>
          <div class="col-md-6">
            <input type="text" class="form-control" name="employment_address_${id}" placeholder="Enter company address">
          </div>
          <div class="col-md-6">
            <input type="text" class="form-control" name="designation_${id}" placeholder="Enter your designation">
          </div>
          <div class="col-md-6">
            <label class="form-label">Start Year</label>
            <input type="date" class="form-control" name="startYear_${id}" placeholder="Enter start year">
          </div>
          <div class="col-md-6">
            <label class="form-label">End Year</label>
            <input type="date" class="form-control" name="endYear_${id}" placeholder="Enter end year">
            <p class="text-muted small mt-1">Leave blank if this is your current employment.</p>
          </div>
          <div class="col-md-6">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="isCurrentEmployment_${id}" name="isCurrentEmployment_${id}">
              <label class="form-check-label" for="isCurrentEmployment_${id}">
                This is my current employment
              </label>
            </div>
          </div>
        </div>
        <div class="mt-3">
          <label class="form-label">Description of Company</label>
          <textarea class="form-control" name="employment_description_${id}" rows="3" placeholder="Describe the company"></textarea>
        </div>
      </div>
    `;
          }

          function createInstitutionHTML(id, displayNumber) {
            return `
      <div class="institution-item border rounded p-4 mt-3" data-id="${id}">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <label class="form-label">Tertiary Institution ${displayNumber}</label>
          <button type="button" class="btn btn-outline-danger btn-sm remove-institution" data-id="${id}">
            <i class="bi bi-dash"></i>
          </button>
        </div>
        <div class="row g-3">
          <div class="col-md-6">
            <input type="text" class="form-control" name="tertiaryInstitution_name_${id}" placeholder="Name of Tertiary Institution">
          </div>
          <div class="col-md-6">
            <input type="text" class="form-control" name="tertiaryInstitution_address_${id}" placeholder="Address of Tertiary Institution">
          </div>
          <div class="col-md-6">
            <input type="text" class="form-control" name="tertiaryInstitution_certificate_${id}" placeholder="Certificate Obtained">
          </div>
          <div class="col-md-6">
            <input type="text" class="form-control" name="tertiaryInstitution_matricNo_${id}" placeholder="Matriculation Number">
          </div>
          <div class="col-md-12">
            <input type="text" class="form-control" name="tertiaryInstitution_year_${id}" placeholder="Year of Attendance">
          </div>
        </div>
      </div>
    `;
          }

          // Function to update display numbers without changing form names
          function updateDisplayNumbers(
            containerSelector,
            itemSelector,
            labelPrefix,
            activeSet
          ) {
            const items = $(containerSelector).find(itemSelector);
            items.each(function (index) {
              $(this)
                .find(".form-label")
                .first()
                .text(`${labelPrefix} ${index + 1}`);
            });

            // Update remove button visibility
            const removeButtons = $(containerSelector).find(
              ".btn-outline-danger"
            );
            removeButtons.toggle(activeSet.size > 1);
          }

          // Add neighbor handler
          $("#add-neighbor").click(function () {
            if (activeNeighbors.size < 5) {
              const id = nextNeighborId++;
              activeNeighbors.add(id);

              const neighborHtml = createNeighborHTML(id, activeNeighbors.size);
              $("#neighbors-container").append(neighborHtml);

              // Update UI state
              $("#neighbor-max-message").toggle(activeNeighbors.size >= 5);
              $("#add-neighbor").prop("disabled", activeNeighbors.size >= 5);
              updateDisplayNumbers(
                "#neighbors-container",
                ".neighbor-item",
                "Neighbor",
                activeNeighbors
              );

              // Trigger auto-save
              if (formManager) formManager.triggerAutoSave();
            }
          });

          // Remove neighbor handler (delegated)
          $("#neighbors-container").on(
            "click",
            ".remove-neighbor",
            function () {
              const id = parseInt($(this).data("id"));
              if (activeNeighbors.size > 1) {
                $(this).closest(".neighbor-item").remove();
                activeNeighbors.delete(id);

                // Update UI state
                $("#neighbor-max-message").hide();
                $("#add-neighbor").prop("disabled", false);
                updateDisplayNumbers(
                  "#neighbors-container",
                  ".neighbor-item",
                  "Neighbor",
                  activeNeighbors
                );

                // Trigger auto-save
                if (formManager) formManager.triggerAutoSave();
              }
            }
          );

          // Add family member handler
          $("#add-family-member").click(function () {
            if (activeFamilyMembers.size < 5) {
              const id = nextFamilyId++;
              activeFamilyMembers.add(id);

              const familyHtml = createFamilyHTML(id, activeFamilyMembers.size);
              $("#family-members-container").append(familyHtml);

              // Update UI state
              $("#family-max-message").toggle(activeFamilyMembers.size >= 5);
              $("#add-family-member").prop(
                "disabled",
                activeFamilyMembers.size >= 5
              );
              updateDisplayNumbers(
                "#family-members-container",
                ".family-item",
                "Family Member",
                activeFamilyMembers
              );

              // Trigger auto-save
              if (formManager) formManager.triggerAutoSave();
            }
          });

          // Remove family member handler (delegated)
          $("#family-members-container").on(
            "click",
            ".remove-family",
            function () {
              const id = parseInt($(this).data("id"));
              if (activeFamilyMembers.size > 1) {
                $(this).closest(".family-item").remove();
                activeFamilyMembers.delete(id);

                // Update UI state
                $("#family-max-message").hide();
                $("#add-family-member").prop("disabled", false);
                updateDisplayNumbers(
                  "#family-members-container",
                  ".family-item",
                  "Family Member",
                  activeFamilyMembers
                );

                // Trigger auto-save
                if (formManager) formManager.triggerAutoSave();
              }
            }
          );

          // Add employment handler
          $("#add-employment").click(function () {
            if (activeEmployments.size < 5) {
              const id = nextEmploymentId++;
              activeEmployments.add(id);

              const employmentHtml = createEmploymentHTML(
                id,
                activeEmployments.size
              );
              $("#employment-history-container").append(employmentHtml);

              // Update UI state
              $("#employment-max-message").toggle(activeEmployments.size >= 5);
              $("#add-employment").prop(
                "disabled",
                activeEmployments.size >= 5
              );
              updateDisplayNumbers(
                "#employment-history-container",
                ".employment-item",
                "Employment",
                activeEmployments
              );

              // Trigger auto-save
              if (formManager) formManager.triggerAutoSave();
            }
          });

          // Remove employment handler (delegated)
          $("#employment-history-container").on(
            "click",
            ".remove-employment",
            function () {
              const id = parseInt($(this).data("id"));
              if (activeEmployments.size > 1) {
                $(this).closest(".employment-item").remove();
                activeEmployments.delete(id);

                // Update UI state
                $("#employment-max-message").hide();
                $("#add-employment").prop("disabled", false);
                updateDisplayNumbers(
                  "#employment-history-container",
                  ".employment-item",
                  "Employment",
                  activeEmployments
                );

                // Trigger auto-save
                if (formManager) formManager.triggerAutoSave();
              }
            }
          );

          // Add institution handler
          $("#add-institution").click(function () {
            const id = nextInstitutionId++;
            activeInstitutions.add(id);

            const institutionHtml = createInstitutionHTML(
              id,
              activeInstitutions.size
            );
            $("#tertiary-institutions-container").append(institutionHtml);

            updateDisplayNumbers(
              "#tertiary-institutions-container",
              ".institution-item",
              "Tertiary Institution",
              activeInstitutions
            );

            // Trigger auto-save
            if (formManager) formManager.triggerAutoSave();
          });

          // Remove institution handler (delegated)
          $("#tertiary-institutions-container").on(
            "click",
            ".remove-institution",
            function () {
              const id = parseInt($(this).data("id"));
              if (activeInstitutions.size > 1) {
                $(this).closest(".institution-item").remove();
                activeInstitutions.delete(id);

                updateDisplayNumbers(
                  "#tertiary-institutions-container",
                  ".institution-item",
                  "Tertiary Institution",
                  activeInstitutions
                );

                // Trigger auto-save
                if (formManager) formManager.triggerAutoSave();
              }
            }
          );

          // Next step handler
          $("#next-step").click(function () {
            if (currentStep < steps.length - 1) {
              currentStep++;
              updateStepDisplay();
            }
          });

          // Previous step handler
          $("#prev-step").click(function () {
            if (currentStep > 0) {
              currentStep--;
              updateStepDisplay();
            }
          });

          // Update step display
          function updateStepDisplay() {
            // Hide all sections
            $(".form-section").removeClass("active");

            // Show current section
            $(`#${steps[currentStep].id}-section`).addClass("active");

            // Update step info in header
            $("#current-step-title").text(steps[currentStep].title);
            $("#current-step-description").text(
              `Step ${currentStep + 1} of ${steps.length}`
            );
            $("#current-step-icon")
              .removeClass()
              .addClass(`bi ${steps[currentStep].icon}`);

            // Update progress bar
            const progressPercent = ((currentStep + 1) / steps.length) * 100;
            $("#progress-bar").css("width", `${progressPercent}%`);

            // Update navigation buttons
            $("#prev-step").prop("disabled", currentStep === 0);

            if (currentStep === steps.length - 1) {
              $("#next-step").hide();
              $("#submit-btn").show();
            } else {
              $("#next-step").show();
              $("#submit-btn").hide();
            }
          }

          // Initialize the form with default items
          $("#neighbors-container").append(createNeighborHTML(0, 1));
          $("#family-members-container").append(createFamilyHTML(0, 1));
          $("#employment-history-container").append(createEmploymentHTML(0, 1));
          $("#tertiary-institutions-container").append(
            createInstitutionHTML(0, 1)
          );

          // Hold state for counts and the auto-save timer.
          const state = {
            autoSaveTimer: null,
            institutionCount: 0,
            neighborCount: 0,
            familyCount: 0,
            employmentCount: 0,
            isDataLoaded: false, // Flag to prevent premature auto-saves
            pendingSave: false, // Flag to prevent concurrent saves
          };

          // Utility function to set input values safely
          const setInputValue = (id, value) => {
            const element = document.getElementById(id);
            if (element) {
              element.value = value || "";
            }
          };

          // Debounced auto-save function
          const debouncedAutoSave = (() => {
            let timeoutId;
            return (delay = 1000) => {
              clearTimeout(timeoutId);
              $("#autoSaveStatus").text("Saving...").css("color", "blue");
              timeoutId = setTimeout(() => {
                if (state.isDataLoaded) {
                  formManager.performAutoSave();
                }
              }, delay);
            };
          })();

          // Utility function to escape HTML to prevent XSS
          const escapeHtml = (text) => {
            if (!text) return "";
            const map = {
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#039;",
            };
            return text.replace(/[&<>"']/g, (m) => map[m]);
          };

          // Helper function to format dates for HTML input[type="date"]
          function formatDateForInput(dateString) {
            if (!dateString) return "";

            // If it's already in YYYY-MM-DD format, return as-is
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
              return dateString;
            }

            // Try to parse various date formats
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return "";

            // Format as YYYY-MM-DD
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, "0");
            const day = String(date.getDate()).padStart(2, "0");

            return `${year}-${month}-${day}`;
          }

          // Updated populateNeighbors function
          const populateNeighbors = (neighbors) => {
            const container = $("#neighbors-container");
            container.empty();
            activeNeighbors.clear();
            nextNeighborId = 0;

            try {
              if (neighbors && neighbors.length > 0) {
                neighbors.forEach((neighbor, index) => {
                  const id = nextNeighborId++;
                  activeNeighbors.add(id);
                  const neighborHtml = createNeighborHTML(id, index + 1);
                  container.append(neighborHtml);

                  // Set values from database
                  $(`input[name="neighbor_name_${id}"]`).val(
                    neighbor.name || ""
                  );
                  $(`input[name="neighbor_address_${id}"]`).val(
                    neighbor.address || ""
                  );
                  $(`input[name="neighbor_phone_${id}"]`).val(
                    neighbor.phone || ""
                  );
                });
              } else {
                // Add default empty neighbor
                const id = nextNeighborId++;
                activeNeighbors.add(id);
                container.append(createNeighborHTML(id, 1));
              }
              updateDisplayNumbers(
                "#neighbors-container",
                ".neighbor-item",
                "Neighbor",
                activeNeighbors
              );
            } catch (error) {
              console.error("Error in populateNeighbors:", error);
            }
          };

          // Updated populateFamily function
          const populateFamily = (family) => {
            const container = $("#family-members-container");
            container.empty();
            activeFamilyMembers.clear();
            nextFamilyId = 0;

            if (family && family.length > 0) {
              family.forEach((member, index) => {
                const id = nextFamilyId++;
                activeFamilyMembers.add(id);
                const familyHtml = createFamilyHTML(id, index + 1);
                container.append(familyHtml);

                // Set values from database
                $(`input[name="family_name_${id}"]`).val(member.name || "");
                $(`input[name="family_relationship_${id}"]`).val(
                  member.relationship || ""
                );
                $(`input[name="family_address_${id}"]`).val(
                  member.address || ""
                );
                $(`input[name="family_phone_${id}"]`).val(member.phone || "");
              });
            } else {
              // Add default empty family member
              const id = nextFamilyId++;
              activeFamilyMembers.add(id);
              container.append(createFamilyHTML(id, 1));
            }
            updateDisplayNumbers(
              "#family-members-container",
              ".family-item",
              "Family Member",
              activeFamilyMembers
            );
          };

          // Updated populateEmploymentHistory function
          const populateEmploymentHistory = (employments) => {
            const container = $("#employment-history-container");
            container.empty();
            activeEmployments.clear();
            nextEmploymentId = 0;

            if (employments && employments.length > 0) {
              employments.forEach((employment, index) => {
                const id = nextEmploymentId++;
                activeEmployments.add(id);
                const employmentHtml = createEmploymentHTML(id, index + 1);
                container.append(employmentHtml);

                // Set values from database
                $(`input[name="companyName_${id}"]`).val(
                  employment.companyName || ""
                );
                $(`input[name="employment_address_${id}"]`).val(
                  employment.address || ""
                );
                $(`input[name="designation_${id}"]`).val(
                  employment.designation || ""
                );

                // Format dates correctly for date inputs
                const formattedStartDate = formatDateForInput(
                  employment.startYear
                );
                const formattedEndDate = formatDateForInput(employment.endYear);

                $(`input[name="startYear_${id}"]`).val(formattedStartDate);
                $(`input[name="endYear_${id}"]`).val(formattedEndDate);
                $(`input[name="isCurrentEmployment_${id}"]`).prop(
                  "checked",
                  employment.isCurrentEmployment || false
                );
                $(`textarea[name="employment_description_${id}"]`).val(
                  employment.description || ""
                );
              });
            } else {
              // Add default empty employment
              const id = nextEmploymentId++;
              activeEmployments.add(id);
              container.append(createEmploymentHTML(id, 1));
            }
            updateDisplayNumbers(
              "#employment-history-container",
              ".employment-item",
              "Employment",
              activeEmployments
            );
          };

          // Updated populateTertiaryInstitutions function
          const populateTertiaryInstitutions = (institutions) => {
            const container = $("#tertiary-institutions-container");
            container.empty();
            activeInstitutions.clear();
            nextInstitutionId = 0;

            if (institutions && institutions.length > 0) {
              institutions.forEach((institution, index) => {
                const id = nextInstitutionId++;
                activeInstitutions.add(id);
                const institutionHtml = createInstitutionHTML(id, index + 1);
                container.append(institutionHtml);

                // Set values from database
                $(`input[name="tertiaryInstitution_name_${id}"]`).val(
                  institution.name || ""
                );
                $(`input[name="tertiaryInstitution_address_${id}"]`).val(
                  institution.address || ""
                );
                $(`input[name="tertiaryInstitution_certificate_${id}"]`).val(
                  institution.certificateObtained || ""
                );
                $(`input[name="tertiaryInstitution_matricNo_${id}"]`).val(
                  institution.matricNo || ""
                );
                $(`input[name="tertiaryInstitution_year_${id}"]`).val(
                  institution.yearOfAttendance || ""
                );
              });
            } else {
              // Add default empty institution
              const id = nextInstitutionId++;
              activeInstitutions.add(id);
              container.append(createInstitutionHTML(id, 1));
            }
            updateDisplayNumbers(
              "#tertiary-institutions-container",
              ".institution-item",
              "Tertiary Institution",
              activeInstitutions
            );
          };

          const handleProfileDataSuccess = (data) => {
            try {
              // Set flag to prevent auto-saves during population
              state.isDataLoaded = false;

              // Populate other fields safely
              if (data) {
                // Handle educational history
                if (data.educationalHistory) {
                  // Primary and secondary school population
                  $('input[name="primarySchool_name"]').val(
                    data.educationalHistory.primarySchool?.name || ""
                  );
                  $('input[name="primarySchool_address"]').val(
                    data.educationalHistory.primarySchool?.address || ""
                  );
                  $('input[name="primarySchool_yearOfAttendance"]').val(
                    data.educationalHistory.primarySchool?.yearOfAttendance ||
                      ""
                  );

                  $('input[name="secondarySchool_name"]').val(
                    data.educationalHistory.secondarySchool?.name || ""
                  );
                  $('input[name="secondarySchool_address"]').val(
                    data.educationalHistory.secondarySchool?.address || ""
                  );
                  $('input[name="secondarySchool_yearOfAttendance"]').val(
                    data.educationalHistory.secondarySchool?.yearOfAttendance ||
                      ""
                  );

                  // Tertiary institutions
                  populateTertiaryInstitutions(
                    data.educationalHistory.tertiaryInstitutions || []
                  );
                }

                // Populate family data
                populateFamily(data.family || []);

                // Populate neighbor data
                populateNeighbors(data.neighbor || []);

                // Populate employment history
                populateEmploymentHistory(data.employmentHistory || []);
              }

              // Set flag to allow auto-saves after population is complete
              state.isDataLoaded = true;
            } catch (error) {
              console.error("Error populating profile data:", error);
              state.isDataLoaded = true; // Still allow saves even if population fails
            }
          };

          // Improved AJAX call with better error handling
          const loadProfileData = () => {
            if (!user || !user.id || !token) {
              console.error("Missing user data or token");
              state.isDataLoaded = true; // Allow saves even without loaded data
              return;
            }

            $.ajax({
              url: `${BACKEND_URL}/users/${user.id}`,
              method: "GET",
              headers: { Authorization: `Bearer ${token}` },
              timeout: 10000, // 10 second timeout
              success: handleProfileDataSuccess,
              error: function (xhr, status, error) {
                console.error("Failed to load profile data:", {
                  status: xhr.status,
                  statusText: xhr.statusText,
                  error: error,
                });

                // Still allow the form to function even if data loading fails
                state.isDataLoaded = true;

                // Add default empty fields if no data was loaded
                if (
                  $("#tertiary-institutions-container .institution-item")
                    .length === 0
                ) {
                  const id = nextInstitutionId++;
                  activeInstitutions.add(id);
                  $("#tertiary-institutions-container").append(
                    createInstitutionHTML(id, 1)
                  );
                }
                if ($("#family-members-container .family-item").length === 0) {
                  const id = nextFamilyId++;
                  activeFamilyMembers.add(id);
                  $("#family-members-container").append(
                    createFamilyHTML(id, 1)
                  );
                }
                if ($("#neighbors-container .neighbor-item").length === 0) {
                  const id = nextNeighborId++;
                  activeNeighbors.add(id);
                  $("#neighbors-container").append(createNeighborHTML(id, 1));
                }
                if (
                  $("#employment-history-container .employment-item").length ===
                  0
                ) {
                  const id = nextEmploymentId++;
                  activeEmployments.add(id);
                  $("#employment-history-container").append(
                    createEmploymentHTML(id, 1)
                  );
                }
              },
            });
          };

          loadProfileData();

          // Enhanced Auto-Save System with Data Loss Prevention
          class FormDataManager {
            constructor() {
              this.state = {
                autoSaveTimer: null,
                retryTimer: null,
                maxRetries: 3,
                retryDelay: 2000,
                currentRetryCount: 0,
                lastSaveAttempt: null,
                pendingChanges: false,
                isOnline: navigator.onLine,
                formData: new Map(),
                lastKnownGoodState: null,
              };

              this.initializeNetworkMonitoring();
              this.initializePageUnloadProtection();
              this.initialize();
            }

            // Network monitoring to detect connectivity issues
            initializeNetworkMonitoring() {
              window.addEventListener("online", () => {
                console.log("Connection restored");
                this.state.isOnline = true;
                this.updateStatus(
                  "Connection restored. Syncing data...",
                  "blue"
                );
                if (this.state.pendingChanges) {
                  this.performAutoSave();
                }
              });

              window.addEventListener("offline", () => {
                console.log("Connection lost");
                this.state.isOnline = false;
                this.updateStatus("Offline - changes saved locally", "orange");
              });
            }

            // Prevent data loss on page unload
            initializePageUnloadProtection() {
              window.addEventListener("beforeunload", (e) => {
                if (this.state.pendingChanges) {
                  // Save to local storage as backup
                  this.saveToLocalStorage();

                  // Show confirmation dialog
                  const message =
                    "You have unsaved changes. Are you sure you want to leave?";
                  e.returnValue = message;
                  return message;
                }
              });

              // Handle page visibility changes (mobile browsers)
              document.addEventListener("visibilitychange", () => {
                if (
                  document.visibilityState === "hidden" &&
                  this.state.pendingChanges
                ) {
                  this.saveToLocalStorage();
                  if (this.state.isOnline) {
                    this.performAutoSave(true); // Force immediate save
                  }
                }
              });
            }

            async loadPersistedData() {
              try {
                const saved = localStorage.getItem("formData_backup");
                if (!saved) return null;

                const parsed = JSON.parse(saved);
                if (!parsed?.data) {
                  console.error("Invalid backup structure");
                  return null;
                }

                // Verify data freshness
                const timestamp = new Date(parsed.timestamp);
                if (new Date() - timestamp > 24 * 60 * 60 * 1000) {
                  localStorage.removeItem("formData_backup");
                  return null;
                }

                // console.log("Loaded backup data:", parsed.data); // Debug
                return parsed.data; // Return JUST the data object
              } catch (error) {
                console.error("Load failed:", error);
                return null;
              }
            }

            // Modify your initialization to wait for DOM ready
            async initialize() {
              await new Promise((resolve) => $(document).ready(resolve));

              const backupData = await this.loadPersistedData();
              if (backupData) {
                this.showDataRecoveryDialog(backupData);
              }

              this.initializeNetworkMonitoring();
              this.initializePageUnloadProtection();
            }

            showDataRecoveryDialog(backupData) {
              // console.log("Dialog received backupData:", backupData); // DEBUG

              Swal.fire({
                title: "Recover Unsaved Changes?",
                text: "We found unsaved changes from your previous session.",
                icon: "question",
                showCancelButton: true,
                confirmButtonText: "Restore",
                cancelButtonText: "Discard",
              }).then((result) => {
                if (result.value === true) {
                  this.restoreFormData(backupData);
                } else {
                  localStorage.removeItem("formData_backup");
                }
              });
            }

            // Update your restoreFormData to ensure proper this binding
            restoreFormData(data) {
              if (!data) {
                console.error("No data provided to restore");
                return;
              }

              // 1. Restore Main Form Fields
              if (data.formData) {
                Object.entries(data.formData).forEach(([key, value]) => {
                  const $field = $(`#${key}`);
                  if ($field.length) {
                    $field.val(value || "");
                  } else {
                    console.warn(`Field not found: #${key}`);
                  }
                });
              }

              // 2. Restore Next of Kin
              if (data.nextOfKin) {
                Object.entries(data.nextOfKin).forEach(([key, value]) => {
                  const cleanKey = key.replace(/^nok_/, "");
                  const $field = $(`#nok_${cleanKey}`);
                  if ($field.length) {
                    $field.val(value || "");
                  } else {
                    console.warn(`Field not found: #nok_${cleanKey}`);
                  }
                });
              }

              // 3. Restore Neighbors
              if (data.neighbor?.length) {
                // Clear existing neighbors first
                $("#neighbors-container").empty();
                activeNeighbors.clear();
                nextNeighborId = 0;

                data.neighbor.forEach((neighbor, index) => {
                  const id = nextNeighborId++;
                  activeNeighbors.add(id);
                  const neighborHtml = createNeighborHTML(id, index + 1);
                  $("#neighbors-container").append(neighborHtml);

                  $(`input[name="neighbor_name_${id}"]`).val(
                    neighbor.name || ""
                  );
                  $(`input[name="neighbor_address_${id}"]`).val(
                    neighbor.address || ""
                  );
                  $(`input[name="neighbor_phone_${id}"]`).val(
                    neighbor.phone || ""
                  );
                });
                updateDisplayNumbers(
                  "#neighbors-container",
                  ".neighbor-item",
                  "Neighbor",
                  activeNeighbors
                );
              }

              // 4. Restore Family Members
              if (data.family?.length) {
                // Clear existing family first
                $("#family-members-container").empty();
                activeFamilyMembers.clear();
                nextFamilyId = 0;

                data.family.forEach((member, index) => {
                  const id = nextFamilyId++;
                  activeFamilyMembers.add(id);
                  const familyHtml = createFamilyHTML(id, index + 1);
                  $("#family-members-container").append(familyHtml);

                  $(`input[name="family_name_${id}"]`).val(member.name || "");
                  $(`input[name="family_relationship_${id}"]`).val(
                    member.relationship || ""
                  );
                  $(`input[name="family_phone_${id}"]`).val(member.phone || "");
                  $(`input[name="family_address_${id}"]`).val(
                    member.address || ""
                  );
                });
                updateDisplayNumbers(
                  "#family-members-container",
                  ".family-item",
                  "Family Member",
                  activeFamilyMembers
                );
              }

              // 5. Restore Business Info
              if (data.business) {
                Object.entries(data.business).forEach(([key, value]) => {
                  const $field = $(`#${key}`);
                  if ($field.length) {
                    $field.val(value || "");
                  }
                });
              }

              // 6. Restore Employment History
              if (data.employmentHistory?.length) {
                // Clear existing employment first
                $("#employment-history-container").empty();
                activeEmployments.clear();
                nextEmploymentId = 0;

                data.employmentHistory.forEach((job, index) => {
                  const id = nextEmploymentId++;
                  activeEmployments.add(id);
                  const employmentHtml = createEmploymentHTML(id, index + 1);
                  $("#employment-history-container").append(employmentHtml);

                  $(`input[name="companyName_${id}"]`).val(
                    job.companyName || ""
                  );
                  $(`input[name="employment_address_${id}"]`).val(
                    job.address || ""
                  );
                  $(`input[name="designation_${id}"]`).val(
                    job.designation || ""
                  );
                  $(`input[name="startYear_${id}"]`).val(job.startYear || "");
                  $(`input[name="endYear_${id}"]`).val(job.endYear || "");
                  $(`input[name="isCurrentEmployment_${id}"]`).prop(
                    "checked",
                    job.isCurrentEmployment || false
                  );
                  $(`textarea[name="employment_description_${id}"]`).val(
                    job.description || ""
                  );
                });
                updateDisplayNumbers(
                  "#employment-history-container",
                  ".employment-item",
                  "Employment",
                  activeEmployments
                );
              }

              // 7. Restore Education History
              if (data.educationalHistory) {
                // Primary School
                if (data.educationalHistory.primarySchool) {
                  $('input[name="primarySchool_name"]').val(
                    data.educationalHistory.primarySchool.name || ""
                  );
                  $('input[name="primarySchool_address"]').val(
                    data.educationalHistory.primarySchool.address || ""
                  );
                  $('input[name="primarySchool_yearOfAttendance"]').val(
                    data.educationalHistory.primarySchool.yearOfAttendance || ""
                  );
                }

                // Secondary School
                if (data.educationalHistory.secondarySchool) {
                  $('input[name="secondarySchool_name"]').val(
                    data.educationalHistory.secondarySchool.name || ""
                  );
                  $('input[name="secondarySchool_address"]').val(
                    data.educationalHistory.secondarySchool.address || ""
                  );
                  $('input[name="secondarySchool_yearOfAttendance"]').val(
                    data.educationalHistory.secondarySchool.yearOfAttendance ||
                      ""
                  );
                }

                // Tertiary Institutions
                if (data.educationalHistory.tertiaryInstitutions?.length) {
                  // Clear existing institutions first
                  $("#tertiary-institutions-container").empty();
                  activeInstitutions.clear();
                  nextInstitutionId = 0;

                  data.educationalHistory.tertiaryInstitutions.forEach(
                    (inst, index) => {
                      const id = nextInstitutionId++;
                      activeInstitutions.add(id);
                      const institutionHtml = createInstitutionHTML(
                        id,
                        index + 1
                      );
                      $("#tertiary-institutions-container").append(
                        institutionHtml
                      );

                      $(`input[name="tertiaryInstitution_name_${id}"]`).val(
                        inst.name || ""
                      );
                      $(`input[name="tertiaryInstitution_address_${id}"]`).val(
                        inst.address || ""
                      );
                      $(
                        `input[name="tertiaryInstitution_certificate_${id}"]`
                      ).val(inst.certificateObtained || "");
                      $(`input[name="tertiaryInstitution_matricNo_${id}"]`).val(
                        inst.matricNo || ""
                      );
                      $(`input[name="tertiaryInstitution_year_${id}"]`).val(
                        inst.yearOfAttendance || ""
                      );
                    }
                  );
                  updateDisplayNumbers(
                    "#tertiary-institutions-container",
                    ".institution-item",
                    "Tertiary Institution",
                    activeInstitutions
                  );
                }
              }

              this.state.pendingChanges = true;
            }

            saveToLocalStorage() {
              try {
                const collected = this.collectFormData();

                // PROPERLY convert FormData to plain object
                const formDataObj = {};
                if (collected.formData instanceof FormData) {
                  collected.formData.forEach((value, key) => {
                    formDataObj[key] = value;
                  });
                }

                const backupData = {
                  data: {
                    formData: formDataObj, // Use converted object
                    nextOfKin: collected.nextOfKin,
                    healthInfo: collected.healthInfo,
                    business: collected.business,
                    educationalHistory: collected.educationalHistory,
                    employmentHistory: collected.employmentHistory,
                    neighbor: collected.neighbor,
                    family: collected.family,
                  },
                  timestamp: new Date().toISOString(),
                };

                localStorage.setItem(
                  "formData_backup",
                  JSON.stringify(backupData)
                );
              } catch (error) {
                console.error("Save failed:", error);
              }
            }

            // Collect all form data
            collectFormData = () => {
              // Initialize FormData (this will also capture file uploads)
              const formData = new FormData();

              // List of simple fields by their IDs.
              const fields = [
                "middlename",
                "lastname",
                "nationality",
                "community",
                "religion",
                "gender",
                "stateOfOrigin",
                "DOB",
                "countryOfResidence",
                "lgaOfOrigin",
                "maritalStatus",
                "house_number",
                "street_name",
                "nearest_bus_stop_landmark",
                "city_town",
                "stateOfResidence",
                "lgaOfResidence",
                "id_number",
                "issue_date",
                "expiry_date",
              ];
              fields.forEach((field) => {
                const value = $(`#${field}`).val() || "";
                formData.append(field, value);
              });

              // Build the next-of-kin object.
              const nextOfKin = {
                nok_surname: $("#nok_surname").val().trim(),
                nok_firstname: $("#nok_firstname").val().trim(),
                nok_middlename: $("#nok_middlename").val().trim(),
                nok_relationship: $("#nok_relationship").val().trim(),
                nok_countryOfResidence: $("#nok_countryOfResidence")
                  .val()
                  .trim(),
                nok_stateOfResidence: $("#nok_stateOfResidence").val().trim(),
                nok_lgaOfResidence: $("#nok_lgaOfResidence").val().trim(),
                nok_cityOfResidence: $("#nok_cityOfResidence").val().trim(),
                nok_address: $("#nok_address").val().trim(),
              };

              // Build the health info object.
              const healthInfo = {
                bloodGroup: $("#bloodGroup").val(),
                genotype: $("#genotype").val(),
                disabilityStatus: $("#disabilityStatus").val(),
              };

              // Build the business object.
              const business = {
                biz_name: $("#biz_name").val().trim(),
                biz_type: $("#biz_type").val(),
                registration_number: $("#registration_number").val().trim(),
                biz_address: $("#biz_address").val().trim(),
                nature_of_business: $("#nature_of_business").val(),
                numberOfYears: $("#numberOfYears").val().trim(),
                numberOfEmployees: $("#numberOfEmployees").val().trim(),
                annualRevenue: $("#annualRevenue").val().trim(),
                TIN: $("#TIN").val().trim(),
                biz_phone: $("#biz_phone").val().trim(),
                biz_email: $("#biz_email").val().trim(),
              };

              // Collect neighbors data
              const neighbor = [];
              $(".neighbor-item").each(function () {
                const id = $(this).data("id");
                neighbor.push({
                  name: $(this).find(`input[name="neighbor_name_${id}"]`).val(),
                  address: $(this)
                    .find(`input[name="neighbor_address_${id}"]`)
                    .val(),
                  phone: $(this)
                    .find(`input[name="neighbor_phone_${id}"]`)
                    .val(),
                });
              });

              // Collect family members data
              const family = [];
              $(".family-item").each(function () {
                const id = $(this).data("id");
                family.push({
                  name: $(this).find(`input[name="family_name_${id}"]`).val(),
                  relationship: $(this)
                    .find(`input[name="family_relationship_${id}"]`)
                    .val(),
                  phone: $(this).find(`input[name="family_phone_${id}"]`).val(),
                  address: $(this)
                    .find(`input[name="family_address_${id}"]`)
                    .val(),
                });
              });

              // Collect employment history
              const employmentHistory = [];
              $(".employment-item").each(function () {
                const id = $(this).data("id");
                employmentHistory.push({
                  companyName: $(this)
                    .find(`input[name="companyName_${id}"]`)
                    .val(),
                  address: $(this)
                    .find(`input[name="employment_address_${id}"]`)
                    .val(),
                  designation: $(this)
                    .find(`input[name="designation_${id}"]`)
                    .val(),
                  startYear: $(this)
                    .find(`input[name="startYear_${id}"]`)
                    .val(),
                  endYear: $(this).find(`input[name="endYear_${id}"]`).val(),
                  isCurrentEmployment: $(this)
                    .find(`input[name="isCurrentEmployment_${id}"]`)
                    .is(":checked"),
                  description: $(this)
                    .find(`textarea[name="employment_description_${id}"]`)
                    .val(),
                });
              });

              // Collect education data
              const educationalHistory = {
                primarySchool: {
                  name: $('input[name="primarySchool_name"]').val(),
                  address: $('input[name="primarySchool_address"]').val(),
                  yearOfAttendance: $(
                    'input[name="primarySchool_yearOfAttendance"]'
                  ).val(),
                },
                secondarySchool: {
                  name: $('input[name="secondarySchool_name"]').val(),
                  address: $('input[name="secondarySchool_address"]').val(),
                  yearOfAttendance: $(
                    'input[name="secondarySchool_yearOfAttendance"]'
                  ).val(),
                },
                tertiaryInstitutions: [],
              };

              $(".institution-item").each(function () {
                const id = $(this).data("id");
                educationalHistory.tertiaryInstitutions.push({
                  name: $(this)
                    .find(`input[name="tertiaryInstitution_name_${id}"]`)
                    .val(),
                  address: $(this)
                    .find(`input[name="tertiaryInstitution_address_${id}"]`)
                    .val(),
                  certificateObtained: $(this)
                    .find(`input[name="tertiaryInstitution_certificate_${id}"]`)
                    .val(),
                  matricNo: $(this)
                    .find(`input[name="tertiaryInstitution_matricNo_${id}"]`)
                    .val(),
                  yearOfAttendance: $(this)
                    .find(`input[name="tertiaryInstitution_year_${id}"]`)
                    .val(),
                });
              });

              // Return both the FormData (with file uploads) and our JSON–ready objects.
              return {
                formData,
                nextOfKin,
                healthInfo,
                business,
                educationalHistory,
                employmentHistory,
                neighbor,
                family,
              };
            };

            // Enhanced auto-save with retry mechanism
            async performAutoSave(forceImmediate = false) {
              if (!this.state.isOnline && !forceImmediate) {
                this.saveToLocalStorage();
                this.updateStatus("Offline - saved locally", "orange");
                return;
              }

              this.state.lastSaveAttempt = new Date();

              try {
                // Collect all the form data.
                const {
                  formData,
                  nextOfKin,
                  healthInfo,
                  business,
                  educationalHistory,
                  employmentHistory,
                  neighbor,
                  family,
                } = this.collectFormData();

                // Append the JSON–structured data.
                formData.append("nextOfKin", JSON.stringify(nextOfKin));
                formData.append("healthInfo", JSON.stringify(healthInfo));
                formData.append("business", JSON.stringify(business));
                formData.append(
                  "educationalHistory",
                  JSON.stringify(educationalHistory)
                );
                formData.append(
                  "employmentHistory",
                  JSON.stringify(employmentHistory)
                );
                formData.append("neighbor", JSON.stringify(neighbor));
                formData.append("family", JSON.stringify(family));

                // Handle identification – use the alternative input if "others" is selected.
                const selectedIdentification = $("#identification").val();
                const otherIdentification = $("#other_identification")
                  .val()
                  .trim();

                if (selectedIdentification === "others") {
                  if (!otherIdentification) {
                    alert("Please specify your identification type");
                    return false; // Prevent form submission
                  }
                  // Store both the fact that it's "others" and the custom value
                  formData.append("identification", `${otherIdentification}`);
                } else {
                  formData.append("identification", selectedIdentification);
                }

                const canvas = $("#snapshot").get(0);
                const dataURL = canvas.toDataURL("image/jpeg", 0.9);
                const passportPhotoFile = $("#passportPhoto")[0]?.files[0];

                if (photoCaptured && dataURL) {
                  formData.append(
                    "passportPhoto",
                    dataURLtoFile(dataURL, "captured-passport.jpg")
                  );
                } else if (passportPhotoFile) {
                  formData.append("passportPhoto", passportPhotoFile);
                }

                // Perform the save operation
                const response = await this.saveWithRetry(formData);

                if (response.ok) {
                  this.onSaveSuccess();
                } else {
                  throw new Error(
                    `Server error: ${response.status} ${response.statusText}`
                  );
                }
              } catch (error) {
                this.onSaveError(error);
              }
            }

            // Save with retry mechanism
            async saveWithRetry(formData, retryCount = 0) {
              try {
                if (!token) {
                  throw new Error("Authentication token not found");
                }

                if (!user.id) {
                  throw new Error("User ID not found");
                }

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout

                const response = await fetch(
                  `${BACKEND_URL}/users/${user.id}`,
                  {
                    method: "PUT",
                    headers: {
                      Authorization: `Bearer ${token}`,
                    },
                    body: formData,
                    signal: controller.signal,
                  }
                );

                clearTimeout(timeoutId);
                return response;
              } catch (error) {
                if (retryCount < this.state.maxRetries) {
                  console.log(
                    `Save attempt ${retryCount + 1} failed, retrying in ${
                      this.state.retryDelay
                    }ms...`
                  );
                  this.updateStatus(
                    `Save failed, retrying... (${retryCount + 1}/${
                      this.state.maxRetries
                    })`,
                    "orange"
                  );

                  await new Promise((resolve) =>
                    setTimeout(resolve, this.state.retryDelay)
                  );
                  return this.saveWithRetry(formData, retryCount + 1);
                }
                throw error;
              }
            }

            // Handle successful save
            onSaveSuccess() {
              console.log("Auto-save successful");
              this.updateStatus("Saved", "green");
              this.state.pendingChanges = false;
              this.state.currentRetryCount = 0;
              this.state.lastKnownGoodState = this.collectFormData();

              // Remove local storage backup after successful save
              localStorage.removeItem("formData_backup");

              // Clear any retry timers
              if (this.state.retryTimer) {
                clearTimeout(this.state.retryTimer);
                this.state.retryTimer = null;
              }
            }

            // Handle save errors
            onSaveError(error) {
              console.error("Auto-save error:", error);

              // Save to local storage as fallback
              this.saveToLocalStorage();

              if (error.name === "AbortError") {
                this.updateStatus("Save timed out - saved locally", "red");
              } else if (!this.state.isOnline) {
                this.updateStatus("Offline - saved locally", "orange");
              } else {
                this.updateStatus("Failed to save - saved locally", "red");
              }

              // Schedule retry if online
              if (
                this.state.isOnline &&
                this.state.currentRetryCount < this.state.maxRetries
              ) {
                this.state.retryTimer = setTimeout(() => {
                  this.performAutoSave();
                }, this.state.retryDelay * (this.state.currentRetryCount + 1));
              }
            }

            // Update status indicator
            updateStatus(message, color) {
              $("#autoSaveStatus").text(message).css("color", color);
            }

            // Convert base64 to blob for efficient transmission
            base64ToBlob(base64String) {
              const parts = base64String.split(",");
              const contentType = parts[0].match(/:(.*?);/)[1];
              const raw = window.atob(parts[1]);
              const rawLength = raw.length;
              const uint8Array = new Uint8Array(rawLength);

              for (let i = 0; i < rawLength; ++i) {
                uint8Array[i] = raw.charCodeAt(i);
              }

              return new Blob([uint8Array], { type: contentType });
            }

            // Debounced auto-save trigger
            triggerAutoSave() {
              this.state.pendingChanges = true;
              clearTimeout(this.state.autoSaveTimer);
              this.updateStatus("Saving...", "blue");

              this.state.autoSaveTimer = setTimeout(() => {
                this.performAutoSave();
              }, 1000); // 1-second debounce
            }

            // Force immediate save (for critical operations)
            async forceSave() {
              clearTimeout(this.state.autoSaveTimer);
              this.updateStatus("Saving...", "blue");
              await this.performAutoSave(true);
            }
          }

          // Initialize the form data manager
          const formManager = new FormDataManager();

          // Camera and photo handling with enhanced error handling
          let cameraStream = null;
          let photoCaptured = false;

          // Utility: Convert dataURL to File
          function dataURLtoFile(dataurl, filename) {
            const arr = dataurl.split(",");
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while (n--) {
              u8arr[n] = bstr.charCodeAt(n);
            }
            return new File([u8arr], filename, { type: mime });
          }

          // ✅ Enhanced Camera Start
          $("#start-camera").click(async function () {
            try {
              const constraints = {
                video: {
                  width: { ideal: 1280 },
                  height: { ideal: 720 },
                  facingMode: "user",
                },
              };

              cameraStream = await navigator.mediaDevices.getUserMedia(
                constraints
              );
              $("#camera-stream").get(0).srcObject = cameraStream;
              $("#camera-stream").show();
              $("#capture-photo, #close-camera").show();
              $("#start-camera").hide();
              $("#photo-preview").hide();
            } catch (err) {
              console.error("Camera access error:", err);
              let errorMessage = "Unable to access camera: ";

              if (err.name === "NotAllowedError") {
                errorMessage +=
                  "Permission denied. Please allow camera access.";
              } else if (err.name === "NotFoundError") {
                errorMessage += "No camera found on this device.";
              } else {
                errorMessage += err.message;
              }

              Swal.fire({
                title: "Camera Error",
                text: errorMessage,
                icon: "error",
              });
            }
          });

          // ✅ Enhanced Capture Photo with validation
          $("#capture-photo").click(function () {
            try {
              const video = $("#camera-stream").get(0);
              const canvas = $("#snapshot").get(0);
              const context = canvas.getContext("2d");

              if (!video.videoWidth || !video.videoHeight) {
                throw new Error("Video stream not ready");
              }

              canvas.width = video.videoWidth;
              canvas.height = video.videoHeight;
              context.drawImage(video, 0, 0, canvas.width, canvas.height);

              const dataUrl = canvas.toDataURL("image/jpeg", 0.9);

              // Validate the captured image
              if (dataUrl === "data:,") {
                throw new Error("Failed to capture image");
              }

              $("#photo-preview").attr("src", dataUrl).show();
              $("#passportPhotoData").val(dataUrl);

              // Clean up camera stream
              if (cameraStream) {
                cameraStream.getTracks().forEach((track) => track.stop());
                cameraStream = null;
              }

              $("#camera-stream, #capture-photo, #close-camera").hide();
              $("#start-camera").show();
              photoCaptured = true;

              formManager.updateStatus("Photo captured! Saving...", "orange");
              formManager.triggerAutoSave();
            } catch (error) {
              console.error("Photo capture error:", error);
              Swal.fire({
                title: "Capture Error",
                text: "Failed to capture photo: " + error.message,
                icon: "error",
              });
            }
          });

          // ✅ Enhanced Close Camera
          $("#close-camera").click(function () {
            if (cameraStream) {
              cameraStream.getTracks().forEach((track) => track.stop());
              cameraStream = null;
            }
            $("#camera-stream, #capture-photo, #close-camera").hide();
            $("#start-camera").show();
          });

          // ✅ Enhanced Upload Photo from File
          $("#upload-photo-btn").click(function () {
            $("#passportPhoto").click();
          });

          $("#passportPhoto").change(function (e) {
            const file = e.target.files[0];
            if (file) {
              // Validate file type and size
              const validTypes = ["image/jpeg", "image/jpg", "image/png"];
              const maxSize = 5 * 1024 * 1024; // 5MB

              if (!validTypes.includes(file.type)) {
                Swal.fire({
                  title: "Invalid File Type",
                  text: "Please select a JPEG or PNG image.",
                  icon: "error",
                });
                return;
              }

              if (file.size > maxSize) {
                Swal.fire({
                  title: "File Too Large",
                  text: "Please select an image smaller than 5MB.",
                  icon: "error",
                });
                return;
              }

              const reader = new FileReader();
              reader.onload = function (event) {
                $("#photo-preview").attr("src", event.target.result).show();
                $("#passportPhotoData").val(event.target.result);

                // Clean up camera if active
                if (cameraStream) {
                  cameraStream.getTracks().forEach((track) => track.stop());
                  cameraStream = null;
                  $("#camera-stream, #capture-photo, #close-camera").hide();
                  $("#start-camera").show();
                }

                photoCaptured = false;
                formManager.updateStatus("Photo uploaded! Saving...", "orange");
                formManager.triggerAutoSave();
              };

              reader.onerror = function () {
                Swal.fire({
                  title: "File Read Error",
                  text: "Failed to read the selected file.",
                  icon: "error",
                });
              };

              reader.readAsDataURL(file);
            }
          });

          /* ===================================================
           * Enhanced Event Bindings
           * =================================================== */

          const bindEvents = () => {
            // Enhanced input change detection
            $(document).on(
              "input change",
              "input, select, textarea",
              function () {
                formManager.triggerAutoSave();
              }
            );

            // Enhanced form submission with validation
            $("#unifiedForm").on("submit", async function (e) {
              e.preventDefault();

              try {
                // Show loading state
                Swal.fire({
                  title: "Submitting...",
                  text: "Please wait while we save your information.",
                  allowOutsideClick: false,
                  didOpen: () => {
                    Swal.showLoading();
                  },
                });

                // Force save before submission
                await formManager.forceSave();

                // Close loading and show success
                Swal.fire({
                  title: "Success!",
                  text: "Your form has been submitted successfully.",
                  icon: "success",
                  confirmButtonText: "OK",
                });
              } catch (error) {
                Swal.fire({
                  title: "Submission Error",
                  text: "Failed to submit form. Your data has been saved locally and will be retried automatically.",
                  icon: "error",
                  confirmButtonText: "OK",
                });
              }
            });
          };

          // Initialize all event bindings
          bindEvents();

          // Add periodic sync for offline changes
          setInterval(() => {
            if (
              formManager.state.isOnline &&
              formManager.state.pendingChanges
            ) {
              const lastAttempt = formManager.state.lastSaveAttempt;
              const now = new Date();

              // If no recent save attempt, try to sync
              if (!lastAttempt || now - lastAttempt > 60000) {
                // 1 minute
                console.log("Periodic sync attempt...");
                formManager.performAutoSave();
              }
            }
          }, 30000); // Check every 30 seconds
        });
      </script>

      <script>
        let populateVerificationStatus;
        // Add this to your document ready function or main script
        $(document).ready(function () {
          // Initialize verification functionality
          initVerificationReview(true);
          // Add this to your document ready function or initialization
          function setupRealTimeVerificationUpdates() {
            // Listen for changes in family/neighbor sections
            $(document).on(
              "input",
              '[name^="neighbor_"], [name^="family_"]',
              function () {
                // Debounce the update to avoid too many requests
                clearTimeout(window.verificationUpdateTimer);
                window.verificationUpdateTimer = setTimeout(() => {
                  populateVerificationStatus(true); // Force refresh
                }, 1000);
              }
            );

            // Update when items are added/removed
            $("#add-neighbor, #add-family-member").click(function () {
              setTimeout(() => {
                if (typeof populateVerificationStatus === "function") {
                  populateVerificationStatus(true);
                }
              }, 300);
            });

            $("#neighbors-container").on(
              "click",
              ".remove-neighbor",
              function () {
                setTimeout(() => {
                  if (typeof populateVerificationStatus === "function") {
                    populateVerificationStatus(true);
                  }
                }, 300);
              }
            );

            $("#family-members-container").on(
              "click",
              ".remove-family",
              function () {
                setTimeout(() => {
                  if (typeof populateVerificationStatus === "function") {
                    populateVerificationStatus(true);
                  }
                }, 300);
              }
            );
          }

          setupRealTimeVerificationUpdates();
        });

        function initVerificationReview(isInitialLoad = false) {
          // Use sessionStorage to maintain verification state
          const storageKey = `verificationState-${user.id}`;

          function saveVerificationState(data) {
            sessionStorage.setItem(
              storageKey,
              JSON.stringify({
                timestamp: new Date().getTime(),
                data,
              })
            );
          }

          function loadVerificationState() {
            const saved = sessionStorage.getItem(storageKey);
            return saved ? JSON.parse(saved) : null;
          }

          // Helper function to get appropriate badge class based on status
          function getStatusBadgeClass(status) {
            status = status.toLowerCase();
            if (status === "verified") return "bg-success";
            if (status === "denied") return "bg-danger";
            return "bg-warning";
          }

          let currentUserData = null;

          // Update the render function to properly check for empty values
          function renderVerificationStatus(userData) {
            currentUserData = userData;

            const neighborContainer = $(
              "#neighbor-verification-status"
            ).empty();
            userData.neighbor?.forEach((neighbor, index) => {
              const phoneValue = neighbor.phone || "";
              const isInvalid = !neighbor.name || !phoneValue.trim();

              neighborContainer.append(`
      <div class="d-flex justify-content-between align-items-center mb-2 border-bottom pb-2 ${
        isInvalid ? "bg-light-danger" : ""
      }">
        <div>
          <span class="fw-medium">${
            neighbor.name || "Neighbor " + (index + 1)
          }</span>
          <div class="text-muted small">${phoneValue || "No phone"}</div>
          ${
            isInvalid
              ? '<div class="text-danger small">Missing required fields</div>'
              : ""
          }
        </div>
        <span class="badge ${getStatusBadgeClass(neighbor.status)}">
          ${neighbor.status || "Pending"}
        </span>
      </div>
    `);
            });

            const familyContainer = $("#family-verification-status").empty();
            userData.family?.forEach((family, index) => {
              const phoneValue = family.phone || "";
              const isInvalid = !family.name || !phoneValue.trim();

              familyContainer.append(`
      <div class="d-flex justify-content-between align-items-center mb-2 border-bottom pb-2 ${
        isInvalid ? "bg-light-danger" : ""
      }">
        <div>
          <span class="fw-medium">${
            family.name || "Family " + (index + 1)
          }</span>
          <div class="text-muted small">${phoneValue || "No phone"}</div>
          ${
            isInvalid
              ? '<div class="text-danger small">Missing required fields</div>'
              : ""
          }
        </div>
        <span class="badge ${getStatusBadgeClass(family.status)}">
          ${family.status || "Pending"}
        </span>
      </div>
    `);
            });

            updateVerificationButtonState(userData);
          }

          // Function to check if there are valid references
          function allReferencesValid() {
            if (!currentUserData) return false;
            // Check neighbors
            const hasValidNeighbors = currentUserData.neighbor?.some(
              (neighbor) => neighbor.name || neighbor.phone
            );

            // Check family members
            const hasValidFamily = currentUserData.family?.some(
              (member) => member.name || member.phone
            );

            return hasValidNeighbors && hasValidFamily;
          }

          // Update verification button state
          //       function updateVerificationButtonState() {
          //         const isValid = allReferencesValid();
          //         $("#initiate-verification").prop("disabled", !isValid);

          //         if (!isValid) {
          //           $("#verification-status").html(`
          //   <div class="alert alert-warning">
          //     <i class="bi bi-exclamation-triangle me-2"></i>
          //     All references must have both name and phone to initiate verification.
          //   </div>
          // `);
          //         } else {
          //           $("#verification-status").empty();
          //         }
          //       }
          function updateVerificationButtonState() {
            const isValid = allReferencesValid();
            const hasPendingReference =
              currentUserData &&
              [
                ...(currentUserData.neighbor || []),
                ...(currentUserData.family || []),
              ].some((ref) => (ref.status || "").toLowerCase() === "pending");

            const shouldDisable = !isValid || !hasPendingReference;

            $("#initiate-verification").prop("disabled", shouldDisable);

            if (!isValid) {
              const invalidRefs = getInvalidReferences();
              let message =
                "All references must have both name and phone. Issues with:";

              invalidRefs.forEach((ref) => {
                message += `<br>• ${ref.type} #${
                  ref.index
                }: Missing ${ref.missing.join(" and ")}`;
              });

              $("#verification-status").html(`
      <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle me-2"></i>
        ${message}
      </div>
    `);
            } else if (!hasPendingReference) {
              $("#verification-status").html(`
      <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        All references have already been verified or denied. No action needed.
      </div>
    `);
            } else {
              $("#verification-status").empty();
            }
          }

          populateVerificationStatus = async function (forceRefresh = false) {
            if ($("#verification-success-message").length > 0) {
              return;
            }

            const savedState = loadVerificationState();
            const shouldUseCache =
              savedState &&
              !forceRefresh &&
              new Date().getTime() - savedState.timestamp < 30000;

            if (shouldUseCache) {
              renderVerificationStatus(savedState.data);
              return;
            }

            const currentFormData = collectCurrentFormData();

            // Show loading state while fetching
            $(
              "#neighbor-verification-status, #family-verification-status"
            ).html(
              '<div class="text-center py-2"><div class="spinner-border spinner-border-sm" role="status"></div> Loading...</div>'
            );

            try {
              // First update with current form data (immediate UI update)
              renderVerificationStatus(currentFormData);
              const response = await fetch(`${BACKEND_URL}/users/${user.id}`, {
                headers: { Authorization: `Bearer ${token}` },
              });

              if (!response.ok)
                throw new Error("Failed to fetch verification status");

              const userData = await response.json();

              saveVerificationState(userData);
              renderVerificationStatus(userData);
            } catch (error) {
              console.error("Error loading verification status:", error);
              // if (savedState) renderVerificationStatus(savedState.data);
              renderVerificationStatus(currentFormData);
            }
          };
          // Add this helper function to collect current form data
          function collectCurrentFormData() {
            const neighbors = [];
            $(".neighbor-item").each(function () {
              const id = $(this).data("id");
              neighbors.push({
                name: $(this).find(`input[name="neighbor_name_${id}"]`).val(),
                phone: $(this).find(`input[name="neighbor_phone_${id}"]`).val(),
                status: "Pending", // Default status
              });
            });

            const family = [];
            $(".family-item").each(function () {
              const id = $(this).data("id");
              family.push({
                name: $(this).find(`input[name="family_name_${id}"]`).val(),
                phone: $(this).find(`input[name="family_phone_${id}"]`).val(),
                status: "Pending", // Default status
              });
            });

            return { neighbor: neighbors, family: family };
          }

          function getInvalidReferences() {
            if (!currentUserData) return [];

            const invalid = [];

            currentUserData.neighbor?.forEach((neighbor, index) => {
              if (!neighbor.name || !neighbor.phone) {
                invalid.push({
                  type: "Neighbor",
                  index: index + 1,
                  missing: [
                    ...(!neighbor.name ? ["name"] : []),
                    ...(!neighbor.phone ? ["phone"] : []),
                  ],
                });
              }
            });

            currentUserData.family?.forEach((member, index) => {
              if (!member.name || !member.phone) {
                invalid.push({
                  type: "Family",
                  index: index + 1,
                  missing: [
                    ...(!member.name ? ["name"] : []),
                    ...(!member.phone ? ["phone"] : []),
                  ],
                });
              }
            });

            return invalid;
          }

          function updateVerificationButtonState() {
            if (!currentUserData) return;

            const allRefs = [
              ...(currentUserData.neighbor || []),
              ...(currentUserData.family || []),
            ];

            // Must have at least one valid reference
            const allValid = allRefs.every((ref) => ref.name && ref.phone);

            // Check if ANY reference is still pending
            const hasPending = allRefs.some(
              (ref) => (ref.status || "").toLowerCase() === "pending"
            );

            // Disable if not valid or if there are no pending references
            const shouldDisable = !allValid || !hasPending;

            $("#initiate-verification").prop("disabled", shouldDisable);

            if (!allValid) {
              const invalidRefs = getInvalidReferences();
              let message =
                "All references must have both name and phone. Issues with:";
              invalidRefs.forEach((ref) => {
                message += `<br>• ${ref.type} #${
                  ref.index
                }: Missing ${ref.missing.join(" and ")}`;
              });
              $("#verification-status").html(`
      <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle me-2"></i>
        ${message}
      </div>
    `);
            } else if (!hasPending) {
              $("#verification-status").html(`
      <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        All references have already been verified or denied. No pending verification.
      </div>
    `);
            } else {
              $("#verification-status").empty();
            }
          }

          // Function to initiate verification
          async function initiateVerification() {
            // Early check for valid references
            if (!allReferencesValid()) {
              $("#verification-status").html(`
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Cannot initiate verification: No valid references with both name and phone.
        </div>
      `);

              return;
            }
            try {
              // Show loading state
              $("#initiate-verification").prop("disabled", true).html(`
              <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
              Initiating...
            `);

              $("#verification-status").html(`
              <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                Initiating verification process...
              </div>
            `);

              const response = await fetch(
                `${BACKEND_URL}/users/${user.id}/initiate-verification`,
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                  },
                }
              );
              if (response.status === 400) {
                const errorData = await response.json();
                throw new Error(errorData.message);
              }

              if (!response.ok) {
                throw new Error(
                  (await response.text()) || "Failed to initiate verification"
                );
              }

              const result = await response.json();

              //       // Show success message
              //       $("#verification-status").html(`
              //   <div class="alert alert-success">
              //     <i class="bi bi-check-circle me-2"></i>
              //     Verification initiated successfully! Reference contacts will receive verification messages.
              //   </div>
              // `);

              // Show success message
              const successMessage = `
      <div class="alert alert-success" id="verification-success-message">
        <i class="bi bi-check-circle me-2"></i>
        Verification initiated successfully! Reference contacts will receive verification messages.
      </div>
    `;

              $("#verification-status").html(successMessage);

              // Update verification status badges after a delay
              setTimeout(() => {
                updateVerificationStatuses();
              }, 2000);

              // Refresh the review section after a longer delay
              setTimeout(() => {
                // Only refresh if success message is still visible
                if ($("#verification-success-message").length) {
                  populateVerificationStatus();
                }
              }, 4000);
            } catch (error) {
              // Handle verification in progress error
              if (error.message.includes("already in progress")) {
                $("#verification-status").html(`
          <div class="alert alert-warning">
            <i class="bi bi-hourglass-split me-2"></i>
            ${error.message}
          </div>
        `);
              }
              // Handle other errors
              else {
                $("#verification-status").html(`
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            ${error.message || "Verification failed"}
          </div>
        `);
              }
            } finally {
              // Reset button state
              $("#initiate-verification").prop("disabled", false).html(`
          <i class="bi bi-send-check me-2"></i>Initiate Verification
        `);
            }
          }

          // Function to update verification status badges
          async function updateVerificationStatuses() {
            try {
              const response = await fetch(`${BACKEND_URL}/users/${user.id}`, {
                headers: {
                  Authorization: `Bearer ${token}`,
                },
              });

              if (!response.ok) {
                throw new Error("Failed to fetch user data");
              }

              const userData = await response.json();

              // Update neighbor verification statuses
              if (userData.neighbor && userData.neighbor.length) {
                userData.neighbor.forEach((neighbor, index) => {
                  const statusBadge = $(`#neighbor-status-${index}`);
                  if (statusBadge.length) {
                    statusBadge.removeClass("bg-warning bg-success bg-danger");
                    if (neighbor.status === "VERIFIED") {
                      statusBadge.addClass("bg-success").text("Verified");
                    } else if (neighbor.status === "DENIED") {
                      statusBadge.addClass("bg-danger").text("Denied");
                    } else {
                      statusBadge.addClass("bg-warning").text("Pending");
                    }
                  }
                });
              }

              // Update family verification statuses
              if (userData.family && userData.family.length) {
                userData.family.forEach((family, index) => {
                  const statusBadge = $(`#family-status-${index}`);
                  if (statusBadge.length) {
                    statusBadge.removeClass("bg-warning bg-success bg-danger");
                    if (family.status === "VERIFIED") {
                      statusBadge.addClass("bg-success").text("Verified");
                    } else if (family.status === "DENIED") {
                      statusBadge.addClass("bg-danger").text("Denied");
                    } else {
                      statusBadge.addClass("bg-warning").text("Pending");
                    }
                  }
                });
              }
            } catch (error) {
              console.error("Error updating verification statuses:", error);
            }
          }

          // Bind the initiate verification button
          $("#initiate-verification").click(initiateVerification);

          // Update verification status when review section is shown
          $("#review-section").on("show", function () {
            populateVerificationStatus();
            updateVerificationStatuses();
          });

          // Initial population if review section is active on load
          if ($("#review-section").hasClass("active")) {
            populateVerificationStatus();
            updateVerificationStatuses();
          }
          // Initialize on page load
          if (isInitialLoad) {
            populateVerificationStatus();
            $("#review-section").on("show", () => {
              populateVerificationStatus(true);
              updateVerificationButtonState();
            }); // Force refresh when section shown
          }
        }
      </script>
      <script>
        document.querySelectorAll(".next-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const nextSection = document.getElementById(btn.dataset.next);
            btn.closest(".form-section").style.display = "none";
            nextSection.style.display = "block";
          });
        });

        document.querySelectorAll(".prev-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const prevSection = document.getElementById(btn.dataset.prev);
            btn.closest(".form-section").style.display = "none";
            prevSection.style.display = "block";
          });
        });
      </script>

      <script>
        document.querySelectorAll(".next-btn").forEach((button) => {
          button.addEventListener("click", () => {
            const currentSection = button.closest(".form-section");
            const nextSectionId = button.getAttribute("data-next");
            const nextSection = document.getElementById(nextSectionId);

            // Validate the current form section
            if (validateForm(currentSection)) {
              currentSection.classList.remove("active");
              nextSection.classList.add("active");
            }
          });
        });

        function validateForm(section) {
          let isValid = true;
          section.querySelectorAll("input, select").forEach((field) => {
            const errorMessage = field.nextElementSibling;
            if (field.hasAttribute("required") && !field.value.trim()) {
              field.classList.add("error");
              if (errorMessage) errorMessage.style.display = "block";
              isValid = false;
            } else {
              field.classList.remove("error");
              if (errorMessage) errorMessage.style.display = "none";
            }
          });
          return isValid;
        }
      </script>
      <script>
        function calculateProfileCompletion(user) {
          let completed = 0;
          let total = 14; // adjust total fields based on your backend logic

          const checks = [
            user.firstname,
            user.lastname,
            user.phone,
            user.NIN,
            user.DOB,
            user.gender,
            user.nationality,
            user.stateOfOrigin,
            user.lgaOfOrigin,
            user.passportPhoto,
          ];

          checks.forEach((field) => {
            if (field && String(field).trim() !== "") completed++;
          });

          // Extra checks (add 1 each if complete)
          if (
            Array.isArray(user.educationalHistory) &&
            user.educationalHistory.length > 0
          )
            completed++;
          if (
            Array.isArray(user.employmentHistory) &&
            user.employmentHistory.length > 0
          )
            completed++;
          if (
            Array.isArray(user.family) &&
            user.family.some((f) => f.status === "verified")
          )
            completed++;
          if (
            Array.isArray(user.neighbor) &&
            user.neighbor.some((n) => n.status === "verified")
          )
            completed++;

          const percent = Math.floor((completed / total) * 100);
          return percent;
        }

        function updateProgressBar(percent) {
          $("#profileProgressBar")
            .css("width", percent + "%")
            .text(percent + "%");

          // Change color based on progress
          const bar = $("#profileProgressBar");
          if (percent < 50) {
            bar.removeClass("bg-success").addClass("bg-danger");
          } else if (percent < 80) {
            bar.removeClass("bg-danger bg-success").addClass("bg-warning");
          } else {
            bar.removeClass("bg-warning bg-danger").addClass("bg-success");
          }
        }

        // Example usage after fetching user data
        $(document).ready(function () {
          $.ajax({
            url: `${BACKEND_URL}/users/${user.id}`,
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            success: function (user) {
              const percent = calculateProfileCompletion(user);
              updateProgressBar(percent);
            },
            error: function (xhr) {
              console.error("Failed to fetch user:", xhr);
            },
          });
        });
      </script>

      <script>
        function logout() {
          localStorage.removeItem("token");
        }
      </script>
    </div>
    <!--**********************************
            Content body end
        ***********************************-->

    <!--**********************************
            Footer start
        ***********************************-->
    <div class="footer">
      <div class="copyright">
        <p>Copyright ©BDIC Ltd 2025. All rights reserved.</p>
      </div>
    </div>

    <!--**********************************
            Footer end
        ***********************************-->

    <!--**********************************
        Scripts
    ***********************************-->
    <!-- Required vendors -->
    <script src="vendor/sweetalert2/dist/sweetalert2.min.js"></script>
    <script src="js/plugins-init/sweetalert.init.js"></script>
    <script src="vendor/global/global.min.js"></script>
    <script src="vendor/bootstrap-select/dist/js/bootstrap-select.min.js"></script>
    <script src="vendor/chart.js/Chart.bundle.min.js"></script>
    <script src="vendor/bootstrap-datetimepicker/js/moment.js"></script>
    <script src="vendor/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js"></script>

    <script src="js/custom.min.js"></script>
    <script src="js/deznav-init.js"></script>
    <script src="js/demo.js"></script>
    <script type="text/javascript" src="../js/index.js"></script>
  </body>
</html>
