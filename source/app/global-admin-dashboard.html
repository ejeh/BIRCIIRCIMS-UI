<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BICRIRMS Admin Dashboard</title>
    <link
      rel="icon"
      type="image/png"
      href="/assets/images/benue-state-logo.png"
      sizes="16x16"
    />

    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <!-- DataTables CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css"
    />

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Important: Set the worker source -->
    <script>
      // Tells PDF.js where to find its worker script
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    </script>

    <style>
      :root {
        --sidebar-width: 260px;
        --sidebar-bg: #1a1d29;
        --sidebar-text: #a0a9c9;
        --sidebar-active: #4c5fd5;
        --header-height: 60px;
        --header-bg: #ffffff;
        --main-bg: #f5f6fa;
        --card-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
      }

      [data-theme="dark"] {
        --sidebar-bg: #0f0f14;
        --sidebar-text: #8892b0;
        --sidebar-active: #6366f1;
        --header-bg: #1a1d29;
        --main-bg: #111318;
        --card-bg: #1a1d29;
        --text-color: #e6e6e6;
        --border-color: #2a2d3a;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--main-bg);
        color: var(--text-color);
        transition: all 0.3s ease;
      }

      /* Sidebar Styles */
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: var(--sidebar-width);
        background-color: var(--sidebar-bg);
        z-index: 1000;
        transition: all 0.3s ease;
        overflow-y: auto;
      }

      .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .sidebar-menu {
        padding: 20px 0;
      }

      .sidebar-menu .nav-link {
        color: var(--sidebar-text);
        padding: 12px 20px;
        display: flex;
        align-items: center;
        transition: all 0.3s ease;
        border-radius: 0;
      }

      .sidebar-menu .nav-link:hover {
        background-color: rgba(255, 255, 255, 0.05);
        color: #fff;
      }

      .sidebar-menu .nav-link.active {
        background-color: var(--sidebar-active);
        color: #fff;
      }

      .sidebar-menu .nav-link i {
        margin-right: 10px;
        font-size: 18px;
      }

      .sidebar-menu .nav-link .badge {
        margin-left: auto;
      }

      /* Header Styles */
      .header {
        position: fixed;
        top: 0;
        left: var(--sidebar-width);
        right: 0;
        height: var(--header-height);
        background-color: var(--header-bg);
        z-index: 999;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);

        display: flex;
        align-items: center;

        /* Keep layout clean and spaced */
        padding: 0 20px;
        gap: 20px;

        transition: all 0.3s ease;
      }

      /* Search bar stays in the middle-left and expands */
      .header .search-bar {
        flex: 1; /* Fills the available space */
        max-width: 400px; /* Prevents it from stretching too wide */
      }

      /* Push header actions to the far right */
      .header .header-actions {
        margin-left: auto; /* The key fix: pushes this entire block to right */

        display: flex;
        align-items: center;
        gap: 15px;
      }

      /* Main Content */
      .main-content {
        margin-left: var(--sidebar-width);
        margin-top: var(--header-height);
        padding: 20px;
        min-height: calc(100vh - var(--header-height));
        transition: all 0.3s ease;
      }

      /* Card Styles */
      .card {
        border: none;
        border-radius: 10px;
        box-shadow: var(--card-shadow);
        margin-bottom: 20px;
        background-color: var(--card-bg);
        transition: all 0.3s ease;
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      }

      .card-header {
        background-color: transparent;
        border-bottom: 1px solid var(--border-color);
        padding: 15px 20px;
        font-weight: 600;
      }

      .card-body {
        padding: 20px;
      }

      /* KPI Cards */
      .kpi-card {
        border-radius: 10px;
        padding: 20px;
        position: relative;
        overflow: hidden;
        color: #fff;
      }

      .kpi-card::before {
        content: "";
        position: absolute;
        top: 0;
        right: 0;
        width: 100px;
        height: 100px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        transform: translate(30px, -30px);
      }

      .kpi-card.primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .kpi-card.success {
        background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
      }

      .kpi-card.warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }

      .kpi-card.info {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      }

      .kpi-card .kpi-value {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 5px;
      }

      .kpi-card .kpi-label {
        font-size: 14px;
        opacity: 0.8;
      }

      .kpi-card .kpi-icon {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 40px;
        opacity: 0.3;
      }

      /* Dark Mode Toggle */
      .theme-toggle {
        position: relative;
        width: 50px;
        height: 26px;
        background-color: #ccc;
        border-radius: 34px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .theme-toggle.active {
        background-color: #6366f1;
      }

      .theme-toggle-slider {
        position: absolute;
        top: 3px;
        left: 3px;
        width: 20px;
        height: 20px;
        background-color: white;
        border-radius: 50%;
        transition: transform 0.3s;
      }

      .theme-toggle.active .theme-toggle-slider {
        transform: translateX(24px);
      }

      /* Responsive */
      @media (max-width: 768px) {
        .sidebar {
          transform: translateX(-100%);
        }

        .sidebar.show {
          transform: translateX(0);
        }

        .header {
          left: 0;
        }

        .main-content {
          margin-left: 0;
        }
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }

      ::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #555;
      }

      /* Table Styles */
      .dataTables_wrapper .dataTables_filter input {
        border: 1px solid var(--border-color);
        border-radius: 5px;
        padding: 5px 10px;
      }

      .dataTables_wrapper .dataTables_length select {
        border: 1px solid var(--border-color);
        border-radius: 5px;
        padding: 5px;
      }

      /* Chart Container */
      .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 20px;
      }

      /* Activity Timeline */
      .activity-timeline {
        position: relative;
        padding-left: 30px;
      }

      .activity-timeline::before {
        content: "";
        position: absolute;
        left: 10px;
        top: 0;
        bottom: 0;
        width: 2px;
        background-color: var(--border-color);
      }

      .activity-item {
        position: relative;
        margin-bottom: 20px;
      }

      .activity-item::before {
        content: "";
        position: absolute;
        left: -24px;
        top: 5px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: var(--sidebar-active);
      }

      .activity-item .activity-time {
        font-size: 12px;
        color: var(--sidebar-text);
        margin-bottom: 5px;
      }

      .activity-item .activity-content {
        font-size: 14px;
      }

      /* Loading Spinner */
      .spinner-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
      }

      .spinner-border {
        width: 1rem;
        height: 1rem;
      }

      /* Export Buttons */
      .export-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }

      .export-buttons button {
        padding: 5px 10px;
        font-size: 14px;
        border-radius: 5px;
        border: 1px solid var(--border-color);
        background-color: transparent;
        color: var(--text-color);
      }

      .export-buttons button:hover {
        background-color: var(--sidebar-active);
        color: white;
      }
      .bg-custom-purple {
        background-color: #8b5cf6 !important;
      }

      .password-validation .valid {
        color: #198754;
      }

      .password-validation .invalid {
        color: #6c757d;
      }
      /* Loading Indicator Styles */
      #loadingIndicator {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(
          255,
          255,
          255,
          0.8
        ); /* Semi-transparent white background */
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000; /* Ensure it's on top of other elements */
      }
      .loader {
        border: 8px solid #f3f3f3; /* Light grey */
        border-top: 8px solid #3498db; /* Blue */
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite; /* Spin animation */
      }

      .profile-photo-container {
        position: relative;
        display: inline-block;
      }

      .profile-photo-container img {
        width: 150px;
        height: 150px;
        object-fit: cover;
      }

      .profile-photo-upload {
        position: absolute;
        bottom: 10px; /* distance from bottom of image */
        right: 10px; /* distance from right edge */
        background: #0d6efd;
        color: #fff;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        font-size: 18px;
        border: 3px solid #fff; /* clean border around the circle */
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        transition: all 0.2s ease-in-out;
      }

      .profile-photo-upload:hover {
        background: #0b5ed7;
        transform: scale(1.05);
      }

      /* Download Loading Overlay */
      .download-loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none; /* Prevent interaction when hidden */
      }

      .download-loading-overlay.show {
        opacity: 1;
        pointer-events: auto; /* Enable interaction when shown */
      }

      .download-loading-content {
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        text-align: center;
        max-width: 300px;
      }

      .download-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4c5fd5;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>

  <body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <!-- <h4 class="text-white mb-0">
                <i class="bi bi-shield-check me-2"></i>GovID Admin
            </h4>
            <small class="text-muted">Identity Management System</small> -->

        <div class="d-flex align-items-center">
          <img
            src="/assets/images/benue-state-logo.png"
            alt="Benue State Logo"
            class="me-3"
            width="40"
          />
          <div>
            <h4 class="mb-0 fw-bold text-white">BICRIRMS</h4>
            <small class="text-white" style="font-size: 0.8rem">
              Certificate of Origin &
              <br />
              Identity Card Management
            </small>
          </div>
        </div>
      </div>
      <nav class="sidebar-menu">
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link active" href="#" data-page="dashboard">
              <i class="bi bi-speedometer2"></i>
              Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-page="users">
              <i class="bi bi-people"></i>
              User Management
              <span class="badge bg-primary usercount">2,451</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-page="idcards">
              <i class="bi bi-card-text"></i>
              Identity Card Requests
              <span class="badge bg-warning totalRequests">142</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-page="certificates">
              <i class="bi bi-file-earmark-text"></i>
              Certificate of Origin
              <span class="badge bg-info totalCertRequests">89</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-page="transactions">
              <i class="bi bi-currency-dollar"></i>
              Transactions
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-page="analytics">
              <i class="bi bi-graph-up"></i>
              Analytics & Reports
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-page="roles">
              <i class="bi bi-person-badge"></i>
              Role Management
            </a>
          </li>
          <!-- <li class="nav-item">
            <a class="nav-link" href="#" data-page="profile">
              <i class="bi bi-person-circle"></i>
              Profile
            </a>
          </li> -->
          <li class="nav-item">
            <a
              class="nav-link"
              href="#"
              data-page="settings"
              id="settings-link"
            >
              <i class="bi bi-gear"></i>
              Settings
            </a>
          </li>
        </ul>
      </nav>
    </aside>

    <!-- Header -->
    <header class="header">
      <button class="btn btn-light d-md-none me-3" id="sidebarToggle">
        <i class="bi bi-list"></i>
      </button>

      <!-- <div class="search-bar">
        <div class="input-group">
          <span class="input-group-text bg-transparent border-end-0">
            <i class="bi bi-search"></i>
          </span>
          <input
            type="text"
            class="form-control border-start-0"
            placeholder="Search..."
          />
        </div>
      </div> -->

      <div class="header-actions">
        <div class="dropdown">
          <button
            class="btn btn-light position-relative"
            type="button"
            data-bs-toggle="dropdown"
            id="notificationDropdown"
          >
            <i class="bi bi-bell"></i>
            <span
              class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
              id="notificationBadge"
            >
              <span id="notificationCount">0</span>
            </span>
          </button>

          <ul
            class="dropdown-menu dropdown-menu-end p-0 shadow-sm"
            style="min-width: 300px; max-height: 400px; overflow-y: auto"
            id="notificationList"
          >
            <li>
              <h6 class="dropdown-header bg-light border-bottom">
                Notifications
              </h6>
            </li>
            <li id="notificationsContainer">
              <div
                class="text-center py-3 text-muted small"
                id="noNotifications"
              >
                No new notifications
              </div>
            </li>
            <li><hr class="dropdown-divider" /></li>
            <li>
              <a
                class="dropdown-item text-center fw-bold text-primary"
                href="#"
                id="viewAllNotifications"
              >
                View all notifications
              </a>
            </li>
          </ul>
        </div>

        <div class="dropdown">
          <button
            class="btn btn-light d-flex align-items-center"
            type="button"
            data-bs-toggle="dropdown"
          >
            <img
              id="userProfilePic"
              src="https://picsum.photos/seed/user/40/40.jpg"
              class="rounded-circle me-2 img-fluid profile-avatar"
              alt="User"
              style="width: 40px; height: 40px; object-fit: cover"
            />
            <span id="currentUser"></span>
          </button>
          <ul class="dropdown-menu">
            <li>
              <a
                class="dropdown-item"
                href="#"
                id="profileNavLink"
                data-page="profile"
              >
                <i class="bi bi-person me-2"></i>Profile
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="#" data-page="settings"
                ><i class="bi bi-gear me-2"></i>Settings</a
              >
            </li>
            <li><hr class="dropdown-divider" /></li>
            <li>
              <a class="dropdown-item" href="./auth/login.html"
                ><i class="bi bi-box-arrow-right me-2"></i>
                <span onclick="logout(this)">Logout</span>
              </a>
            </li>
          </ul>
        </div>

        <!-- <div class="theme-toggle" id="themeToggle">
          <div class="theme-toggle-slider"></div>
        </div> -->
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Dashboard Page -->
      <div id="dashboard-page" class="page-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="mb-0">Dashboard Overview</h2>
          <div>
            <button id="exportDashboardBtn" class="btn btn-primary me-2">
              <i class="bi bi-download me-2"></i>Export Report
            </button>
            <button
              id="dateRangeBtn"
              class="btn btn-outline-primary"
              data-bs-toggle="modal"
              data-bs-target="#dateRangeModal"
            >
              <i class="bi bi-calendar3 me-2"></i>Date Range
            </button>
          </div>
        </div>

        <!-- KPI Cards -->
        <div class="row mb-4">
          <div class="col-xl-3 col-md-6 mb-3">
            <div class="kpi-card primary">
              <div class="kpi-value usercount">2,451</div>
              <div class="kpi-label">Total Registered Users</div>
              <div class="kpi-icon"><i class="bi bi-people-fill"></i></div>
            </div>
          </div>
          <div class="col-xl-3 col-md-6 mb-3">
            <div class="kpi-card success">
              <div class="kpi-value isActive">1,892</div>
              <div class="kpi-label">Active Users</div>
              <div class="kpi-icon">
                <i class="bi bi-person-check-fill"></i>
              </div>
            </div>
          </div>
          <div class="col-xl-3 col-md-6 mb-3">
            <div class="kpi-card warning">
              <div class="kpi-value" id="pending">231</div>
              <div class="kpi-label">Pending Requests</div>
              <div class="kpi-icon"><i class="bi bi-clock-history"></i></div>
            </div>
          </div>
          <div class="col-xl-3 col-md-6 mb-3">
            <div class="kpi-card info">
              <div class="kpi-value">₦2.4M</div>
              <div class="kpi-label">Total Revenue</div>
              <div class="kpi-icon"><i class="bi bi-currency-dollar"></i></div>
            </div>
          </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
          <div class="col-lg-8 mb-3">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">User Registration Trend</h5>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="registrationTrendChart"></canvas>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-4 mb-3">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Request Status</h5>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="requestStatusChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Activity -->
        <div class="row">
          <div class="col-lg-6 mb-3">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Recent Activity</h5>
              </div>
              <div class="card-body">
                <div class="activity-timeline">
                  <div class="activity-item">
                    <div class="activity-time">2 hours ago</div>
                    <div class="activity-content">
                      <strong>John Doe</strong> submitted an identity card
                      request
                    </div>
                  </div>
                  <div class="activity-item">
                    <div class="activity-time">4 hours ago</div>
                    <div class="activity-content">
                      <strong>Sarah Johnson</strong>'s certificate of origin was
                      approved
                    </div>
                  </div>
                  <div class="activity-item">
                    <div class="activity-time">6 hours ago</div>
                    <div class="activity-content">
                      <strong>Michael Brown</strong> was assigned Support Admin
                      role
                    </div>
                  </div>
                  <div class="activity-item">
                    <div class="activity-time">8 hours ago</div>
                    <div class="activity-content">
                      <strong>Emily Davis</strong> completed payment for
                      certificate request
                    </div>
                  </div>
                  <div class="activity-item">
                    <div class="activity-time">12 hours ago</div>
                    <div class="activity-content">
                      System maintenance completed successfully
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-6 mb-3">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Top LGAs by Requests</h5>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="topLGAChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Users Page -->
      <div id="users-page" class="page-content d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="mb-0">User Management</h2>
          <div class="d-flex gap-2">
            <button
              class="btn btn-primary"
              data-bs-toggle="modal"
              data-bs-target="#addUserModal"
            >
              <i class="bi bi-plus-circle me-2"></i>Add New User
            </button>
            <!-- Toggle buttons -->
            <div class="btn-group" role="group">
              <button
                type="button"
                class="btn btn-outline-primary active"
                id="chartsViewBtn"
              >
                <i class="bi bi-bar-chart me-1"></i>Charts & Summary
              </button>
              <button
                type="button"
                class="btn btn-outline-primary"
                id="tableViewBtn"
              >
                <i class="bi bi-table me-1"></i>Table View
              </button>
            </div>
          </div>
        </div>

        <!-- Charts and Summary View -->
        <div id="charts-summary-view">
          <div class="row mb-4">
            <div class="col-md-3 mb-3">
              <div class="card">
                <div class="card-body text-center">
                  <h3 class="text-primary usercount">2,451</h3>
                  <p class="mb-0">Total Users</p>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card">
                <div class="card-body text-center">
                  <h3 class="text-success isActive">1,892</h3>
                  <p class="mb-0">Active Users</p>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card">
                <div class="card-body text-center">
                  <h3 class="text-warning" id="inActive">559</h3>
                  <p class="mb-0">Inactive Users</p>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card">
                <div class="card-body text-center">
                  <h3 class="text-info" id="new-this-month">142</h3>
                  <p class="mb-0">New This Month</p>
                </div>
              </div>
            </div>
          </div>

          <div class="row mb-4">
            <div class="col-lg-4 mb-3">
              <div class="card">
                <div class="card-header">
                  <h5 class="mb-0">Age Distribution</h5>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="ageDistributionChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-4 mb-3">
              <div class="card">
                <div class="card-header">
                  <h5 class="mb-0">Gender Distribution</h5>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="genderDistributionChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-4 mb-3">
              <div class="card">
                <div class="card-header">
                  <h5 class="mb-0">State Distribution</h5>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="stateDistributionChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Table View -->
        <div id="table-view" class="d-none">
          <div class="card">
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <h5 class="mb-0">All Users</h5>
              <div class="export-buttons btn-group">
                <button onclick="exportTable('csv')">
                  <i class="bi bi-file-earmark-csv me-1"></i>CSV
                </button>
                <button onclick="exportTable('pdf')">
                  <i class="bi bi-file-earmark-pdf me-1"></i>PDF
                </button>
                <button onclick="window.print()">
                  <i class="bi bi-printer me-1"></i>Print
                </button>
              </div>
            </div>
            <div class="card-body">
              <table
                id="usersTable"
                class="table table-striped table-hover dt-responsive w-100"
              >
                <thead>
                  <tr>
                    <th>S/N</th>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>IsActive</th>
                    <th>State</th>
                    <th>LGA</th>
                    <th>Registered</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Identity Cards Page -->
      <div id="idcards-page" class="page-content d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="mb-0">Identity Card Requests</h2>
          <div class="d-flex gap-2">
            <button id="exportTdcardRequestBtn" class="btn btn-primary">
              <i class="bi bi-download me-2"></i>Export Report
            </button>
            <!-- Toggle buttons -->
            <div class="btn-group" role="group">
              <button
                type="button"
                class="btn btn-outline-primary active"
                id="idcardsChartsBtn"
              >
                <i class="bi bi-bar-chart me-1"></i>Charts & Summary
              </button>
              <button
                type="button"
                class="btn btn-outline-primary"
                id="idcardsTableBtn"
              >
                <i class="bi bi-table me-1"></i>Table View
              </button>
            </div>
          </div>
        </div>

        <!-- Charts and Summary View -->
        <div id="idcards-charts-view">
          <!-- ID Card Stats -->
          <div class="row mb-4">
            <div class="col-md-3 mb-3">
              <div class="card">
                <div class="card-body text-center">
                  <h3 class="text-primary totalRequests">892</h3>
                  <p class="mb-0">Total Requests</p>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card">
                <div class="card-body text-center">
                  <h3 class="text-success" id="approvedRequests">654</h3>
                  <p class="mb-0">Approved</p>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card">
                <div class="card-body text-center">
                  <h3 class="text-warning" id="pendingRequests">142</h3>
                  <p class="mb-0">Pending</p>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card">
                <div class="card-body text-center">
                  <h3 class="text-danger" id="rejectedRequests">96</h3>
                  <p class="mb-0">Rejected</p>
                </div>
              </div>
            </div>
          </div>

          <!-- ID Card Charts -->
          <div class="row mb-4">
            <div class="col-lg-8 mb-3">
              <div class="card">
                <div class="card-header">
                  <h5 class="mb-0">Request Trends</h5>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="idcardTrendChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-4 mb-3">
              <div class="card">
                <div class="card-header">
                  <h5 class="mb-0">Requests by State</h5>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="idcardStateChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Table View -->
        <div id="idcards-table-view" class="d-none">
          <!-- ID Card Requests Table -->
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">All Requests</h5>
            </div>
            <div class="card-body">
              <table
                id="idcardsTable"
                class="table table-striped table-hover dt-responsive w-100"
              >
                <thead>
                  <tr>
                    <th>S/N</th>
                    <th>ID</th>
                    <th>User</th>
                    <th>State</th>
                    <th>LGA</th>
                    <th>Status</th>
                    <th>Request Date</th>
                    <th>IsProfileCompleted</th>
                    <th>ApprovedBy</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Table data will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Certificates Page -->
      <div id="certificates-page" class="page-content d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="mb-0">Certificate of Origin Requests</h2>
          <div class="d-flex gap-2">
            <button class="btn btn-primary">
              <i class="bi bi-download me-2"></i>Export Report
            </button>
            <!-- Toggle buttons -->
            <div class="btn-group" role="group">
              <button
                type="button"
                class="btn btn-outline-primary active"
                id="certificatesChartsBtn"
              >
                <i class="bi bi-bar-chart me-1"></i>Charts & Summary
              </button>
              <button
                type="button"
                class="btn btn-outline-primary"
                id="certificatesTableBtn"
              >
                <i class="bi bi-table me-1"></i>Table View
              </button>
            </div>
          </div>
        </div>

        <!-- Charts and Summary View -->
        <div id="certificates-charts-view">
          <div class="row mb-4">
            <div class="col-md-3 mb-3">
              <div class="card">
                <div class="card-body text-center">
                  <h3 class="text-primary totalCertRequests">523</h3>
                  <p class="mb-0">Total Requests</p>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card">
                <div class="card-body text-center">
                  <h3 class="text-success" id="approvedCertRequests">412</h3>
                  <p class="mb-0">Approved</p>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card">
                <div class="card-body text-center">
                  <h3 class="text-warning" id="pendingCertRequests">89</h3>
                  <p class="mb-0">Pending</p>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card">
                <div class="card-body text-center">
                  <h3 class="text-danger" id="rejectedCertRequests">22</h3>
                  <p class="mb-0">Rejected</p>
                </div>
              </div>
            </div>
          </div>

          <div class="row mb-4">
            <div class="col-lg-6 mb-3">
              <div class="card">
                <div class="card-header">
                  <h5 class="mb-0">Daily Breakdown</h5>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="certificateDailyChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-6 mb-3">
              <div class="card">
                <div class="card-header">
                  <h5 class="mb-0">Top LGAs</h5>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="certificateLGAChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Table View -->
        <div id="certificates-table-view" class="d-none">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">All Requests</h5>
            </div>
            <div class="card-body">
              <table
                id="certificatesTable"
                class="table table-striped table-hover dt-responsive w-100"
              >
                <thead>
                  <tr>
                    <th>S/N</th>
                    <th>ID</th>
                    <th>User</th>
                    <th>State</th>
                    <th>LGA</th>
                    <th>Status</th>
                    <th>Request Time</th>
                    <th>IsProfileCompleted</th>
                    <th>ApprovedBy</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Table data will be populated by JavaScript -->
                </tbody>
              </table>
              <div
                id="pdf-loader"
                style="
                  display: none;
                  position: fixed;
                  top: 50%;
                  left: 50%;
                  z-index: 9999;
                  transform: translate(-50%, -50%);
                "
              >
                <div
                  class="spinner-border text-primary"
                  role="status"
                  style="width: 3rem; height: 3rem"
                >
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Transactions Page -->
      <div id="transactions-page" class="page-content d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="mb-0">Transactions & Logs</h2>
          <div class="d-flex gap-2">
            <button id="exportTransactionsBtn" class="btn btn-primary">
              <i class="bi bi-download me-2"></i>Export Report
            </button>
            <!-- Toggle buttons -->
            <div class="btn-group" role="group">
              <button
                type="button"
                class="btn btn-outline-primary active"
                id="transactionsChartsBtn"
              >
                <i class="bi bi-bar-chart me-1"></i>Charts & Summary
              </button>
              <button
                type="button"
                class="btn btn-outline-primary"
                id="transactionsTableBtn"
              >
                <i class="bi bi-table me-1"></i>Table View
              </button>
            </div>
          </div>
        </div>

        <!-- Charts and Summary View -->
        <div id="transactions-charts-view">
          <!-- Transaction Stats -->
          <div class="row mb-4">
            <div class="col-md-3 mb-3">
              <div class="card">
                <div class="card-body text-center">
                  <h3 class="text-primary total-transactions">1,842</h3>
                  <p class="mb-0">Total Transactions</p>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card">
                <div class="card-body text-center">
                  <h3 class="text-success total-revenue">₦2.4M</h3>
                  <p class="mb-0">Total Revenue</p>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card">
                <div class="card-body text-center">
                  <h3 class="text-info average-amount">₦1,302</h3>
                  <p class="mb-0">Average Transaction</p>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card">
                <div class="card-body text-center">
                  <h3 class="text-warning success-rate">98.2%</h3>
                  <p class="mb-0">Success Rate</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Transaction Charts -->
          <div class="row mb-4">
            <div class="col-lg-8 mb-3">
              <div class="card">
                <div class="card-header">
                  <h5 class="mb-0">Transactions Over Time</h5>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="transactionTrendChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-4 mb-3">
              <div class="card">
                <div class="card-header">
                  <h5 class="mb-0">Revenue by LGA</h5>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="revenueStateChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Table View -->
        <div id="transactions-table-view" class="d-none">
          <!-- Transactions Table -->
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">All Transactions</h5>
            </div>
            <div class="card-body">
              <table
                id="transactionsTable"
                class="table table-striped table-hover dt-responsive w-100"
              >
                <thead>
                  <tr>
                    <th>S/N</th>
                    <th>ID</th>
                    <th>User</th>
                    <th>Type</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Date & Time</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Table data will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Analytics Page -->
      <div id="analytics-page" class="page-content d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="mb-0">Analytics & Reports</h2>
          <div>
            <button class="btn btn-outline-primary me-2">
              <i class="bi bi-calendar3 me-2"></i>Date Range
            </button>
            <button class="btn btn-primary">
              <i class="bi bi-download me-2"></i>Generate Report
            </button>
          </div>
        </div>

        <!-- Analytics Charts -->
        <div class="row mb-4">
          <div class="col-lg-6 mb-3">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">User Growth vs Request Volume</h5>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="growthComparisonChart"></canvas>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-6 mb-3">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Request Processing Time</h5>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="processingTimeChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Map View -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Geographic Distribution</h5>
              </div>
              <div class="card-body">
                <div
                  id="mapView"
                  style="height: 400px; border-radius: 10px"
                ></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Performance Metrics -->
        <div class="row">
          <div class="col-lg-4 mb-3">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">System Performance</h5>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <div class="d-flex justify-content-between mb-1">
                    <span>Server Response Time</span>
                    <span>120ms</span>
                  </div>
                  <div class="progress" style="height: 8px">
                    <div
                      class="progress-bar bg-success"
                      style="width: 85%"
                    ></div>
                  </div>
                </div>
                <div class="mb-3">
                  <div class="d-flex justify-content-between mb-1">
                    <span>Database Query Time</span>
                    <span>45ms</span>
                  </div>
                  <div class="progress" style="height: 8px">
                    <div
                      class="progress-bar bg-success"
                      style="width: 90%"
                    ></div>
                  </div>
                </div>
                <div class="mb-3">
                  <div class="d-flex justify-content-between mb-1">
                    <span>API Response Time</span>
                    <span>180ms</span>
                  </div>
                  <div class="progress" style="height: 8px">
                    <div
                      class="progress-bar bg-warning"
                      style="width: 70%"
                    ></div>
                  </div>
                </div>
                <div class="mb-3">
                  <div class="d-flex justify-content-between mb-1">
                    <span>System Uptime</span>
                    <span>99.8%</span>
                  </div>
                  <div class="progress" style="height: 8px">
                    <div
                      class="progress-bar bg-success"
                      style="width: 99.8%"
                    ></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-8 mb-3">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Request Type Distribution</h5>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="requestTypeChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Roles Page -->
      <div id="roles-page" class="page-content d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="mb-0">Role Management</h2>
          <div class="d-flex gap-2">
            <button
              class="btn btn-primary"
              data-bs-toggle="modal"
              data-bs-target="#addRoleModal"
            >
              <i class="bi bi-plus-circle me-2"></i>Add New Role
            </button>
            <!-- Toggle buttons -->
            <div class="btn-group" role="group">
              <button
                type="button"
                class="btn btn-outline-primary active"
                id="rolesChartsBtn"
              >
                <i class="bi bi-bar-chart me-1"></i>Charts & Summary
              </button>
              <button
                type="button"
                class="btn btn-outline-primary"
                id="rolesTableBtn"
              >
                <i class="bi bi-table me-1"></i>Table View
              </button>
            </div>
          </div>
        </div>

        <!-- Charts and Summary View -->
        <div id="roles-charts-view">
          <!-- Role Distribution -->
          <div class="row mb-4">
            <div class="col-lg-6 mb-3">
              <div class="card">
                <div class="card-header">
                  <h5 class="mb-0">Role Distribution</h5>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="roleDistributionChart"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-lg-6 mb-3">
              <div class="card shadow-sm">
                <div
                  class="card-header d-flex justify-content-between align-items-center"
                >
                  <h5 class="mb-0">Role Permissions</h5>
                  <button
                    id="refreshRoleStats"
                    class="btn btn-sm btn-outline-primary"
                  >
                    <i class="fas fa-sync-alt"></i> Refresh
                  </button>
                </div>
                <div class="card-body">
                  <table class="table table-hover align-middle text-center">
                    <thead class="table-light">
                      <tr>
                        <th>Role</th>
                        <th>Users</th>
                        <th>Permissions</th>
                      </tr>
                    </thead>
                    <tbody id="roleStatsTableBody">
                      <tr>
                        <td colspan="3" class="text-muted">Loading...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Table View -->
        <div id="roles-table-view" class="d-none">
          <!-- Role Assignment -->
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">Role Assignment</h5>
            </div>
            <div class="card-body">
              <table
                id="rolesTable"
                class="table table-striped table-hover dt-responsive w-100"
              >
                <thead>
                  <tr>
                    <th>S/N</th>
                    <th>ID</th>
                    <th>User</th>
                    <th>Email</th>
                    <th>Current Role</th>
                    <th>Assigned By</th>
                    <th>Assigned Date</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Table data will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Toast Notification -->
      <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div
          id="settingsToast"
          class="toast"
          role="alert"
          aria-live="assertive"
          aria-atomic="true"
        >
          <div class="toast-header">
            <strong class="me-auto">Settings</strong>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="toast"
              aria-label="Close"
            ></button>
          </div>
          <div class="toast-body" id="toastMessage">
            Settings saved successfully!
          </div>
        </div>
      </div>

      <!-- Profile Page -->
      <div id="profile-page" class="page-content d-none">
        <div class="row">
          <div class="col-md-4 mb-4">
            <div class="card">
              <div class="card-body text-center">
                <div class="profile-photo-container">
                  <img
                    src="https://picsum.photos/seed/admin/150/150.jpg"
                    class="rounded-circle mb-3"
                    id="profilePhotoImg"
                    alt="Profile"
                  />
                  <div class="profile-photo-upload" id="profilePhotoUpload">
                    <i class="bi bi-camera"></i>
                  </div>
                  <input
                    type="file"
                    id="profilePhotoInput"
                    accept="image/*"
                    style="display: none"
                  />
                </div>
                <div
                  class="progress mt-3"
                  id="uploadProgress"
                  style="display: none"
                >
                  <div
                    class="progress-bar"
                    role="progressbar"
                    style="width: 0%"
                  ></div>
                </div>
                <h4 id="profileName">Global Admin</h4>
                <p class="text-muted" id="profileRole">
                  global Admin - Makurdi LGA
                </p>
                <p class="text-muted" id="profileEmail">admin@otukpo.gov.ng</p>
                <button
                  class="btn btn-primary"
                  data-bs-toggle="modal"
                  data-bs-target="#editProfileModal"
                >
                  <i class="bi bi-pencil me-2"></i>Edit Profile
                </button>
              </div>
            </div>
          </div>
          <div class="col-md-8 mb-4">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Profile Information</h5>
              </div>
              <div class="card-body">
                <table class="table table-borderless">
                  <tr>
                    <td><strong>Full Name:</strong></td>
                    <td id="profileFullName">John Doe</td>
                  </tr>
                  <tr>
                    <td><strong>Email:</strong></td>
                    <td id="profileEmailFull">admin@otukpo.gov.ng</td>
                  </tr>
                  <tr>
                    <td><strong>Phone:</strong></td>
                    <td id="profilePhone">+234 803 123 4567</td>
                  </tr>
                  <tr>
                    <td><strong>Role:</strong></td>
                    <td>
                      <span class="role-badge global-admin">Global Admin</span>
                    </td>
                  </tr>

                  <tr>
                    <td><strong>Date Joined:</strong></td>
                    <td id="profileDateJoined">January 15, 2023</td>
                  </tr>
                  <tr>
                    <td><strong>Last Login:</strong></td>
                    <td id="profileLastLogin">Today, 09:30 AM</td>
                  </tr>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Security Settings</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <button
                      class="btn btn-outline-primary w-100"
                      id="changePasswordBtn"
                    >
                      <i class="bi bi-key me-2"></i>Change Password
                    </button>
                  </div>
                  <div class="col-md-6 mb-3">
                    <button
                      class="btn btn-outline-primary w-100"
                      id="enable2FABtn"
                    >
                      <i class="bi bi-shield-check me-2"></i>Enable Two-Factor
                      Authentication
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Page -->
      <div id="settings-page" class="page-content d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="mb-0">Settings</h2>
          <button id="saveSettingsBtn" class="btn btn-primary">
            <i class="bi bi-check-circle me-2"></i>Save Changes
          </button>
        </div>

        <div class="row">
          <div class="col-lg-4 mb-4">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">System Settings</h5>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label class="form-label">System Name</label>
                  <input type="text" id="systemName" class="form-control" />
                </div>
                <div class="mb-3">
                  <label class="form-label">System Email</label>
                  <input type="email" id="systemEmail" class="form-control" />
                </div>
                <div class="mb-3">
                  <label class="form-label">Default Currency</label>
                  <select id="currency" class="form-select">
                    <option value="NGN">Nigerian Naira (₦)</option>
                    <option value="USD">US Dollar ($)</option>
                    <option value="EUR">Euro (€)</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Date Format</label>
                  <select id="dateFormat" class="form-select">
                    <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                    <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                    <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Time Zone</label>
                  <select id="timezone" class="form-select">
                    <option value="West Africa Time (WAT)">
                      West Africa Time (WAT)
                    </option>
                    <option value="Greenwich Mean Time (GMT)">
                      Greenwich Mean Time (GMT)
                    </option>
                    <option value="Central European Time (CET)">
                      Central European Time (CET)
                    </option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-4 mb-4">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Notification Settings</h5>
              </div>
              <div class="card-body">
                <div class="mb-3 form-check form-switch">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="emailNotifications"
                  />
                  <label class="form-check-label" for="emailNotifications">
                    Email Notifications
                  </label>
                </div>
                <div class="mb-3 form-check form-switch">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="smsNotifications"
                  />
                  <label class="form-check-label" for="smsNotifications">
                    SMS Notifications
                  </label>
                </div>
                <div class="mb-3 form-check form-switch">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="pushNotifications"
                  />
                  <label class="form-check-label" for="pushNotifications">
                    Push Notifications
                  </label>
                </div>
                <div class="mb-3 form-check form-switch">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="newUserAlerts"
                  />
                  <label class="form-check-label" for="newUserAlerts">
                    New User Alerts
                  </label>
                </div>
                <div class="mb-3 form-check form-switch">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="requestAlerts"
                  />
                  <label class="form-check-label" for="requestAlerts">
                    Request Alerts
                  </label>
                </div>
                <div class="mb-3 form-check form-switch">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="systemAlerts"
                  />
                  <label class="form-check-label" for="systemAlerts">
                    System Alerts
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-4 mb-4">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Security Settings</h5>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label class="form-label">Session Timeout (minutes)</label>
                  <input
                    type="number"
                    id="sessionTimeout"
                    class="form-control"
                  />
                </div>
                <div class="mb-3 form-check form-switch">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="twoFactorAuth"
                  />
                  <label class="form-check-label" for="twoFactorAuth">
                    Two-Factor Authentication
                  </label>
                </div>
                <div class="mb-3 form-check form-switch">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="passwordComplexity"
                  />
                  <label class="form-check-label" for="passwordComplexity">
                    Enforce Password Complexity
                  </label>
                </div>
                <div class="mb-3 form-check form-switch">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="limitLoginAttempts"
                  />
                  <label class="form-check-label" for="limitLoginAttempts">
                    Limit Login Attempts
                  </label>
                </div>
                <div class="mb-3">
                  <label class="form-label">Max Login Attempts</label>
                  <input
                    type="number"
                    id="maxLoginAttempts"
                    class="form-control"
                  />
                </div>
                <div class="mb-3">
                  <label class="form-label">Lockout Duration (minutes)</label>
                  <input
                    type="number"
                    id="lockoutDuration"
                    class="form-control"
                  />
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-4 mb-4">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Verification Limits</h5>
              </div>
              <div class="card-body">
                <p class="text-muted small mb-3">
                  Set the minimum number of verified family members and
                  neighbors required for a user's profile to be considered
                  complete.
                </p>
                <div class="mb-3">
                  <label for="familyVerificationLimit" class="form-label"
                    >Family Verification Limit</label
                  >
                  <input
                    type="number"
                    id="familyVerificationLimit"
                    class="form-control"
                    min="1"
                  />
                </div>
                <div class="mb-3">
                  <label for="neighborVerificationLimit" class="form-label"
                    >Neighbor Verification Limit</label
                  >
                  <input
                    type="number"
                    id="neighborVerificationLimit"
                    class="form-control"
                    min="1"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">API Configuration</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Base API URL</label>
                    <input type="text" id="apiBaseUrl" class="form-control" />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">API Key</label>
                    <div class="input-group">
                      <input type="password" id="apiKey" class="form-control" />
                      <button
                        class="btn btn-outline-secondary"
                        type="button"
                        id="toggleApiKey"
                      >
                        <i class="bi bi-eye"></i>
                      </button>
                    </div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Webhook URL</label>
                    <input type="text" id="webhookUrl" class="form-control" />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Webhook Secret</label>
                    <input
                      type="password"
                      id="webhookSecret"
                      class="form-control"
                    />
                  </div>
                </div>
                <div class="mt-3">
                  <button id="testApiBtn" class="btn btn-primary me-2">
                    Test API Connection
                  </button>
                  <button
                    id="regenerateApiKeyBtn"
                    class="btn btn-outline-primary"
                  >
                    Regenerate API Key
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    <!-- Change Password Modal -->
    <div
      class="modal fade"
      id="changePasswordModal"
      tabindex="-1"
      aria-labelledby="changePasswordModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="changePasswordModalLabel">
              Change Password
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="changePasswordForm">
              <div class="mb-3">
                <label for="currentPassword" class="form-label"
                  >Current Password</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="currentPassword"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="newPassword" class="form-label">New Password</label>
                <input
                  type="password"
                  class="form-control"
                  id="newPassword"
                  required
                />
                <div class="password-strength" id="passwordStrength"></div>
                <div class="form-text" id="passwordStrengthText"></div>
              </div>
              <div class="mb-3">
                <label for="confirmPassword" class="form-label"
                  >Confirm New Password</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="confirmPassword"
                  required
                />
                <div class="invalid-feedback" id="passwordMatchFeedback">
                  Passwords do not match.
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-primary" id="savePasswordBtn">
              Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Enable 2FA Modal -->
    <div
      class="modal fade"
      id="enable2FAModal"
      tabindex="-1"
      aria-labelledby="enable2FAModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="enable2FAModalLabel">
              Enable Two-Factor Authentication
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div id="2faSetupStep1">
              <p>
                Two-factor authentication adds an extra layer of security to
                your account. Once enabled, you'll need to enter a verification
                code in addition to your password when signing in.
              </p>
              <p>Click "Continue" to set up two-factor authentication.</p>
            </div>

            <div id="2faSetupStep2" style="display: none">
              <h6>Step 1: Scan the QR code</h6>
              <p>
                Use your authenticator app (like Google Authenticator, Authy, or
                Microsoft Authenticator) to scan the QR code below:
              </p>
              <div class="qr-code">
                <img
                  src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=otpauth://totp/Example:demo@example.com?secret=JBSWY3DPEHPK3PXP&issuer=Example"
                  alt="QR Code"
                />
              </div>
              <p class="text-center mt-2">
                Or manually enter this code: <strong>JBSWY3DPEHPK3PXP</strong>
              </p>

              <h6 class="mt-4">Step 2: Enter verification code</h6>
              <p>Enter the 6-digit code from your authenticator app:</p>
              <div class="mb-3">
                <input
                  type="text"
                  class="form-control"
                  id="verificationCode"
                  placeholder="000000"
                  maxlength="6"
                  pattern="[0-9]{6}"
                />
              </div>
            </div>

            <div id="2faSetupStep3" style="display: none">
              <h6>Save your backup codes</h6>
              <p>
                These backup codes can be used to access your account if you
                lose your device. Save them somewhere safe.
              </p>
              <div class="backup-codes">
                <code>12345678</code>
                <code>23456789</code>
                <code>34567890</code>
                <code>45678901</code>
                <code>56789012</code>
                <code>67890123</code>
                <code>78901234</code>
                <code>89012345</code>
                <code>90123456</code>
                <code>01234567</code>
              </div>
              <div class="form-check mt-3">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="backupCodesSaved"
                />
                <label class="form-check-label" for="backupCodesSaved">
                  I have saved my backup codes
                </label>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-primary" id="2faContinueBtn">
              Continue
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="2faVerifyBtn"
              style="display: none"
            >
              Verify
            </button>
            <button
              type="button"
              class="btn btn-success"
              id="2faFinishBtn"
              style="display: none"
            >
              Finish Setup
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Profile Modal -->
    <div
      class="modal fade"
      id="editProfileModal"
      tabindex="-1"
      aria-labelledby="editProfileModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editProfileModalLabel">Edit Profile</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editProfileForm">
              <div class="mb-3">
                <label for="editProfileFirstName" class="form-label"
                  >First Name</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="editProfileFirstName"
                  required
                />
              </div>

              <div class="mb-3">
                <label for="editProfileLastName" class="form-label"
                  >Last Name</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="editProfileLastName"
                  required
                />
              </div>

              <div class="mb-3">
                <label for="editProfileEmail" class="form-label"
                  >Email Address</label
                >
                <input
                  type="email"
                  class="form-control"
                  id="editProfileEmail"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="editProfilePhone" class="form-label"
                  >Phone Number</label
                >
                <input
                  type="tel"
                  class="form-control"
                  id="editProfilePhone"
                  required
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-primary" id="saveProfileBtn">
              Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add User Modal -->
    <div
      class="modal fade"
      id="addUserModal"
      tabindex="-1"
      aria-labelledby="addUserModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addUserModalLabel">Add New User</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>

          <div class="modal-body">
            <form id="addUserForm">
              <div class="row g-3">
                <!-- Date of birth -->
                <div class="mb-3">
                  <input id="DOB" type="text" hidden />
                </div>
                <!-- NIN -->
                <div class="col-md-6">
                  <label class="form-label">NIN</label>
                  <input
                    type="text"
                    class="form-control"
                    id="userNIN"
                    maxlength="11"
                    minlength="11"
                    required
                  />
                  <div id="ninStatus" class="mt-1 text-sm text-info"></div>
                </div>
                <!-- FIRSTNAME -->
                <div class="col-md-6">
                  <label class="form-label">First Name</label>
                  <input
                    type="text"
                    class="form-control"
                    id="firstName"
                    required
                  />
                </div>

                <!-- MIDDLENAME -->
                <div class="col-md-6">
                  <label class="form-label">Middle Name</label>
                  <input
                    type="text"
                    class="form-control"
                    id="middleName"
                    required
                  />
                </div>

                <!-- LASTNAME -->
                <div class="col-md-6">
                  <label class="form-label">Last Name</label>
                  <input
                    type="text"
                    class="form-control"
                    id="lastName"
                    required
                  />
                </div>

                <!-- EMAIL -->
                <div class="col-md-6">
                  <label class="form-label">Email</label>
                  <input
                    type="email"
                    class="form-control"
                    id="userEmail"
                    required
                  />
                </div>

                <!-- PHONE -->
                <div class="col-md-6">
                  <label class="form-label">Phone</label>
                  <input
                    type="tel"
                    class="form-control"
                    id="userPhone"
                    maxlength="11"
                    minlength="11"
                    required
                  />
                </div>

                <!-- ROLE (DYNAMIC) -->
                <div class="col-md-6">
                  <label class="form-label">Role</label>
                  <select id="userRole" class="form-select" required>
                    <option value="">Select Role</option>
                  </select>
                </div>

                <!-- STATE -->
                <div class="col-md-6">
                  <label class="form-label">State of Origin</label>
                  <select id="userState" class="form-select" required>
                    <option value="">Select State</option>
                    <option value="abia">Abia</option>
                    <option value="adamawa">Adamawa</option>
                    <option value="akwa_ibom">Akwa Ibom</option>
                    <option value="anambra">Anambra</option>
                    <option value="bauchi">Bauchi</option>
                    <option value="bayelsa">Bayelsa</option>
                    <option value="benue">Benue</option>
                    <option value="borno">Borno</option>
                    <option value="cross_river">Cross River</option>
                    <option value="delta">Delta</option>
                    <option value="ebonyi">Ebonyi</option>
                    <option value="edo">Edo</option>
                    <option value="ekiti">Ekiti</option>
                    <option value="enugu">Enugu</option>
                    <option value="gombe">Gombe</option>
                    <option value="imo">Imo</option>
                    <option value="jigawa">Jigawa</option>
                    <option value="kaduna">Kaduna</option>
                    <option value="kano">Kano</option>
                    <option value="katsina">Katsina</option>
                    <option value="kebbi">Kebbi</option>
                    <option value="kogi">Kogi</option>
                    <option value="kwara">Kwara</option>
                    <option value="lagos">Lagos</option>
                    <option value="nasarawa">Nasarawa</option>
                    <option value="niger">Niger</option>
                    <option value="ogun">Ogun</option>
                    <option value="ondo">Ondo</option>
                    <option value="osun">Osun</option>
                    <option value="oyo">Oyo</option>
                    <option value="plateau">Plateau</option>
                    <option value="rivers">Rivers</option>
                    <option value="sokoto">Sokoto</option>
                    <option value="taraba">Taraba</option>
                    <option value="yobe">Yobe</option>
                    <option value="zamfara">Zamfara</option>
                    <option value="abuja">Abuja (FCT)</option>
                  </select>
                </div>

                <!-- LGA -->
                <div class="col-md-6">
                  <label class="form-label">LGA of Origin</label>
                  <select id="userLGA" class="form-select" required>
                    <option value="">Select Local Government</option>
                  </select>
                </div>
              </div>
            </form>
          </div>

          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" id="addUserBtn" class="btn btn-primary">
              Add User
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Role Modal -->
    <div
      class="modal fade"
      id="addRoleModal"
      tabindex="-1"
      aria-labelledby="addRoleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addRoleModalLabel">Add New Role</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="mb-3">
                <label for="roleName" class="form-label">Role Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="roleName"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="roleDescription" class="form-label"
                  >Description</label
                >
                <textarea
                  class="form-control"
                  id="roleDescription"
                  rows="3"
                ></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">Permissions</label>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="permDashboard"
                  />
                  <label class="form-check-label" for="permDashboard">
                    View Dashboard
                  </label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="permUsers"
                  />
                  <label class="form-check-label" for="permUsers">
                    Manage Users
                  </label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="permRequests"
                  />
                  <label class="form-check-label" for="permRequests">
                    Manage Requests
                  </label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="permReports"
                  />
                  <label class="form-check-label" for="permReports">
                    View Reports
                  </label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="permSettings"
                  />
                  <label class="form-check-label" for="permSettings">
                    Access Settings
                  </label>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-primary">Add Role</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Change Role Modal -->
    <div
      class="modal fade"
      id="changeRoleModal"
      tabindex="-1"
      aria-labelledby="changeRoleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="changeRoleModalLabel">
              Change User Role
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="changeRoleForm">
              <input type="hidden" id="changeRoleUserId" />
              <div class="mb-3">
                <label for="changeRoleUser" class="form-label">User</label>
                <input
                  type="text"
                  class="form-control"
                  id="changeRoleUser"
                  readonly
                />
              </div>
              <div class="mb-3">
                <label for="changeRoleNew" class="form-label">New Role</label>
                <select class="form-select" id="changeRoleNew" required>
                  <!-- <option value="super_admin">Super Admin</option> -->
                  <!-- <option value="support_admin">Support Admin</option>
                  <option value="kindred_head">Kindred Head</option>                  
                  <option value="user">User</option> -->
                </select>
              </div>
              <div class="mb-3">
                <label for="changeRoleReason" class="form-label"
                  >Reason for Change</label
                >
                <textarea
                  class="form-control"
                  id="changeRoleReason"
                  rows="3"
                ></textarea>
              </div>

              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                  Update Role
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- 📝 Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
      <div class="modal-dialog">
        <form id="editUserForm" class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit User</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editUserId" />
            <div class="mb-3">
              <label>First Name</label>
              <input
                type="text"
                class="form-control"
                id="editFirstname"
                required
              />
            </div>
            <div class="mb-3">
              <label>Last Name</label>
              <input
                type="text"
                class="form-control"
                id="editLastname"
                required
              />
            </div>
            <div class="mb-3">
              <label>Email</label>
              <input
                type="email"
                class="form-control"
                id="editEmail"
                required
              />
            </div>
            <div class="mb-3">
              <label>Phone</label>
              <input type="text" class="form-control" id="editPhone" />
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>

    <!-- View Request Modal -->
    <div
      class="modal fade"
      id="viewRequestModal"
      tabindex="-1"
      aria-labelledby="viewRequestModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="viewRequestModalLabel">
              ID Card Request Details
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div id="viewRequestContent" class="p-3">
              <div class="text-center">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">Loading request details...</p>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- View Cert Requet Modal -->
    <div
      class="modal fade"
      id="viewCertRequestModal"
      tabindex="-1"
      aria-labelledby="viewCertRequestModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="viewCertRequestModalLabel">
              User Certificate Request Details
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div id="viewCertRequestContent" class="p-3">
              <div class="text-center">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">Loading request details...</p>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- View Modal -->
    <div
      id="viewModal"
      class="modal fade"
      tabindex="-1"
      role="dialog"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">User Details</h5>
            <button
              type="button"
              data-bs-dismiss="modal"
              class="close"
              aria-label="Close"
              onclick="closeModal('details-modal')"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <!-- User details will be loaded here -->
          </div>
          <div class="modal-footer">
            <button
              data-bs-dismiss="modal"
              type="button"
              class="btn btn-secondary"
              onclick="closeModal('details-modal')"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Request Action Modal -->
    <div
      class="modal fade"
      id="requestActionModal"
      tabindex="-1"
      aria-labelledby="requestActionModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="requestActionModalLabel">
              Request Action
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="requestActionForm">
              <div class="mb-3">
                <label for="requestActionType" class="form-label">Action</label>
                <select class="form-select" id="requestActionType" required>
                  <option value="approve">Approve</option>
                  <option value="reject">Reject</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="requestActionReason" class="form-label"
                  >Reason</label
                >
                <textarea
                  class="form-control"
                  id="requestActionReason"
                  rows="3"
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="submitRequestActionBtn"
            >
              Submit
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div
      class="modal fade"
      id="confirmActionModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirm Action</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <p id="confirmActionMessage"></p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-danger" id="confirmActionBtn">
              Confirm
            </button>
          </div>
        </div>
      </div>
    </div>

    <!--  Date Range Modal -->
    <div
      class="modal fade"
      id="dateRangeModal"
      tabindex="-1"
      aria-labelledby="dateRangeModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="dateRangeModalLabel">
              Select Date Range
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="dateRangeForm">
              <div class="mb-3">
                <label for="startDate" class="form-label">Start Date</label>
                <input type="date" class="form-control" id="startDate" />
              </div>
              <div class="mb-3">
                <label for="endDate" class="form-label">End Date</label>
                <input type="date" class="form-control" id="endDate" />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              id="applyDateRangeBtn"
              class="btn btn-primary"
            >
              Apply
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="bg-white text-center text-lg-start mt-auto shadow-sm">
      <div class="text-center p-3">© 2025 BDIC. All rights reserved.</div>
    </footer>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Your Custom Script -->
    <script type="text/javascript" src="../js/index.js"></script>

    <script>
      // Initialize DataTables
      let usersTable,
        idcardsTable,
        certificatesTable,
        transactionsTable,
        rolesTable;

      // Initialize Charts
      let registrationTrendChart, requestStatusChart, topLGAChart;
      let ageDistributionChart, genderDistributionChart, stateDistributionChart;
      let idcardTrendChart, idcardStateChart;
      let certificateDailyChart, certificateLGAChart;
      let transactionTrendChart, revenueStateChart;
      let growthComparisonChart, processingTimeChart, requestTypeChart;
      let roleDistributionChart;

      // Add this to your script to store the current date range
      let currentDashboardFilters = {
        startDate: null,
        endDate: null,
      };

      // Page Navigation
      $(document).ready(function () {
        fetchUsersData();

        loadUserData();
        $(".password-toggle").click(function () {
          const targetSelector = $(this).data("target");
          const input = $(targetSelector);
          const type = input.attr("type") === "password" ? "text" : "password";
          input.attr("type", type);
          $(this).find("i").toggleClass("fa-eye fa-eye-slash");
        });

        // Password validation
        $("#userPassword").on("input", function () {
          const password = $(this).val();

          // Validation checks
          const lengthValid = password.length >= 8;
          const symbolValid = /[!@#$%^&*(),.?":{}|<>]/.test(password);
          const capitalValid = /[A-Z]/.test(password);
          const numberValid = /\d/.test(password);

          // Update UI
          updateValidationIcon("#lengthCheck", "#lengthText", lengthValid);
          updateValidationIcon("#symbolCheck", "#symbolText", symbolValid);
          updateValidationIcon("#capitalCheck", "#capitalText", capitalValid);
          updateValidationIcon("#numberCheck", "#numberText", numberValid);
        });
        function updateValidationIcon(iconId, textId, isValid) {
          if (isValid) {
            $(iconId).removeClass("invalid").addClass("valid");
            $(textId).removeClass("invalid").addClass("valid");
          } else {
            $(iconId).removeClass("valid").addClass("invalid");
            $(textId).removeClass("valid").addClass("invalid");
          }
        }

        // Initialize dashboard
        initializeDashboard();

        // SPA Navigation (for both sidebar and header profile link)
        $(".sidebar-menu .nav-link, #profileNavLink").on("click", function (e) {
          e.preventDefault();
          const page = $(this).data("page");
          showPage(page);

          // Update active state in the sidebar
          $(".sidebar-menu .nav-link").removeClass("active");
          $(`.sidebar-menu .nav-link[data-page="${page}"]`).addClass("active");

          // Close the header dropdown if it's open
          $("#profileNavLink")
            .closest(".dropdown")
            .find(".dropdown-toggle")
            .dropdown("hide");
        });
        // Toggle sidebar on small screens
        $("#sidebarToggle").on("click", function (e) {
          e.stopPropagation(); // Prevent the click from bubbling to document
          $("#sidebar").toggleClass("show");
        });

        // Prevent clicks inside the sidebar from closing it
        $(".sidebar").on("click", function (e) {
          e.stopPropagation();
        });

        // Hide sidebar when clicking outside
        $(document).on("click", function () {
          $(".sidebar").removeClass("show");
        });

        // Profile photo upload
        $("#profilePhotoUpload").on("click", function () {
          $("#profilePhotoInput").click();
        });

        $("#profilePhotoInput").on("change", function () {
          uploadProfilePhoto(this.files[0]);
        });

        // Theme toggle
        $("#themeToggle").on("click", function () {
          $(this).toggleClass("active");
          $("body").attr(
            "data-theme",
            $(this).hasClass("active") ? "dark" : "light"
          );
          localStorage.setItem(
            "theme",
            $(this).hasClass("active") ? "dark" : "light"
          );
        });

        // Load saved theme
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme === "dark") {
          $("#themeToggle").addClass("active");
          $("body").attr("data-theme", "dark");
        }

        // // Request action form submission
        // $("#submitRequestActionBtn").on("click", function () {

        //   submitRequestAction();
        // });

        $("#submitRequestActionBtn").on("click", function () {
          const action = $("#requestActionType").val(); // "approve" or "reject"
          const requestType = $("#requestActionModal").data("requestType");
          const reason = $("#requestActionReason").val();

          // Create appropriate warning message based on action
          const actionText = action === "approve" ? "approve" : "reject";
          const requestTypeText =
            requestType === "idcard" ? "ID Card" : "Certificate";
          let warningMessage = `Are you sure you want to ${actionText} this ${requestTypeText} request?`;

          // If rejecting and no reason is provided, warn about that too
          if (action === "reject" && !reason) {
            warningMessage +=
              "\n\nNote: You haven't provided a reason for rejection. It's recommended to add one.";
          }

          // Show confirmation modal
          $("#confirmActionMessage").text(warningMessage);
          $("#confirmActionBtn").attr("data-action", action);
          $("#confirmActionModal").modal("show");
        });

        // Handle confirmation button click
        $("#confirmActionBtn").on("click", function () {
          $("#confirmActionModal").modal("hide");
          submitRequestAction();
        });

        // API Key visibility toggle
        $("#toggleApiKey").on("click", function () {
          const apiKeyInput = $("#apiKey");
          const currentType = apiKeyInput.attr("type");
          apiKeyInput.attr(
            "type",
            currentType === "password" ? "text" : "password"
          );
          $(this).find("i").toggleClass("bi-eye bi-eye-slash");
        });

        // Change role modal
        $(".change-role-btn").on("click", function () {
          const userName = $(this).data("user");
          const userId = $(this).data("id");
          $("#changeRoleUser").val(userName);
          $("#changeRoleModal").data("userId", userId);
        });

        // Export Transactions Button
        $("#exportTransactionsBtn").on("click", function () {
          exportTransactionsToPDF();
        });

        // Date Range Button: Opens the modal and pre-fills dates
        $("#dateRangeBtn").on("click", function () {
          $("#startDate").val(currentDashboardFilters.startDate || "");
          $("#endDate").val(currentDashboardFilters.endDate || "");
        });

        // Apply Date Range Button
        $("#applyDateRangeBtn").on("click", function () {
          currentDashboardFilters.startDate = $("#startDate").val();
          currentDashboardFilters.endDate = $("#endDate").val();
          $("#dateRangeModal").modal("hide");
          // Re-initialize the dashboard with the new filters
          initializeDashboard();
        });

        // Export Dashboard Button
        $("#exportDashboardBtn").on("click", function () {
          exportDashboardToPDF();
        });

        // Profile form change tracking
        $(
          "#editProfileFirstName, #editProfileLastName, #editProfileEmail, #editProfilePhone"
        ).on("input change", function () {
          profileHasUnsavedChanges = true;
          saveProfileFormData();
        });

        // Edit profile form submission
        $("#saveProfileBtn").on("click", function () {
          updateProfile();
        });
        updateCurrentUserDisplay();
      });

      // Save profile form data to localStorage
      function saveProfileFormData() {
        const profileData = {
          firstname: $("#editProfileFirstName").val(),
          lastname: $("#editProfileLastName").val(),
          email: $("#editProfileEmail").val(),
          phone: $("#editProfilePhone").val(),
        };

        localStorage.setItem("profileFormData", JSON.stringify(profileData));
      }

      // Load profile form data from localStorage
      function loadProfileFormData() {
        const savedData = localStorage.getItem("profileFormData");
        if (savedData) {
          const profileData = JSON.parse(savedData);

          // Populate form fields
          $("#editProfileFirstName").val(profileData.firstname || "");
          $("#editProfileLastName").val(profileData.lastname || "");
          $("#editProfileEmail").val(profileData.email || "");
          $("#editProfilePhone").val(profileData.phone || "");

          return true;
        }
        return false;
      }

      async function updateCurrentUserDisplay() {
        try {
          const response = await $.ajax({
            url: `${BACKEND_URL}/users/me`,
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          const user = response; // expected user object from backend
          // Update user display
          $("#currentUser").text(user.firstname + " " + user.lastname);
          // ✅ Update user profile picture dynamically
          const profilePicUrl = user.passportPhoto
            ? user.passportPhoto
            : "https://picsum.photos/seed/user/40/40.jpg";

          $("#userProfilePic")
            .attr("src", profilePicUrl)
            .addClass("img-fluid rounded-circle profile-avatar");

          $("#profilePhotoImg").attr("src", user.passportPhoto);

          $("#currentUser").text(
            `${user?.firstname} ${user?.lastname}` || "N/A"
          );
          $("#currentLGA").text(user?.lgaOfOrigin || "N/A");
          $("#lgaState").text(user?.stateOfOrigin?.toUpperCase() || "N/A");
          $("#profileName").text(user?.lastname || "N/A");
          $("#profileRole").text(
            `${user?.role || "User"} - ${user?.lgaOfOrigin || ""} LGA`
          );
          $("#profileEmail").text(user?.email || "N/A");
          $("#profileFullName").text(
            `${user?.firstname} ${user?.lastname}` || "N/A"
          );
          $("#profileEmailFull").text(user?.email || "N/A");
          $("#profilePhone").text(user?.phone || "N/A");

          $("#profileDateJoined").text(
            user?.created_at
              ? new Date(user?.created_at).toLocaleDateString()
              : "N/A"
          );
          $("#profileLastLogin").text(
            user?.lastLogin ? new Date(user?.lastLogin).toLocaleString() : "N/A"
          );

          // Pre-fill edit profile form
          $("#editProfileFirstName").val(user?.firstname || "");
          $("#editProfileLastName").val(user?.lastname || "");

          $("#editProfileEmail").val(user?.email || "");
          $("#editProfilePhone").val(user?.phone || "");

          // Save current profile data to localStorage
          saveProfileFormData();
        } catch (error) {
          console.error("Failed to fetch current user:", error);
          showNotification(
            "Unable to load user profile. Please refresh or log in again.",
            "error"
          );

          // If server load fails, try to load from localStorage
          const hasLocalData = loadProfileFormData();
          if (!hasLocalData) {
            showNotification(
              "No local data available. Please check your connection.",
              "warning"
            );
          }
        }
      }

      async function uploadProfilePhoto(file) {
        if (!file) return;

        // Show progress bar
        $("#uploadProgress").show();
        $("#uploadProgress .progress-bar").css("width", "0%");

        // Prepare FormData for file upload
        const formData = new FormData();
        formData.append("passportPhoto", file); // field name must match your NestJS DTO

        try {
          // Perform AJAX upload
          const response = await $.ajax({
            url: `${BACKEND_URL}/users/${user.id}`,
            method: "PUT",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            data: formData,
            processData: false,
            contentType: false,
            xhr: function () {
              const xhr = new window.XMLHttpRequest();
              xhr.upload.addEventListener("progress", function (e) {
                if (e.lengthComputable) {
                  const percentComplete = (e.loaded / e.total) * 100;
                  $("#uploadProgress .progress-bar").css(
                    "width",
                    percentComplete + "%"
                  );
                }
              });
              return xhr;
            },
          });

          // ✅ Update photo preview on success
          if (response?.photoUrl) {
            $("#profilePhotoImg").attr("src", response.photoUrl);
          }
          updateCurrentUserDisplay();

          showNotification("Profile photo uploaded successfully", "success");
        } catch (xhr) {
          console.error("Upload failed:", xhr);
          showNotification(
            xhr.responseJSON?.message || "Failed to upload profile photo",
            "error"
          );
        } finally {
          // Hide loader after completion
          setTimeout(() => {
            $("#uploadProgress").hide();
            $("#uploadProgress .progress-bar").css("width", "0%");
          }, 800);
        }
      }

      function updateProfile() {
        const firstname = $("#editProfileFirstName").val().trim();
        const lastname = $("#editProfileLastName").val().trim();

        const email = $("#editProfileEmail").val().trim();
        const phone = $("#editProfilePhone").val().trim();

        if (!firstname || !lastname || !email || !phone) {
          showNotification("All fields are required.", "error");
          return;
        }

        // Disable button to prevent double submission
        $("#saveProfileBtn").prop("disabled", true).text("Saving...");

        $.ajax({
          url: `${BACKEND_URL}/users/${user.id}`,
          method: "PUT",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          data: JSON.stringify({ firstname, lastname, email, phone }),
          success: function (response) {
            // ✅ Update UI with new data
            $("#currentUser").text(
              `${response.firstname} ${response.lastname}` || firstname
            );
            $("#currentUserEmail").text(response.email || email);
            $("#currentUserPhone").text(response.phone || phone);

            // Close modal
            $("#editProfileModal").modal("hide");

            // Update display
            updateCurrentUserDisplay();

            // Show success message
            showNotification("Profile updated successfully", "success");

            // Clear saved form data after successful save
            localStorage.removeItem("profileFormData");

            // Reset the form change tracking after successful save
            profileHasUnsavedChanges = false;
          },
          error: function (xhr) {
            console.error("Error updating profile:", xhr.responseText);
            const message =
              xhr.responseJSON?.message || "Failed to update profile.";
            showNotification(message, "error");
          },
          complete: function () {
            $("#saveProfileBtn").prop("disabled", false).text("Save Changes");
          },
        });
      }

      function showPage(pageName) {
        // Hide all pages
        $(".page-content").addClass("d-none");

        // Show selected page
        $(`#${pageName}-page`).removeClass("d-none");

        // Initialize page-specific components
        switch (pageName) {
          case "dashboard":
            initializeDashboard();
            break;
          case "users":
            initializeUsersPage();
            break;
          case "idcards":
            initializeIdCardsPage();
            break;
          case "certificates":
            initializeCertificatesPage();
            break;
          case "transactions":
            initializeTransactionsPage();
            break;
          case "analytics":
            initializeAnalyticsPage();
            break;
          case "roles":
            initializeRolesPage();
            break;
          case "settings":
            // Settings page doesn't need special initialization
            break;
        }
      }

      async function loadUserData() {
        try {
          const response = await $.ajax({
            url: `${BACKEND_URL}/users/me`,
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          const user = response; // expected user object from backend
          // Update user display
          $("#currentUser").text(user.firstname + " " + user.lastname);
          // ✅ Update user profile picture dynamically
          const profilePicUrl = user.passportPhoto
            ? user.passportPhoto
            : "https://picsum.photos/seed/admin/40/40.jpg";

          $("#userProfilePic")
            .attr("src", profilePicUrl)
            .addClass("img-fluid rounded-circle profile-avatar");
        } catch (error) {
          console.error("Failed to fetch current user:", error);
          showNotification(
            "Unable to load user profile. Please refresh or log in again.",
            "error"
          );
        }
      }

      async function initializeDashboard() {
        // Construct the query string from filters
        const queryParams = new URLSearchParams();
        if (currentDashboardFilters.startDate)
          queryParams.append("startDate", currentDashboardFilters.startDate);
        if (currentDashboardFilters.endDate)
          queryParams.append("endDate", currentDashboardFilters.endDate);

        $.ajax({
          url: `${BACKEND_URL}/users/dashboard-stats?${queryParams.toString()}`,
          method: "GET",
          headers: { Authorization: `Bearer ${token}` },
          success: function (data) {
            // --- Destroy old charts if they exist ---
            if (registrationTrendChart) registrationTrendChart.destroy();
            if (requestStatusChart) requestStatusChart.destroy();
            if (topLGAChart) topLGAChart.destroy();
            // --- Registration Trend ---
            const ctx1 = document
              .getElementById("registrationTrendChart")
              .getContext("2d");
            registrationTrendChart = new Chart(ctx1, {
              type: "line",
              data: {
                labels: [
                  "Jan",
                  "Feb",
                  "Mar",
                  "Apr",
                  "May",
                  "Jun",
                  "Jul",
                  "Aug",
                  "Sep",
                  "Oct",
                  "Nov",
                  "Dec",
                ],
                datasets: [
                  {
                    label: "New Registrations",
                    data: data.registrationTrend,
                    borderColor: "#6366f1",
                    backgroundColor: "rgba(99, 102, 241, 0.1)",
                    tension: 0.4,
                    fill: true,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
              },
            });

            // --- Request Status ---
            const ctx2 = document
              .getElementById("requestStatusChart")
              .getContext("2d");
            requestStatusChart = new Chart(ctx2, {
              type: "doughnut",
              data: {
                labels: ["Approved", "Pending", "Rejected"],
                datasets: [
                  {
                    data: [
                      data.requestStatus.Approved,
                      data.requestStatus.Pending,
                      data.requestStatus.Rejected,
                    ],
                    backgroundColor: ["#10b981", "#f59e0b", "#ef4444"],
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: "bottom" } },
              },
            });

            function renderRecentActivity(activityList) {
              const container = $(".activity-timeline");
              container.empty();

              if (!activityList || activityList.length === 0) {
                container.append(
                  '<div class="text-muted text-center">No recent activity</div>'
                );
                return;
              }

              activityList.forEach((item) => {
                const timeAgo = timeSince(new Date(item.createdAt));
                let actionText = "";
                switch (item.type) {
                  case "certificate":
                    actionText = `<strong>${
                      item.name
                    }</strong>'s certificate of origin is <span class="text-primary">${item.status.toLowerCase()}</span>`;
                    break;
                  case "idcard":
                    actionText = `<strong>${item.name}</strong> submitted an identity card request`;
                    break;

                  case "transaction":
                    const amountInNaira = item.amount
                      ? (item.amount / 100).toLocaleString()
                      : "0";
                    const badgeClass =
                      item.status === "success"
                        ? "text-success"
                        : item.status === "failed"
                        ? "text-danger"
                        : "text-warning";

                    actionText = `<strong>Payment</strong> of ₦${amountInNaira} for ${item.paymentType} <span class="${badgeClass}">(${item.status})</span>`;
                    break;
                  case "user":
                    if (
                      item.role === "global_admin" ||
                      item.role === "support_admin" ||
                      item.role === "kindred_head" ||
                      item.role === "user"
                    ) {
                      actionText = `<strong>${
                        item.name
                      }</strong> was assigned <span class="text-info">${item.role.replace(
                        "_",
                        " "
                      )}</span> role`;
                    } else {
                      actionText = `<strong>${item.name}</strong> registered as a new user`;
                    }
                    break;
                  default:
                    actionText = `${item.name} performed an action`;
                }

                const activityItem = `
                        <div class="activity-item">
                            <div class="activity-time">${timeAgo}</div>
                            <div class="activity-content">${actionText}</div>
                        </div>
                        `;
                container.append(activityItem);
              });
            }

            // Helper to convert date → “2 hours ago”
            function timeSince(date) {
              const seconds = Math.floor((new Date() - date) / 1000);
              const intervals = [
                { label: "year", seconds: 31536000 },
                { label: "month", seconds: 2592000 },
                { label: "day", seconds: 86400 },
                { label: "hour", seconds: 3600 },
                { label: "minute", seconds: 60 },
              ];

              for (const i of intervals) {
                const count = Math.floor(seconds / i.seconds);
                if (count >= 1)
                  return `${count} ${i.label}${count > 1 ? "s" : ""} ago`;
              }
              return "just now";
            }
            renderRecentActivity(data.recentActivities);

            // --- Top LGAs ---
            const ctx3 = document
              .getElementById("topLGAChart")
              .getContext("2d");
            topLGAChart = new Chart(ctx3, {
              type: "bar",
              data: {
                labels: data.topLGAs.map((lga) => lga.name),
                datasets: [
                  {
                    label: "Requests",
                    data: data.topLGAs.map((lga) => lga.count),
                    backgroundColor: "#6366f1",
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
              },
            });
          },
          error: function (xhr) {
            console.error("Failed to load dashboard stats:", xhr.responseText);
          },
        });
      }

      /**
       * Calls the backend to generate and download a PDF report of the dashboard.
       */
      async function exportDashboardToPDF() {
        showNotification("Generating dashboard report, please wait...", "info");

        // Construct the URL with the current filters
        const queryParams = new URLSearchParams();
        if (currentDashboardFilters.startDate)
          queryParams.append("startDate", currentDashboardFilters.startDate);
        if (currentDashboardFilters.endDate)
          queryParams.append("endDate", currentDashboardFilters.endDate);
        const url = `${BACKEND_URL}/users/dashboard/export/pdf?${queryParams.toString()}`;

        try {
          // Use fetch to make an authenticated request
          const response = await fetch(url, {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          if (!response.ok) {
            // If the server responds with an error, throw it to be caught by the catch block
            const errorData = await response.json();
            throw new Error(
              errorData.message || `HTTP error! status: ${response.status}`
            );
          }

          // Get the response body as a Blob
          const pdfBlob = await response.blob();

          // Create a temporary link element to trigger the download
          const link = document.createElement("a");
          const blobUrl = URL.createObjectURL(pdfBlob);

          // Set the download file name with the current date
          const fileName = `dashboard_report_${new Date()
            .toISOString()
            .slice(0, 10)}.pdf`;

          link.setAttribute("href", blobUrl);
          link.setAttribute("download", fileName);
          link.style.visibility = "hidden";

          // Append to the document, click it, and clean up
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          // Clean up the object URL to free memory
          URL.revokeObjectURL(blobUrl);

          showNotification(
            "Dashboard report exported successfully!",
            "success"
          );
        } catch (error) {
          console.error("Error exporting dashboard report:", error);
          showNotification(
            `Failed to export report: ${error.message}`,
            "error"
          );
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Toggle between views
        const chartsViewBtn = document.getElementById("chartsViewBtn");
        const tableViewBtn = document.getElementById("tableViewBtn");
        const chartsView = document.getElementById("charts-summary-view");
        const tableView = document.getElementById("table-view");

        chartsViewBtn.addEventListener("click", function () {
          chartsView.classList.remove("d-none");
          tableView.classList.add("d-none");
          chartsViewBtn.classList.add("active");
          tableViewBtn.classList.remove("active");

          // Refresh charts when switching to charts view
          if (typeof initializeUsersPage === "function") {
            initializeUsersPage();
          }
        });

        tableViewBtn.addEventListener("click", function () {
          chartsView.classList.add("d-none");
          tableView.classList.remove("d-none");
          chartsViewBtn.classList.remove("active");
          tableViewBtn.classList.add("active");

          // Refresh table when switching to table view
          if (typeof initializeUsersPage === "function") {
            initializeUsersPage();
          }
        });
      });

      async function initializeUsersPage() {
        // Only initialize DataTable if we're on the table view
        if (!$("#table-view").hasClass("d-none")) {
          if ($.fn.DataTable.isDataTable("#usersTable")) {
            $("#usersTable").DataTable().destroy();
          }

          // Rest of your existing DataTable initialization code
          function calculateAge(dob) {
            if (!dob) return "";
            const birthDate = new Date(dob);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();

            if (
              monthDiff < 0 ||
              (monthDiff === 0 && today.getDate() < birthDate.getDate())
            ) {
              age--;
            }
            return age;
          }

          try {
            $.ajax({
              url: `${BACKEND_URL}/users`,
              method: "GET",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              success: function (response) {
                // The actual array is in response.data
                const usersArray = response.data || [];

                // Initialize or re-draw DataTable
                usersTable = $("#usersTable").DataTable({
                  drawCallback: function (settings) {
                    initializeTooltips();
                  },
                  data: usersArray,
                  columns: [
                    {
                      title: "S/N",
                      data: null,
                      orderable: false,
                      searchable: false,
                      render: function (data, type, row, meta) {
                        return meta.row + meta.settings._iDisplayStart + 1;
                      },
                    },
                    {
                      data: "_id",
                      visible: false,
                      searchable: false,
                    },
                    {
                      data: null,
                      render: function (row) {
                        return `${row.firstname || ""} ${row.lastname || ""}`;
                      },
                    },
                    { data: "email" },
                    {
                      data: "role",
                      render: function (data) {
                        let badgeClass = "bg-primary";
                        if (data === "super_admin") badgeClass = "bg-danger";
                        else if (data === "support_admin")
                          badgeClass = "bg-warning";
                        else if (data === "kindred_head")
                          badgeClass = "bg-info";

                        return `<span class="badge ${badgeClass}">${data
                          .replace("_", " ")
                          .toUpperCase()}</span>`;
                      },
                    },

                    {
                      data: "isActive",
                      render: function (data) {
                        return data
                          ? `<span class="badge bg-success">Active</span>`
                          : `<span class="badge bg-secondary">Inactive</span>`;
                      },
                    },

                    {
                      data: null,
                      render: function (row) {
                        return row.stateOfOrigin || "N/A";
                      },
                    },

                    {
                      data: null,
                      render: function (row) {
                        return row.lgaOfOrigin || "N/A";
                      },
                    },

                    {
                      data: "created_at",
                      render: function (data) {
                        return new Date(data).toLocaleDateString();
                      },
                    },

                    {
                      data: null,
                      render: function (row) {
                        // <button class="btn btn-sm btn-outline-primary edit-user-btn" data-id="${row._id}">
                        //     <i class="bi bi-pencil"></i>
                        // </button>
                        return `
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-warning change-role-btn"
                        data-id="${row._id}" data-user="${row.firstname}"
                        data-bs-toggle="modal" data-bs-target="#changeRoleModal"
                        title="Change User Role">
                    <i class="bi bi-person-badge"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger deactivate-user-btn" 
                        data-id="${row._id}"
                        title="Deactivate User">
                    <i class="bi bi-person-x"></i>
                </button>
            </div>
        `;
                      },
                    },
                  ],
                  responsive: true,
                  pageLength: 10,
                });
              },
              error: function (xhr) {
                console.error("Failed to fetch users:", xhr.responseText);
              },
            });
          } catch (err) {
            console.error("Unexpected error:", err);
          }
        }

        // Only initialize charts if we're on the charts view
        if (!$("#charts-summary-view").hasClass("d-none")) {
          // 2. Fetch User Stats (for charts)
          $.ajax({
            url: `${BACKEND_URL}/users/stats`,
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            success: function (statsData) {
              // 🧹 Ensure old charts are fully destroyed
              destroyChart(ageDistributionChart, "ageDistributionChart");
              destroyChart(genderDistributionChart, "genderDistributionChart");
              destroyChart(stateDistributionChart, "stateDistributionChart");

              // Age distribution chart
              const ctx1 = document
                .getElementById("ageDistributionChart")
                .getContext("2d");
              ageDistributionChart = new Chart(ctx1, {
                type: "bar",
                data: {
                  labels: Object.keys(statsData.ageDistribution),
                  datasets: [
                    {
                      label: "Users",
                      data: Object.values(statsData.ageDistribution),
                      backgroundColor: "#6366f1",
                    },
                  ],
                },
                options: { responsive: true, maintainAspectRatio: false },
              });

              // Gender distribution chart
              const ctx2 = document
                .getElementById("genderDistributionChart")
                .getContext("2d");
              genderDistributionChart = new Chart(ctx2, {
                type: "pie",
                data: {
                  labels: Object.keys(statsData.genderDistribution),
                  datasets: [
                    {
                      data: Object.values(statsData.genderDistribution),
                      backgroundColor: ["#6366f1", "#ec4899"],
                    },
                  ],
                },
                options: { responsive: true, maintainAspectRatio: false },
              });

              // State distribution chart
              const ctx3 = document
                .getElementById("stateDistributionChart")
                .getContext("2d");
              stateDistributionChart = new Chart(ctx3, {
                type: "doughnut",
                data: {
                  labels: Object.keys(statsData.stateDistribution),
                  datasets: [
                    {
                      data: Object.values(statsData.stateDistribution),
                      backgroundColor: [
                        "#6366f1",
                        "#8b5cf6",
                        "#ec4899",
                        "#f59e0b",
                        "#10b981",
                        "#64748b",
                      ],
                    },
                  ],
                },
                options: { responsive: true, maintainAspectRatio: false },
              });
            },
            error: function (xhr) {
              console.error("Failed to fetch stats:", xhr.responseText);
            },
          });
        }
      }

      // Make chart variables global so they can be accessed by destroyChart

      // ✅ SAFETY WRAPPER — Ensures Chart.js fully releases canvas
      function destroyChart(chartInstance, canvasId) {
        if (chartInstance) {
          chartInstance.destroy();
        }
        // Chart.js maintains internal registry. Manually unregister if needed:
        const chartStatus = Chart.getChart(canvasId);
        if (chartStatus) {
          chartStatus.destroy();
        }

        // Clear canvas to ensure it's truly free
        const canvas = document.getElementById(canvasId);
        if (canvas) {
          const ctx = canvas.getContext("2d");
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
      }

      function destroyChart(chartInstance, canvasId) {
        if (chartInstance) {
          chartInstance.destroy();
        }
        // Chart.js maintains internal registry. Manually unregister if needed:
        const chartStatus = Chart.getChart(canvasId);
        if (chartStatus) {
          chartStatus.destroy();
        }

        // Clear canvas to ensure it’s truly free
        const canvas = document.getElementById(canvasId);
        if (canvas) {
          const ctx = canvas.getContext("2d");
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
      }

      // 🔹 Edit User (show form, submit update)
      $(document).on("click", ".edit-user-btn", function () {
        const userId = $(this).data("id");

        // Fetch user details (optional if already in table)
        $.ajax({
          url: `${BACKEND_URL}/users/${userId}`,
          method: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          success: function (user) {
            // Fill modal form fields
            $("#editUserId").val(user._id);
            $("#editFirstname").val(user.firstname);
            $("#editLastname").val(user.lastname);
            $("#editEmail").val(user.email);
            $("#editPhone").val(user.phone || "");

            // Show modal
            $("#editUserModal").modal("show");
          },
          error: function (xhr) {
            console.error("Failed to fetch user details:", xhr.responseText);
          },
        });
      });

      // 🔹 Handle Edit User form submission
      $("#editUserForm").on("submit", function (e) {
        e.preventDefault();
        const userId = $("#editUserId").val();
        const payload = {
          firstname: $("#editFirstname").val(),
          lastname: $("#editLastname").val(),
          email: $("#editEmail").val(),
          phoneNumber: $("#editPhone").val(),
        };

        $.ajax({
          url: `${BACKEND_URL}/users/${userId}/user-details`,
          method: "PUT",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          data: JSON.stringify(payload),
          success: function () {
            $("#editUserModal").modal("hide");
            initializeUsersPage(); // refresh list
            showNotification(
              "Updated!",
              "User details updated successfully.",
              "success"
            );
          },
          error: function (xhr) {
            showNotification(
              "Error",
              xhr.responseText || "Failed to update user",
              "error"
            );
          },
        });
      });

      // Function to fetch available roles from the backend
      function fetchAvailableRoles() {
        return $.ajax({
          url: `${BACKEND_URL}/users/roles`,
          method: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
        });
      }

      // Function to populate the role dropdown
      function populateRoleDropdown(roles) {
        const $roleSelect = $("#changeRoleNew");
        $roleSelect.empty(); // Clear existing options

        // Add a default option if needed
        $roleSelect.append(
          '<option value="" disabled selected>Select a role</option>'
        );

        // Add each role as an option
        roles.forEach((role) => {
          // Skip super_admin if needed (uncomment the condition if you want to exclude it)
          // if (role.value === 'super_admin') return;

          $roleSelect.append(
            `<option value="${role.value}">${role.label}</option>`
          );
        });
      }

      // 🔹 Open Change Role Modal
      // $(document).on("click", ".change-role-btn", function () {
      //   const userId = $(this).data("id");
      //   const userName = $(this).data("user");
      //   $("#changeRoleUserId").val(userId);
      //   $("#changeRoleUser").val(userName);
      // });
      $(document).on("click", ".change-role-btn", function () {
        const userId = $(this).data("id");
        const userName = $(this).data("user");
        $("#changeRoleUserId").val(userId);
        $("#changeRoleUser").val(userName);

        // Fetch available roles and populate the dropdown
        fetchAvailableRoles()
          .done(function (response) {
            // The response structure will be { status: 'success', data: [...] }
            const roles = response.data;
            populateRoleDropdown(roles);
          })
          .fail(function (xhr) {
            showNotification(
              "Error",
              xhr.responseText || "Failed to fetch available roles",
              "error"
            );

            // Fallback to hardcoded roles if API fails
            const fallbackRoles = [
              { value: "support_admin", label: "Support Admin" },
              { value: "kindred_head", label: "Kindred Head" },
              { value: "user", label: "User" },
            ];
            populateRoleDropdown(fallbackRoles);
          });
      });

      // 🔹 Handle Role Change Submission
      $("#changeRoleForm").on("submit", function (e) {
        e.preventDefault();
        const userId = $("#changeRoleUserId").val();
        const newRole = $("#changeRoleNew").val();
        $.ajax({
          url: `${BACKEND_URL}/users/${userId}/role`,
          method: "PATCH",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          data: JSON.stringify({ role: newRole }),
          success: function () {
            $("#changeRoleModal").modal("hide");
            initializeUsersPage();
            showNotification(
              "Success",
              "User role updated successfully",
              "success"
            );
          },
          error: function (xhr) {
            showNotification(
              xhr.responseJSON.message || "Failed to change role",
              "error"
            );
          },
        });
      });

      $(document).on("click", ".deactivate-user-btn", function () {
        const userId = $(this).data("id");

        Swal.fire({
          title: "Are you sure?",
          text: "This will toggle the user's active status.",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "Yes, proceed",
        }).then((result) => {
          if (result.isConfirmed) {
            $.ajax({
              url: `${BACKEND_URL}/users/${userId}/toggle-status`,
              method: "PATCH",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              success: function () {
                initializeUsersPage();
                showNotification("User status updated.", "success");
              },
              error: function (xhr) {
                showNotification(
                  xhr.responseText || "Failed to update user status",
                  "error"
                );
              },
            });
          }
        });
      });

      // 1. Function to initialize tooltips
      function initializeTooltips() {
        // Select all elements that should have a tooltip
        const tooltipTriggerList = document.querySelectorAll("[title]");

        // Convert to array and map over them to create new Tooltip instances
        const tooltipList = [...tooltipTriggerList].map(
          (tooltipTriggerEl) => new bootstrap.Tooltip(tooltipTriggerEl)
        );
      }

      // Call on page load
      $(document).ready(function () {
        initializeTooltips();
        initializeUsersPage();
        initializeIdCardsPage();
      });

      document.addEventListener("DOMContentLoaded", function () {
        // Toggle functionality for Identity Cards page
        const idcardsChartsBtn = document.getElementById("idcardsChartsBtn");
        const idcardsTableBtn = document.getElementById("idcardsTableBtn");
        const idcardsChartsView = document.getElementById(
          "idcards-charts-view"
        );
        const idcardsTableView = document.getElementById("idcards-table-view");

        idcardsChartsBtn.addEventListener("click", function () {
          idcardsChartsView.classList.remove("d-none");
          idcardsTableView.classList.add("d-none");
          idcardsChartsBtn.classList.add("active");
          idcardsTableBtn.classList.remove("active");

          // Refresh charts when switching to charts view
          if (typeof initializeIdCardsPage === "function") {
            initializeIdCardsPage();
          }
        });

        idcardsTableBtn.addEventListener("click", function () {
          idcardsChartsView.classList.add("d-none");
          idcardsTableView.classList.remove("d-none");
          idcardsChartsBtn.classList.remove("active");
          idcardsTableBtn.classList.add("active");

          // Refresh table when switching to table view
          if (typeof initializeIdCardsPage === "function") {
            initializeIdCardsPage();
          }
        });
      });

      async function loadPDFJ(url, container) {
        let pdfDoc = null;
        let canvas = null;
        let ctx = null;

        /**
         * Renders the PDF page with the current container width.
         */
        const renderPage = async () => {
          if (!pdfDoc || !canvas) return;

          try {
            const page = await pdfDoc.getPage(1);

            // Get the container's current width
            const containerWidth = container.clientWidth;

            // Calculate the scale to fit the container width
            // We start with a scale of 1 to get the page's original dimensions
            const viewport = page.getViewport({ scale: 1 });
            const scale = containerWidth / viewport.width;

            // Re-calculate viewport with the new, responsive scale
            const responsiveViewport = page.getViewport({ scale: scale });

            // Set canvas dimensions to match the scaled viewport
            const outputScale = window.devicePixelRatio || 1;
            canvas.width = Math.floor(viewport.width * scale * outputScale);
            canvas.height = Math.floor(viewport.height * scale * outputScale);
            canvas.style.width = Math.floor(viewport.width * scale) + "px";
            canvas.style.height = Math.floor(viewport.height * scale) + "px";

            // Scale the drawing context to match the device pixel ratio for sharpness
            ctx.scale(outputScale, outputScale);

            // Render PDF page into canvas context
            const renderContext = {
              canvasContext: ctx,
              viewport: responsiveViewport,
            };
            await page.render(renderContext).promise;
          } catch (error) {
            console.error("Error rendering PDF page:", error);
          }
        };

        /**
         * Event handler for window resizing.
         */
        const handleResize = () => {
          renderPage();
        };

        try {
          container.innerHTML = `<p class="text-center">Loading PDF...</p>`;

          const loadingTask = pdfjsLib.getDocument(url);
          pdfDoc = await loadingTask.promise;

          // Set up canvas
          canvas = document.createElement("canvas");
          ctx = canvas.getContext("2d");
          container.innerHTML = ""; // Clear loading message
          container.appendChild(canvas);

          // Initial render
          renderPage();

          // Add resize listener to make it responsive
          window.addEventListener("resize", handleResize);

          // --- IMPORTANT: CLEANUP ---
          // When the modal is hidden, remove the resize listener to prevent memory leaks.
          // This assumes your modal has the ID 'viewModal'.
          const viewModal = document.getElementById("viewModal");
          const cleanup = () => {
            window.removeEventListener("resize", handleResize);
            viewModal.removeEventListener("hide.bs.modal", cleanup);
          };
          viewModal.addEventListener("hide.bs.modal", cleanup);
        } catch (error) {
          console.error("Error loading PDF:", error);
          container.innerHTML = `<div class="alert alert-danger">Failed to load PDF. <a href="${url}" target="_blank" class="btn btn-sm btn-primary mt-2">Open in New Tab</a></div>`;
        }
      }

      /**
       * Renders an image into a specified container.
       */
      function loadImage(url, container) {
        const img = document.createElement("img");
        img.src = url;
        img.className = "img-fluid"; // Makes the image responsive
        img.style.maxHeight = "400px"; // Consistent max height with PDF viewer
        img.style.display = "block"; // Removes bottom space under image
        img.style.margin = "auto"; // Centers the image
        container.innerHTML = ""; // Clear the loading spinner
        container.appendChild(img);
      }

      //   // Handle View Modal Function
      function handleCardView(requestId) {
        const apiHeaders = {
          Authorization: `Bearer ${token}`,
        };
        $.ajax({
          url: `${BACKEND_URL}/idcard/${requestId}/request`,
          method: "GET",
          headers: apiHeaders,
          success: function (response) {
            const docTypes = ["utilityBill", "ref_letter"];
            const documentTitles = ["Utility Bill", "Reference Letter"];

            // Filter documents that actually exist in response
            const validDocuments = docTypes
              .map((key, index) => ({ key, title: documentTitles[index] }))
              .filter((doc) => response[doc.key]); // Check if document exists

            let modalContent = `
              <div class="container-fluid">
                  <div class="row mb-3">
                      <div class="col-md-3 text-center">
                          <img 
                            src="${
                              response.passportPhoto ||
                              "/assets/images/avatar.jpeg"
                            }" 
                            alt="Passport Photo" 
                            class="img-fluid rounded shadow-sm profile-photo"
                            style="max-height: 150px;"
                            crossOrigin="anonymous"
                          >
                      </div>
                      <div class="col-md-9">
                          <h5 class="fw-bold mb-2">${response.firstname} ${
              response.lastname
            }</h5>
                          <p class="mb-1"><strong>Phone:</strong> ${
                            response.phone
                          }</p>
                          <p class="mb-1"><strong>Email:</strong> ${
                            response.email
                          }</p>
                          <p class="mb-1"><strong>Status:</strong> <span class="badge bg-info">${
                            response.status
                          }</span></p>
                          <p><strong>State:</strong> ${
                            response.userId?.stateOfOrigin
                          }</p>
                          <p><strong>LGA:</strong> 
                          ${response.userId?.lgaOfOrigin}
                          </p>
                          <p><strong>isProfileCompleted:</strong> ${
                            response.userId?.isProfileCompleted
                          }</p>
                      </div>
                  </div>

                  <hr class="my-3">
                  <h6 class="text-primary">Uploaded Documents</h6>
          `;

            if (validDocuments.length === 0) {
              modalContent += `<p class="text-muted">No documents uploaded.</p>`;
            }

            // Generate HTML for each existing document
            validDocuments.forEach((doc, index) => {
              const fileUrl = `${BACKEND_URL}/idcard/${requestId}/document/${doc.key}`;

              modalContent += `
                  <div class="card my-3 shadow-sm">
                      <div class="card-header bg-light fw-semibold">
                          ${doc.title}
                      </div>
                      <div class="card-body">
                          <div id="pdf-viewer-container-${index}" style="width:100%; height:400px;" class="pdf-container"></div>
                          <div class="text-end mt-2">
                             <button class="btn btn-sm btn-outline-primary me-2" onclick="window.open('${fileUrl}', '_blank')">Open in New Tab</button>
                             <button class="btn btn-sm btn-outline-secondary" data-doc-index="${index}" data-url="${fileUrl}" onclick="downloadPDF(this)">Download</button>
                          </div>
                      </div>
                  </div>
              `;
            });

            modalContent += `</div>`;
            $("#viewModal .modal-body").html(modalContent);
            $("#viewModal").modal("show");

            // Load PDFs with authorization
            validDocuments.forEach((doc, index) => {
              const fileUrl = `${BACKEND_URL}/idcard/${requestId}/document/${doc.key}`;
              const container = document.getElementById(
                `pdf-viewer-container-${index}`
              );
              // Show loader while fetching
              $(`#pdf-viewer-container-${index}`).html(`
                  <div class="d-flex justify-content-center align-items-center h-100">
                      <div class="spinner-border text-primary" role="status">
                          <span class="visually-hidden">Loading...</span>
                      </div>
                  </div>
              `);

              // Fetch document with authorization
              fetch(fileUrl, {
                headers: {
                  Authorization: apiHeaders.Authorization,
                },
              })
                .then((res) => {
                  if (!res.ok) throw new Error("Failed to fetch document");

                  // --- KEY LOGIC: Get the content type from the response header ---
                  const contentType = res.headers.get("Content-Type");

                  // Return both the blob and the content type for the next .then()
                  return res.blob().then((blob) => ({ blob, contentType }));
                })
                .then(({ blob, contentType }) => {
                  const blobUrl = URL.createObjectURL(blob);

                  // --- Check the content type and call the correct renderer ---
                  if (contentType === "application/pdf") {
                    loadPDFJ(blobUrl, container);
                  } else if (contentType && contentType.startsWith("image/")) {
                    loadImage(blobUrl, container);
                  } else {
                    // Handle unknown or missing content type
                    throw new Error(
                      `Unsupported file type: ${contentType || "Unknown"}`
                    );
                  }
                })
                .catch((err) => {
                  console.error(`Error loading PDF [${doc.key}]:`, err);
                  $(`#pdf-viewer-container-${index}`).html(`
                      <div class="alert alert-danger">
                          Failed to load document: ${err.message}
                          <div class="mt-2">
                              <a href="${fileUrl}" target="_blank" class="btn btn-sm btn-primary">Open in New Tab</a>
                          </div>
                      </div>
                  `);
                });
            });
          },
          error: function (error) {
            console.error("Error fetching request details:", error);
            alert("Failed to fetch request details.");
          },
        });
      }

      async function initializeIdCardsPage() {
        // Only initialize DataTable if we're on the table view
        if (!$("#idcards-table-view").hasClass("d-none")) {
          if ($.fn.DataTable.isDataTable("#idcardsTable")) {
            $("#idcardsTable").DataTable().destroy();
          }

          // Your existing DataTable initialization code
          try {
            $.ajax({
              url: `${BACKEND_URL}/idcard/get-all-request`,
              method: "GET",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              success: function (response) {
                if (!Array.isArray(response)) {
                  return;
                }

                // 🔹 Prepare data for the DataTable
                const idcardsData = response.map((req, index) => ({
                  _id: req._id, // Keep original ID for actions
                  id: index + 1,
                  user: req.userId?.firstname
                    ? `${req.userId.firstname} ${req.userId.lastname}`
                    : "Unknown",
                  state: req.userId?.stateOfOrigin || "N/A",
                  lga: req.userId?.lgaOfOrigin || "N/A",
                  status: req.status
                    ? req.status.charAt(0).toUpperCase() + req.status.slice(1)
                    : "Pending",
                  requestDate: req.created_at
                    ? new Date(req.created_at).toLocaleDateString()
                    : "N/A",
                  approvedBy: req.approvedBy
                    ? `${req.approvedBy?.firstname} ${req.approvedBy?.lastname}`
                    : req.status === "Rejected"
                    ? "Rejected by Admin"
                    : "Not yet approved",

                  isProfileCompleted: req.userId?.isProfileCompleted ?? false,

                  isProfileCompletedBadge: req.userId?.isProfileCompleted
                    ? `<span class="badge bg-success">Yes</span>`
                    : `<span class="badge bg-danger">No</span>`,

                  paymentStatus: req?.paymentStatus || "Pending",
                }));

                // 🔹 Initialize  DataTable
                $("#idcardsTable").DataTable({
                  drawCallback: function (settings) {
                    initializeTooltips();
                  },
                  data: idcardsData,
                  columns: [
                    {
                      title: "S/N",
                      data: null,
                      orderable: false,
                      searchable: false,
                      render: function (data, type, row, meta) {
                        return meta.row + meta.settings._iDisplayStart + 1;
                      },
                    },
                    {
                      data: "id",
                      visible: false,
                      searchable: false,
                    },
                    { data: "user" },
                    { data: "state" },
                    { data: "lga" },
                    {
                      data: "status",
                      render: function (data) {
                        let badgeClass = "bg-primary";
                        if (data === "Approved") badgeClass = "bg-success";
                        else if (data === "Pending") badgeClass = "bg-warning";
                        else if (data === "Rejected") badgeClass = "bg-danger";
                        return `<span class="badge ${badgeClass}">${data}</span>`;
                      },
                    },
                    { data: "requestDate" },
                    { data: "isProfileCompletedBadge" },
                    { data: "approvedBy" },

                    {
                      // Actions column
                      orderable: false,
                      searchable: false,
                      width: "120px",

                      data: null,
                      render: function (data, type, row) {
                        let actionButtons = "";
                        let downloadButton = "";

                        // Show action buttons only for pending requests
                        if (row.status === "Pending") {
                          actionButtons = `
        <button class="btn btn-sm btn-outline-success approve-request-btn" 
                data-id="${row._id}" data-type="idcard" 
                data-bs-toggle="modal" data-bs-target="#requestActionModal"
                title="Approve Request">
          <i class="bi bi-check-circle"></i>
        </button>
        <button class="btn btn-sm btn-outline-danger reject-request-btn" 
                data-id="${row._id}" data-type="idcard" 
                data-bs-toggle="modal" data-bs-target="#requestActionModal"
                title="Reject Request">
          <i class="bi bi-x-circle"></i>
        </button>
      `;
                        }

                        // ✅ Show download button only if: Approved, Paid, and Profile Completed
                        if (
                          row.status === "Approved" &&
                          row.paymentStatus.toLowerCase() === "paid" &&
                          row.isProfileCompleted === true
                        ) {
                          downloadButton = `
        <button class="btn btn-sm btn-outline-danger btn-idcard-download" 
                data-id="${row._id}"
                title="Download ID Card ">
          <i class="bi bi-download"></i>
        </button>
      `;
                        }

                        // Optional: Show a disabled version if payment is pending
                        else if (
                          row.status === "Approved" &&
                          row.paymentStatus.toLowerCase() === "pending" &&
                          row.isProfileCompleted === true
                        ) {
                          // Note: The 'disabled' button already had the title for the tooltip
                          downloadButton = `
        <button class="btn btn-sm btn-outline-secondary" disabled 
                title="Payment pending. Cannot download.">
          <i class="bi bi-download"></i>
        </button>
      `;
                        }

                        return `
        <div class="btn-group" >
          <button class="btn btn-sm btn-outline-primary btn-card-view" 
                  data-id="${row._id}"
                  title="View Details"
                  data-bs-toggle="tooltip"
                  >
            <i class="bi bi-eye"></i>
          </button>
          ${actionButtons}
          ${downloadButton}
        </div>
      `;
                      },
                    },
                  ],
                  responsive: true,
                  pageLength: 10,
                  // retrieve: true,
                });

                // ✅ Move the event handler here
                $("#idcardsTable").on("click", ".btn-card-view", function () {
                  const requestId = $(this).data("id");
                  handleCardView(requestId);
                });
              },
              error: function (xhr) {
                console.error(
                  "Failed to fetch ID card requests:",
                  xhr.responseJSON.message
                );
              },
            });
          } catch (err) {
            console.error("Unexpected error:", err);
          }
        }

        // Only initialize charts if we're on the charts view
        if (!$("#idcards-charts-view").hasClass("d-none")) {
          try {
            $.ajax({
              url: `${BACKEND_URL}/idcard/get-all-request`,
              method: "GET",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              success: function (response) {
                if (!Array.isArray(response)) {
                  console.error("Invalid response format:", response);
                  return;
                }

                // 🔹 Compute statistics for charts
                const monthlyTrend = {};
                const stateDistribution = {};

                response.forEach((req) => {
                  // Monthly trend (by createdAt)
                  if (req.created_at) {
                    const month = new Date(req.created_at).toLocaleString(
                      "default",
                      {
                        month: "short",
                        year: "numeric",
                      }
                    );
                    monthlyTrend[month] = (monthlyTrend[month] || 0) + 1;
                  }

                  // State distribution
                  const state =
                    req.userId?.stateOfOrigin.toUpperCase() || "Unknown";
                  stateDistribution[state] =
                    (stateDistribution[state] || 0) + 1;
                });

                // 🔹 Render Charts
                renderIdCardCharts(monthlyTrend, stateDistribution);
              },
              error: function (xhr) {
                console.error(
                  "Failed to fetch ID card requests:",
                  xhr.responseText
                );
              },
            });
          } catch (err) {
            console.error("Unexpected error:", err);
          }
        }
      }

      // Add this function to render ID card charts
      function renderIdCardCharts(monthlyTrend, stateDistribution) {
        // Destroy existing charts if they exist
        destroyChart(idcardTrendChart, "idcardTrendChart");
        destroyChart(idcardStateChart, "idcardStateChart");

        // Request Trends Chart
        const ctx1 = document
          .getElementById("idcardTrendChart")
          .getContext("2d");
        idcardTrendChart = new Chart(ctx1, {
          type: "line",
          data: {
            labels: Object.keys(monthlyTrend),
            datasets: [
              {
                label: "Monthly Requests",
                data: Object.values(monthlyTrend),
                backgroundColor: "rgba(99, 102, 241, 0.2)",
                borderColor: "#6366f1",
                borderWidth: 2,
                tension: 0.4,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
              },
            },
          },
        });

        // State Distribution Chart
        const ctx2 = document
          .getElementById("idcardStateChart")
          .getContext("2d");
        idcardStateChart = new Chart(ctx2, {
          type: "doughnut",
          data: {
            labels: Object.keys(stateDistribution),
            datasets: [
              {
                data: Object.values(stateDistribution),
                backgroundColor: [
                  "#6366f1",
                  "#8b5cf6",
                  "#ec4899",
                  "#f59e0b",
                  "#10b981",
                  "#64748b",
                  "#ef4444",
                  "#3b82f6",
                ],
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
          },
        });
      }
      // 🔹 Approve / Reject ID Card Request
      $(document).on(
        "click",
        ".approve-request-btn, .reject-request-btn",
        function () {
          const requestId = $(this).data("id");
          const requestType = $(this).data("type");
          const action = $(this).hasClass("approve-request-btn")
            ? "approve"
            : "reject";

          $("#requestActionType").val(action);
          $("#requestActionModal").data("requestId", requestId);
          $("#requestActionModal").data("requestType", requestType);
        }
      );

      function submitRequestAction() {
        const requestId = $("#requestActionModal").data("requestId");
        const requestType = $("#requestActionModal").data("requestType");
        const action = $("#requestActionType").val(); // "approve" or "reject"
        const reason = $("#requestActionReason").val();

        if (!requestId || !action) {
          showNotification("Invalid request. Please try again.", "danger");
          return;
        }

        // Determine endpoint based on request type
        let endpoint = "";
        if (requestType === "idcard") {
          endpoint = `${BACKEND_URL}/idcard/${requestId}/${action}`;
        } else if (requestType === "certificate") {
          endpoint = `${BACKEND_URL}/indigene/certificate/${requestId}/${action}`;
        } else {
          showNotification("Unknown request type.", "error");
          return;
        }

        // Disable submit button to prevent multiple clicks
        $("#submitActionBtn").prop("disabled", true).text("Processing...");

        // ✅ Real API call
        $.ajax({
          url: endpoint,
          method: "PATCH",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          data: JSON.stringify({
            rejectionReason: reason,
            approvedBy: user.id,
          }),
          success: function (response) {
            // Close modal and reset
            $("#requestActionModal").modal("hide");
            $("#requestActionForm")[0].reset();

            // Refresh dashboard
            initializeDashboard();

            // Refresh the table to reflect the change
            initializeIdCardsPage();

            initializeCertificatesPage();

            initializeIdCardsPage();

            // Show success message
            showNotification(`Request ${action}d successfully`, "success");
          },
          error: function (xhr) {
            showNotification(
              xhr.responseJSON?.message || `Failed to ${action} request.`,
              "error"
            );
          },
          complete: function () {
            $("#submitActionBtn").prop("disabled", false).text("Submit");
          },
        });
      }

      function renderIdCardCharts(monthlyTrend, stateDistribution) {
        // Safely destroy old charts if they exist and are Chart.js instances
        if (window.idcardTrendChart instanceof Chart) {
          window.idcardTrendChart.destroy();
        }
        if (window.idcardStateChart instanceof Chart) {
          window.idcardStateChart.destroy();
        }

        // 📈 Monthly trend chart
        const ctx1 = document.getElementById("idcardTrendChart");
        if (!ctx1) {
          console.error("❌ Missing #idcardTrendChart canvas element");
          return;
        }

        window.idcardTrendChart = new Chart(ctx1.getContext("2d"), {
          type: "line",
          data: {
            labels: Object.keys(monthlyTrend),
            datasets: [
              {
                label: "Requests",
                data: Object.values(monthlyTrend),
                borderColor: "#6366f1",
                backgroundColor: "rgba(99, 102, 241, 0.1)",
                tension: 0.4,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } },
          },
        });

        // 🥧 State distribution chart
        const ctx2 = document.getElementById("idcardStateChart");
        if (!ctx2) {
          console.error("❌ Missing #idcardStateChart canvas element");
          return;
        }

        window.idcardStateChart = new Chart(ctx2.getContext("2d"), {
          type: "pie",
          data: {
            labels: Object.keys(stateDistribution),
            datasets: [
              {
                data: Object.values(stateDistribution),
                backgroundColor: [
                  "#6366f1",
                  "#8b5cf6",
                  "#ec4899",
                  "#f59e0b",
                  "#10b981",
                  "#64748b",
                ],
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: "bottom" } },
          },
        });
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Toggle functionality for Certificates page
        const certificatesChartsBtn = document.getElementById(
          "certificatesChartsBtn"
        );
        const certificatesTableBtn = document.getElementById(
          "certificatesTableBtn"
        );
        const certificatesChartsView = document.getElementById(
          "certificates-charts-view"
        );
        const certificatesTableView = document.getElementById(
          "certificates-table-view"
        );

        certificatesChartsBtn.addEventListener("click", function () {
          certificatesChartsView.classList.remove("d-none");
          certificatesTableView.classList.add("d-none");
          certificatesChartsBtn.classList.add("active");
          certificatesTableBtn.classList.remove("active");

          // Refresh charts when switching to charts view
          if (typeof initializeCertificatesPage === "function") {
            initializeCertificatesPage();
          }
        });

        certificatesTableBtn.addEventListener("click", function () {
          certificatesChartsView.classList.add("d-none");
          certificatesTableView.classList.remove("d-none");
          certificatesChartsBtn.classList.remove("active");
          certificatesTableBtn.classList.add("active");

          // Refresh table when switching to table view
          if (typeof initializeCertificatesPage === "function") {
            initializeCertificatesPage();
          }
        });
      });
      function handleView(requestId) {
        const apiHeaders = {
          Authorization: `Bearer ${token}`,
        };
        $.ajax({
          url: `${BACKEND_URL}/indigene/certificate/${requestId}/request`,
          method: "GET",
          headers: apiHeaders,
          success: function (response) {
            const docTypes = ["idCard", "birthCertificate"];
            const documentTitles = ["Identity Card", "Birth Certificate"];

            // Filter documents that actually exist in response
            const validDocuments = docTypes
              .map((key, index) => ({ key, title: documentTitles[index] }))
              .filter((doc) => response[doc.key]);

            let modalContent = `
        <div class="container-fluid">
          <div class="row mb-3">
            <div class="col-md-3 text-center">
              <img 
                src="${response.passportPhoto || "/assets/images/avatar.jpeg"}" 
                alt="Passport Photo" 
                class="img-fluid rounded shadow-sm profile-photo"
                style="max-height: 150px;"
                crossOrigin="anonymous"
              >
            </div>
            <div class="col-md-9">
              <h5 class="fw-bold mb-2">${response.firstname} ${
              response.lastname
            }</h5>
              <p class="mb-1"><strong>Phone:</strong> ${response.phone}</p>
              <p class="mb-1"><strong>Email:</strong> ${response.email}</p>
              <p class="mb-1"><strong>Status:</strong> <span class="badge bg-info">${
                response.status
              }</span></p>
              <p><strong>State:</strong> ${response.stateOfOrigin}</p>
              <p><strong>LGA:</strong> ${response.lgaOfOrigin}</p>
              <p><strong>Kindred:</strong> ${response.kindred}</p>
              <p><strong>isProfileCompleted:</strong> ${
                response.userId?.isProfileCompleted
              }</p>
            </div>
          </div>
  
          <hr class="my-3">
          <h6 class="text-primary">Uploaded Documents</h6>
      `;

            if (validDocuments.length === 0) {
              modalContent += `<p class="text-muted">No documents uploaded.</p>`;
            }

            // Generate HTML for each existing document
            validDocuments.forEach((doc, index) => {
              const fileUrl = `${BACKEND_URL}/indigene/certificate/${requestId}/document/${doc.key}`;

              modalContent += `
          <div class="card my-3 shadow-sm">
            <div class="card-header bg-light fw-semibold">
              ${doc.title}
            </div>
            <div class="card-body p-0"> <!-- Use p-0 for full-width viewer -->
              <!-- Renamed ID for clarity, added responsive container -->
              <div id="viewer-container-${index}" style="width:100%; max-height:75vh; overflow:auto;" class="border bg-light p-2"></div>
              <div class="p-2 text-end">
                 <button class="btn btn-sm btn-outline-primary me-2" onclick="window.open('${fileUrl}', '_blank')">Open in New Tab</button>
                 <!-- Updated onclick to call the generic downloadFile function -->
                 <button class="btn btn-sm btn-outline-secondary" data-doc-index="${index}" data-url="${fileUrl}" onclick="downloadFile(this)">Download</button>
              </div>
            </div>
          </div>
        `;
            });

            modalContent += `</div>`;
            $("#viewModal .modal-body").html(modalContent);
            $("#viewModal").modal("show");

            // Load documents with authorization and type-checking
            validDocuments.forEach((doc, index) => {
              const fileUrl = `${BACKEND_URL}/indigene/certificate/${requestId}/document/${doc.key}`;
              const container = document.getElementById(
                `viewer-container-${index}`
              );

              // Show loader while fetching
              container.innerHTML = `
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        `;

              // Fetch document with authorization
              fetch(fileUrl, {
                headers: {
                  Authorization: apiHeaders.Authorization,
                },
              })
                .then((res) => {
                  if (!res.ok) throw new Error("Failed to fetch document");

                  // --- KEY LOGIC: Get the content type from the response header ---
                  const contentType = res.headers.get("Content-Type");

                  // Return both the blob and the content type for the next .then()
                  return res.blob().then((blob) => ({ blob, contentType }));
                })
                .then(({ blob, contentType }) => {
                  const blobUrl = URL.createObjectURL(blob);

                  // --- Check the content type and call the correct renderer ---
                  if (contentType === "application/pdf") {
                    loadPDFJ(blobUrl, container);
                  } else if (contentType && contentType.startsWith("image/")) {
                    loadImage(blobUrl, container);
                  } else {
                    // Handle unknown or missing content type
                    throw new Error(
                      `Unsupported file type: ${contentType || "Unknown"}`
                    );
                  }
                })
                .catch((err) => {
                  console.error(`Error loading document [${doc.key}]:`, err);
                  container.innerHTML = `
              <div class="alert alert-danger m-2">
                Failed to load document: ${err.message}
                <div class="mt-2">
                  <a href="${fileUrl}" target="_blank" class="btn btn-sm btn-primary">Try Opening in New Tab</a>
                </div>
              </div>
            `;
                });
            });
          },
          error: function (error) {
            console.error("Error fetching request details:", error);
            alert("Failed to fetch request details.");
          },
        });
      }
      // Modify your initializeCertificatesPage function to work with the toggle
      async function initializeCertificatesPage() {
        // Only initialize DataTable if we're on the table view
        if (!$("#certificates-table-view").hasClass("d-none")) {
          if ($.fn.DataTable.isDataTable("#certificatesTable")) {
            $("#certificatesTable").DataTable().destroy();
          }

          const headers = {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          };

          try {
            const response = await $.ajax({
              url: `${BACKEND_URL}/indigene/certificate/get-all-request`,
              method: "GET",
              headers: headers,
            });

            // ✅ Prepare table data
            const tableData = response.map((item, index) => ({
              _id: item._id, // Keep original ID for actions
              id: index + 1,
              user: item.firstname
                ? `${item.firstname} ${item.lastname}`
                : "Unknown",
              state: item.stateOfOrigin || "N/A",
              lga: item.lgaOfOrigin || "N/A",
              status: item?.status || "Pending",
              requestTime: item.created_at
                ? new Date(item.created_at).toLocaleString()
                : "N/A",

              isProfileCompleted: item.userId?.isProfileCompleted ?? false,

              isProfileCompletedBadge: item.userId?.isProfileCompleted
                ? `<span class="badge bg-success">Yes</span>`
                : `<span class="badge bg-danger">No</span>`,

              approvedBy: item.approvedBy
                ? `${item.approvedBy?.firstname} ${item.approvedBy?.lastname}`
                : item.status === "Rejected"
                ? "Rejected by Admin"
                : "Not yet approved",

              paymentStatus: item?.paymentStatus || "Pending",
            }));

            // ✅ Initialize DataTable
            $("#certificatesTable").DataTable({
              drawCallback: function (settings) {
                initializeTooltips();
              },
              data: tableData,
              columns: [
                {
                  title: "S/N",
                  data: null,
                  orderable: false,
                  searchable: false,
                  render: function (data, type, row, meta) {
                    return meta.row + meta.settings._iDisplayStart + 1;
                  },
                },
                {
                  data: "id",
                  visible: false,
                  searchable: false,
                },
                { data: "user" },
                { data: "state" },
                { data: "lga" },
                {
                  data: "status",
                  render: function (data) {
                    let badgeClass = "bg-primary";
                    if (data.toLowerCase() === "approved")
                      badgeClass = "bg-success";
                    else if (data.toLowerCase() === "pending")
                      badgeClass = "bg-warning";
                    else if (data.toLowerCase() === "rejected")
                      badgeClass = "bg-danger";
                    return `<span class="badge ${badgeClass}">${data}</span>`;
                  },
                },
                { data: "requestTime" },
                { data: "isProfileCompletedBadge" },
                { data: "approvedBy" },

                {
                  // Actions column
                  orderable: false,
                  searchable: false,
                  width: "120px",
                  data: null,
                  render: function (data, type, row) {
                    let actionButtons = "";
                    let downloadButton = "";

                    // Approve/Reject buttons (for pending status)
                    if (row.status === "Pending") {
                      actionButtons = `
        <button class="btn btn-sm btn-outline-success approve-request-btn" 
                data-id="${row._id}" 
                data-type="certificate" 
                data-bs-toggle="modal" 
                data-bs-target="#requestActionModal"
                title="Approve Request">
          <i class="bi bi-check-circle"></i>
        </button>
        <button class="btn btn-sm btn-outline-danger reject-request-btn" 
                data-id="${row._id}" 
                data-type="certificate" 
                data-bs-toggle="modal" 
                data-bs-target="#requestActionModal"
                title="Reject Request">
          <i class="bi bi-x-circle"></i>
        </button>
      `;
                    }

                    // ✅ Show download button only if: Approved, Paid, and Profile Completed
                    if (
                      row.status === "Approved" &&
                      row.paymentStatus.toLowerCase() === "paid" &&
                      row.isProfileCompleted === true
                    ) {
                      downloadButton = `
        <button class="btn btn-sm btn-outline-danger btn-certificate-download" 
                data-id="${row._id}"
                title="Download Certificate">
          <i class="bi bi-download"></i>
        </button>
      `;
                    }

                    // Optional: Show a disabled version if payment is pending
                    else if (
                      row.status === "Approved" &&
                      row.paymentStatus.toLowerCase() === "pending" &&
                      row.isProfileCompleted === true
                    ) {
                      downloadButton = `
        <button class="btn btn-sm btn-outline-secondary" disabled 
                title="Payment pending. Cannot download.">
          <i class="bi bi-download"></i>
        </button>
      `;
                    }

                    return `
        <div class="btn-group" >
          <button class="btn btn-sm btn-outline-primary btn-cert-view" 
                  data-id="${row._id}"
                  title="View Details"
                  data-bs-toggle="tooltip"
                  >
            <i class="bi bi-eye"></i>
          </button>
          ${actionButtons}
          ${downloadButton}
        </div>
      `;
                  },
                },
              ],
              responsive: true,
              pageLength: 10,
            });
            $("#certificatesTable").on("click", ".btn-cert-view", function () {
              const requestId = $(this).data("id");
              handleView(requestId);
            });
          } catch (error) {
            console.error("Error loading certificate data:", error);
          }
        }

        // Only initialize charts if we're on the charts view
        if (!$("#certificates-charts-view").hasClass("d-none")) {
          const headers = {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          };

          try {
            const response = await $.ajax({
              url: `${BACKEND_URL}/indigene/certificate/get-all-request`,
              method: "GET",
              headers: headers,
            });

            // ✅ Chart data grouping by date
            const dailyBreakdown = {};
            const lgaCounts = {};

            response.forEach((item) => {
              const day = new Date(item.created_at).toLocaleDateString();
              dailyBreakdown[day] = (dailyBreakdown[day] || 0) + 1;
              const lga = item.userId?.lgaOfOrigin || "Unknown";
              lgaCounts[lga] = (lgaCounts[lga] || 0) + 1;
            });

            destroyChart(certificateDailyChart, "certificateDailyChart");
            destroyChart(certificateLGAChart, "certificateLGAChart");

            // ✅ Daily Requests Chart
            const ctx1 = document
              .getElementById("certificateDailyChart")
              .getContext("2d");
            certificateDailyChart = new Chart(ctx1, {
              type: "bar",
              data: {
                labels: Object.keys(dailyBreakdown),
                datasets: [
                  {
                    label: "Requests",
                    data: Object.values(dailyBreakdown),
                    backgroundColor: "#6366f1",
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } },
              },
            });

            // ✅ Top LGA Chart
            const ctx2 = document
              .getElementById("certificateLGAChart")
              .getContext("2d");
            certificateLGAChart = new Chart(ctx2, {
              type: "bar",
              data: {
                labels: Object.keys(lgaCounts),
                datasets: [
                  {
                    label: "Requests",
                    data: Object.values(lgaCounts),
                    backgroundColor: "#6366f1",
                  },
                ],
              },
              options: {
                indexAxis: "y",
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { x: { beginAtZero: true } },
              },
            });
          } catch (error) {
            console.error("Error loading certificate data:", error);
          }
        }
      }

      // ✅ SAFETY WRAPPER — Ensures Chart.js fully releases canvas
      function destroyChart(chartInstance, canvasId) {
        if (chartInstance) {
          chartInstance.destroy();
        }
        // Chart.js maintains internal registry. Manually unregister if needed:
        const chartStatus = Chart.getChart(canvasId);
        if (chartStatus) {
          chartStatus.destroy();
        }

        // Clear canvas to ensure it's truly free
        const canvas = document.getElementById(canvasId);
        if (canvas) {
          const ctx = canvas.getContext("2d");
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
      }

      $(document).ready(function () {
        initializeCertificatesPage();

        // ✅ Approve certificate request
        $(document).on("click", ".approve-cert-request-btn", function () {
          const requestId = $(this).data("id");

          if (
            !confirm(
              "Are you sure you want to approve this certificate request?"
            )
          )
            return;

          $.ajax({
            url: `${BACKEND_URL}/indigene/certificate/${requestId}/approve`,
            method: "PATCH",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            data: JSON.stringify({ approvedBy: user.id }), // Optionally send who approved
            success: function (response) {
              showNotification(
                "✅ Certificate request approved successfully!",
                "success"
              );
              // Refresh the table to reflect the change
              initializeCertificatesPage();
            },
            error: function (xhr) {
              console.error(
                "Failed to approve request:",
                xhr.responseJSON.message
              );
              showNotification("Failed to approve request.", "error");
            },
          });
        });

        // ❌ Reject certificate request
        $(document).on("click", ".reject-cert-request-btn", function () {
          const requestId = $(this).data("id");

          if (
            !confirm(
              "Are you sure you want to reject this certificate request?"
            )
          )
            return;

          $.ajax({
            url: `${BACKEND_URL}/indigene/certificate/${requestId}/reject`,
            method: "PATCH",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            success: function (response) {
              showNotification(
                "Certificate request rejected successfully!",
                "success"
              );
              // Refresh the table to reflect the change
              initializeCertificatesPage();
            },
            error: function (xhr) {
              console.error("Failed to reject request:", xhr.responseText);
              showNotification("Failed to reject request.", "error");
            },
          });
        });
        $(document).on("click", ".view-cert-request-btn", function () {
          const requestId = $(this).data("id");

          // Show modal immediately with loading state
          $("#viewCertRequestModal").modal("show");
          $("#viewCertRequestContent").html(`
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Loading request details...</p>
                </div>
            `);

          // Fetch details from backend
          $.ajax({
            url: `${BACKEND_URL}/indigene/certificate/${requestId}/request`,
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            success: function (data) {
              console.log("Certificate Request details:", data);
              if (!data) {
                $("#viewCertRequestContent").html(
                  "<p class='text-danger'>No details found for this request.</p>"
                );
                return;
              }

              const user = data.userId || {};
              const approvedBy = data.approvedBy
                ? `${data.approvedBy.firstname} ${data.approvedBy.lastname}`
                : "Not yet approved";
              const createdAt = data.created_at
                ? new Date(data.created_at).toLocaleString()
                : "N/A";

              // Build the HTML for the modal content
              const detailsHtml = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6><strong>User:</strong> ${
                                  user.firstname || ""
                                } ${user.lastname || ""}</h6>
                                <p><strong>Email:</strong> ${
                                  user.email || "N/A"
                                }</p>
                                <p><strong>Phone:</strong> ${
                                  user.phone || "N/A"
                                }</p>
                                <p><strong>State of Origin:</strong> ${
                                  user.stateOfOrigin || "N/A"
                                }</p>
                                <p><strong>LGA:</strong> ${
                                  user.lgaOfOrigin || "N/A"
                                }</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Status:</strong>
                                    <span class="badge ${
                                      data.status === "Approved"
                                        ? "bg-success"
                                        : data.status === "Rejected"
                                        ? "bg-danger"
                                        : "bg-warning"
                                    }">
                                        ${data.status}
                                    </span>
                                </p>
                                <p><strong>Approved By:</strong> ${approvedBy}</p>
                                <p><strong>Request Date:</strong> ${createdAt}</p>
                                <p><strong>Profile Completed:</strong> ${
                                  user.isProfileCompleted
                                    ? '<span class="badge bg-success">Yes</span>'
                                    : '<span class="badge bg-danger">No</span>'
                                }</p>
                            </div>
                        </div>
                    `;
              $("#viewCertRequestContent").html(detailsHtml);
            },
            error: function (xhr) {
              console.error(
                "Failed to fetch request details:",
                xhr.responseJSON.message
              );
              $("#viewCertRequestContent").html(
                "<p class='text-danger'>Failed to load request details.</p>"
              );
            },
          });
        });
      });

      document.addEventListener("DOMContentLoaded", function () {
        // Toggle functionality for Transactions page
        const transactionsChartsBtn = document.getElementById(
          "transactionsChartsBtn"
        );
        const transactionsTableBtn = document.getElementById(
          "transactionsTableBtn"
        );
        const transactionsChartsView = document.getElementById(
          "transactions-charts-view"
        );
        const transactionsTableView = document.getElementById(
          "transactions-table-view"
        );

        transactionsChartsBtn.addEventListener("click", function () {
          transactionsChartsView.classList.remove("d-none");
          transactionsTableView.classList.add("d-none");
          transactionsChartsBtn.classList.add("active");
          transactionsTableBtn.classList.remove("active");

          // Refresh charts when switching to charts view
          if (typeof initializeTransactionsPage === "function") {
            initializeTransactionsPage();
          }
        });

        transactionsTableBtn.addEventListener("click", function () {
          transactionsChartsView.classList.add("d-none");
          transactionsTableView.classList.remove("d-none");
          transactionsChartsBtn.classList.remove("active");
          transactionsTableBtn.classList.add("active");

          // Refresh table when switching to table view
          if (typeof initializeTransactionsPage === "function") {
            initializeTransactionsPage();
          }
        });
      });

      // Modify your initializeTransactionsPage function to work with the toggle
      function initializeTransactionsPage() {
        const headers = {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
        };

        // 1️⃣ Fetch Transactions for Table (only if table view is visible)
        if (!$("#transactions-table-view").hasClass("d-none")) {
          $.ajax({
            url: `${BACKEND_URL}/transaction/all`,
            method: "GET",
            headers,
            success: function (transactions) {
              if (!Array.isArray(transactions)) {
                console.error("Invalid transactions data:", transactions);
                return;
              }

              if ($.fn.DataTable.isDataTable("#transactionsTable")) {
                $("#transactionsTable").DataTable().destroy();
              }

              transactionsTable = $("#transactionsTable").DataTable({
                data: transactions.map((t) => ({
                  id: t._id,
                  user: t.userId?.firstname
                    ? `${t.userId.firstname} ${t.userId.lastname}`
                    : "N/A",
                  type: t.paymentType || "N/A",
                  amount: (t.amount || 0) / 100,
                  status: t.status || "Pending",
                  datetime: new Date(t.createdAt).toLocaleString(),
                })),
                columns: [
                  {
                    title: "S/N",
                    data: null,
                    orderable: false,
                    searchable: false,
                    render: function (data, type, row, meta) {
                      return meta.row + meta.settings._iDisplayStart + 1;
                    },
                  },
                  {
                    data: "id",
                    visible: false,
                    searchable: false,
                  },
                  { data: "user" },
                  { data: "type" },

                  {
                    data: "amount",
                    render: (data) =>
                      `₦${Number(data).toLocaleString(undefined, {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2,
                      })}`,
                  },
                  {
                    data: "status",
                    render: function (data) {
                      let badgeClass = "bg-primary";
                      if (data === "Completed") badgeClass = "bg-success";
                      else if (data === "Pending") badgeClass = "bg-warning";
                      else if (data === "Failed") badgeClass = "bg-danger";
                      return `<span class="badge ${badgeClass}">${data}</span>`;
                    },
                  },
                  { data: "datetime" },
                  {
                    data: null,
                    render: function (data, type, row) {
                      return `
                              <div class="btn-group">
                                  <button class="btn btn-sm btn-outline-primary view-transaction-btn" data-id="${row.id}">
                                      <i class="bi bi-eye"></i>
                                  </button>
                                  <button class="btn btn-sm btn-outline-success refund-transaction-btn" data-id="${row.id}">
                                      <i class="bi bi-arrow-counterclockwise"></i>
                                  </button>
                              </div>
                          `;
                    },
                  },
                ],
                responsive: true,
                pageLength: 10,
              });
            },
            error: function (err) {
              console.error("Error loading transactions:", err);
            },
          });
        }

        // 2️⃣ Fetch Transaction Stats (for charts, only if charts view is visible)
        if (!$("#transactions-charts-view").hasClass("d-none")) {
          $.ajax({
            url: `${BACKEND_URL}/transaction/stats`,
            method: "GET",
            headers,
            success: function (stats) {
              // Destroy existing charts before creating new ones
              destroyChart(transactionTrendChart, "transactionTrendChart");
              destroyChart(revenueStateChart, "revenueStateChart");

              // Transaction Trend Chart
              const ctx1 = document
                .getElementById("transactionTrendChart")
                .getContext("2d");
              transactionTrendChart = new Chart(ctx1, {
                type: "line",
                data: {
                  labels: Object.keys(stats.monthlyTrend || {}),
                  datasets: [
                    {
                      label: "Revenue (₦)",
                      data: Object.values(stats.monthlyTrend || {}),
                      borderColor: "#10b981",
                      backgroundColor: "rgba(16, 185, 129, 0.1)",
                      tension: 0.4,
                      fill: true,
                    },
                  ],
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: { legend: { display: false } },
                  scales: {
                    y: {
                      beginAtZero: true,
                      ticks: {
                        callback: (value) => "₦" + value.toLocaleString(),
                      },
                    },
                  },
                },
              });

              // Revenue by State Chart
              const ctx2 = document
                .getElementById("revenueStateChart")
                .getContext("2d");
              revenueStateChart = new Chart(ctx2, {
                type: "pie",
                data: {
                  labels: Object.keys(stats.revenueByLGA || {}),
                  datasets: [
                    {
                      data: Object.values(stats.revenueByLGA || {}),
                      backgroundColor: [
                        "#6366f1",
                        "#8b5cf6",
                        "#ec4899",
                        "#f59e0b",
                        "#10b981",
                        "#64748b",
                      ],
                    },
                  ],
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: { legend: { position: "bottom" } },
                },
              });
            },
            error: function (err) {
              console.error("Error loading stats:", err);
            },
          });
        }
      }

      // ✅ SAFETY WRAPPER — Ensures Chart.js fully releases canvas
      function destroyChart(chartInstance, canvasId) {
        if (chartInstance) {
          chartInstance.destroy();
        }
        // Chart.js maintains internal registry. Manually unregister if needed:
        const chartStatus = Chart.getChart(canvasId);
        if (chartStatus) {
          chartStatus.destroy();
        }

        // Clear canvas to ensure it's truly free
        const canvas = document.getElementById(canvasId);
        if (canvas) {
          const ctx = canvas.getContext("2d");
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
      }

      function initializeAnalyticsPage() {
        $.ajax({
          url: `${BACKEND_URL}/users/analytics-stats`,
          method: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          success: function (stats) {
            initializeMapView();

            // ✅ GROWTH COMPARISON CHART
            const userLabels = Object.keys(stats.monthlyUserGrowth || {});
            const userGrowth = Object.values(stats.monthlyUserGrowth || {});
            const requestVolume = Object.values(
              stats.monthlyRequestVolume || {}
            );

            if (!growthComparisonChart) {
              const ctx1 = document
                .getElementById("growthComparisonChart")
                .getContext("2d");
              growthComparisonChart = new Chart(ctx1, {
                type: "line",
                data: {
                  labels: userLabels,
                  datasets: [
                    {
                      label: "User Growth",
                      data: userGrowth,
                      borderColor: "#6366f1",
                      backgroundColor: "rgba(99, 102, 241, 0.1)",
                      tension: 0.4,
                      fill: true,
                    },
                    {
                      label: "Request Volume",
                      data: requestVolume,
                      borderColor: "#10b981",
                      backgroundColor: "rgba(16, 185, 129, 0.1)",
                      tension: 0.4,
                      fill: true,
                    },
                  ],
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  scales: {
                    y: { beginAtZero: true },
                  },
                },
              });
            }

            // ✅ AVERAGE PROCESSING TIME CHART
            const processLabels = Object.keys(
              stats.averageProcessingTime || {}
            );
            const processValues = Object.values(
              stats.averageProcessingTime || {}
            );

            if (!processingTimeChart) {
              const ctx2 = document
                .getElementById("processingTimeChart")
                .getContext("2d");
              processingTimeChart = new Chart(ctx2, {
                type: "bar",
                data: {
                  labels: processLabels,
                  datasets: [
                    {
                      label: "Average Processing Time (hours)",
                      data: processValues,
                      backgroundColor: "#6366f1",
                    },
                  ],
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: { legend: { display: false } },
                  scales: { y: { beginAtZero: true } },
                },
              });
            }

            // ✅ REQUEST TYPE DISTRIBUTION CHART
            const requestLabels = Object.keys(
              stats.requestTypeDistribution || {}
            );
            const requestValues = Object.values(
              stats.requestTypeDistribution || {}
            );

            if (!requestTypeChart) {
              const ctx3 = document
                .getElementById("requestTypeChart")
                .getContext("2d");
              requestTypeChart = new Chart(ctx3, {
                type: "doughnut",
                data: {
                  labels: requestLabels,
                  datasets: [
                    {
                      data: requestValues,
                      backgroundColor: [
                        "#6366f1",
                        "#8b5cf6",
                        "#ec4899",
                        "#f59e0b",
                      ],
                    },
                  ],
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: { legend: { position: "bottom" } },
                },
              });
            }
          },
          error: function (err) {
            console.error("Error loading analytics:", err);
          },
        });
      }

      function initializeMapView() {
        // Initialize the map and center it on Nigeria (approx)
        const map = L.map("mapView").setView([7.5, 8.8], 7); // Benue State focus

        // Add OpenStreetMap tiles
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 18,
          attribution: "© OpenStreetMap contributors",
        }).addTo(map);

        // Fetch location-based stats from API
        $.ajax({
          url: `${BACKEND_URL}/idcard/location-stats`,
          method: "GET",
          headers: { Authorization: `Bearer ${token}` },
          success: function (response) {
            if (!response || !Array.isArray(response)) return;

            response.forEach((location) => {
              const { name, lat, lng, totalRequests } = location;

              // Add a circle marker for each location
              L.circleMarker([lat, lng], {
                radius: Math.sqrt(totalRequests) * 1.5, // size proportional to requests
                color: "#6366f1",
                fillColor: "#6366f1",
                fillOpacity: 0.5,
              })
                .addTo(map)
                .bindPopup(
                  `<strong>${name}</strong><br>Total Requests: ${totalRequests}`
                );
            });
          },
          error: function (err) {
            console.error("Error loading location stats:", err);
          },
        });
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Toggle functionality for Roles page
        const rolesChartsBtn = document.getElementById("rolesChartsBtn");
        const rolesTableBtn = document.getElementById("rolesTableBtn");
        const rolesChartsView = document.getElementById("roles-charts-view");
        const rolesTableView = document.getElementById("roles-table-view");

        rolesChartsBtn.addEventListener("click", function () {
          rolesChartsView.classList.remove("d-none");
          rolesTableView.classList.add("d-none");
          rolesChartsBtn.classList.add("active");
          rolesTableBtn.classList.remove("active");

          // Refresh charts when switching to charts view
          if (typeof initializeRolesPage === "function") {
            initializeRolesPage();
          }
        });

        rolesTableBtn.addEventListener("click", function () {
          rolesChartsView.classList.add("d-none");
          rolesTableView.classList.remove("d-none");
          rolesChartsBtn.classList.remove("active");
          rolesTableBtn.classList.add("active");

          // Refresh table when switching to table view
          if (typeof initializeRolesPage === "function") {
            initializeRolesPage();
          }
        });
      });

      // Modify your initializeRolesPage function to work with the toggle
      async function initializeRolesPage() {
        try {
          // 🔹 Fetch all users from backend (needed for both views)
          const response = await $.ajax({
            url: `${BACKEND_URL}/users`,
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          const users = Array.isArray(response.data) ? response.data : [];

          // 1️⃣ LOGIC FOR TABLE VIEW
          if (!$("#roles-table-view").hasClass("d-none")) {
            if ($.fn.DataTable.isDataTable("#rolesTable")) {
              $("#rolesTable").DataTable().destroy();
            }

            rolesTable = $("#rolesTable").DataTable({
              data: users.map((u) => ({
                id: u._id,
                name:
                  `${u.firstname || ""} ${u.lastname || ""}`.trim() || "N/A",
                email: u.email || "N/A",
                role: u.role || "user",
                assignedBy: u.assignedBy
                  ? `${u.assignedBy?.firstname} ${u.assignedBy?.lastname}`
                  : "N/A",
                registeredAt: new Date(u.created_at).toLocaleString(),
              })),
              columns: [
                {
                  title: "S/N",
                  data: null,
                  orderable: false,
                  searchable: false,
                  render: function (data, type, row, meta) {
                    return meta.row + meta.settings._iDisplayStart + 1;
                  },
                },
                {
                  data: "id",
                  visible: false,
                  searchable: false,
                },
                { data: "name" },
                { data: "email" },
                {
                  data: "role",
                  render: function (data) {
                    let badgeClass = "bg-primary";
                    if (data === "super_admin") badgeClass = "bg-danger";
                    else if (data === "support_admin")
                      badgeClass = "bg-warning";
                    else if (data === "kindred_head") badgeClass = "bg-info";
                    else badgeClass = "bg-success";

                    return `<span class="badge ${badgeClass}">${data
                      .replace("_", " ")
                      .toUpperCase()}</span>`;
                  },
                },
                { data: "assignedBy" },
                { data: "registeredAt" },
                {
                  data: null,
                  render: function (data, type, row) {
                    return `
                              <button class="btn btn-sm btn-outline-primary change-role-btn"
                                  data-id="${row.id}"
                                  data-user="${row.name}"
                                  data-bs-toggle="modal"
                                  data-bs-target="#changeRoleModal">
                                  <i class="bi bi-person-badge"></i> Change Role
                              </button>
                          `;
                  },
                },
              ],
              responsive: true,
              pageLength: 10,
            });
          }

          // 2️⃣ LOGIC FOR CHARTS & SUMMARY VIEW
          if (!$("#roles-charts-view").hasClass("d-none")) {
            // 🔹 Prepare role counts for chart and summary table
            const roleCounts = {
              global_admin: 0,
              support_admin: 0,
              kindred_head: 0,
              user: 0,
            };

            users.forEach((u) => {
              const role = (u.role || "user").toLowerCase();
              if (roleCounts[role] !== undefined) roleCounts[role]++;
              else roleCounts.user++; // fallback
            });

            // 🔹 Populate Role Permissions Summary Table
            const roleStatsBody = document.getElementById("roleStatsTableBody");
            const rolePermissions = {
              "Global Admin": "Full system access",
              "Support Admin": "Manage requests & users",
              "Kindred Head": "Manage kindred members",
              User: "View and request services",
            };

            let tableHTML = "";
            const roleLabels = {
              global_admin: "Global Admin",
              support_admin: "Support Admin",
              kindred_head: "Kindred Head",
              user: "User",
            };

            for (const roleKey in roleCounts) {
              const count = roleCounts[roleKey];
              const roleName = roleLabels[roleKey];
              const permissions = rolePermissions[roleName] || "N/A";
              tableHTML += `
          <tr>
            <td><strong>${roleName}</strong></td>
            <td><span class="badge bg-primary">${count}</span></td>
            <td>${permissions}</td>
          </tr>
        `;
            }
            roleStatsBody.innerHTML = tableHTML;

            // 🔹 Initialize role distribution chart
            destroyChart(roleDistributionChart, "roleDistributionChart");
            const ctx = document
              .getElementById("roleDistributionChart")
              .getContext("2d");
            roleDistributionChart = new Chart(ctx, {
              type: "pie",
              data: {
                labels: [
                  "Support Admin",
                  "Kindred Head",
                  "User",
                  "Global Admin",
                ],
                datasets: [
                  {
                    data: [
                      roleCounts.support_admin,
                      roleCounts.kindred_head,
                      roleCounts.user,
                      roleCounts.global_admin,
                    ],
                    backgroundColor: [
                      // "#ef4444",
                      "#f59e0b",
                      "#3b82f6",
                      "#10b981",
                      "#8b5cf6",
                    ],
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: { position: "bottom" },
                },
              },
            });
          }
        } catch (error) {
          showNotification(
            "Failed to load roles. Please check your network or API.",
            "error"
          );
        }
      }

      // ✅ SAFETY WRAPPER — Ensures Chart.js fully releases canvas
      function destroyChart(chartInstance, canvasId) {
        if (chartInstance) {
          chartInstance.destroy();
        }
        // Chart.js maintains internal registry. Manually unregister if needed:
        const chartStatus = Chart.getChart(canvasId);
        if (chartStatus) {
          chartStatus.destroy();
        }

        // Clear canvas to ensure it's truly free
        const canvas = document.getElementById(canvasId);
        if (canvas) {
          const ctx = canvas.getContext("2d");
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
      }

      $(document).on("click", ".change-role-btn", function () {
        const userId = $(this).data("id");
        const userName = $(this).data("user");
        $("#changeRoleUserId").val(userId);
        $("#changeRoleUser").val(userName);
      });
      // 🔹 Handle Change Role Form Submission
      $("#changeRoleForm").on("submit", function (e) {
        e.preventDefault();
        const userId = $("#changeRoleUserId").val();
        const newRole = $("#changeRoleNew").val();
        if (!userId || !newRole) {
          alert("Please select a valid role.");
          return;
        }

        $.ajax({
          url: `${BACKEND_URL}/users/${userId}/role`,
          method: "PATCH",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          data: JSON.stringify({ role: newRole }),
          success: function (response) {
            $("#changeRoleModal").modal("hide");
            showNotification("✅ User role updated successfully!", "success");
            // Refresh roles page to reflect changes
            initializeRolesPage();
          },
          error: function (xhr) {
            showNotification(xhr.responseJSON.message, "error");
          },
        });
      });

      function loadRoleStats() {
        $.ajax({
          url: `${BACKEND_URL}/users/role-stats`,
          method: "GET",
          headers: { Authorization: `Bearer ${token}` },
          success: function (data) {
            const tbody = $("#roleStatsTableBody");
            tbody.empty();

            const roles = [
              {
                key: "global_admin",
                label: "Global Admin",
                badge: "bg-custom-purple",
              },
              {
                key: "support_admin",
                label: "Support Admin",
                badge: "bg-warning",
              },
              { key: "kindred_head", label: "Kindred Head", badge: "bg-info" },
              { key: "user", label: "User", badge: "bg-primary" },
            ];

            roles.forEach((role) => {
              const roleData = data[role.key] || {
                count: 0,
                permissions: "N/A",
              };
              tbody.append(`
                    <tr>
                    <td><span class="badge ${role.badge}">${
                role.label
              }</span></td>
                    <td>${roleData.count.toLocaleString()}</td>
                    <td>${roleData.permissions}</td>
                    </tr>
                `);
            });
          },
          error: function (xhr) {
            $("#roleStatsTableBody").html(`
                <tr><td colspan="3" class="text-danger">Failed to load data</td></tr>
                `);
            console.error("Error fetching role stats:", xhr.responseText);
          },
        });
      }

      $(document).ready(function () {
        loadRoleStats();
        $("#refreshRoleStats").click(loadRoleStats);
      });

      function showNotification(message, type = "info") {
        const alertClass =
          type === "success"
            ? "alert-success"
            : type === "error"
            ? "alert-danger"
            : type === "warning"
            ? "alert-warning"
            : "alert-info";

        const notification = $(`
                <div class="alert ${alertClass} alert-dismissible fade show position-fixed" style="top: 80px; right: 20px; z-index: 9999; min-width: 300px;">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `);

        $("body").append(notification);

        setTimeout(() => {
          notification.alert("close");
        }, 5000);
      }

      function exportTable(format) {
        showNotification(
          `Exporting table as ${format.toUpperCase()}...`,
          "info"
        );

        // In a real implementation, this would call the appropriate export function
        // For now, we'll just show a notification

        const table = document.getElementById("usersTable");
        const rows = Array.from(table.querySelectorAll("tr"));

        if (rows.length === 0) {
          showNotification("No table data to export!", "warning");
          return;
        }

        showNotification(
          `Exporting table as ${format.toUpperCase()}...`,
          "info"
        );

        if (format === "csv") {
          exportToCSV(rows);
        } else if (format === "pdf") {
          exportToPDF(rows);
        } else {
          showNotification("Unsupported export format!", "error");
        }
      }

      // 🟩 Export to CSV
      function exportToCSV(rows) {
        const csvContent = rows
          .map((row) => {
            const cols = Array.from(row.querySelectorAll("th, td")).map(
              (col) => `"${col.textContent.trim().replace(/"/g, '""')}"`
            );
            return cols.join(",");
          })
          .join("\n");

        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `users_${new Date().toISOString().slice(0, 10)}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showNotification("Table exported successfully as CSV", "success");
      }

      // 🟦 Export to PDF
      function exportToPDF(rows) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF("l", "pt", "a4"); // landscape mode
        const head = [
          Array.from(rows[0].querySelectorAll("th")).map((th) =>
            th.textContent.trim()
          ),
        ];
        const body = rows
          .slice(1)
          .map((row) =>
            Array.from(row.querySelectorAll("td")).map((td) =>
              td.textContent.trim()
            )
          );

        doc.text("All Users", 40, 40);
        doc.autoTable({
          startY: 60,
          head: head,
          body: body,
          styles: { fontSize: 8 },
          headStyles: { fillColor: [41, 128, 185] },
        });

        doc.save(`users_${new Date().toISOString().slice(0, 10)}.pdf`);

        setTimeout(() => {
          showNotification(
            `Table exported successfully as ${format.toUpperCase()}`,
            "success"
          );
        }, 1500);
      }
    </script>

    <script>
      $(document).ready(function () {
        // Populate states dropdown
        const states = Object.keys(nigerData).map((state) =>
          state.replace("_", " ").toUpperCase()
        );
        states.forEach((state) => {
          $("#userState").append(new Option(state, state));
        });

        // Update LGAs when state changes
        $("#userState").on("change", function () {
          const selectedState = $(this).val().toLowerCase().replace(" ", "_");
          const lgas = nigerData[selectedState] || [];
          const lgaSelect = $("#userLGA");
          lgaSelect.empty().append(new Option("Select LGA", ""));
          lgas.forEach((lga) => {
            lgaSelect.append(new Option(lga, lga));
          });
        });
      });

      $("#userNIN").on("blur", async function () {
        const nin = $(this).val().trim();
        if (/^\d{11}$/.test(nin)) {
          try {
            $("#ninStatus").html(
              '<span class="text-info">Verifying NIN...</span>'
            );

            const response = await $.ajax({
              url: `${BACKEND_URL}/auth/verify`,
              type: "POST",
              contentType: "application/json",
              data: JSON.stringify({ nin }),
            });

            if (response.success && response.data) {
              const {
                firstname,
                lastname,
                middlename,
                dob,
                phone,
                stateOfOrigin,
                lga,
              } = response.data;

              $("#firstName").val(firstname).prop("readonly", true);
              $("#lastName").val(lastname).prop("readonly", true);
              $("#userPhone").val(phone).prop("readonly", true);
              $("#middleName").val(middlename).prop("readonly", true);
              $("#DOB").val(dob).prop("readonly", true);

              // Populate state of origin
              if (stateOfOrigin) {
                // Convert stateOfOrigin to match your select options
                let formattedState = stateOfOrigin
                  .toLowerCase()
                  .replace(/\s+/g, "_");

                // Set the value and trigger change to update LGA dropdown
                $("#userState")
                  .val(formattedState)
                  .trigger("change")
                  .prop("disabled", true);

                // If you're using Bootstrap selectpicker
                if ($("#userState").hasClass("selectpicker")) {
                  $("#userState").selectpicker("refresh");
                }
                // Populate LGA after a small delay to ensure state change is processed
                setTimeout(() => {
                  if (lga) {
                    $("#userLGA")
                      .val(lga)
                      .trigger("change")
                      .prop("disabled", true);

                    if ($("#userLGA").hasClass("selectpicker")) {
                      $("#userLGA").selectpicker("refresh");
                    }
                  }
                }, 200);
              }

              $("#ninStatus").html(
                '<span class="text-success">NIN Verified ✅</span>'
              );
            } else {
              $("#ninStatus").html(
                '<span class="text-danger">NIN not found.</span>'
              );
            }
          } catch (error) {
            $("#ninStatus").html(
              `<span class="text-danger">${
                error.responseJSON?.message || "Verification failed."
              }</span>`
            );
          }
        }
      });

      async function loadRoles() {
        try {
          const res = await fetch(`${BACKEND_URL}/users/roles`, {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          const result = await res.json();

          console.log("Roles fetched:", result);

          if (result.status !== "success") {
            console.error("Failed to load roles:", result);
            return;
          }

          const roles = result.data;
          const roleSelect = $("#userRole");

          roleSelect.empty(); // Clear old values
          roleSelect.append(`<option value="">Select Role</option>`);

          roles.forEach((role) => {
            roleSelect.append(
              `<option value="${role.value}">${role.label}</option>`
            );
          });
        } catch (error) {
          console.error("Error loading roles:", error);
        }
      }
      $("#addUserModal").on("shown.bs.modal", function () {
        loadRoles();
      });

      $("#addUserBtn").on("click", async function () {
        const data = {
          firstname: $("#firstName").val().trim(),
          middlename: $("#middleName").val().trim(),
          lastname: $("#lastName").val().trim(),
          email: $("#userEmail").val().trim(),
          phone: $("#userPhone").val().trim(),
          NIN: $("#userNIN").val().trim(),
          role: $("#userRole").val(),
          stateOfOrigin: $("#userState").val(),
          lgaOfOrigin: $("#userLGA").val(),
          DOB: $("#DOB").val().trim(),
        };

        // Validate
        // for (let key in data) {
        //   if (!data[key]) {
        //     alert("Please complete all fields.");
        //     return;
        //   }
        // }

        try {
          $("#addUserBtn").prop("disabled", true).text("Processing...");

          const res = await fetch(`${BACKEND_URL}/auth/admin-signup`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          });

          const result = await res.json();

          if (!res.ok) {
            showNotification(result.message || "Error adding user", "error");
            return;
          }

          showNotification(
            "User created successfully. Password sent to email",
            "success"
          );
          $("#addUserModal").modal("hide");
          $("#addUserForm")[0].reset();

          initializeUsersPage();
        } catch (error) {
          console.error(error);
          alert("Network error. Try again.");
        }
      });
    </script>

    <script>
      // Fetch and display ID card request stats
      async function fetchIdCardStats() {
        try {
          $.ajax({
            url: `${BACKEND_URL}/idcard/get-all-request`,
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            success: function (data) {
              if (!Array.isArray(data)) {
                return;
              }
              // 🔹 Calculate counts
              const total = data.length;
              const approved = data.filter(
                (req) => req.status === "Approved"
              ).length;
              const pending = data.filter(
                (req) => req.status === "Pending"
              ).length;
              const rejected = data.filter(
                (req) => req.status === "Rejected"
              ).length;

              // 🔹 Update the card UI
              $(".totalRequests").text(total);
              $("#approvedRequests").text(approved);
              $("#pendingRequests").text(pending);
              $("#rejectedRequests").text(rejected);
            },
            error: function (xhr) {
              console.error(
                "Failed to fetch ID card requests:",
                xhr.responseText
              );
            },
          });
        } catch (err) {
          console.error("Unexpected error:", err);
        }
      }

      // Fetch and display ID certificate request stats
      async function fetchCertStats() {
        try {
          $.ajax({
            url: `${BACKEND_URL}/indigene/certificate/get-all-request`,
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            success: function (data) {
              if (!Array.isArray(data)) {
                return;
              }

              // 🔹 Calculate counts
              const total = data.length;
              const approved = data.filter(
                (req) => req.status === "Approved"
              ).length;
              const pending = data.filter(
                (req) => req.status === "Pending"
              ).length;
              const rejected = data.filter(
                (req) => req.status === "Rejected"
              ).length;

              // 🔹 Update the card UI
              $(".totalCertRequests").text(total);
              $("#approvedCertRequests").text(approved);
              $("#pendingCertRequests").text(pending);
              $("#rejectedCertRequests").text(rejected);
            },
            error: function (xhr) {
              console.error(
                "Failed to fetch ID card requests:",
                xhr.responseText
              );
            },
          });
        } catch (err) {
          console.error("Unexpected error:", err);
        }
      }

      // Fetch and display ID certificate request stats
      function initializeTransactionStats() {
        $.ajax({
          url: `${BACKEND_URL}/transaction/stats`,
          method: "GET",
          headers: { Authorization: `Bearer ${token}` },
          success: function (stats) {
            const {
              totalTransactions,
              totalRevenue,
              avgTransaction,
              successRate,
            } = stats;

            // Format numbers with commas and ₦ sign
            const formatCurrency = (amount) =>
              "₦" +
              amount.toLocaleString("en-NG", { maximumFractionDigits: 2 });

            // Update UI
            $(".total-transactions").text(totalTransactions.toLocaleString());
            $(".total-revenue").text(formatCurrency(totalRevenue));
            $(".average-amount").text(formatCurrency(avgTransaction));
            $(".success-rate").text(successRate.toFixed(1) + "%");
            $(".kpi-value").text(formatCurrency(totalRevenue));
          },
          error: function (xhr) {
            console.error(
              "Failed to fetch transaction stats:",
              xhr.responseText
            );
          },
        });
      }

      /**
       * Calls the backend to generate and download a PDF report.
       */
      function exportTransactionsToPDF() {
        showNotification("Generating report, please wait...", "info");

        // Construct the URL with any query parameters if needed
        const url = `${BACKEND_URL}/transaction/export/pdf`;

        // Create a temporary link element to trigger the download
        const link = document.createElement("a");
        link.href = url;
        link.target = "_blank"; // Recommended for downloads
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // Note: For better error handling, you could use fetch() and create a Blob,
        // but a simple link is often sufficient for this use case.
      }

      // Add this code to your existing JavaScript file

      // --- PDF Export Logic ---

      // Assign jsPDF to a variable from the window object
      const { jsPDF } = window.jspdf;

      // Export functionality for Identity Cards
      document.addEventListener("DOMContentLoaded", function () {
        // Get the export button for ID cards
        const exportIdcardBtn = document.getElementById(
          "exportTdcardRequestBtn"
        );

        if (exportIdcardBtn) {
          exportIdcardBtn.addEventListener("click", function () {
            exportIdcardRequestsPDF();
          });
        }

        // Get the export button for Certificates
        const exportCertificateBtn = document.querySelector(
          "#certificates-page .btn-primary"
        );

        if (exportCertificateBtn) {
          // Add an ID to the button for easier reference if it doesn't have one
          if (!exportCertificateBtn.id) {
            exportCertificateBtn.id = "exportCertificateBtn";
          }

          exportCertificateBtn.addEventListener("click", function () {
            exportCertificateRequestsPDF();
          });
        }
      });

      // Function to export ID card requests as PDF
      function exportIdcardRequestsPDF() {
        showLoadingIndicator();

        $.ajax({
          url: `${BACKEND_URL}/idcard/get-all-request`,
          method: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          success: function (response) {
            if (!Array.isArray(response)) {
              console.error("Invalid response format:", response);
              hideLoadingIndicator();
              alert("Failed to load data for export.");
              return;
            }

            // Process the data for the PDF table
            const tableData = response.map((req) => [
              req.userId?.firstname && req.userId?.lastname
                ? `${req.userId.firstname} ${req.userId.lastname}`
                : "Unknown",
              req.userId?.stateOfOrigin || "N/A",
              req.userId?.lgaOfOrigin || "N/A",
              req.status
                ? req.status.charAt(0).toUpperCase() + req.status.slice(1)
                : "Pending",
              req.created_at
                ? new Date(req.created_at).toLocaleDateString()
                : "N/A",
              req.userId?.isProfileCompleted ? "Yes" : "No",
              req.approvedBy
                ? `${req.approvedBy?.firstname} ${req.approvedBy?.lastname}`
                : req.status === "Rejected"
                ? "Rejected by Admin"
                : "Not yet approved",
              req?.paymentStatus || "Pending",
            ]);

            // Generate filename with current date
            const today = new Date().toISOString().split("T")[0];
            const filename = `ID_Card_Requests_${today}.pdf`;

            // Generate and download the PDF
            generatePDF(tableData, filename, "Identity Card Requests Report");

            hideLoadingIndicator();
          },
          error: function (xhr) {
            console.error(
              "Failed to fetch ID card requests:",
              xhr.responseText
            );
            hideLoadingIndicator();
            alert("Error exporting data. Please try again.");
          },
        });
      }

      // Function to export Certificate requests as PDF
      function exportCertificateRequestsPDF() {
        showLoadingIndicator();

        $.ajax({
          url: `${BACKEND_URL}/indigene/certificate/get-all-request`,
          method: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          success: function (response) {
            if (!Array.isArray(response)) {
              console.error("Invalid response format:", response);
              hideLoadingIndicator();
              alert("Failed to load data for export.");
              return;
            }

            // Process the data for the PDF table
            const tableData = response.map((req) => [
              req.userId?.firstname && req.userId?.lastname
                ? `${req.userId.firstname} ${req.userId.lastname}`
                : "Unknown",
              req.userId?.stateOfOrigin || "N/A",
              req.userId?.lgaOfOrigin || "N/A",
              req.status
                ? req.status.charAt(0).toUpperCase() + req.status.slice(1)
                : "Pending",
              req.created_at
                ? new Date(req.created_at).toLocaleDateString()
                : "N/A",
              req.userId?.isProfileCompleted ? "Yes" : "No",
              req.approvedBy
                ? `${req.approvedBy?.firstname} ${req.approvedBy?.lastname}`
                : req.status === "Rejected"
                ? "Rejected by Admin"
                : "Not yet approved",
              req?.paymentStatus || "Pending",
            ]);

            // Generate filename with current date
            const today = new Date().toISOString().split("T")[0];
            const filename = `Certificate_Requests_${today}.pdf`;

            // Generate and download the PDF
            generatePDF(
              tableData,
              filename,
              "Certificate of Origin Requests Report"
            );

            hideLoadingIndicator();
          },
          error: function (xhr) {
            console.error(
              "Failed to fetch certificate requests:",
              xhr.responseText
            );
            hideLoadingIndicator();
            alert("Error exporting data. Please try again.");
          },
        });
      }

      /**
       * Generates a PDF document from the provided data and triggers a download.
       * @param {Array<Array<any>>} data - The data to be displayed in the table (array of rows).
       * @param {string} filename - The name of the file to be downloaded.
       * @param {string} title - The title to be displayed at the top of the PDF.
       */
      function generatePDF(data, filename, title) {
        // Initialize jsPDF
        const doc = new jsPDF("l", "pt", "a4"); // 'l' for landscape orientation

        // Add title to the PDF
        doc.setFontSize(18);
        doc.text(title, doc.internal.pageSize.getWidth() / 2, 40, {
          align: "center",
        });

        // Add generation date
        doc.setFontSize(10);
        doc.text(
          `Generated on: ${new Date().toLocaleString()}`,
          doc.internal.pageSize.getWidth() / 2,
          55,
          { align: "center" }
        );

        // Define the table columns
        const columns = [
          { header: "User Name", dataKey: "user" },
          { header: "State", dataKey: "state" },
          { header: "LGA", dataKey: "lga" },
          { header: "Status", dataKey: "status" },
          { header: "Request Date", dataKey: "requestDate" },
          { header: "Profile Completed", dataKey: "profileCompleted" },
          { header: "Approved By", dataKey: "approvedBy" },
          { header: "Payment Status", dataKey: "paymentStatus" },
        ];

        // Convert the array of arrays to an array of objects for autoTable
        const tableData = data.map((row) => {
          const obj = {};
          columns.forEach((col, index) => {
            obj[col.dataKey] = row[index];
          });
          return obj;
        });

        // Add the table to the PDF
        doc.autoTable({
          head: [columns.map((col) => col.header)],
          body: data,
          startY: 70, // Start the table 70 points from the top
          theme: "grid",
          styles: { fontSize: 9, cellPadding: 5 },
          headStyles: { fillColor: [41, 128, 185], textColor: 255 }, // Blue header, white text
          alternateRowStyles: { fillColor: [245, 245, 245] }, // Light grey for alternate rows
          margin: { top: 70, left: 20, right: 20 },
        });

        // Save the PDF
        doc.save(filename);
      }

      // --- Loading Indicator (Unchanged) ---

      // You can reuse the same loading indicator functions from the previous solution
      function showLoadingIndicator() {
        let loader = document.getElementById("export-loader");

        if (!loader) {
          loader = document.createElement("div");
          loader.id = "export-loader";
          loader.innerHTML = `
      <div style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      ">
        <div style="
          background-color: white;
          padding: 20px;
          border-radius: 5px;
          text-align: center;
        ">
          <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3 mb-0">Preparing PDF export...</p>
        </div>
      </div>
    `;
          document.body.appendChild(loader);
        } else {
          loader.style.display = "flex";
        }
      }

      function hideLoadingIndicator() {
        const loader = document.getElementById("export-loader");
        if (loader) {
          loader.style.display = "none";
        }
      }

      // 🔹 Initialize the stats after page load
      $(document).ready(function () {
        fetchIdCardStats();
        fetchCertStats();
        initializeTransactionStats();
      });

      $(document).ready(function () {
        // Load settings when the settings page is shown
        $("#settings-link").on("click", function (e) {
          e.preventDefault();
          loadSettings();
        });

        // Save settings button click
        $("#saveSettingsBtn").on("click", function () {
          saveSettings();
          saveVerificationLimits();
        });

        // Toggle API key visibility
        $("#toggleApiKey").on("click", function () {
          const apiKeyInput = $("#apiKey");
          const icon = $(this).find("i");

          if (apiKeyInput.attr("type") === "password") {
            apiKeyInput.attr("type", "text");
            icon.removeClass("bi-eye").addClass("bi-eye-slash");
          } else {
            apiKeyInput.attr("type", "password");
            icon.removeClass("bi-eye-slash").addClass("bi-eye");
          }
        });

        // Test API connection button click
        $("#testApiBtn").on("click", function () {
          testApiConnection();
        });

        // Regenerate API key button click
        $("#regenerateApiKeyBtn").on("click", function () {
          regenerateApiKey();
        });

        // Function to load settings from the backend
        function loadSettings() {
          $.ajax({
            url: `${BACKEND_URL}/settings`,
            method: "GET",
            success: function (response) {
              // Populate system settings
              $("#systemName").val(response.systemName);
              $("#systemEmail").val(response.systemEmail);
              $("#currency").val(response.currency);
              $("#dateFormat").val(response.dateFormat);
              $("#timezone").val(response.timezone);

              // Populate notification settings
              $("#emailNotifications").prop(
                "checked",
                response.emailNotifications
              );
              $("#smsNotifications").prop("checked", response.smsNotifications);
              $("#pushNotifications").prop(
                "checked",
                response.pushNotifications
              );
              $("#newUserAlerts").prop("checked", response.newUserAlerts);
              $("#requestAlerts").prop("checked", response.requestAlerts);
              $("#systemAlerts").prop("checked", response.systemAlerts);

              // Populate security settings
              $("#sessionTimeout").val(response.sessionTimeout);
              $("#twoFactorAuth").prop("checked", response.twoFactorAuth);
              $("#passwordComplexity").prop(
                "checked",
                response.passwordComplexity
              );
              $("#limitLoginAttempts").prop(
                "checked",
                response.limitLoginAttempts
              );
              $("#maxLoginAttempts").val(response.maxLoginAttempts);
              $("#lockoutDuration").val(response.lockoutDuration);

              // Populate API configuration
              $("#apiBaseUrl").val(response.apiBaseUrl);
              $("#apiKey").val(response.apiKey);
              $("#webhookUrl").val(response.webhookUrl);
              $("#webhookSecret").val(response.webhookSecret);
            },
            error: function (error) {
              showToast(
                "Failed to load settings: " + error.responseJSON.message,
                "error"
              );
            },
          });

          $.ajax({
            url: `${BACKEND_URL}/verification-limits`, // Your new endpoint
            method: "GET",
            headers: { Authorization: `Bearer ${token}` },
            success: function (limits) {
              // Populate the new input fields with the values from the backend
              $("#familyVerificationLimit").val(limits.familyVerificationLimit);
              $("#neighborVerificationLimit").val(
                limits.neighborVerificationLimit
              );
            },
            error: function (xhr) {
              console.error(
                "Failed to load verification limits:",
                xhr.responseText
              );
              // Set default values if the call fails
              $("#familyVerificationLimit").val(3);
              $("#neighborVerificationLimit").val(3);
            },
          });
          // -
        }

        // --- NEW: Add this new function ---
        function saveVerificationLimits() {
          const familyLimit = $("#familyVerificationLimit").val();
          const neighborLimit = $("#neighborVerificationLimit").val();

          // Basic validation
          if (
            !familyLimit ||
            !neighborLimit ||
            familyLimit < 1 ||
            neighborLimit < 1
          ) {
            showNotification(
              "Verification limits must be positive numbers.",
              "warning"
            );
            return;
          }

          $.ajax({
            url: `${BACKEND_URL}/verification-limits`, // Your new endpoint
            method: "PUT", // Use PUT to update the existing limits
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            data: JSON.stringify({
              familyLimit: parseInt(familyLimit),
              neighborLimit: parseInt(neighborLimit),
            }),
            success: function (response) {
              showNotification(
                "Verification limits updated successfully!",
                "success"
              );
            },
            error: function (xhr) {
              const errorMessage =
                xhr.responseJSON?.message ||
                "Failed to update verification limits.";
              showNotification(errorMessage, "error");
            },
          });
        }
        // --- END of NEW function ---

        // Function to save settings to the backend
        function saveSettings() {
          const settings = {
            systemName: $("#systemName").val(),
            systemEmail: $("#systemEmail").val(),
            currency: $("#currency").val(),
            dateFormat: $("#dateFormat").val(),
            timezone: $("#timezone").val(),
            emailNotifications: $("#emailNotifications").is(":checked"),
            smsNotifications: $("#smsNotifications").is(":checked"),
            pushNotifications: $("#pushNotifications").is(":checked"),
            newUserAlerts: $("#newUserAlerts").is(":checked"),
            requestAlerts: $("#requestAlerts").is(":checked"),
            systemAlerts: $("#systemAlerts").is(":checked"),
            sessionTimeout: parseInt($("#sessionTimeout").val()),
            twoFactorAuth: $("#twoFactorAuth").is(":checked"),
            passwordComplexity: $("#passwordComplexity").is(":checked"),
            limitLoginAttempts: $("#limitLoginAttempts").is(":checked"),
            maxLoginAttempts: parseInt($("#maxLoginAttempts").val()),
            lockoutDuration: parseInt($("#lockoutDuration").val()),
            apiBaseUrl: $("#apiBaseUrl").val(),
            apiKey: $("#apiKey").val(),
            webhookUrl: $("#webhookUrl").val(),
            webhookSecret: $("#webhookSecret").val(),
          };

          $.ajax({
            url: `${BACKEND_URL}/settings`,
            method: "PATCH",
            data: JSON.stringify(settings),
            contentType: "application/json",
            success: function (response) {
              showToast("Settings saved successfully!", "success");
            },
            error: function (error) {
              showToast(
                "Failed to save settings: " + error.responseJSON.message,
                "error"
              );
            },
          });
        }

        // Function to test API connection
        function testApiConnection() {
          const apiBaseUrl = $("#apiBaseUrl").val();
          const apiKey = $("#apiKey").val();
          console.log("apiBaseUrl", apiBaseUrl, "apiKey", apiKey);

          $.ajax({
            url: `${BACKEND_URL}/settings/test-api`,
            method: "POST",
            data: {
              apiBaseUrl: apiBaseUrl,
              apiKey: apiKey,
            },
            success: function (response) {
              console.log("API Test Response:", response);
              if (response.success) {
                showToast("API connection successful!", "success");
              } else {
                showToast(
                  "API connection failed: " + response.message,
                  "error"
                );
              }
            },
            error: function (error) {
              showToast(
                "API connection test failed: " + error.responseJSON.message,
                "error"
              );
            },
          });
        }

        // Function to regenerate API key
        function regenerateApiKey() {
          // Generate a random API key
          const newApiKey =
            "sk_test_" +
            Math.random().toString(36).substring(2, 15) +
            Math.random().toString(36).substring(2, 15);
          $("#apiKey").val(newApiKey);
          showToast(
            "API key regenerated. Remember to save your changes.",
            "info"
          );
        }

        // Function to show toast notification
        function showToast(message, type = "info") {
          const toast = $("#settingsToast");
          const toastMessage = $("#toastMessage");

          // Update toast message
          toastMessage.text(message);

          // Update toast class based on type
          toast.removeClass(
            "bg-success bg-danger bg-info bg-warning text-white"
          );

          if (type === "success") {
            toast.addClass("bg-success text-white");
          } else if (type === "error") {
            toast.addClass("bg-danger text-white");
          } else if (type === "warning") {
            toast.addClass("bg-warning text-white");
          } else {
            toast.addClass("bg-info text-white");
          }

          // Show toast
          const bsToast = new bootstrap.Toast(toast[0]);
          bsToast.show();
        }

        // ✅ Render notifications & unread count
        function renderNotifications(notifListData) {
          const unreadCount = notifListData.filter((n) => !n.read).length;
          $("#notificationCount").text(unreadCount);

          const notifList = $(".dropdown-menu.dropdown-menu-end");
          notifList.find(".dynamic-notification, .mark-all-container").remove(); // clear old ones

          if (notifListData.length > 0) {
            notifListData.slice(0, 5).forEach((n) => {
              notifList.find("hr.dropdown-divider").before(`
      <li class="dynamic-notification">
        <a 
          class="dropdown-item d-block ${!n.read ? "fw-bold" : "text-muted"}" 
          href="#" 
          data-id="${n._id}"
        >
          ${n.title}<br/>
          <small class="text-muted">${
            n.createdAt ? new Date(n.createdAt).toLocaleString() : ""
          }</small>
        </a>
      </li>
    `);
            });

            // ✅ Add "Mark all as read" button
            notifList.append(`
    <li class="mark-all-container text-center p-2">
      <button class="btn btn-sm btn-outline-primary" id="markAllReadBtn">
        <i class="bi bi-check2-all me-1"></i> Mark all as read
      </button>
    </li>
  `);
          } else {
            notifList.find("hr.dropdown-divider").before(`
      <li class="dynamic-notification">
        <a class="dropdown-item text-muted" href="#">No notifications yet</a>
      </li>
    `);
          }
        }

        // ✅ Mark one notification as read
        $(document).on("click", ".dropdown-item[data-id]", async function (e) {
          e.preventDefault();
          const notifId = $(this).data("id");

          try {
            await $.ajax({
              url: `${BACKEND_URL}/notifications/${notifId}/mark-read`,
              method: "PATCH",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            });

            $(this)
              .removeClass("fw-bold")
              .addClass("text-muted")
              .fadeTo(300, 0.8);

            const countEl = $("#notificationCount");
            const currentCount = parseInt(countEl.text()) || 0;
            countEl.text(Math.max(currentCount - 1, 0));
          } catch (error) {
            console.error("Failed to mark notification as read:", error);
          }
        });

        // ✅ Mark all notifications as read
        $(document).on("click", "#markAllReadBtn", async function () {
          try {
            await $.ajax({
              url: `${BACKEND_URL}/notifications/mark-all-read`,
              method: "PATCH",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            });

            $(".dropdown-item[data-id]")
              .removeClass("fw-bold")
              .addClass("text-muted");
            $("#notificationCount").text(0);
            showNotification("All notifications marked as read", "success");
          } catch (error) {
            showNotification(
              "Failed to mark all notifications as read:",
              "error"
            );
          }
        });

        // ✅ WebSocket: receive new notifications in real-time
        function initializeWebSocket() {
          const socket = io(BACKEND_URL, {
            extraHeaders: {
              Authorization: `Bearer ${token}`,
            },
          });

          socket.on("connect", () => {
            console.log("✅ Connected to notification server");
          });

          socket.on("notification:new", (notification) => {
            console.log("🔔 New notification received:", notification);

            // Show toast
            showNotification(notification.title, notification.message);

            // Increment unread count
            const countEl = $("#notificationCount");
            const currentCount = parseInt(countEl.text()) || 0;
            countEl.text(currentCount + 1);

            // Prepend notification
            const notifList = $(".dropdown-menu.dropdown-menu-end");
            notifList.find("hr.dropdown-divider").before(`
    <li class="dynamic-notification">
      <a class="dropdown-item fw-bold" href="#" data-id="${notification._id}">
        ${notification.title}<br/>
        <small class="text-muted">${new Date().toLocaleString()}</small>
      </a>
    </li>
  `);
          });

          socket.on("disconnect", () => {
            console.log("❌ Disconnected from notification server");
          });
        }
        $(document).ready(function () {
          initializeWebSocket();
        });
      });

      // Create the download overlay element
      const downloadOverlay = document.createElement("div");
      downloadOverlay.className = "download-loading-overlay";
      downloadOverlay.innerHTML = `
    <div class="download-loading-content">
        <div class="download-spinner"></div>
        <h5>Preparing Your Document</h5>
        <p class="text-muted">Please wait while we prepare your document for download.</p>
        <div class="progress mt-3" style="height: 6px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" style="width: 100%"></div>
        </div>
    </div>
`;
      // Download certificate & ID card
      document.body.appendChild(downloadOverlay);

      $(document).on(
        "click",
        ".btn-certificate-download, .btn-idcard-download",
        function () {
          if (
            !confirm(
              "Warning! Sure you want to download? Click ok to continue or else click cancel."
            )
          ) {
            return;
          }
          const $button = $(this);
          const requestId = $button.data("id");
          const isCertificate = $button.hasClass("btn-certificate-download");

          // Store original button content
          const originalContent = $button.html();

          // Show spinner on button
          $button.prop("disabled", true).html(`
        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        Downloading...
    `);

          // Show the overlay
          $(downloadOverlay).addClass("show");

          // Update overlay message based on document type
          const documentType = isCertificate
            ? "Certificate of Origin"
            : "Identity Card";
          $(downloadOverlay).find("h5").text(`Preparing Your ${documentType}`);

          // Determine download URL
          const downloadUrl = isCertificate
            ? `${BACKEND_URL}/indigene/certificate/download/${requestId}`
            : `${BACKEND_URL}/idcard/download/${requestId}`;

          // Create a temporary link element
          const link = document.createElement("a");
          link.style.display = "none";
          document.body.appendChild(link);

          // Use fetch to handle the download
          fetch(downloadUrl, {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }

              // Update overlay message
              $(downloadOverlay).find("h5").text("Processing Your Document");
              $(downloadOverlay)
                .find("p")
                .text(
                  "Your document is being processed. This may take a moment."
                );

              return response.blob();
            })
            .then((blob) => {
              // Create URL for the blob
              const url = window.URL.createObjectURL(blob);

              // Set link properties
              link.href = url;
              link.download = isCertificate
                ? `Certificate_${requestId}.pdf`
                : `ID_Card_${requestId}.pdf`;

              // Trigger the download
              link.click();

              // Clean up
              window.URL.revokeObjectURL(url);
              document.body.removeChild(link);

              // Hide the overlay
              $(downloadOverlay).removeClass("show");

              // Show success state on button
              $button.prop("disabled", false).html(`
            <i class="bi bi-check-circle me-2"></i>
            Downloaded
        `);

              // Reset button after a delay
              setTimeout(() => {
                $button.html(originalContent);
              }, 3000);
            })
            .catch((error) => {
              const errorMessage = error.responseJSON
                ? error.responseJSON.message
                : "Download window has expired. Please make a new request.";
              showNotification(errorMessage, "error");

              // Hide the overlay
              $(downloadOverlay).removeClass("show");

              // Show error state on button
              $button.prop("disabled", false).html(`
            <i class="bi bi-exclamation-triangle me-2"></i>
            Error
        `);

              // Reset button after a delay
              setTimeout(() => {
                $button.html(originalContent);
              }, 3000);
            });
        }
      );

      const nigerData = {
        adamawa: [
          "Demsa",
          "Fufure",
          "Ganye",
          "Gayuk",
          "Gombi",
          "Grie",
          "Hong",
          "Jada",
          "Larmurde",
          "Madagali",
          "Maiha",
          "Mayo Belwa",
          "Michika",
          "Mubi North",
          "Mubi South",
          "Numan",
          "Shelleng",
          "Song",
          "Toungo",
          "Yola North",
          "Yola South",
        ],
        akwa_ibom: [
          "Abak",
          "Eastern Obolo",
          "Eket",
          "Esit Eket",
          "Essien Udim",
          "Etim Ekpo",
          "Etinan",
          "Ibeno",
          "Ibesikpo Asutan",
          "Ibiono-Ibom",
          "Ikot Abasi",
          "Ika",
          "Ikono",
          "Ikot Ekpene",
          "Ini",
          "Mkpat-Enin",
          "Itu",
          "Mbo",
          "Nsit-Atai",
          "Nsit-Ibom",
          "Nsit-Ubium",
          "Obot Akara",
          "Okobo",
          "Onna",
          "Oron",
          "Udung-Uko",
          "Ukanafun",
          "Oruk Anam",
          "Uruan",
          "Urue-Offong/Oruko",
          "Uyo",
        ],
        anambra: [
          "Aguata",
          "Anambra East",
          "Anaocha",
          "Awka North",
          "Anambra West",
          "Awka South",
          "Ayamelum",
          "Dunukofia",
          "Ekwusigo",
          "Idemili North",
          "Idemili South",
          "Ihiala",
          "Njikoka",
          "Nnewi North",
          "Nnewi South",
          "Ogbaru",
          "Onitsha North",
          "Onitsha South",
          "Orumba North",
          "Orumba South",
          "Oyi",
        ],
        abia: [
          "Aba North",
          "Arochukwu",
          "Aba South",
          "Bende",
          "Isiala Ngwa North",
          "Ikwuano",
          "Isiala Ngwa South",
          "Isuikwuato",
          "Obi Ngwa",
          "Ohafia",
          "Osisioma",
          "Ugwunagbo",
          "Ukwa East",
          "Ukwa West",
          "Umuahia North",
          "Umuahia South",
          "Umu Nneochi",
        ],
        bauchi: [
          "Alkaleri",
          "Bauchi",
          "Bogoro",
          "Damban",
          "Darazo",
          "Dass",
          "Gamawa",
          "Ganjuwa",
          "Giade",
          "Itas/Gadau",
          "Jama'are",
          "Katagum",
          "Kirfi",
          "Misau",
          "Ningi",
          "Shira",
          "Tafawa Balewa",
          "Toro",
          "Warji",
          "Zaki",
        ],
        benue: [
          "Agatu",
          "Apa",
          "Ado",
          "Buruku",
          "Gboko",
          "Guma",
          "Gwer East",
          "Gwer West",
          "Katsina-Ala",
          "Konshisha",
          "Kwande",
          "Logo",
          "Makurdi",
          "Obi",
          "Ogbadibo",
          "Ohimini",
          "Oju",
          "Okpokwu",
          "Oturkpo",
          "Tarka",
          "Ukum",
          "Ushongo",
          "Vandeikya",
        ],
        borno: [
          "Abadam",
          "Askira/Uba",
          "Bama",
          "Bayo",
          "Biu",
          "Chibok",
          "Damboa",
          "Dikwa",
          "Guzamala",
          "Gubio",
          "Hawul",
          "Gwoza",
          "Jere",
          "Kaga",
          "Kala/Balge",
          "Konduga",
          "Kukawa",
          "Kwaya Kusar",
          "Mafa",
          "Magumeri",
          "Maiduguri",
          "Mobbar",
          "Marte",
          "Monguno",
          "Ngala",
          "Nganzai",
          "Shani",
        ],
        bayelsa: [
          "Brass",
          "Ekeremor",
          "Kolokuma/Opokuma",
          "Nembe",
          "Ogbia",
          "Sagbama",
          "Southern Ijaw",
          "Yenagoa",
        ],
        cross_river: [
          "Abi",
          "Akamkpa",
          "Akpabuyo",
          "Bakassi",
          "Bekwarra",
          "Biase",
          "Boki",
          "Calabar Municipal",
          "Calabar South",
          "Etung",
          "Ikom",
          "Obanliku",
          "Obubra",
          "Obudu",
          "Odukpani",
          "Ogoja",
          "Yakuur",
          "Yala",
        ],
        delta: [
          "Aniocha North",
          "Aniocha South",
          "Bomadi",
          "Burutu",
          "Ethiope West",
          "Ethiope East",
          "Ika North East",
          "Ika South",
          "Isoko North",
          "Isoko South",
          "Ndokwa East",
          "Ndokwa West",
          "Okpe",
          "Oshimili North",
          "Oshimili South",
          "Patani",
          "Sapele",
          "Udu",
          "Ughelli North",
          "Ukwuani",
          "Ughelli South",
          "Uvwie",
          "Warri North",
          "Warri South",
          "Warri South West",
        ],
        ebonyi: [
          "Abakaliki",
          "Afikpo North",
          "Ebonyi",
          "Afikpo South",
          "Ezza North",
          "Ikwo",
          "Ezza South",
          "Ivo",
          "Ishielu",
          "Izzi",
          "Ohaozara",
          "Ohaukwu",
          "Onicha",
        ],
        edo: [
          "Akoko-Edo",
          "Egor",
          "Esan Central",
          "Esan North-East",
          "Esan South-East",
          "Esan West",
          "Etsako Central",
          "Etsako East",
          "Etsako West",
          "Igueben",
          "Ikpoba Okha",
          "Orhionmwon",
          "Oredo",
          "Ovia North-East",
          "Ovia South-West",
          "Owan East",
          "Owan West",
          "Uhunmwonde",
        ],
        ekiti: [
          "Ado Ekiti",
          "Efon",
          "Ekiti East",
          "Ekiti South-West",
          "Ekiti West",
          "Emure",
          "Gbonyin",
          "Ido Osi",
          "Ijero",
          "Ikere",
          "Ilejemeje",
          "Irepodun/Ifelodun",
          "Ikole",
          "Ise/Orun",
          "Moba",
          "Oye",
        ],
        enugu: [
          "Awgu",
          "Aninri",
          "Enugu East",
          "Enugu North",
          "Ezeagu",
          "Enugu South",
          "Igbo Etiti",
          "Igbo Eze North",
          "Igbo Eze South",
          "Isi Uzo",
          "Nkanu East",
          "Nkanu West",
          "Nsukka",
          "Udenu",
          "Oji River",
          "Uzo Uwani",
          "Udi",
        ],
        abuja: [
          "Abaji",
          "Bwari",
          "Gwagwalada",
          "Kuje",
          "Kwali",
          "Municipal Area Council",
        ],
        gombe: [
          "Akko",
          "Balanga",
          "Billiri",
          "Dukku",
          "Funakaye",
          "Gombe",
          "Kaltungo",
          "Kwami",
          "Nafada",
          "Shongom",
          "Yamaltu/Deba",
        ],
        jigawa: [
          "Auyo",
          "Babura",
          "Buji",
          "Biriniwa",
          "Birnin Kudu",
          "Dutse",
          "Gagarawa",
          "Garki",
          "Gumel",
          "Guri",
          "Gwaram",
          "Gwiwa",
          "Hadejia",
          "Jahun",
          "Kafin Hausa",
          "Kazaure",
          "Kiri Kasama",
          "Kiyawa",
          "Kaugama",
          "Maigatari",
          "Malam Madori",
          "Miga",
          "Sule Tankarkar",
          "Roni",
          "Ringim",
          "Yankwashi",
          "Taura",
        ],
        lagos: [
          "Agege",
          "Ajeromi-Ifelodun",
          "Alimosho",
          "Amuwo-Odofin",
          "Badagry",
          "Apapa",
          "Epe",
          "Eti Osa",
          "Ibeju-Lekki",
          "Ifako-Ijaiye",
          "Ikeja",
          "Ikorodu",
          "Kosofe",
          "Lagos Island",
          "Mushin",
          "Lagos Mainland",
          "Ojo",
          "Oshodi-Isolo",
          "Shomolu",
          "Surulere Lagos State",
        ],
        oyo: [
          "Afijio",
          "Akinyele",
          "Atiba",
          "Atisbo",
          "Egbeda",
          "Ibadan North",
          "Ibadan North-East",
          "Ibadan North-West",
          "Ibadan South-East",
          "Ibarapa Central",
          "Ibadan South-West",
          "Ibarapa East",
          "Ido",
          "Ibarapa North",
          "Irepo",
          "Iseyin",
          "Itesiwaju",
          "Iwajowa",
          "Kajola",
          "Lagelu",
          "Ogbomosho North",
          "Ogbomosho South",
          "Ogo Oluwa",
          "Olorunsogo",
          "Oluyole",
          "Ona Ara",
          "Orelope",
          "Ori Ire",
          "Oyo",
          "Oyo East",
          "Saki East",
          "Saki West",
          "Surulere Oyo State",
        ],
        imo: [
          "Aboh Mbaise",
          "Ahiazu Mbaise",
          "Ehime Mbano",
          "Ezinihitte",
          "Ideato North",
          "Ideato South",
          "Ihitte/Uboma",
          "Ikeduru",
          "Isiala Mbano",
          "Mbaitoli",
          "Isu",
          "Ngor Okpala",
          "Njaba",
          "Nkwerre",
          "Nwangele",
          "Obowo",
          "Oguta",
          "Ohaji/Egbema",
          "Okigwe",
          "Orlu",
          "Orsu",
          "Oru East",
          "Oru West",
          "Owerri Municipal",
          "Owerri North",
          "Unuimo",
          "Owerri West",
        ],
        kaduna: [
          "Birnin Gwari",
          "Chikun",
          "Giwa",
          "Ikara",
          "Igabi",
          "Jaba",
          "Jema'a",
          "Kachia",
          "Kaduna North",
          "Kaduna South",
          "Kagarko",
          "Kajuru",
          "Kaura",
          "Kauru",
          "Kubau",
          "Kudan",
          "Lere",
          "Makarfi",
          "Sabon Gari",
          "Sanga",
          "Soba",
          "Zangon Kataf",
          "Zaria",
        ],
        kebbi: [
          "Aleiro",
          "Argungu",
          "Arewa Dandi",
          "Augie",
          "Bagudo",
          "Birnin Kebbi",
          "Bunza",
          "Dandi",
          "Fakai",
          "Gwandu",
          "Jega",
          "Kalgo",
          "Koko/Besse",
          "Maiyama",
          "Ngaski",
          "Shanga",
          "Suru",
          "Sakaba",
          "Wasagu/Danko",
          "Yauri",
          "Zuru",
        ],
        kano: [
          "Ajingi",
          "Albasu",
          "Bagwai",
          "Bebeji",
          "Bichi",
          "Bunkure",
          "Dala",
          "Dambatta",
          "Dawakin Kudu",
          "Dawakin Tofa",
          "Doguwa",
          "Fagge",
          "Gabasawa",
          "Garko",
          "Garun Mallam",
          "Gezawa",
          "Gaya",
          "Gwale",
          "Gwarzo",
          "Kabo",
          "Kano Municipal",
          "Karaye",
          "Kibiya",
          "Kiru",
          "Kumbotso",
          "Kunchi",
          "Kura",
          "Madobi",
          "Makoda",
          "Minjibir",
          "Nasarawa",
          "Rano",
          "Rimin Gado",
          "Rogo",
          "Shanono",
          "Takai",
          "Sumaila",
          "Tarauni",
          "Tofa",
          "Tsanyawa",
          "Tudun Wada",
          "Ungogo",
          "Warawa",
          "Wudil",
        ],
        kogi: [
          "Ajaokuta",
          "Adavi",
          "Ankpa",
          "Bassa",
          "Dekina",
          "Ibaji",
          "Idah",
          "Igalamela Odolu",
          "Ijumu",
          "Kogi",
          "Kabba/Bunu",
          "Lokoja",
          "Ofu",
          "Mopa Muro",
          "Ogori/Magongo",
          "Okehi",
          "Okene",
          "Olamaboro",
          "Omala",
          "Yagba East",
          "Yagba West",
        ],
        osun: [
          "Aiyedire",
          "Atakunmosa West",
          "Atakunmosa East",
          "Aiyedaade",
          "Boluwaduro",
          "Boripe",
          "Ife East",
          "Ede South",
          "Ife North",
          "Ede North",
          "Ife South",
          "Ejigbo",
          "Ife Central",
          "Ifedayo",
          "Egbedore",
          "Ila",
          "Ifelodun",
          "Ilesa East",
          "Ilesa West",
          "Irepodun",
          "Irewole",
          "Isokan",
          "Iwo",
          "Obokun",
          "Odo Otin",
          "Ola Oluwa",
          "Olorunda",
          "Oriade",
          "Orolu",
          "Osogbo",
        ],
        sokoto: [
          "Gudu",
          "Gwadabawa",
          "Illela",
          "Isa",
          "Kebbe",
          "Kware",
          "Rabah",
          "Sabon Birni",
          "Shagari",
          "Silame",
          "Sokoto North",
          "Sokoto South",
          "Tambuwal",
          "Tangaza",
          "Tureta",
          "Wamako",
          "Wurno",
          "Yabo",
          "Binji",
          "Bodinga",
          "Dange Shuni",
          "Goronyo",
          "Gada",
        ],
        plateau: [
          "Bokkos",
          "Barkin Ladi",
          "Bassa",
          "Jos East",
          "Jos North",
          "Jos South",
          "Kanam",
          "Kanke",
          "Langtang South",
          "Langtang North",
          "Mangu",
          "Mikang",
          "Pankshin",
          "Qua'an Pan",
          "Riyom",
          "Shendam",
          "Wase",
        ],
        taraba: [
          "Ardo Kola",
          "Bali",
          "Donga",
          "Gashaka",
          "Gassol",
          "Ibi",
          "Jalingo",
          "Karim Lamido",
          "Kumi",
          "Lau",
          "Sardauna",
          "Takum",
          "Ussa",
          "Wukari",
          "Yorro",
          "Zing",
        ],
        yobe: [
          "Bade",
          "Bursari",
          "Damaturu",
          "Fika",
          "Fune",
          "Geidam",
          "Gujba",
          "Gulani",
          "Jakusko",
          "Karasuwa",
          "Machina",
          "Nangere",
          "Nguru",
          "Potiskum",
          "Tarmuwa",
          "Yunusari",
          "Yusufari",
        ],
        zamfara: [
          "Anka",
          "Birnin Magaji/Kiyaw",
          "Bakura",
          "Bukkuyum",
          "Bungudu",
          "Gummi",
          "Gusau",
          "Kaura Namoda",
          "Maradun",
          "Shinkafi",
          "Maru",
          "Talata Mafara",
          "Tsafe",
          "Zurmi",
        ],
        katsina: [
          "Bakori",
          "Batagarawa",
          "Batsari",
          "Baure",
          "Bindawa",
          "Charanchi",
          "Danja",
          "Dandume",
          "Dan Musa",
          "Daura",
          "Dutsi",
          "Dutsin Ma",
          "Faskari",
          "Funtua",
          "Ingawa",
          "Jibia",
          "Kafur",
          "Kaita",
          "Kankara",
          "Kankia",
          "Katsina",
          "Kurfi",
          "Kusada",
          "Mai'Adua",
          "Malumfashi",
          "Mani",
          "Mashi",
          "Matazu",
          "Musawa",
          "Rimi",
          "Sabuwa",
          "Safana",
          "Sandamu",
          "Zango",
        ],
        kwara: [
          "Asa",
          "Baruten",
          "Edu",
          "Ilorin East",
          "Ifelodun",
          "Ilorin South",
          "Ekiti Kwara State",
          "Ilorin West",
          "Irepodun",
          "Isin",
          "Kaiama",
          "Moro",
          "Offa",
          "Oke Ero",
          "Oyun",
          "Pategi",
        ],
        nasarawa: [
          "Akwanga",
          "Awe",
          "Doma",
          "Karu",
          "Keana",
          "Keffi",
          "Lafia",
          "Kokona",
          "Nasarawa Egon",
          "Nasarawa",
          "Obi",
          "Toto",
          "Wamba",
        ],
        niger: [
          "Agaie",
          "Agwara",
          "Bida",
          "Borgu",
          "Bosso",
          "Chanchaga",
          "Edati",
          "Gbako",
          "Gurara",
          "Katcha",
          "Kontagora",
          "Lapai",
          "Lavun",
          "Mariga",
          "Magama",
          "Mokwa",
          "Mashegu",
          "Moya",
          "Paikoro",
          "Rafi",
          "Rijau",
          "Shiroro",
          "Suleja",
          "Tafa",
          "Wushishi",
        ],
        rivers: [
          "Abua/Odual",
          "Ahoada East",
          "Ahoada West",
          "Andoni",
          "Akuku-Toru",
          "Asari-Toru",
          "Bonny",
          "Degema",
          "Emuoha",
          "Eleme",
          "Ikwerre",
          "Etche",
          "Gokana",
          "Khana",
          "Obio/Akpor",
          "Ogba/Egbema/Ndoni",
          "Ogu/Bolo",
          "Okrika",
          "Omuma",
          "Opobo/Nkoro",
          "Oyigbo",
          "Port Harcourt",
          "Tai",
        ],
      };
    </script>

    <script>
      function logout() {
        localStorage.removeItem("token");
      }

      $(document).on("click", '[data-page="profile"]', function (e) {
        e.preventDefault();

        // Hide all pages
        $(".page-content").addClass("d-none");

        // Show profile page
        $("#profile-page").removeClass("d-none");

        // Close dropdown after clicking
        $(this).closest(".dropdown-menu").removeClass("show");
        $(this).closest(".dropdown").removeClass("show");
      });
    </script>

    <script>
      $(document).ready(function () {
        // Initialize modals
        const changePasswordModal = new bootstrap.Modal(
          document.getElementById("changePasswordModal")
        );
        const enable2FAModal = new bootstrap.Modal(
          document.getElementById("enable2FAModal")
        );

        // Change Password Button Click
        $("#changePasswordBtn").click(function () {
          changePasswordModal.show();
        });

        // Enable 2FA Button Click
        $("#enable2FABtn").click(function () {
          enable2FAModal.show();
          reset2FASetup();
          setup2FA(); // This is the missing call
        });

        // Password strength checker
        $("#newPassword").on("input", function () {
          const password = $(this).val();
          let strength = 0;
          let strengthText = "";

          if (password.length >= 8) strength++;
          if (password.match(/[a-z]+/)) strength++;
          if (password.match(/[A-Z]+/)) strength++;
          if (password.match(/[0-9]+/)) strength++;
          if (password.match(/[$@#&!]+/)) strength++;

          const strengthBar = $("#passwordStrength");
          const strengthTextElement = $("#passwordStrengthText");

          strengthBar.removeClass();
          strengthTextElement.removeClass();

          if (password.length === 0) {
            strengthBar.hide();
            strengthTextElement.text("");
          } else if (strength < 3) {
            strengthBar.addClass("password-strength strength-weak");
            strengthTextElement.text("Weak password").addClass("text-danger");
          } else if (strength === 3 || strength === 4) {
            strengthBar.addClass("password-strength strength-medium");
            strengthTextElement
              .text("Medium strength")
              .addClass("text-warning");
          } else {
            strengthBar.addClass("password-strength strength-strong");
            strengthTextElement
              .text("Strong password")
              .addClass("text-success");
          }
        });

        // Confirm password validation
        $("#confirmPassword").on("input", function () {
          const newPassword = $("#newPassword").val();
          const confirmPassword = $(this).val();

          if (newPassword !== confirmPassword) {
            $(this).addClass("is-invalid");
            $("#passwordMatchFeedback").show();
          } else {
            $(this).removeClass("is-invalid");
            $("#passwordMatchFeedback").hide();
          }
        });

        // Save Password Button Click
        $("#savePasswordBtn").click(function () {
          const currentPassword = $("#currentPassword").val();
          const newPassword = $("#newPassword").val();
          const confirmPassword = $("#confirmPassword").val();

          // Validate form
          if (!currentPassword || !newPassword || !confirmPassword) {
            showNotification("Please fill in all fields", "error");
            return;
          }

          if (newPassword !== confirmPassword) {
            showNotification("Passwords do not match", "error");
            return;
          }

          // Disable button to prevent multiple submissions
          $(this).prop("disabled", true).text("Processing...");

          // Make the API call
          $.ajax({
            url: `${BACKEND_URL}/auth/change-password`,
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            data: JSON.stringify({
              currentPassword: currentPassword,
              newPassword: newPassword,
            }),
            success: function (response) {
              showNotification("Password changed successfully", "success");
              changePasswordModal.hide();
              $("#changePasswordForm")[0].reset();
            },
            error: function (xhr) {
              const errorMessage = xhr.responseJSON
                ? xhr.responseJSON.message
                : "Failed to change password";
              showNotification(errorMessage, "error");
            },
            complete: function () {
              // Re-enable the button
              $("#savePasswordBtn")
                .prop("disabled", false)
                .text("Save Changes");
            },
          });
        });

        // 2FA Setup Process
        $("#2faContinueBtn").click(function () {
          $("#2faSetupStep1").hide();
          $("#2faSetupStep2").show();
          $(this).hide();
          $("#2faVerifyBtn").show();
        });

        $("#2faVerifyBtn").click(function () {
          const verificationCode = $("#verificationCode").val();

          if (!verificationCode || verificationCode.length !== 6) {
            showNotification(
              "Please enter a valid 6-digit verification code",
              "error"
            );
            return;
          }

          // Disable button to prevent multiple submissions
          $(this).prop("disabled", true).text("Verifying...");

          // API call to verify code
          $.ajax({
            url: `${BACKEND_URL}/auth/2fa/verify`,
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            data: JSON.stringify({ code: verificationCode }),
            success: function (response) {
              $("#2faSetupStep2").hide();
              $("#2faSetupStep3").show();
              $("#2faVerifyBtn").hide();
              $("#2faFinishBtn").show();

              // Store backup codes if provided
              if (response.backupCodes && response.backupCodes.length > 0) {
                const backupCodesHtml = response.backupCodes
                  .map((code) => `<code>${code}</code>`)
                  .join("");
                $(".backup-codes").html(backupCodesHtml);
              }
            },
            error: function (xhr) {
              const errorMessage = xhr.responseJSON
                ? xhr.responseJSON.message
                : "Invalid verification code";
              showNotification(errorMessage, "error");
            },
            complete: function () {
              // Re-enable the button
              $("#2faVerifyBtn").prop("disabled", false).text("Verify");
            },
          });
        });

        $("#2faFinishBtn").click(function () {
          if (!$("#backupCodesSaved").is(":checked")) {
            showNotification(
              "Please confirm you have saved your backup codes",
              "warning"
            );
            return;
          }

          // Disable button to prevent multiple submissions
          $(this).prop("disabled", true).text("Enabling...");

          // API call to enable 2FA
          $.ajax({
            url: `${BACKEND_URL}/auth/2fa/enable`,
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            success: function (response) {
              showNotification(
                "Two-factor authentication enabled successfully",
                "success"
              );
              enable2FAModal.hide();
              $("#enable2FABtn").html(
                '<i class="bi bi-shield-check me-2"></i>Disable Two-Factor Authentication'
              );
              $("#enable2FABtn")
                .removeClass("btn-outline-primary")
                .addClass("btn-outline-danger");
              $("#enable2FABtn")
                .off("click")
                .click(function () {
                  disable2FA();
                });
            },
            error: function (xhr) {
              const errorMessage = xhr.responseJSON
                ? xhr.responseJSON.message
                : "Failed to enable two-factor authentication";
              showNotification(errorMessage, "error");
            },
            complete: function () {
              // Re-enable the button
              $("#2faFinishBtn").prop("disabled", false).text("Finish Setup");
            },
          });
        });

        // Function to setup 2FA
        function setup2FA() {
          // Show loading state
          $("#2faSetupStep1").html(`
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Setting up two-factor authentication...</p>
            </div>
        `);

          // Fetch 2FA setup data from the server
          $.ajax({
            url: `${BACKEND_URL}/auth/2fa/setup`,
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            success: function (response) {
              console.log("2FA setup response:", response);

              // Check 2FA status to ensure the secret was stored
              $.ajax({
                url: `${BACKEND_URL}/auth/2fa/status`,
                method: "GET",
                headers: {
                  Authorization: `Bearer ${token}`,
                  "Content-Type": "application/json",
                },
                success: function (statusResponse) {
                  console.log("2FA status after setup:", statusResponse);

                  if (!statusResponse.hasSecret) {
                    showNotification(
                      "Failed to setup 2FA. Please try again.",
                      "error"
                    );
                    $("#2faSetupStep1").html(`
                                <div class="alert alert-danger">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    Failed to setup 2FA. Please try again.
                                </div>
                            `);
                    return;
                  }

                  // Reset step 1 content
                  $("#2faSetupStep1").html(`
                            <p>Two-factor authentication adds an extra layer of security to your account. Once enabled, you'll need to enter a verification code in addition to your password when signing in.</p>
                            <p>Click "Continue" to set up two-factor authentication.</p>
                        `);

                  // Update QR code with the URL from the server
                  $(".qr-code img").attr(
                    "src",
                    `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(
                      response.qrCodeUrl
                    )}`
                  );

                  // Update the manual entry code
                  $(".qr-code p strong").text(response.secret);
                },
                error: function (xhr) {
                  console.error("Error checking 2FA status:", xhr);
                  showNotification(
                    "Failed to verify 2FA setup. Please try again.",
                    "error"
                  );
                },
              });
            },
            error: function (xhr) {
              console.error("Error setting up 2FA:", xhr);
              const errorMessage = xhr.responseJSON
                ? xhr.responseJSON.message
                : "Failed to setup 2FA";
              showNotification(errorMessage, "error");

              // Reset step 1 content with error message
              $("#2faSetupStep1").html(`
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        ${errorMessage}
                    </div>
                    <p>Please try again later or contact support if the issue persists.</p>
                `);
            },
          });
        }

        function reset2FASetup() {
          $("#2faSetupStep1").show();
          $("#2faSetupStep2").hide();
          $("#2faSetupStep3").hide();
          $("#2faContinueBtn").show();
          $("#2faVerifyBtn").show();
          $("#2faFinishBtn").hide();
          $("#verificationCode").val("");
          $("#backupCodesSaved").prop("checked", false);

          // Reset QR code to placeholder
          $(".qr-code img").attr(
            "src",
            "https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=otpauth://totp/Example:demo@example.com?secret=JBSWY3DPEHPK3PXP&issuer=Example"
          );
          $(".qr-code p strong").text("JBSWY3DPEHPK3PXP");
        }

        function disable2FA() {
          if (
            confirm(
              "Are you sure you want to disable two-factor authentication? This will make your account less secure."
            )
          ) {
            // API call to disable 2FA
            $.ajax({
              url: `${BACKEND_URL}/auth/2fa/disable`,
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              success: function (response) {
                showNotification(
                  "Two-factor authentication disabled",
                  "success"
                );
                $("#enable2FABtn").html(
                  '<i class="bi bi-shield-check me-2"></i>Enable Two-Factor Authentication'
                );
                $("#enable2FABtn")
                  .removeClass("btn-outline-danger")
                  .addClass("btn-outline-primary");
                $("#enable2FABtn")
                  .off("click")
                  .click(function () {
                    enable2FAModal.show();
                    reset2FASetup();
                    setup2FA();
                  });
              },
              error: function (xhr) {
                const errorMessage = xhr.responseJSON
                  ? xhr.responseJSON.message
                  : "Failed to disable two-factor authentication";
                showNotification(errorMessage, "error");
              },
            });
          }
        }

        // Function to check 2FA status on page load
        function check2FAStatus() {
          $.ajax({
            url: `${BACKEND_URL}/auth/2fa/status`,
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            success: function (response) {
              // Update the button based on 2FA status
              if (response.isEnabled) {
                $("#enable2FABtn").html(
                  '<i class="bi bi-shield-check me-2"></i>Disable Two-Factor Authentication'
                );
                $("#enable2FABtn")
                  .removeClass("btn-outline-primary")
                  .addClass("btn-outline-danger");
                $("#enable2FABtn")
                  .off("click")
                  .click(function () {
                    disable2FA();
                  });
              } else {
                $("#enable2FABtn").html(
                  '<i class="bi bi-shield-check me-2"></i>Enable Two-Factor Authentication'
                );
                $("#enable2FABtn")
                  .removeClass("btn-outline-danger")
                  .addClass("btn-outline-primary");
                $("#enable2FABtn")
                  .off("click")
                  .click(function () {
                    enable2FAModal.show();
                    reset2FASetup();
                    setup2FA();
                  });
              }
            },
            error: function (xhr) {
              console.error("Error checking 2FA status:", xhr);
            },
          });
        }

        // Check 2FA status when the profile page is loaded
        if (
          window.location.hash === "#profile" ||
          document.getElementById("profile-page").classList.contains("active")
        ) {
          check2FAStatus();
        }
      });

      $(document).on("click", '[data-page="profile"]', function (e) {
        e.preventDefault();

        // Hide all pages
        $(".page-content").addClass("d-none");

        // Show profile page
        $("#profile-page").removeClass("d-none");

        // Close dropdown after clicking
        $(this).closest(".dropdown-menu").removeClass("show");
        $(this).closest(".dropdown").removeClass("show");
      });

      // Utility function to make API requests
      const apiRequest = (
        url,
        method,
        headers = {},
        data = null,
        onSuccess,
        onError
      ) => {
        $.ajax({
          url,
          method,
          headers,
          data,
          success: onSuccess,
          error: onError || ((error) => console.error("API Error:", error)),
        });
      };

      // Fetch user data for the current page
      const fetchUsersData = () => {
        const url = `${BACKEND_URL}/users`;
        const headers = { Authorization: `Bearer ${token}` };

        apiRequest(url, "GET", headers, null, (response) => {
          const { data } = response;
          const now = new Date();
          const currentMonth = now.getMonth();
          const currentYear = now.getFullYear();

          const { activeCount, inactiveCount, newThisMonthCount } = data.reduce(
            (acc, user) => {
              // Count active/inactive users
              if (user.isActive) {
                acc.activeCount++;
              } else {
                acc.inactiveCount++;
              }

              // Count users created this month
              const createdAt = new Date(user.created_at);
              if (
                createdAt.getMonth() === currentMonth &&
                createdAt.getFullYear() === currentYear
              ) {
                acc.newThisMonthCount++;
              }

              return acc;
            },
            { activeCount: 0, inactiveCount: 0, newThisMonthCount: 0 }
          );

          $("#usercount").text(data.length);
          $(".usercount").text(data.length);
          $(".isActive").text(activeCount);
          $("#inActive").text(inactiveCount);
          $("#new-this-month").text(newThisMonthCount);
        });
      };
      // })
    </script>
  </body>
</html>
