<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Dashboard - BICRIRMS System</title>

    <link
      rel="icon"
      type="image/png"
      href="/assets/images/benue-state-logo.png"
      sizes="16x16"
    />

    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <!-- DataTables CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"
    />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

    <style>
      :root {
        --sidebar-width: 260px;
        --sidebar-bg: #1a1d29;
        --sidebar-text: #a0a9c9;
        --sidebar-active: #4c5fd5;
        --header-height: 60px;
        --header-bg: #ffffff;
        --main-bg: #f5f6fa;
        --card-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
        --primary-color: #4c5fd5;
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
        --info-color: #3b82f6;
      }

      [data-theme="dark"] {
        --sidebar-bg: #0f0f14;
        --sidebar-text: #8892b0;
        --sidebar-active: #6366f1;
        --header-bg: #1a1d29;
        --main-bg: #111318;
        --card-bg: #1a1d29;
        --text-color: #e6e6e6;
        --border-color: #2a2d3a;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--main-bg);
        color: var(--text-color);
        transition: all 0.3s ease;
      }

      /* Sidebar Styles */
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: var(--sidebar-width);
        background-color: var(--sidebar-bg);
        z-index: 1000;
        transition: all 0.3s ease;
        overflow-y: auto;
      }

      .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .sidebar-menu {
        padding: 20px 0;
      }

      .sidebar-menu .nav-link {
        color: var(--sidebar-text);
        padding: 12px 20px;
        display: flex;
        align-items: center;
        transition: all 0.3s ease;
        border-radius: 0;
      }

      .sidebar-menu .nav-link:hover {
        background-color: rgba(255, 255, 255, 0.05);
        color: #fff;
      }

      .sidebar-menu .nav-link.active {
        background-color: var(--sidebar-active);
        color: #fff;
      }

      .sidebar-menu .nav-link i {
        margin-right: 10px;
        font-size: 18px;
      }

      .sidebar-menu .nav-link .badge {
        margin-left: auto;
      }

      /* Header Styles */
      .header {
        position: fixed;
        top: 0;
        left: var(--sidebar-width);
        right: 0;
        height: var(--header-height);
        background-color: var(--header-bg);
        z-index: 999;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        display: flex;
        align-items: center;
        padding: 0 20px;
        transition: all 0.3s ease;
      }

      .header .search-bar {
        flex: 1;
        max-width: 400px;
      }

      .header .header-actions {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      /* Main Content */
      .main-content {
        margin-left: var(--sidebar-width);
        margin-top: var(--header-height);
        padding: 20px;
        min-height: calc(100vh - var(--header-height));
        transition: all 0.3s ease;
      }

      /* Card Styles */
      .card {
        border: none;
        border-radius: 10px;
        box-shadow: var(--card-shadow);
        margin-bottom: 20px;
        background-color: var(--card-bg);
        transition: all 0.3s ease;
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      }

      .card-header {
        background-color: transparent;
        border-bottom: 1px solid var(--border-color);
        padding: 15px 20px;
        font-weight: 600;
      }

      .card-body {
        padding: 20px;
      }

      /* Profile Photo Upload */
      .profile-photo-container {
        position: relative;
        width: 150px;
        height: 150px;
        margin: 0 auto 20px;
      }

      .profile-photo {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid var(--primary-color);
      }
      .profile-avatar {
        width: 40px;
        height: 40px;
        object-fit: cover;
      }

      .profile-photo-upload {
        position: absolute;
        bottom: 0;
        right: 0;
        background-color: var(--primary-color);
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .profile-photo-upload:hover {
        background-color: #3b4cdb;
      }

      /* Profile Completion Bar */
      .profile-completion {
        margin-bottom: 20px;
      }

      .progress {
        height: 10px;
        border-radius: 5px;
      }

      /* Status Badge */
      .status-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
      }

      .status-badge.approved {
        background-color: #10b981;
        color: white;
      }

      .status-badge.pending {
        background-color: #f59e0b;
        color: white;
      }

      .status-badge.rejected {
        background-color: #ef4444;
      }

      .status-badge.verified {
        background-color: var(--success-color);
        color: white;
      }

      .status-badge.unverified {
        background-color: var(--warning-color);
        color: white;
      }

      /* Verification Status Badge */
      .verification-status {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-weight: 600;
      }

      .verification-status.verified {
        background-color: #28a745;
        color: white;
      }

      .verification-status.pending {
        background-color: #ffc107;
        color: black;
      }

      .verification-status.denied {
        background-color: #dc3545;
        color: white;
      }

      .verification-status.expired {
        background-color: #6c757d;
        color: white;
      }

      .verification-status.not-added {
        background-color: #e9ecef;
        color: black;
      }

      /* Verification Actions */
      .verification-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
      }

      /* Dark Mode Toggle */
      .theme-toggle {
        position: relative;
        width: 50px;
        height: 26px;
        background-color: #ccc;
        border-radius: 34px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .theme-toggle.active {
        background-color: var(--primary-color);
      }

      .theme-toggle-slider {
        position: absolute;
        top: 3px;
        left: 3px;
        width: 20px;
        height: 20px;
        background-color: white;
        border-radius: 50%;
        transition: transform 0.3s;
      }

      .theme-toggle.active .theme-toggle-slider {
        transform: translateX(24px);
      }

      /* Two Factor Toggle */
      .form-switch .form-check-input {
        width: 50px;
        height: 26px;
        background-color: #ccc;
        border: none;
      }

      .form-switch .form-check-input:checked {
        background-color: var(--primary-color);
      }

      /* Responsive */
      @media (max-width: 768px) {
        .sidebar {
          transform: translateX(-100%);
        }

        .sidebar.show {
          transform: translateX(0);
        }

        .header {
          left: 0;
        }

        .main-content {
          margin-left: 0;
        }
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }

      ::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #555;
      }

      /* Table Styles */
      .dataTables_wrapper .dataTables_filter input {
        border: 1px solid var(--border-color);
        border-radius: 5px;
        padding: 5px 10px;
      }

      .dataTables_wrapper .dataTables_length select {
        border: 1px solid var(--border-color);
        border-radius: 5px;
        padding: 5px;
      }

      /* Chart Container */
      .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 20px;
      }

      /* Activity Timeline */
      .activity-timeline {
        position: relative;
        padding-left: 30px;
      }

      .activity-timeline::before {
        content: "";
        position: absolute;
        left: 10px;
        top: 0;
        bottom: 0;
        width: 2px;
        background-color: var(--border-color);
      }

      .activity-item {
        position: relative;
        margin-bottom: 20px;
      }

      .activity-item::before {
        content: "";
        position: absolute;
        left: -24px;
        top: 5px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: var(--sidebar-active);
      }

      .activity-item .activity-time {
        font-size: 12px;
        color: var(--sidebar-text);
        margin-bottom: 5px;
      }

      .activity-item .activity-content {
        font-size: 14px;
      }

      /* Expandable Panel */
      .expandable-panel {
        margin-bottom: 15px;
      }

      .expandable-panel .panel-header {
        background-color: var(--primary-color);
        color: white;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .expandable-panel .panel-body {
        padding: 15px;
        border: 1px solid var(--border-color);
        border-top: none;
        border-radius: 0 0 5px 5px;
      }

      /* Print Styles */
      @media print {
        .sidebar,
        .header,
        .btn-group,
        .dataTables_paginate,
        .dataTables_info,
        .dataTables_length,
        .dataTables_filter {
          display: none !important;
        }

        .main-content {
          margin-left: 0 !important;
          margin-top: 0 !important;
        }

        .card {
          break-inside: avoid;
        }

        /* Loading Indicator Styles */
        #loadingIndicator {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(
            255,
            255,
            255,
            0.8
          ); /* Semi-transparent white background */
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000; /* Ensure it's on top of other elements */
        }
        .loader {
          border: 8px solid #f3f3f3; /* Light grey */
          border-top: 8px solid #3498db; /* Blue */
          border-radius: 50%;
          width: 60px;
          height: 60px;
          animation: spin 1s linear infinite; /* Spin animation */
        }

        @keyframes spin {
          0% {
            transform: rotate(0deg);
          }
          100% {
            transform: rotate(360deg);
          }
        }
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="d-flex align-items-center">
          <img
            src="/assets/images/benue-state-logo.png"
            alt="Benue State Logo"
            class="me-3"
            width="40"
          />
          <div>
            <h4 class="mb-0 fw-bold text-white">BICRIRMS</h4>
            <small class="text-white" style="font-size: 0.8rem">
              User Portal
            </small>
          </div>
        </div>
      </div>
      <nav class="sidebar-menu">
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link active" href="#" data-page="dashboard">
              <i class="bi bi-speedometer2"></i>
              Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-page="profile">
              <i class="bi bi-person-circle"></i>
              Profile
              <span class="badge bg-warning" id="profileCompletionBadge"
                >0%</span
              >
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-page="requests">
              <i class="bi bi-file-earmark-text"></i>
              Requests
              <span class="badge bg-primary" id="pendingRequestsBadge">0</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-page="analytics">
              <i class="bi bi-graph-up"></i>
              Analytics
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-page="settings">
              <i class="bi bi-gear"></i>
              Settings
            </a>
          </li>
        </ul>
      </nav>
    </aside>

    <!-- Header -->
    <header class="header">
      <button class="btn btn-light d-md-none me-3" id="sidebarToggle">
        <i class="bi bi-list"></i>
      </button>

      <div class="search-bar">
        <div class="input-group">
          <span class="input-group-text bg-transparent border-end-0">
            <i class="bi bi-search"></i>
          </span>
          <input
            type="text"
            class="form-control border-start-0"
            placeholder="Search..."
          />
        </div>
      </div>

      <div class="header-actions">
        <div class="dropdown">
          <button
            class="btn btn-light position-relative"
            type="button"
            data-bs-toggle="dropdown"
            id="notificationDropdown"
          >
            <i class="bi bi-bell"></i>
            <span
              class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
              id="notificationBadge"
            >
              <span id="notificationCount">0</span>
            </span>
          </button>

          <ul
            class="dropdown-menu dropdown-menu-end p-0 shadow-sm"
            style="min-width: 300px; max-height: 400px; overflow-y: auto"
            id="notificationList"
          >
            <li>
              <h6 class="dropdown-header bg-light border-bottom">
                Notifications
              </h6>
            </li>
            <li id="notificationsContainer">
              <div
                class="text-center py-3 text-muted small"
                id="noNotifications"
              >
                No new notifications
              </div>
            </li>
            <li><hr class="dropdown-divider" /></li>
            <li>
              <a
                class="dropdown-item text-center fw-bold text-primary"
                href="#"
                id="viewAllNotifications"
              >
                View all notifications
              </a>
            </li>
          </ul>
        </div>

        <div class="dropdown">
          <button
            class="btn btn-light d-flex align-items-center"
            type="button"
            data-bs-toggle="dropdown"
          >
            <img
              id="userProfilePic"
              src="https://picsum.photos/seed/user/40/40.jpg"
              class="rounded-circle me-2 img-fluid profile-avatar"
              alt="User"
              style="width: 40px; height: 40px; object-fit: cover"
            />
            <span id="currentUser">John Doe</span>
          </button>
          <ul class="dropdown-menu">
            <li>
              <a class="dropdown-item" href="#" data-page="profile"
                ><i class="bi bi-person me-2"></i>Profile</a
              >
            </li>
            <li>
              <a class="dropdown-item" href="#" data-page="settings"
                ><i class="bi bi-gear me-2"></i>Settings</a
              >
            </li>
            <li><hr class="dropdown-divider" /></li>
            <li>
              <a class="dropdown-item" href="#" id="logoutBtn"
                ><i class="bi bi-box-arrow-right me-2"></i>Logout</a
              >
            </li>
          </ul>
        </div>

        <div class="theme-toggle" id="themeToggle">
          <div class="theme-toggle-slider"></div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Dashboard Page -->
      <div id="dashboard-page" class="page-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="mb-0">Dashboard Overview</h2>
          <div>
            <button class="btn btn-primary me-2" id="refreshDashboard">
              <i class="bi bi-arrow-clockwise me-2"></i>Refresh
            </button>
          </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-4">
          <div class="col-xl-3 col-md-6 mb-3">
            <div class="card">
              <div class="card-body text-center">
                <h3 class="text-primary" id="totalRequestsCard">0</h3>
                <p class="mb-0">Total Requests</p>
              </div>
            </div>
          </div>
          <div class="col-xl-3 col-md-6 mb-3">
            <div class="card">
              <div class="card-body text-center">
                <h3 class="text-success" id="approvedRequestsCard">0</h3>
                <p class="mb-0">Approved Requests</p>
              </div>
            </div>
          </div>
          <div class="col-xl-3 col-md-6 mb-3">
            <div class="card">
              <div class="card-body text-center">
                <h3 class="text-warning" id="pendingRequestsCard">0</h3>
                <p class="mb-0">Pending Requests</p>
              </div>
            </div>
          </div>
          <div class="col-xl-3 col-md-6 mb-3">
            <div class="card">
              <div class="card-body text-center">
                <h3 class="text-info" id="profileCompletionCard">0%</h3>
                <p class="mb-0">Profile Completion</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
          <div class="col-lg-6 mb-3">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Request Status</h5>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="requestStatusChart"></canvas>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-6 mb-3">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Request Frequency</h5>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="requestFrequencyChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Activity -->
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Recent Activity</h5>
              </div>
              <div class="card-body">
                <div class="activity-timeline" id="activityTimeline">
                  <!-- Activity items will be populated by JavaScript -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Profile Page -->
      <div id="profile-page" class="page-content d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="mb-0">Profile Management</h2>
          <button class="btn btn-primary" id="saveProfileBtn">
            <i class="bi bi-check-circle me-2"></i>Save Changes
          </button>
        </div>

        <!-- Profile Photo and Completion -->
        <div class="card mb-4">
          <div class="card-body">
            <div class="row">
              <div class="col-md-4 text-center">
                <div class="profile-photo-container">
                  <img
                    src="https://picsum.photos/seed/user/150/150.jpg"
                    class="profile-photo"
                    id="profilePhotoImg"
                    alt="Profile"
                  />
                  <div class="profile-photo-upload" id="profilePhotoUpload">
                    <i class="bi bi-camera"></i>
                  </div>
                  <input
                    type="file"
                    id="profilePhotoInput"
                    accept="image/*"
                    style="display: none"
                  />
                </div>
                <div
                  class="progress mt-3"
                  id="uploadProgress"
                  style="display: none"
                >
                  <div
                    class="progress-bar"
                    role="progressbar"
                    style="width: 0%"
                  ></div>
                </div>
              </div>
              <div class="col-md-8">
                <div class="profile-completion">
                  <div
                    class="d-flex justify-content-between align-items-center mb-2"
                  >
                    <h5>Profile Completion</h5>
                    <span id="profileCompletionText">0%</span>
                  </div>
                  <div class="progress">
                    <div
                      class="progress-bar bg-success"
                      id="profileCompletionBar"
                      role="progressbar"
                      style="width: 0%"
                    ></div>
                  </div>
                  <div class="mt-2">
                    <span class="status-badge" id="verificationStatus"
                      >Unverified</span
                    >
                    <span class="status-badge ms-2" id="profileStatus"
                      >Incomplete</span
                    >
                  </div>
                </div>

                <div class="mt-4">
                  <h5>Account Security</h5>
                  <div class="d-flex align-items-center mt-2">
                    <span class="me-3">Two-Factor Authentication:</span>
                    <div class="form-check form-switch">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="twoFactorToggle"
                      />
                      <label class="form-check-label" for="twoFactorToggle">
                        <span id="twoFactorStatus">Disabled</span>
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Verification Section -->
        <div class="card mb-4">
          <div
            class="card-header d-flex justify-content-between align-items-center"
          >
            <h5 class="mb-0">Reference Verification</h5>
            <button id="verifyReferencesBtn" class="btn btn-primary">
              <i class="bi bi-shield-check"></i> Verify My References
            </button>
          </div>
          <div class="card-body">
            <div id="verificationStatus" class="alert alert-info d-none">
              <!-- Verification status messages will appear here -->
            </div>
            <p class="mb-0">
              Add your neighbors and family members as references, then click
              the "Verify My References" button to send verification links to
              them. Their verification will help complete your profile.
            </p>
          </div>
        </div>

        <!-- Personal Information -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Personal Information</h5>
          </div>
          <div class="card-body">
            <form id="personalInfoForm">
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="firstname" class="form-label">First Name</label>
                  <input
                    type="text"
                    class="form-control"
                    id="firstname"
                    required
                    readonly
                  />
                </div>
                <div class="col-md-4 mb-3">
                  <label for="middlename" class="form-label">Middle Name</label>
                  <input type="text" class="form-control" id="middlename" />
                </div>
                <div class="col-md-4 mb-3">
                  <label for="lastname" class="form-label">Last Name</label>
                  <input
                    type="text"
                    class="form-control"
                    id="lastname"
                    readonly
                  />
                </div>
              </div>
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="email" class="form-label">Email</label>
                  <input type="email" class="form-control" id="email" />
                </div>
                <div class="col-md-4 mb-3">
                  <label for="phone" class="form-label">Phone</label>
                  <input type="tel" class="form-control" id="phone" />
                </div>
                <div class="col-md-4 mb-3">
                  <label for="NIN" class="form-label">NIN</label>
                  <input type="text" class="form-control" id="NIN" readonly />
                </div>
              </div>
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="DOB" class="form-label">Date of Birth</label>
                  <input
                    type="date"
                    class="form-control"
                    id="DOB"
                    min="1900-01-01"
                  />
                </div>
                <div class="col-md-4 mb-3">
                  <label for="gender" class="form-label">Gender</label>
                  <select class="form-select" id="gender">
                    <option value="">Select Gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="maritalStatus" class="form-label"
                    >Marital Status</label
                  >
                  <select class="form-select" id="maritalStatus" required>
                    <option value="">Select Status</option>
                    <option value="Single">Single</option>
                    <option value="Married">Married</option>
                    <option value="Divorced">Divorced</option>
                    <option value="Widowed">Widowed</option>
                  </select>
                </div>
              </div>
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="nationality" class="form-label"
                    >Nationality</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="nationality"
                    required
                  />
                </div>
                <div class="col-md-4 mb-3">
                  <label for="religion" class="form-label">Religion</label>
                  <input type="text" class="form-control" id="religion" />
                </div>
                <div class="col-md-4 mb-3">
                  <label for="community" class="form-label">Community</label>
                  <input type="text" class="form-control" id="community" />
                </div>
              </div>
            </form>
          </div>
        </div>

        <!-- Address Information -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Address Information</h5>
          </div>
          <div class="card-body">
            <form id="addressInfoForm">
              <h6>Origin</h6>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="stateOfOrigin" class="form-label"
                    >State of Origin</label
                  >

                  <input
                    type="text"
                    class="form-control"
                    id="stateOfOrigin"
                    readonly
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label for="lgaOfOrigin" class="form-label"
                    >LGA of Origin</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="lgaOfOrigin"
                    readonly
                  />
                </div>
              </div>

              <h6 class="mt-4">Residence</h6>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="stateOfResidence" class="form-label"
                    >State of Residence</label
                  >
                  <select
                    class="form-select"
                    id="stateOfResidence"
                    onchange="updateLocalGovernmentsOfResidence()"
                  >
                    <option selected disabled>Select State</option>
                    <option value="adamawa">Adamawa</option>
                    <option value="akwa-ibom">Akwa Ibom</option>
                    <option value="anambra">Anambra</option>
                    <option value="abia">Abia</option>
                    <option value="bauchi">Bauchi</option>
                    <option value="benue">Benue</option>
                    <option value="borno">Borno</option>
                    <option value="bayelsa">Bayelsa</option>
                    <option value="delta">Delta</option>
                    <option value="ebonyi">Ebonyi</option>
                    <option value="edo">Edo</option>
                    <option value="enugu">Enugu</option>
                    <option value="abuja">Abuja</option>
                    <option value="gombe">Gombe</option>
                    <option value="jigawa">Jigawa</option>
                    <option value="ekiti">Ekiti</option>
                    <option value="lagos">Lagos</option>
                    <option value="oyo">Oyo</option>
                    <option value="imo">Imo</option>
                    <option value="kaduna">Kaduna</option>
                    <option value="kebbi">Kebbi</option>
                    <option value="kano">Kano</option>
                    <option value="kogi">Kogi</option>
                    <option value="osun">Osun</option>
                    <option value="sokoto">Sokoto</option>
                    <option value="plateau">Plateau</option>
                    <option value="taraba">Taraba</option>
                    <option value="yobe">Yobe</option>
                    <option value="zamfara">Zamfara</option>
                    <option value="katsina">Katsina</option>
                    <option value="kwara">Kwara</option>
                    <option value="nasarawa">Nasarawa</option>
                    <option value="niger">Niger</option>
                    <option value="rivers">Rivers</option>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="lgaOfResidence" class="form-label"
                    >Local Government of Residence</label
                  >
                  <select class="form-select" id="lgaOfResidence">
                    <option selected disabled>Select Local Government</option>
                  </select>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="house_number" class="form-label"
                    >House Number</label
                  >
                  <input type="text" class="form-control" id="house_number" />
                </div>
                <div class="col-md-6 mb-3">
                  <label for="street_name" class="form-label"
                    >Street Name</label
                  >
                  <input type="text" class="form-control" id="street_name" />
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="nearest_bus_stop_landmark" class="form-label"
                    >Nearest Bus Stop/Landmark</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="nearest_bus_stop_landmark"
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label for="city_town" class="form-label">City/Town</label>
                  <input type="text" class="form-control" id="city_town" />
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="countryOfResidence" class="form-label"
                    >Country of Residence</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="countryOfResidence"
                    required
                  />
                </div>
              </div>
            </form>
          </div>
        </div>

        <!-- Identification Information -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Identification Information</h5>
          </div>
          <div class="card-body">
            <form id="identificationForm">
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="identification" class="form-label"
                    >Identification Type</label
                  >
                  <select class="form-select" id="identification" required>
                    <option value="">Select ID Type</option>
                    <option value="National ID">National ID</option>
                    <option value="Driver's License">Driver's License</option>
                    <option value="International Passport">
                      International Passport
                    </option>
                    <option value="Voter's Card">Voter's Card</option>
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="id_number" class="form-label">ID Number</label>
                  <input
                    type="text"
                    class="form-control"
                    id="id_number"
                    required
                  />
                </div>
                <div class="col-md-4 mb-3">
                  <label for="issue_date" class="form-label">Issue Date</label>
                  <input
                    type="date"
                    class="form-control"
                    id="issue_date"
                    required
                  />
                </div>
              </div>
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="expiry_date" class="form-label"
                    >Expiry Date</label
                  >
                  <input type="date" class="form-control" id="expiry_date" />
                </div>
              </div>
            </form>
          </div>
        </div>

        <!-- Expandable Sections -->
        <div class="accordion" id="expandableSections">
          <!-- Next of Kin -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="nextOfKinHeading">
              <button
                class="accordion-button"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#nextOfKinCollapse"
              >
                Next of Kin
              </button>
            </h2>
            <div
              id="nextOfKinCollapse"
              class="accordion-collapse collapse show"
              data-bs-parent="#expandableSections"
            >
              <div class="accordion-body">
                <div id="nextOfKinContainer">
                  <div class="next-of-kin-item mb-3">
                    <div class="card">
                      <div class="card-body">
                        <div class="row">
                          <div class="col-md-4 mb-3">
                            <label class="form-label">Full Name</label>
                            <input
                              type="text"
                              class="form-control next-of-kin-name"
                              required
                            />
                          </div>
                          <div class="col-md-4 mb-3">
                            <label class="form-label">Relationship</label>
                            <input
                              type="text"
                              class="form-control next-of-kin-relationship"
                            />
                          </div>
                          <div class="col-md-4 mb-3">
                            <label class="form-label">Phone</label>
                            <input
                              type="tel"
                              class="form-control next-of-kin-phone"
                            />
                          </div>
                          <div class="col-md-4 mb-3">
                            <label class="form-label">Email</label>
                            <input
                              type="email"
                              class="form-control next-of-kin-email"
                            />
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md-12 mb-3">
                            <label class="form-label">Address</label>
                            <input
                              type="text"
                              class="form-control next-of-kin-address"
                            />
                          </div>
                        </div>
                        <div class="text-end">
                          <button
                            type="button"
                            class="btn btn-sm btn-outline-danger remove-next-of-kin"
                          >
                            <i class="bi bi-trash"></i> Remove
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="text-center mt-3">
                  <button
                    type="button"
                    class="btn btn-outline-primary"
                    id="addNextOfKinBtn"
                  >
                    <i class="bi bi-plus-circle"></i> Add Next of Kin
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Neighbor -->
          <!-- <div class="accordion-item">
            <h2 class="accordion-header" id="neighborHeading">
              <button
                class="accordion-button collapsed"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#neighborCollapse"
              >
                Neighbor
              </button>
            </h2>
            <div
              id="neighborCollapse"
              class="accordion-collapse collapse"
              data-bs-parent="#expandableSections"
            >
              <div class="accordion-body">
                <div id="neighborContainer">
                  <div class="neighbor-item mb-3">
                    <div class="card">
                      <div class="card-body">
                        <div class="row">
                          <div class="col-md-4 mb-3">
                            <label class="form-label">Name</label>
                            <input
                              type="text"
                              class="form-control neighbor-name"
                              required
                            />
                          </div>
                          <div class="col-md-4 mb-3">
                            <label class="form-label">Phone</label>
                            <input
                              type="tel"
                              class="form-control neighbor-phone"
                              required
                            />
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md-12 mb-3">
                            <label class="form-label">Address</label>
                            <input
                              type="text"
                              class="form-control neighbor-address"
                              required
                            />
                          </div>
                        </div>
                        <div class="text-end">
                          <button
                            type="button"
                            class="btn btn-sm btn-outline-danger remove-neighbor"
                          >
                            <i class="bi bi-trash"></i> Remove
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="text-center mt-3">
                  <button
                    type="button"
                    class="btn btn-outline-primary"
                    id="addNeighborBtn"
                  >
                    <i class="bi bi-plus-circle"></i> Add neighbor
                  </button>
                </div>
              </div>
            </div>
          </div> -->

          <!-- Neighbor -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="neighborHeading">
              <button
                class="accordion-button collapsed"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#neighborCollapse"
              >
                Neighbor
              </button>
            </h2>
            <div
              id="neighborCollapse"
              class="accordion-collapse collapse"
              data-bs-parent="#expandableSections"
            >
              <div class="accordion-body">
                <div class="loading-spinner" id="neighborLoadingSpinner">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </div>
                <div id="neighborContainer">
                  <div class="neighbor-item mb-3">
                    <div class="card">
                      <div
                        class="card-header d-flex justify-content-between align-items-center"
                      >
                        <h5 class="mb-0">Neighbor Reference</h5>
                        <span class="verification-status not-added"
                          >Not Added</span
                        >
                      </div>
                      <div class="card-body">
                        <div class="row">
                          <div class="col-md-4 mb-3">
                            <label class="form-label">Name</label>
                            <input
                              type="text"
                              class="form-control neighbor-name"
                              required
                            />
                          </div>
                          <div class="col-md-4 mb-3">
                            <label class="form-label">Phone</label>
                            <input
                              type="tel"
                              class="form-control neighbor-phone"
                              required
                            />
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md-12 mb-3">
                            <label class="form-label">Address</label>
                            <input
                              type="text"
                              class="form-control neighbor-address"
                              required
                            />
                          </div>
                        </div>
                        <div class="verification-actions">
                          <button
                            type="button"
                            class="btn btn-sm btn-outline-primary resend-verification d-none"
                          >
                            <i class="bi bi-send"></i> Resend
                          </button>
                          <button
                            type="button"
                            class="btn btn-sm btn-outline-info view-history d-none"
                          >
                            <i class="bi bi-clock-history"></i> History
                          </button>
                          <button
                            type="button"
                            class="btn btn-sm btn-outline-danger remove-neighbor"
                          >
                            <i class="bi bi-trash"></i> Remove
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="text-center mt-3">
                  <button
                    type="button"
                    class="btn btn-outline-primary"
                    id="addNeighborBtn"
                  >
                    <i class="bi bi-plus-circle"></i> Add neighbor
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Family -->
          <!-- <div class="accordion-item">
            <h2 class="accordion-header" id="FamilyHeading">
              <button
                class="accordion-button collapsed"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#FamilyCollapse"
              >
                Family
              </button>
            </h2>
            <div
              id="FamilyCollapse"
              class="accordion-collapse collapse"
              data-bs-parent="#expandableSections"
            >
              <div class="accordion-body">
                <div id="familyContainer">
                  <div class="family-item mb-3">
                    <div class="card">
                      <div class="card-body">
                        <div class="row">
                          <div class="col-md-4 mb-3">
                            <label class="form-label">Name</label>
                            <input
                              type="text"
                              class="form-control family-name"
                              required
                            />
                          </div>
                          <div class="col-md-4 mb-3">
                            <label class="form-label">Relationship</label>
                            <input
                              type="text"
                              class="form-control family-relationship"
                              required
                            />
                          </div>
                          <div class="col-md-4 mb-3">
                            <label class="form-label">Phone</label>
                            <input
                              type="tel"
                              class="form-control family-phone"
                              required
                            />
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md-12 mb-3">
                            <label class="form-label">Address</label>
                            <input
                              type="text"
                              class="form-control family-address"
                              required
                            />
                          </div>
                        </div>
                        <div class="text-end">
                          <button
                            type="button"
                            class="btn btn-sm btn-outline-danger remove-family"
                          >
                            <i class="bi bi-trash"></i> Remove
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="text-center mt-3">
                  <button
                    type="button"
                    class="btn btn-outline-primary"
                    id="addFamilyBtn"
                  >
                    <i class="bi bi-plus-circle"></i> Add Family
                  </button>
                </div>
              </div>
            </div>
          </div> -->

          <div class="accordion-item">
            <h2 class="accordion-header" id="FamilyHeading">
              <button
                class="accordion-button collapsed"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#FamilyCollapse"
              >
                Family
              </button>
            </h2>
            <div
              id="FamilyCollapse"
              class="accordion-collapse collapse"
              data-bs-parent="#expandableSections"
            >
              <div class="accordion-body">
                <div class="loading-spinner" id="familyLoadingSpinner">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </div>
                <div id="familyContainer">
                  <div class="family-item mb-3">
                    <div class="card">
                      <div
                        class="card-header d-flex justify-content-between align-items-center"
                      >
                        <h5 class="mb-0">Family Reference</h5>
                        <span class="verification-status not-added"
                          >Not Added</span
                        >
                      </div>
                      <div class="card-body">
                        <div class="row">
                          <div class="col-md-4 mb-3">
                            <label class="form-label">Name</label>
                            <input
                              type="text"
                              class="form-control family-name"
                              required
                            />
                          </div>
                          <div class="col-md-4 mb-3">
                            <label class="form-label">Relationship</label>
                            <input
                              type="text"
                              class="form-control family-relationship"
                              required
                            />
                          </div>
                          <div class="col-md-4 mb-3">
                            <label class="form-label">Phone</label>
                            <input
                              type="tel"
                              class="form-control family-phone"
                              required
                            />
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md-12 mb-3">
                            <label class="form-label">Address</label>
                            <input
                              type="text"
                              class="form-control family-address"
                              required
                            />
                          </div>
                        </div>
                        <div class="verification-actions">
                          <button
                            type="button"
                            class="btn btn-sm btn-outline-primary resend-verification d-none"
                          >
                            <i class="bi bi-send"></i> Resend
                          </button>
                          <button
                            type="button"
                            class="btn btn-sm btn-outline-info view-history d-none"
                          >
                            <i class="bi bi-clock-history"></i> History
                          </button>
                          <button
                            type="button"
                            class="btn btn-sm btn-outline-danger remove-family"
                          >
                            <i class="bi bi-trash"></i> Remove
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="text-center mt-3">
                  <button
                    type="button"
                    class="btn btn-outline-primary"
                    id="addFamilyBtn"
                  >
                    <i class="bi bi-plus-circle"></i> Add Family
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Employment History -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="employmentHistoryHeading">
              <button
                class="accordion-button collapsed"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#employmentHistoryCollapse"
              >
                Employment History
              </button>
            </h2>
            <div
              id="employmentHistoryCollapse"
              class="accordion-collapse collapse"
              data-bs-parent="#expandableSections"
            >
              <div class="accordion-body">
                <div id="employmentHistoryContainer">
                  <div class="employment-item mb-3">
                    <div class="card">
                      <div class="card-body">
                        <div class="row">
                          <div class="col-md-6 mb-3">
                            <label class="form-label">Company Name</label>
                            <input
                              type="text"
                              class="form-control employment-company"
                              required
                            />
                          </div>
                          <div class="col-md-6 mb-3">
                            <label class="form-label">Position</label>
                            <input
                              type="text"
                              class="form-control employment-position"
                              required
                            />
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md-6 mb-3">
                            <label class="form-label">Start Date</label>
                            <input
                              type="date"
                              class="form-control employment-start"
                              required
                            />
                          </div>
                          <div class="col-md-6 mb-3">
                            <label class="form-label">End Date</label>
                            <input
                              type="date"
                              class="form-control employment-end"
                            />
                          </div>
                        </div>
                        <div class="text-end">
                          <button
                            type="button"
                            class="btn btn-sm btn-outline-danger remove-employment"
                          >
                            <i class="bi bi-trash"></i> Remove
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="text-center mt-3">
                  <button
                    type="button"
                    class="btn btn-outline-primary"
                    id="addEmploymentBtn"
                  >
                    <i class="bi bi-plus-circle"></i> Add Employment
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Business Information -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="businessHeading">
              <button
                class="accordion-button collapsed"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#businessCollapse"
              >
                Business Information
              </button>
            </h2>
            <div
              id="businessCollapse"
              class="accordion-collapse collapse"
              data-bs-parent="#expandableSections"
            >
              <div class="accordion-body">
                <div id="businessContainer">
                  <div class="business-item mb-3">
                    <div class="card">
                      <div class="card-body">
                        <div class="row">
                          <div class="col-md-4 mb-3">
                            <label class="form-label">Business Name</label>
                            <input
                              type="text"
                              class="form-control business-name"
                              required
                            />
                          </div>
                          <div class="col-md-4 mb-3">
                            <label class="form-label">Business Type</label>
                            <input
                              type="text"
                              class="form-control business-type"
                              required
                            />
                          </div>
                          <div class="col-md-4 mb-3">
                            <label class="form-label"
                              >Registration Number</label
                            >
                            <input
                              type="text"
                              class="form-control business-registration"
                            />
                          </div>
                        </div>
                        <div class="text-end">
                          <button
                            type="button"
                            class="btn btn-sm btn-outline-danger remove-business"
                          >
                            <i class="bi bi-trash"></i> Remove
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="text-center mt-3">
                  <button
                    type="button"
                    class="btn btn-outline-primary"
                    id="addBusinessBtn"
                  >
                    <i class="bi bi-plus-circle"></i> Add Business
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Educational History -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="educationHistoryHeading">
              <button
                class="accordion-button collapsed"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#educationHistoryCollapse"
              >
                Educational History
              </button>
            </h2>
            <div
              id="educationHistoryCollapse"
              class="accordion-collapse collapse"
              data-bs-parent="#expandableSections"
            >
              <div class="accordion-body">
                <div id="educationHistoryContainer">
                  <div class="education-item mb-3">
                    <div class="card">
                      <div class="card-body">
                        <div class="row">
                          <div class="col-md-6 mb-3">
                            <label class="form-label">Institution</label>
                            <input
                              type="text"
                              class="form-control education-institution"
                              required
                            />
                          </div>
                          <div class="col-md-6 mb-3">
                            <label class="form-label">Qualification</label>
                            <input
                              type="text"
                              class="form-control education-qualification"
                              required
                            />
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md-6 mb-3">
                            <label class="form-label">Start Date</label>
                            <input
                              type="date"
                              class="form-control education-start"
                              required
                            />
                          </div>
                          <div class="col-md-6 mb-3">
                            <label class="form-label">End Date</label>
                            <input
                              type="date"
                              class="form-control education-end"
                            />
                          </div>
                        </div>
                        <div class="text-end">
                          <button
                            type="button"
                            class="btn btn-sm btn-outline-danger remove-education"
                          >
                            <i class="bi bi-trash"></i> Remove
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="text-center mt-3">
                  <button
                    type="button"
                    class="btn btn-outline-primary"
                    id="addEducationBtn"
                  >
                    <i class="bi bi-plus-circle"></i> Add Education
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Health Information -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="healthInfoHeading">
              <button
                class="accordion-button collapsed"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#healthInfoCollapse"
              >
                Health Information
              </button>
            </h2>
            <div
              id="healthInfoCollapse"
              class="accordion-collapse collapse"
              data-bs-parent="#expandableSections"
            >
              <div class="accordion-body">
                <form id="healthInfoForm">
                  <div class="row">
                    <div class="col-md-4 mb-3">
                      <label for="blood_group" class="form-label"
                        >Blood Group</label
                      >
                      <select class="form-select" id="blood_group">
                        <option value="">Select Blood Group</option>
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                      </select>
                    </div>
                    <div class="col-md-4 mb-3">
                      <label for="genotype" class="form-label">Genotype</label>
                      <select class="form-select" id="genotype">
                        <option value="">Select Genotype</option>
                        <option value="AA">AA</option>
                        <option value="AS">AS</option>
                        <option value="SS">SS</option>
                        <option value="AC">AC</option>
                      </select>
                    </div>
                    <div class="col-md-4 mb-3">
                      <label for="disability" class="form-label"
                        >Disabilities</label
                      >
                      <!-- <textarea
                        class="form-control"
                        id="disability"
                        rows="3"
                      ></textarea> -->

                      <select class="form-control" id="disability">
                        <option value="">Select Disability</option>
                        <option value="none">None</option>
                        <option value="physical">Physical</option>
                        <option value="hearing">Hearing</option>
                        <option value="visual">Visual</option>
                        <option value="mental">Mental</option>
                        <option value="other">Other</option>
                      </select>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-12 mb-3">
                      <label for="medical_condition" class="form-label"
                        >Medical Conditions</label
                      >
                      <textarea
                        class="form-control"
                        id="medical_condition"
                        rows="3"
                      ></textarea>
                    </div>
                  </div>
                  <!-- <div class="row">
                    <div class="col-md-12 mb-3">
                      <label for="disability" class="form-label"
                        >Disabilities</label
                      >
                      <textarea
                        class="form-control"
                        id="disability"
                        rows="3"
                      ></textarea>

                    </div>
               
                  
                  </div> -->
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Requests Page -->
      <div id="requests-page" class="page-content d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="mb-0">My Requests</h2>
          <div>
            <button
              class="btn btn-primary me-2"
              data-bs-toggle="modal"
              data-bs-target="#newRequestModal"
            >
              <i class="bi bi-plus-circle me-2"></i>New Request
            </button>
          </div>
        </div>

        <!-- Request Tabs -->
        <ul class="nav nav-tabs mb-4" id="requestTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button
              class="nav-link active"
              id="idcard-tab"
              data-bs-toggle="tab"
              data-bs-target="#idcard"
              type="button"
              role="tab"
            >
              Identity Cards
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="certificate-tab"
              data-bs-toggle="tab"
              data-bs-target="#certificate"
              type="button"
              role="tab"
            >
              Certificates of Origin
            </button>
          </li>
        </ul>

        <div class="tab-content" id="requestTabsContent">
          <!-- Identity Card Requests -->
          <div class="tab-pane fade show active" id="idcard" role="tabpanel">
            <div class="card">
              <div
                class="card-header d-flex justify-content-between align-items-center"
              >
                <h5 class="mb-0">Identity Card Requests</h5>
                <div class="export-buttons">
                  <button onclick="exportTable('csv', 'idcardRequestsTable')">
                    <i class="bi bi-file-earmark-csv me-1"></i>CSV
                  </button>
                  <button onclick="exportTable('pdf', 'idcardRequestsTable')">
                    <i class="bi bi-file-earmark-pdf me-1"></i>PDF
                  </button>
                  <button onclick="window.print()">
                    <i class="bi bi-printer me-1"></i>Print
                  </button>
                </div>
              </div>
              <div class="card-body">
                <table
                  id="idcardRequestsTable"
                  class="table table-striped table-hover w-100"
                >
                  <thead>
                    <tr>
                      <th>Request ID</th>
                      <th>Full Name</th>
                      <th>Date of Issue</th>
                      <th>Date of Expiration</th>
                      <th>Status</th>
                      <th>Approval Date</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Table data will be populated by JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Certificate Requests -->
          <div class="tab-pane fade" id="certificate" role="tabpanel">
            <div class="card">
              <div
                class="card-header d-flex justify-content-between align-items-center"
              >
                <h5 class="mb-0">Certificate of Origin Requests</h5>
                <div class="export-buttons">
                  <button
                    onclick="exportTable('csv', 'certificateRequestsTable')"
                  >
                    <i class="bi bi-file-earmark-csv me-1"></i>CSV
                  </button>
                  <button
                    onclick="exportTable('pdf', 'certificateRequestsTable')"
                  >
                    <i class="bi bi-file-earmark-pdf me-1"></i>PDF
                  </button>
                  <button onclick="window.print()">
                    <i class="bi bi-printer me-1"></i>Print
                  </button>
                </div>
              </div>
              <div class="card-body">
                <table
                  id="certificateRequestsTable"
                  class="table table-striped table-hover w-100"
                >
                  <thead>
                    <tr>
                      <th>Request ID</th>
                      <th>Full Name</th>
                      <th>State of Origin</th>
                      <th>LGA of Origin</th>
                      <th>Kindred</th>
                      <th>Status</th>
                      <th>Approval Date</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Table data will be populated by JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Analytics Page -->
      <div id="analytics-page" class="page-content d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="mb-0">Analytics</h2>
          <div>
            <button class="btn btn-outline-primary me-2" id="dateRange">
              <i class="bi bi-calendar3 me-2"></i>Date Range
            </button>
            <button class="btn btn-primary" id="refreshAnalytics">
              <i class="bi bi-arrow-clockwise me-2"></i>Refresh
            </button>
          </div>
        </div>

        <!-- Analytics Charts -->
        <div class="row mb-4">
          <div class="col-lg-6 mb-3">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Total ID Card Requests</h5>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="idcardAnalyticsChart"></canvas>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-6 mb-3">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Total Certificates of Origin</h5>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="certificateAnalyticsChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row mb-4">
          <div class="col-lg-6 mb-3">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Approved vs Pending vs Rejected</h5>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="requestRatioChart"></canvas>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-6 mb-3">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Request Frequency by Day/Time</h5>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="requestFrequencyAnalyticsChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Page -->
      <div id="settings-page" class="page-content d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="mb-0">Settings & Security</h2>
        </div>

        <!-- Security Settings -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Security Settings</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <h6>Two-Factor Authentication</h6>
              <div class="d-flex align-items-center">
                <div class="form-check form-switch me-3">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="settingsTwoFactorToggle"
                  />
                  <label class="form-check-label" for="settingsTwoFactorToggle">
                    Enable Two-Factor Authentication
                  </label>
                </div>
                <button
                  class="btn btn-outline-primary"
                  id="generateBackupCodes"
                >
                  <i class="bi bi-shield-lock me-2"></i>Generate Backup Codes
                </button>
              </div>
            </div>

            <div class="mb-3">
              <h6>Password</h6>
              <button
                class="btn btn-outline-primary"
                data-bs-toggle="modal"
                data-bs-target="#changePasswordModal"
              >
                <i class="bi bi-key me-2"></i>Change Password
              </button>
            </div>

            <div class="mb-3">
              <h6>Backup Codes</h6>
              <div id="backupCodesContainer" class="d-none">
                <div class="alert alert-info">
                  <p class="mb-2">
                    Save these backup codes in a safe place. You can use them to
                    access your account if you lose access to your
                    authentication device.
                  </p>
                  <div class="row" id="backupCodesList">
                    <!-- Backup codes will be populated here -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Notification Settings -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Notification Settings</h5>
          </div>
          <div class="card-body">
            <div class="form-check form-switch mb-3">
              <input
                class="form-check-input"
                type="checkbox"
                id="emailNotifications"
                checked
              />
              <label class="form-check-label" for="emailNotifications">
                Email Notifications
              </label>
            </div>
            <div class="form-check form-switch mb-3">
              <input
                class="form-check-input"
                type="checkbox"
                id="smsNotifications"
              />
              <label class="form-check-label" for="smsNotifications">
                SMS Notifications
              </label>
            </div>
            <div class="form-check form-switch mb-3">
              <input
                class="form-check-input"
                type="checkbox"
                id="pushNotifications"
                checked
              />
              <label class="form-check-label" for="pushNotifications">
                Push Notifications
              </label>
            </div>
          </div>
        </div>

        <!-- Privacy Settings -->
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Privacy Settings</h5>
          </div>
          <div class="card-body">
            <div class="form-check form-switch mb-3">
              <input
                class="form-check-input"
                type="checkbox"
                id="profileVisibility"
                checked
              />
              <label class="form-check-label" for="profileVisibility">
                Make Profile Public
              </label>
            </div>
            <div class="form-check form-switch mb-3">
              <input
                class="form-check-input"
                type="checkbox"
                id="showContactInfo"
              />
              <label class="form-check-label" for="showContactInfo">
                Show Contact Information
              </label>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- New Request Modal -->
    <div
      class="modal fade"
      id="newRequestModal"
      tabindex="-1"
      aria-labelledby="newRequestModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="newRequestModalLabel">
              Submit New Request
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="newRequestForm">
              <div class="mb-3">
                <label for="requestType" class="form-label">Request Type</label>
                <select class="form-select" id="requestType" required>
                  <option value="">Select Request Type</option>
                  <option value="idcard">Identity Card</option>
                  <option value="certificate">Certificate of Origin</option>
                </select>
              </div>

              <!-- ID Card Request Fields -->
              <div id="idcardFields" class="request-fields d-none">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="idcardFirstname" class="form-label"
                      >first Name</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="idcardFirstname"
                      required
                      readonly
                    />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="idcardLastname" class="form-label"
                      >Last Name</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="idcardLastname"
                      required
                      readonly
                    />
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="idcardEmail" class="form-label">Email</label>
                    <input
                      type="text"
                      class="form-control"
                      id="idcardEmail"
                      required
                    />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="idcardPhone" class="form-label"
                      >Phone Number</label
                    >
                    <input
                      type="tel"
                      class="form-control"
                      id="idcardPhone"
                      required
                    />
                  </div>
                </div>

                <div class="mb-3">
                  <label for="ref_Letter" class="form-label"
                    >Reference Letter</label
                  >
                  <input
                    type="file"
                    class="form-control"
                    id="ref_Letter"
                    accept=".pdf,.jpg,.jpeg,.png"
                    required
                  />
                </div>
                <div class="mb-3">
                  <label for="utilityBill" class="form-label"
                    >Utility Bill
                  </label>
                  <input
                    type="file"
                    class="form-control"
                    id="utilityBill"
                    accept=".pdf,.jpg,.jpeg,.png"
                    required
                  />
                </div>
              </div>

              <!-- Certificate Request Fields -->
              <div id="certificateFields" class="request-fields d-none">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="certFirstname" class="form-label"
                      >First Name</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="certFirstname"
                      required
                      readonly
                    />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="certLastname" class="form-label"
                      >Last Name</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="certLastname"
                      required
                      readonly
                    />
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="certMiddlename" class="form-label"
                      >Middle Name</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="certMiddlename"
                    />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="certDOB" class="form-label"
                      >Date of Birth</label
                    >
                    <input
                      type="date"
                      class="form-control"
                      id="certDOB"
                      min="1900-01-01"
                      required
                    />
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="certMaritalStatus" class="form-label"
                      >Marital Status</label
                    >
                    <select class="form-select" id="certMaritalStatus" required>
                      <option value="">Select Status</option>
                      <option value="Single">Single</option>
                      <option value="Married">Married</option>
                      <option value="Divorced">Divorced</option>
                      <option value="Widowed">Widowed</option>
                    </select>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="certGender" class="form-label">Gender</label>
                    <select class="form-select" id="certGender" required>
                      <option value="">Select Gender</option>
                      <option value="Male">Male</option>
                      <option value="Female">Female</option>
                    </select>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="stateOfOrigin" class="form-label"
                      >State Of Origin</label
                    >
                    <input
                      type="text"
                      class="form-control bg-light"
                      id="certStateOfOrigin"
                      required
                      readonly
                    />
                  </div>

                  <div class="col-md-6 mb-3">
                    <label for="certLGAOfOrigin" class="form-label"
                      >LGA of Origin</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="certLGAOfOrigin"
                      required
                      readonly
                    />
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="certWard" class="form-label">Ward</label>
                    <input
                      type="text"
                      class="form-control"
                      id="certWard"
                      required
                    />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="certAddress" class="form-label">Address</label>
                    <input
                      type="text"
                      class="form-control"
                      id="certAddress"
                      required
                    />
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="certPhone" class="form-label"
                      >Phone Number</label
                    >
                    <input
                      type="tel"
                      class="form-control"
                      id="certPhone"
                      required
                    />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="certKindred" class="form-label">Kindred</label>
                    <input
                      type="text"
                      class="form-control"
                      id="certKindred"
                      required
                    />
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="certFathersName" class="form-label"
                      >Father's Name</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="certFathersName"
                      required
                    />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="certFathersStateOfOrigin" class="form-label"
                      >Father's State of Origin</label
                    >
                    <select
                      class="form-select"
                      id="certFathersStateOfOrigin"
                      required
                    >
                      <option value="">Select State</option>
                      <option value="Abia">Abia</option>
                      <option value="Adamawa">Adamawa</option>
                      <option value="Akwa Ibom">Akwa Ibom</option>
                      <option value="Anambra">Anambra</option>
                      <option value="Bauchi">Bauchi</option>
                      <option value="Bayelsa">Bayelsa</option>
                      <option value="Benue">Benue</option>
                      <option value="Borno">Borno</option>
                      <option value="Cross River">Cross River</option>
                      <option value="Delta">Delta</option>
                      <option value="Ebonyi">Ebonyi</option>
                      <option value="Edo">Edo</option>
                      <option value="Ekiti">Ekiti</option>
                      <option value="Enugu">Enugu</option>
                      <option value="FCT">FCT</option>
                      <option value="Gombe">Gombe</option>
                      <option value="Imo">Imo</option>
                      <option value="Jigawa">Jigawa</option>
                      <option value="Kaduna">Kaduna</option>
                      <option value="Kano">Kano</option>
                      <option value="Katsina">Katsina</option>
                      <option value="Kebbi">Kebbi</option>
                      <option value="Kogi">Kogi</option>
                      <option value="Kwara">Kwara</option>
                      <option value="Lagos">Lagos</option>
                      <option value="Nasarawa">Nasarawa</option>
                      <option value="Niger">Niger</option>
                      <option value="Ogun">Ogun</option>
                      <option value="Ondo">Ondo</option>
                      <option value="Osun">Osun</option>
                      <option value="Oyo">Oyo</option>
                      <option value="Plateau">Plateau</option>
                      <option value="Rivers">Rivers</option>
                      <option value="Sokoto">Sokoto</option>
                      <option value="Taraba">Taraba</option>
                      <option value="Yobe">Yobe</option>
                      <option value="Zamfara">Zamfara</option>
                    </select>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="certMothersName" class="form-label"
                      >Mother's Name</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="certMothersName"
                      required
                    />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="certMothersStateOfOrigin" class="form-label"
                      >Mother's State of Origin</label
                    >
                    <select
                      class="form-select"
                      id="certMothersStateOfOrigin"
                      required
                    >
                      <option value="">Select State</option>
                      <option value="Abia">Abia</option>
                      <option value="Adamawa">Adamawa</option>
                      <option value="Akwa Ibom">Akwa Ibom</option>
                      <option value="Anambra">Anambra</option>
                      <option value="Bauchi">Bauchi</option>
                      <option value="Bayelsa">Bayelsa</option>
                      <option value="Benue">Benue</option>
                      <option value="Borno">Borno</option>
                      <option value="Cross River">Cross River</option>
                      <option value="Delta">Delta</option>
                      <option value="Ebonyi">Ebonyi</option>
                      <option value="Edo">Edo</option>
                      <option value="Ekiti">Ekiti</option>
                      <option value="Enugu">Enugu</option>
                      <option value="FCT">FCT</option>
                      <option value="Gombe">Gombe</option>
                      <option value="Imo">Imo</option>
                      <option value="Jigawa">Jigawa</option>
                      <option value="Kaduna">Kaduna</option>
                      <option value="Kano">Kano</option>
                      <option value="Katsina">Katsina</option>
                      <option value="Kebbi">Kebbi</option>
                      <option value="Kogi">Kogi</option>
                      <option value="Kwara">Kwara</option>
                      <option value="Lagos">Lagos</option>
                      <option value="Nasarawa">Nasarawa</option>
                      <option value="Niger">Niger</option>
                      <option value="Ogun">Ogun</option>
                      <option value="Ondo">Ondo</option>
                      <option value="Osun">Osun</option>
                      <option value="Oyo">Oyo</option>
                      <option value="Plateau">Plateau</option>
                      <option value="Rivers">Rivers</option>
                      <option value="Sokoto">Sokoto</option>
                      <option value="Taraba">Taraba</option>
                      <option value="Yobe">Yobe</option>
                      <option value="Zamfara">Zamfara</option>
                    </select>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="certGuardian" class="form-label"
                      >Guardian (if applicable)</label
                    >
                    <input type="text" class="form-control" id="certGuardian" />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="certRelationshipToGuardian" class="form-label"
                      >Relationship to Guardian</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="certRelationshipToGuardian"
                    />
                  </div>
                </div>
                <!-- <div class="mb-3">
                  <label for="certPurpose" class="form-label"
                    >Purpose of Request</label
                  >
                  <textarea
                    class="form-control"
                    id="certPurpose"
                    rows="2"
                    required
                  ></textarea>
                </div> -->

                <h6 class="mt-4 mb-3">Required Documents</h6>
                <div class="row">
                  <div class="col-md-4 mb-3">
                    <label for="certPassportPhoto" class="form-label"
                      >Passport Photo *</label
                    >
                    <input
                      type="file"
                      class="form-control"
                      id="certPassportPhoto"
                      accept=".jpg,.jpeg,.png"
                      required
                    />
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="certIdCard" class="form-label">ID Card *</label>
                    <input
                      type="file"
                      class="form-control"
                      id="certIdCard"
                      accept=".jpg,.jpeg,.png"
                      required
                    />
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="certBirthCertificate" class="form-label"
                      >Birth Certificate *</label
                    >
                    <input
                      type="file"
                      class="form-control"
                      id="certBirthCertificate"
                      accept=".jpg,.jpeg,.png"
                      required
                    />
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label
                      for="certParentGuardianIndigeneCert"
                      class="form-label"
                      >Parent/Guardian Indigene Certificate</label
                    >
                    <input
                      type="file"
                      class="form-control"
                      id="certParentGuardianIndigeneCert"
                      accept=".pdf,.jpg,.jpeg,.png"
                    />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="certAttestationLetter" class="form-label"
                      >Attestation Letter</label
                    >
                    <input
                      type="file"
                      class="form-control"
                      id="certAttestationLetter"
                      accept=".pdf,.jpg,.jpeg,.png"
                    />
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-primary" id="submitRequestBtn">
              Submit Request
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Change Password Modal -->
    <div
      class="modal fade"
      id="changePasswordModal"
      tabindex="-1"
      aria-labelledby="changePasswordModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="changePasswordModalLabel">
              Change Password
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="changePasswordForm">
              <div class="mb-3">
                <label for="currentPassword" class="form-label"
                  >Current Password</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="currentPassword"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="newPassword" class="form-label">New Password</label>
                <input
                  type="password"
                  class="form-control"
                  id="newPassword"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="confirmPassword" class="form-label"
                  >Confirm New Password</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="confirmPassword"
                  required
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="changePasswordBtn"
            >
              Change Password
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- View Request Modal -->
    <div
      class="modal fade"
      id="viewRequestModal"
      tabindex="-1"
      aria-labelledby="viewRequestModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="viewRequestModalLabel">
              Request Details
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div id="viewRequestContent" class="p-2">
              <div class="text-center text-muted">
                <i class="bi bi-hourglass-split fs-3"></i>
                <p class="mt-2">Loading request details...</p>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="downloadRequestBtn"
              style="display: none"
            >
              <i class="bi bi-download me-2"></i>Download
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Verification History Modal -->
    <div
      class="modal fade"
      id="verificationHistoryModal"
      tabindex="-1"
      aria-labelledby="verificationHistoryModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="verificationHistoryModalLabel">
              Verification History
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div id="verificationHistoryContent" class="verification-history">
              <!-- Verification history will be populated here -->
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Mock Mode Toggle -->
    <div class="form-check form-switch mock-mode-toggle">
      <input class="form-check-input" type="checkbox" id="mockModeToggle" />
      <label class="form-check-label" for="mockModeToggle">Mock Mode</label>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
      const mockAPI = {
        // Current user data
        currentUser: {
          id: "64a1b2c3d4e5f6789012345", // MongoDB ObjectId format
          email: "john.doe@example.com",
          firstname: "John",
          lastname: "Doe",
          middlename: "Michael",
          isActive: true,
          DOB: "1990-05-15",
          maritalStatus: "Single",
          gender: "Male",
          nationality: "Nigerian",
          stateOfOrigin: "Lagos",
          lgaOfOrigin: "Ikeja",
          stateOfResidence: "Lagos",
          lgaOfResidence: "Ikeja",
          house_number: "123",
          street_name: "Main Street",
          nearest_bus_stop_landmark: "City Mall",
          city_town: "Ikeja",
          countryOfResidence: "Nigeria",
          identification: "National ID",
          id_number: "12345678901",
          issue_date: "2020-01-15",
          expiry_date: "2025-01-15",
          passportPhoto: "https://picsum.photos/seed/user/150/150.jpg",
          nextOfKin: [
            {
              name: "Jane Doe",
              relationship: "Spouse",
              phone: "+2348023456789",
              address: "123 Main Street, Ikeja, Lagos",
            },
          ],
          employmentHistory: [
            {
              company: "Tech Solutions Ltd",
              position: "Software Developer",
              start: "2018-01-15",
              end: "",
            },
          ],
          business: [
            {
              name: "Doe Enterprises",
              type: "Technology",
              registrationNumber: "RC123456",
            },
          ],
          educationalHistory: [
            {
              institution: "University of Lagos",
              qualification: "B.Sc Computer Science",
              start: "2012-09-15",
              end: "2016-06-30",
            },
          ],
          healthInfo: {
            blood_group: "O+",
            genotype: "AA",
            medical_condition: "None",
            disability: "None",
          },
          neighbor: "James Smith",
          family: "Doe Family",
          phone: "+2348012345678",
          NIN: "12345678901",
          role: "user",
          religion: "Christianity",
          community: "Yoruba",
          isVerified: true,
          isProfileCompleted: true,
          profileCompletionPercentage: 85,
          twoFactorEnabled: false,
          created_at: "2023-01-15T10:30:00Z",
        },

        // ID Card requests (updated to match IdCard schema)
        idcardRequests: [
          {
            id: "ID2023001",
            refNumber: "ID2023001",
            userId: "64a1b2c3d4e5f6789012345",
            firstname: "John",
            lastname: "Doe",
            email: "john.doe@example.com",
            status: "Approved",
            card_type: "National ID",
            dateOfIssue: "2023-01-15",
            dateOfExpiration: "2028-01-15",
            phone: "+2348012345678",
            lga: "Ikeja",
            approvalDate: "2023-02-01",
            approvedBy: "64a1b2c3d4e5f6789012346",
          },
          {
            id: "ID2023002",
            refNumber: "ID2023002",
            userId: "64a1b2c3d4e5f6789012345",
            firstname: "John",
            lastname: "Doe",
            email: "john.doe@example.com",
            status: "Pending",
            card_type: "Driver's License",
            dateOfIssue: "2023-03-10",
            dateOfExpiration: "2028-03-10",
            phone: "+2348012345678",
            lga: "Ikeja",
          },
          {
            id: "ID2023003",
            refNumber: "ID2023003",
            userId: "64a1b2c3d4e5f6789012345",
            firstname: "John",
            lastname: "Doe",
            email: "john.doe@example.com",
            status: "Rejected",
            card_type: "Voter's Card",
            dateOfIssue: "2023-02-05",
            dateOfExpiration: "2028-02-05",
            phone: "+2348012345678",
            lga: "Ikeja",
            rejectionReason: "Invalid documents provided",
          },
        ],

        // Certificate requests (updated to match Certificate schema)
        certificateRequests: [
          {
            id: "CERT2023001",
            refNumber: "CERT2023001",
            userId: "64a1b2c3d4e5f6789012345",
            status: "Approved",
            email: "john.doe@example.com",
            firstname: "John",
            lastname: "Doe",
            middlename: "Michael",
            DOB: new Date("1990-05-15"),
            maritalStatus: "Single",
            gender: "Male",
            stateOfOrigin: "Lagos",
            lgaOfOrigin: "Ikeja",
            ward: "Central Ward",
            address: "123 Main Street, Ikeja, Lagos",
            phone: "+2348012345678",
            kindred: "Yoruba",
            fathersName: "Richard Doe",
            fathersStateOfOrigin: "Lagos",
            mothersName: "Mary Doe",
            mothersStateOfOrigin: "Lagos",
            purpose: "Employment verification",
            passportPhoto: "https://picsum.photos/seed/user/150/150.jpg",
            idCard: "National ID",
            birthCertificate: "Birth Certificate",
            approvalDate: "2023-03-15",
            approvedBy: "64a1b2c3d4e5f6789012346",
          },
          {
            id: "CERT2023002",
            refNumber: "CERT2023002",
            userId: "64a1b2c3d4e5f6789012345",
            status: "Pending",
            email: "john.doe@example.com",
            firstname: "John",
            lastname: "Doe",
            middlename: "Michael",
            DOB: new Date("1990-05-15"),
            maritalStatus: "Single",
            gender: "Male",
            stateOfOrigin: "Lagos",
            lgaOfOrigin: "Ikeja",
            ward: "Central Ward",
            address: "123 Main Street, Ikeja, Lagos",
            phone: "+2348012345678",
            kindred: "Yoruba",
            fathersName: "Richard Doe",
            fathersStateOfOrigin: "Lagos",
            mothersName: "Mary Doe",
            mothersStateOfOrigin: "Lagos",
            purpose: "Bank account opening",
            passportPhoto: "https://picsum.photos/seed/user/150/150.jpg",
            idCard: "National ID",
            birthCertificate: "Birth Certificate",
          },
        ],

        // Analytics data
        analytics: {
          idcardRequests: {
            Jan: 2,
            Feb: 1,
            Mar: 3,
            Apr: 2,
          },
          certificateRequests: {
            Jan: 1,
            Feb: 2,
            Mar: 1,
            Apr: 2,
          },
          requestStatus: {
            Approved: 3,
            Pending: 2,
            Rejected: 1,
          },
          requestFrequency: {
            Monday: 1,
            Tuesday: 2,
            Wednesday: 1,
            Thursday: 2,
            Friday: 1,
            Saturday: 0,
            Sunday: 0,
          },
        },

        // Activity data
        activities: [
          { time: "2023-04-15 10:30", content: "Submitted ID card request" },
          {
            time: "2023-04-10 14:15",
            content: "Certificate of Origin approved",
          },
          { time: "2023-03-15 09:45", content: "Updated profile information" },
          {
            time: "2023-03-10 16:20",
            content: "Submitted Driver's License request",
          },
          {
            time: "2023-02-05 11:30",
            content: "Voter's Card request rejected",
          },
        ],

        // Notifications
        notifications: [
          {
            id: 1,
            message: "Your ID card request has been approved",
            read: false,
          },
          {
            id: 2,
            message: "Certificate of origin is ready for download",
            read: false,
          },
          {
            id: 3,
            message: "Please complete your profile verification",
            read: true,
          },
        ],

        // Verification tokens data
        verificationTokens: {
          neighbor: [
            {
              id: "n1",
              name: "James Smith",
              phone: "+2348012345678",
              address: "124 Main Street, Ikeja, Lagos",
              verificationToken: "token123",
              verificationLink: "https://example.com/verify/token123",
              status: "verified",
              verifiedAt: "2023-05-15T10:30:00Z",
              comments: "Confirmed residence for 3 years",
              verificationExpiresAt: "2023-06-15T23:59:59Z",
            },
            {
              id: "n2",
              name: "Sarah Johnson",
              phone: "+2348023456789",
              address: "126 Main Street, Ikeja, Lagos",
              verificationToken: "token456",
              verificationLink: "https://example.com/verify/token456",
              status: "pending",
              verificationExpiresAt: "2023-06-20T23:59:59Z",
            },
          ],
          family: [
            {
              id: "f1",
              name: "Richard Doe",
              relationship: "Father",
              phone: "+2348034567890",
              address: "456 Oak Avenue, Ikeja, Lagos",
              verificationToken: "token789",
              verificationLink: "https://example.com/verify/token789",
              status: "expired",
              verificationExpiresAt: "2023-05-01T23:59:59Z",
            },
            {
              id: "f2",
              name: "Mary Doe",
              relationship: "Mother",
              phone: "+2348045678901",
              address: "456 Oak Avenue, Ikeja, Lagos",
              verificationToken: "token101",
              verificationLink: "https://example.com/verify/token101",
              status: "pending",
              verificationExpiresAt: "2023-06-25T23:59:59Z",
            },
          ],
        },

        // Verification history data
        verificationHistory: [
          {
            date: "2023-05-15T10:30:00Z",
            status: "verified",
            comments: "Confirmed residence for 3 years",
            deviceInfo:
              "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
          },
          {
            date: "2023-05-10T14:22:00Z",
            status: "pending",
            comments: "Verification link sent",
            deviceInfo:
              "Mozilla/5.0 (iPhone; CPU iPhone OS 14_7_1 like Mac OS X)",
          },
        ],
      };

      // // Global configuration and state (prevent ReferenceErrors when code references these before async load)
      // const BACKEND_URL = window.BACKEND_URL || ""; // set your backend base URL here or via global variable
      // const token = localStorage.getItem("token") || ""; // auth token (if any)
      // // Global user object  loadUserData() will overwrite this when real data is fetched.
      // // Initialize with mockAPI.currentUser to avoid runtime errors when code expects `user` immediately.
      // let user = mockAPI.currentUser || null;
      // Track unsaved changes on the profile page
      let formHasUnsavedChanges = false;

      // Initialize DataTables
      let idcardRequestsTable, certificateRequestsTable;

      // Initialize Charts
      let requestStatusChart, requestFrequencyChart;
      let idcardAnalyticsChart,
        certificateAnalyticsChart,
        requestRatioChart,
        requestFrequencyAnalyticsChart;

      // Page Navigation
      $(document).ready(function () {
        // Initialize dashboard
        initializeDashboard();

        // Sidebar navigation
        $(".sidebar-menu .nav-link").on("click", function (e) {
          e.preventDefault();
          const page = $(this).data("page");
          showPage(page);

          // Update active state
          $(".sidebar-menu .nav-link").removeClass("active");
          $(this).addClass("active");
        });

        // Toggle sidebar on small screens
        $("#sidebarToggle").on("click", function (e) {
          e.stopPropagation(); // Prevent the click from bubbling to document
          $("#sidebar").toggleClass("show");
        });

        // Prevent clicks inside the sidebar from closing it
        $(".sidebar").on("click", function (e) {
          e.stopPropagation();
        });

        // Hide sidebar when clicking outside
        $(document).on("click", function () {
          $(".sidebar").removeClass("show");
        });

        // Theme toggle
        $("#themeToggle").on("click", function () {
          $(this).toggleClass("active");
          $("body").attr(
            "data-theme",
            $(this).hasClass("active") ? "dark" : "light"
          );
          localStorage.setItem(
            "theme",
            $(this).hasClass("active") ? "dark" : "light"
          );
        });

        // Load saved theme
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme === "dark") {
          $("#themeToggle").addClass("active");
          $("body").attr("data-theme", "dark");
        }

        // Logout button
        $("#logoutBtn").on("click", function (e) {
          e.preventDefault();
          logout();
        });

        // Profile photo upload
        $("#profilePhotoUpload").on("click", function () {
          $("#profilePhotoInput").click();
        });

        $("#profilePhotoInput").on("change", function () {
          uploadProfilePhoto(this.files[0]);
        });

        // Two-factor toggle
        $("#twoFactorToggle, #settingsTwoFactorToggle").on(
          "change",
          function () {
            const isEnabled = $(this).is(":checked");
            toggleTwoFactor(isEnabled);
          }
        );

        // Save profile button
        $("#saveProfileBtn").on("click", function () {
          saveProfile();
        });

        // Submit request button
        $("#submitRequestBtn").on("click", function () {
          submitNewRequest();
        });

        // Change password button
        $("#changePasswordBtn").on("click", function () {
          changePassword();
        });

        // Generate backup codes button
        $("#generateBackupCodes").on("click", function () {
          generateBackupCodes();
        });

        // Refresh dashboard button
        $("#refreshDashboard").on("click", function () {
          refreshDashboard();
        });

        // Refresh analytics button
        $("#refreshAnalytics").on("click", function () {
          refreshAnalytics();
        });

        // Add next of kin button
        $("#addNextOfKinBtn").on("click", function () {
          addNextOfKin();
          // Save profile form data to localStorage
          saveProfileFormData();
        });

        $("#addNeighborBtn").on("click", function () {
          addNeighbor();
          // Save profile form data to localStorage
          saveProfileFormData();
        });

        $("#addFamilyBtn").on("click", function () {
          addFamily();
          // Save profile form data to localStorage
          saveProfileFormData();
        });

        // Add employment button
        $("#addEmploymentBtn").on("click", function () {
          addEmployment();
          // Save profile form data to localStorage
          saveProfileFormData();
        });

        // Add business button
        $("#addBusinessBtn").on("click", function () {
          addBusiness();
          // Save profile form data to localStorage
          saveProfileFormData();
        });

        // Add education button
        $("#addEducationBtn").on("click", function () {
          addEducation();
          // Save profile form data to localStorage
          saveProfileFormData();
        });

        // Event delegation for dynamically created elements
        $(document).on("click", ".remove-next-of-kin", function () {
          $(this).closest(".next-of-kin-item").remove();
          // Save profile form data to localStorage
          saveProfileFormData();
        });

        $(document).on("click", ".remove-neighbor", function () {
          $(this).closest(".neighbor-item").remove();
          // Save profile form data to localStorage
          saveProfileFormData();
        });

        $(document).on("click", ".remove-family", function () {
          $(this).closest(".family-item").remove();
          // Save profile form data to localStorage
          saveProfileFormData();
        });

        $(document).on("click", ".remove-employment", function () {
          $(this).closest(".employment-item").remove();
          // Save profile form data to localStorage
          saveProfileFormData();
        });

        $(document).on("click", ".remove-business", function () {
          $(this).closest(".business-item").remove();
          // Save profile form data to localStorage
          saveProfileFormData();
        });

        $(document).on("click", ".remove-education", function () {
          $(this).closest(".education-item").remove();
          // Save profile form data to localStorage
          saveProfileFormData();
        });

        // Save profile form data on any input change
        $(document).on(
          "input change",
          "#profile-page input, #profile-page select, #profile-page textarea",
          function () {
            saveProfileFormData();
          }
        );

        // Initialize user data
        loadUserData();

        // Initialize verification system
        initializeVerificationSystem();
      });

      // Initialize verification system
      function initializeVerificationSystem() {
        // Load verification tokens on page load
        loadVerificationTokens();

        // Set up event listeners for verification actions
        $("#verifyReferencesBtn").on("click", function () {
          initiateVerificationProcess();
        });

        // Mock mode toggle
        $("#mockModeToggle").on("change", function () {
          mockMode = $(this).prop("checked");
          if (mockMode) {
            showToast("Mock mode enabled. Using test data.", "success");
          } else {
            showToast("Mock mode disabled. Using real API.", "success");
          }
          // Reload verification tokens with the new mode
          loadVerificationTokens();
        });
      }

      // Global variables for verification
      let mockMode = false;
      let verificationTokens = {
        neighbor: [],
        family: [],
      };

      // Load verification tokens from the backend
      function loadVerificationTokens() {
        // Show loading spinners
        $("#neighborLoadingSpinner").show();
        $("#familyLoadingSpinner").show();

        if (mockMode) {
          // Simulate API delay
          setTimeout(function () {
            verificationTokens = mockAPI.verificationTokens;
            updateVerificationUI();

            // Hide loading spinners
            $("#neighborLoadingSpinner").hide();
            $("#familyLoadingSpinner").hide();
          }, 1000);
          return;
        }

        // Real API call
        $.ajax({
          url: `${BACKEND_URL}/users/${user.id}/verification-tokens`,
          type: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          success: function (response) {
            verificationTokens = response;
            updateVerificationUI();
          },
          error: function (xhr) {
            let errorMessage = "Failed to load verification tokens.";
            if (xhr.responseJSON && xhr.responseJSON.message) {
              errorMessage = xhr.responseJSON.message;
            }
            showToast(errorMessage, "error");
          },
          complete: function () {
            // Hide loading spinners
            $("#neighborLoadingSpinner").hide();
            $("#familyLoadingSpinner").hide();
          },
        });
      }

      // Update the UI with verification token data
      function updateVerificationUI() {
        // Update neighbor references
        const neighborContainer = $("#neighborContainer");
        neighborContainer.empty();

        if (
          verificationTokens.neighbor &&
          verificationTokens.neighbor.length > 0
        ) {
          verificationTokens.neighbor.forEach(function (neighbor) {
            const neighborItem = createNeighborItem(neighbor);
            neighborContainer.append(neighborItem);
          });
        } else {
          // Add empty neighbor item if none exist
          addNeighbor();
        }

        // Update family references
        const familyContainer = $("#familyContainer");
        familyContainer.empty();

        if (verificationTokens.family && verificationTokens.family.length > 0) {
          verificationTokens.family.forEach(function (family) {
            const familyItem = createFamilyItem(family);
            familyContainer.append(familyItem);
          });
        } else {
          // Add empty family item if none exist
          addFamily();
        }
      }

      // Create a neighbor item with verification status
      function createNeighborItem(neighbor) {
        const statusClass = getStatusClass(neighbor.status);
        const statusText = getStatusText(neighbor.status);
        const expiryInfo = neighbor.verificationExpiresAt
          ? `<small class="text-muted">Expires: ${formatDate(
              neighbor.verificationExpiresAt
            )}</small>`
          : "";

        const neighborItem = $(`
          <div class="neighbor-item mb-3" data-id="${neighbor._id}">
              <div class="card">
                  <div class="card-header d-flex justify-content-between align-items-center">
                      <h5 class="mb-0">Neighbor Reference</h5>
                      <span class="verification-status ${statusClass}">${statusText}</span>
                  </div>
                  <div class="card-body">
                      <div class="row">
                          <div class="col-md-4 mb-3">
                              <label class="form-label">Name</label>
                              <input type="text" class="form-control neighbor-name" value="${
                                neighbor.name || ""
                              }" required>
                          </div>
                          <div class="col-md-4 mb-3">
                              <label class="form-label">Phone</label>
                              <input type="tel" class="form-control neighbor-phone" value="${
                                neighbor.phone || ""
                              }" required>
                          </div>
                      </div>
                      <div class="row">
                          <div class="col-md-12 mb-3">
                              <label class="form-label">Address</label>
                              <input type="text" class="form-control neighbor-address" value="${
                                neighbor.address || ""
                              }" required>
                          </div>
                      </div>
                      ${
                        expiryInfo
                          ? `<div class="row"><div class="col-12">${expiryInfo}</div></div>`
                          : ""
                      }
                      <div class="verification-actions">
                          ${
                            neighbor.status === "pending"
                              ? `<button type="button" class="btn btn-sm btn-outline-primary resend-verification">
                              <i class="bi bi-send"></i> Resend
                          </button>`
                              : ""
                          }
                          ${
                            neighbor.status === "verified"
                              ? `<button type="button" class="btn btn-sm btn-outline-info view-history">
                              <i class="bi bi-clock-history"></i> History
                          </button>`
                              : ""
                          }
                          <button type="button" class="btn btn-sm btn-outline-danger remove-neighbor">
                              <i class="bi bi-trash"></i> Remove
                          </button>
                      </div>
                  </div>
              </div>
          </div>
      `);

        // Add event listeners
        neighborItem.find(".remove-neighbor").click(function () {
          $(this).closest(".neighbor-item").remove();
          saveProfileFormData();
        });

        neighborItem.find(".resend-verification").click(function () {
          resendReference(neighbor._id, "neighbor");
        });

        neighborItem.find(".view-history").click(function () {
          openVerifyModalForRef(neighbor._id, "neighbor");
        });

        return neighborItem;
      }

      // Create a family item with verification status
      function createFamilyItem(family) {
        console.log("family", family);
        const statusClass = getStatusClass(family.status);
        const statusText = getStatusText(family.status);
        const expiryInfo = family.verificationExpiresAt
          ? `<small class="text-muted">Expires: ${formatDate(
              family.verificationExpiresAt
            )}</small>`
          : "";

        const familyItem = $(`
          <div class="family-item mb-3" data-id="${family._id}">
              <div class="card">
                  <div class="card-header d-flex justify-content-between align-items-center">
                      <h5 class="mb-0">Family Reference</h5>
                      <span class="verification-status ${statusClass}">${statusText}</span>
                  </div>
                  <div class="card-body">
                      <div class="row">
                          <div class="col-md-4 mb-3">
                              <label class="form-label">Name</label>
                              <input type="text" class="form-control family-name" value="${
                                family.name || ""
                              }" required>
                          </div>
                          <div class="col-md-4 mb-3">
                              <label class="form-label">Relationship</label>
                              <input type="text" class="form-control family-relationship" value="${
                                family.relationship || ""
                              }" required>
                          </div>
                          <div class="col-md-4 mb-3">
                              <label class="form-label">Phone</label>
                              <input type="tel" class="form-control family-phone" value="${
                                family.phone || ""
                              }" required>
                          </div>
                      </div>
                      <div class="row">
                          <div class="col-md-12 mb-3">
                              <label class="form-label">Address</label>
                              <input type="text" class="form-control family-address" value="${
                                family.address || ""
                              }" required>
                          </div>
                      </div>
                      ${
                        expiryInfo
                          ? `<div class="row"><div class="col-12">${expiryInfo}</div></div>`
                          : ""
                      }
                      <div class="verification-actions">
                          ${
                            family.status === "pending"
                              ? `<button type="button" class="btn btn-sm btn-outline-primary resend-verification">
                              <i class="bi bi-send"></i> Resend
                          </button>`
                              : ""
                          }
                          ${
                            family.status === "verified"
                              ? `<button type="button" class="btn btn-sm btn-outline-info view-history">
                              <i class="bi bi-clock-history"></i> History
                          </button>`
                              : ""
                          }
                          <button type="button" class="btn btn-sm btn-outline-danger remove-family">
                              <i class="bi bi-trash"></i> Remove
                          </button>
                      </div>
                  </div>
              </div>
          </div>
      `);

        // Add event listeners
        familyItem.find(".remove-family").click(function () {
          $(this).closest(".family-item").remove();
          saveProfileFormData();
        });

        familyItem.find(".resend-verification").click(function () {
          resendReference(family.id, "family");
        });

        familyItem.find(".view-history").click(function () {
          openVerifyModalForRef(family.id, "family");
        });

        return familyItem;
      }

      // Get status class for badge
      function getStatusClass(status) {
        switch (status) {
          case "verified":
            return "verified";
          case "pending":
            return "pending";
          case "denied":
            return "denied";
          case "expired":
            return "expired";
          default:
            return "not-added";
        }
      }

      // Get status text for badge
      function getStatusText(status) {
        switch (status) {
          case "verified":
            return "Verified";
          case "pending":
            return "Pending";
          case "denied":
            return "Denied";
          case "expired":
            return "Expired";
          default:
            return "Not Added";
        }
      }

      // Format date for display
      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString() + " " + date.toLocaleTimeString();
      }

      // Initiate verification process
      function initiateVerificationProcess() {
        const verifyBtn = $("#verifyReferencesBtn");
        verifyBtn
          .prop("disabled", true)
          .html(
            '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...'
          );

        if (mockMode) {
          // Simulate API delay
          setTimeout(function () {
            const response = {
              success: true,
              message: "Verification links sent successfully",
              updatedTokens: {
                neighbor: [
                  {
                    id: "n2",
                    name: "Sarah Johnson",
                    phone: "+2348023456789",
                    address: "126 Main Street, Ikeja, Lagos",
                    verificationToken: "token456",
                    verificationLink: "https://example.com/verify/token456",
                    status: "pending",
                    verificationExpiresAt: "2023-06-20T23:59:59Z",
                  },
                ],
                family: [
                  {
                    id: "f2",
                    name: "Mary Doe",
                    relationship: "Mother",
                    phone: "+2348045678901",
                    address: "456 Oak Avenue, Ikeja, Lagos",
                    verificationToken: "token101",
                    verificationLink: "https://example.com/verify/token101",
                    status: "pending",
                    verificationExpiresAt: "2023-06-25T23:59:59Z",
                  },
                ],
              },
              profileCompletionPercentage: 90,
            };

            if (response.success) {
              showToast(response.message, "success");
              verificationTokens = response.updatedTokens;
              updateVerificationUI();

              // Update profile completion if returned
              if (response.profileCompletionPercentage) {
                updateProfileCompletion(
                  response.profileCompletionPercentage,
                  true
                );
              }
            } else {
              showToast(
                response.message || "Failed to initiate verification",
                "error"
              );
            }

            verifyBtn
              .prop("disabled", false)
              .html('<i class="bi bi-shield-check"></i> Verify My References');
          }, 1500);
          return;
        }

        // Real API call
        $.ajax({
          url: `${BACKEND_URL}/users/${user.id}/initiate-verification`,
          type: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          success: function (response) {
            console.log("response", response);
            showNotification("Verification links sent successfully", "success");

            // Reload verification tokens
            loadVerificationTokens();

            // Update profile completion if returned
            if (response.profileCompletionPercentage) {
              updateProfileCompletion(
                response.profileCompletionPercentage,
                true
              );
            }
          },
          error: function (xhr) {
            let errorMessage = "Failed to initiate verification.";
            if (xhr.responseJSON && xhr.responseJSON.message) {
              errorMessage = xhr.responseJSON.message;
            }
            showToast(errorMessage, "error");
          },
          complete: function () {
            verifyBtn
              .prop("disabled", false)
              .html('<i class="bi bi-shield-check"></i> Verify My References');
          },
        });
      }

      // Resend verification for a specific reference
      function resendReference(refId, refType) {
        if (mockMode) {
          // Simulate API delay
          setTimeout(function () {
            showToast(
              `Verification link resent for ${refType} reference`,
              "success"
            );

            // Update the status to pending and refresh expiry
            const refArray = verificationTokens[refType];
            const refIndex = refArray.findIndex((ref) => ref.id === refId);

            if (refIndex !== -1) {
              // Set new expiry date (7 days from now)
              const newExpiry = new Date();
              newExpiry.setDate(newExpiry.getDate() + 7);

              refArray[refIndex].status = "pending";
              refArray[refIndex].verificationExpiresAt =
                newExpiry.toISOString();

              updateVerificationUI();
            }
          }, 1000);
          return;
        }

        // Real API call
        $.ajax({
          url: `${BACKEND_URL}/users/${user.id}/initiate-verification`,
          type: "POST",
          data: JSON.stringify({
            resend: true,
            refId: refId,
            refType: refType,
          }),
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          success: function (response) {
            showToast(
              `Verification link resent for ${refType} reference`,
              "success"
            );

            // Reload verification tokens
            loadVerificationTokens();
          },
          error: function (xhr) {
            let errorMessage = `Failed to resend verification for ${refType} reference.`;
            if (xhr.responseJSON && xhr.responseJSON.message) {
              errorMessage = xhr.responseJSON.message;
            }
            showToast(errorMessage, "error");
          },
        });
      }

      // Open verification history modal for a reference
      function openVerifyModalForRef(refId, refType) {
        const modal = $("#verificationHistoryModal");
        const modalContent = $("#verificationHistoryContent");

        // Clear previous content
        modalContent.empty();

        if (mockMode) {
          // Use mock data
          const historyItems = mockAPI.verificationHistory;

          if (historyItems && historyItems.length > 0) {
            historyItems.forEach(function (item) {
              const statusClass = getStatusClass(item.status);
              const statusText = getStatusText(item.status);

              const historyItem = $(`
            <div class="history-item">
                <div class="d-flex justify-content-between">
                    <strong>${formatDate(item.date)}</strong>
                    <span class="verification-status ${statusClass}">${statusText}</span>
                </div>
                <p class="mb-1">${item.comments}</p>
                <small class="text-muted">Device: ${item.deviceInfo}</small>
            </div>
        `);

              modalContent.append(historyItem);
            });
          } else {
            modalContent.html("<p>No verification history available.</p>");
          }

          // Show the modal
          modal.modal("show");
          return;
        }

        // Real API call
        $.ajax({
          url: `${BACKEND_URL}/users/${user.id}/verification-history/${refId}`,
          type: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          success: function (response) {
            if (response.history && response.history.length > 0) {
              response.history.forEach(function (item) {
                const statusClass = getStatusClass(item.status);
                const statusText = getStatusText(item.status);

                const historyItem = $(`
              <div class="history-item">
                  <div class="d-flex justify-content-between">
                      <strong>${formatDate(item.date)}</strong>
                      <span class="verification-status ${statusClass}">${statusText}</span>
                  </div>
                  <p class="mb-1">${item.comments}</p>
                  <small class="text-muted">Device: ${item.deviceInfo}</small>
              </div>
          `);

                modalContent.append(historyItem);
              });
            } else {
              modalContent.html("<p>No verification history available.</p>");
            }

            // Show the modal
            modal.modal("show");
          },
          error: function (xhr) {
            let errorMessage = "Failed to load verification history.";
            if (xhr.responseJSON && xhr.responseJSON.message) {
              errorMessage = xhr.responseJSON.message;
            }
            showToast(errorMessage, "error");
          },
        });
      }

      // Show toast notification
      function showToast(message, type) {
        const toastId = type === "success" ? "successToast" : "errorToast";
        const toastBodyId =
          type === "success" ? "successToastBody" : "errorToastBody";

        // Create toast if it doesn't exist
        if (!$("#" + toastId).length) {
          const toast = $(`
    <div id="${toastId}" class="toast position-fixed bottom-0 end-0 m-3" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header bg-${
        type === "success" ? "success" : "danger"
      } text-white">
        <i class="bi bi-${
          type === "success" ? "check-circle" : "exclamation-triangle"
        }-fill me-2"></i>
        <strong class="me-auto">${
          type === "success" ? "Success" : "Error"
        }</strong>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="${toastBodyId}">
        ${message}
      </div>
    </div>
  `);

          $("body").append(toast);
        } else {
          $("#" + toastBodyId).text(message);
        }

        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
      }

      // Modified addNeighbor function to include verification status
      function addNeighbor() {
        const neighborItem = $(`
          <div class="neighbor-item mb-3" data-id="">
              <div class="card">
                  <div class="card-header d-flex justify-content-between align-items-center">
                      <h5 class="mb-0">Neighbor Reference</h5>
                      <span class="verification-status not-added">Not Added</span>
                  </div>
                  <div class="card-body">
                      <div class="row">
                          <div class="col-md-4 mb-3">
                              <label class="form-label">Name</label>
                              <input type="text" class="form-control neighbor-name" required>
                          </div>
                          <div class="col-md-4 mb-3">
                              <label class="form-label">Phone</label>
                              <input type="tel" class="form-control neighbor-phone" required>
                          </div>
                      </div>
                      <div class="row">
                          <div class="col-md-12 mb-3">
                              <label class="form-label">Address</label>
                              <input type="text" class="form-control neighbor-address" required>
                          </div>
                      </div>
                      <div class="verification-actions">
                          <button type="button" class="btn btn-sm btn-outline-primary resend-verification d-none">
                              <i class="bi bi-send"></i> Resend
                          </button>
                          <button type="button" class="btn btn-sm btn-outline-info view-history d-none">
                              <i class="bi bi-clock-history"></i> History
                          </button>
                          <button type="button" class="btn btn-sm btn-outline-danger remove-neighbor">
                              <i class="bi bi-trash"></i> Remove
                          </button>
                      </div>
                  </div>
              </div>
          </div>
      `);

        $("#neighborContainer").append(neighborItem);

        // Add event listeners for the new neighbor
        neighborItem.find(".remove-neighbor").click(function () {
          $(this).closest(".neighbor-item").remove();
          saveProfileFormData();
        });

        neighborItem.find(".resend-verification").click(function () {
          const refId = $(this).closest(".neighbor-item").data("id");
          if (refId) {
            resendReference(refId, "neighbor");
          }
        });

        neighborItem.find(".view-history").click(function () {
          const refId = $(this).closest(".neighbor-item").data("id");
          if (refId) {
            openVerifyModalForRef(refId, "neighbor");
          }
        });
      }

      // Modified addFamily function to include verification status
      function addFamily() {
        const famItem = $(`
          <div class="family-item mb-3" data-id="">
              <div class="card">
                  <div class="card-header d-flex justify-content-between align-items-center">
                      <h5 class="mb-0">Family Reference</h5>
                      <span class="verification-status not-added">Not Added</span>
                  </div>
                  <div class="card-body">
                      <div class="row">
                          <div class="col-md-4 mb-3">
                              <label class="form-label">Name</label>
                              <input type="text" class="form-control family-name" required>
                          </div>
                          <div class="col-md-4 mb-3">
                              <label class="form-label">Relationship</label>
                              <input type="text" class="form-control family-relationship" required>
                          </div>
                          <div class="col-md-4 mb-3">
                              <label class="form-label">Phone</label>
                              <input type="tel" class="form-control family-phone" required>
                          </div>
                      </div>
                      <div class="row">
                          <div class="col-md-12 mb-3">
                              <label class="form-label">Address</label>
                              <input type="text" class="form-control family-address" required>
                          </div>
                      </div>
                      <div class="verification-actions">
                          <button type="button" class="btn btn-sm btn-outline-primary resend-verification d-none">
                              <i class="bi bi-send"></i> Resend
                          </button>
                          <button type="button" class="btn btn-sm btn-outline-info view-history d-none">
                              <i class="bi bi-clock-history"></i> History
                          </button>
                          <button type="button" class="btn btn-sm btn-outline-danger remove-family">
                              <i class="bi bi-trash"></i> Remove
                          </button>
                      </div>
                  </div>
              </div>
          </div>
      `);

        $("#familyContainer").append(famItem);

        // Add event listeners for the new family member
        famItem.find(".remove-family").click(function () {
          $(this).closest(".family-item").remove();
          saveProfileFormData();
        });

        famItem.find(".resend-verification").click(function () {
          const refId = $(this).closest(".family-item").data("id");
          if (refId) {
            resendReference(refId, "family");
          }
        });

        famItem.find(".view-history").click(function () {
          const refId = $(this).closest(".family-item").data("id");
          if (refId) {
            openVerifyModalForRef(refId, "family");
          }
        });
      }

      // Modified populateNeighbor function to include verification status
      function populateNeighbor(neighborData) {
        console.log("neighborData", neighborData);
        const container = $("#neighborContainer");
        container.empty();

        if (neighborData && neighborData.length > 0) {
          neighborData.forEach((nei) => {
            const neighborItem = createNeighborItem(nei);
            container.append(neighborItem);
          });
        } else {
          // Add empty neighbor item if none exist
          addNeighbor();
        }
      }

      // Modified populateFamily function to include verification status
      function populateFamily(familyData) {
        console.log("familyData", familyData);
        const container = $("#familyContainer");
        container.empty();

        if (familyData && familyData.length > 0) {
          familyData.forEach((fam) => {
            console.log("fam", fam);
            const familyItem = createFamilyItem(fam);
            container.append(familyItem);
          });
        } else {
          // Add empty family item if none exist
          addFamily();
        }
      }

      /**
       * Updates existing form items with data from the server response.
       * It finds items in the form that don't have a database ID yet and matches them
       * to items from the server based on their field values, then assigns the ID.
       *
       * @param {Array} serverData - The array of items from the server response (e.g., response.family).
       * @param {string} containerSelector - The jQuery selector for the container (e.g., "#familyContainer").
       * @param {string} itemClass - The class of the individual items (e.g., ".family-item").
       * @param {Object} fieldMap - An object mapping server data fields to form input classes.
       *                            e.g., { name: '.family-name', phone: '.family-phone' }
       */
      function updateExistingItemsWithServerData(
        serverData,
        containerSelector,
        itemClass,
        fieldMap
      ) {
        if (!serverData || !Array.isArray(serverData)) return;

        // Iterate over each item returned from the server
        serverData.forEach((serverItem) => {
          // Find the corresponding item in the DOM that hasn't been saved yet (has no data-id)
          const $matchingItem = $(containerSelector)
            .find(itemClass)
            .filter(function () {
              // If it already has an ID, it's not a new item, so skip it.
              if ($(this).data("id")) return false;

              // Check if the form data matches the server data
              let isMatch = true;
              for (const serverField in fieldMap) {
                const formSelector = fieldMap[serverField];
                const formValue = $(this).find(formSelector).val();
                const serverValue = serverItem[serverField];

                if (formValue !== serverValue) {
                  isMatch = false;
                  break; // No need to check other fields if one doesn't match
                }
              }
              return isMatch;
            });

          // If a matching, unsaved item was found, update its data-id
          if ($matchingItem.length) {
            $matchingItem.attr("data-id", serverItem._id);
            console.log(`Updated ${itemClass} with new ID: ${serverItem._id}`);
          }
        });
      }

      // Modified saveProfile function to handle verification tokens
      async function saveProfile() {
        // Collect form data
        const formData = {
          // firstname: $("#firstname").val(),
          // lastname: $("#lastname").val(),
          middlename: $("#middlename").val(),
          email: $("#email").val().trim(),
          phone: $("#phone").val(),
          // NIN: $("#NIN").val(),
          DOB: $("#DOB").val(),
          gender: $("#gender").val(),
          maritalStatus: $("#maritalStatus").val(),
          nationality: $("#nationality").val(),
          religion: $("#religion").val(),
          community: $("#community").val(),
          stateOfOrigin: $("#stateOfOrigin").val(),
          lgaOfOrigin: $("#lgaOfOrigin").val(),
          stateOfResidence: $("#stateOfResidence").val(),
          lgaOfResidence: $("#lgaOfResidence").val(),
          house_number: $("#house_number").val(),
          street_name: $("#street_name").val(),
          nearest_bus_stop_landmark: $("#nearest_bus_stop_landmark").val(),
          city_town: $("#city_town").val(),
          countryOfResidence: $("#countryOfResidence").val(),
          identification: $("#identification").val(),
          id_number: $("#id_number").val(),
          issue_date: $("#issue_date").val(),
          expiry_date: $("#expiry_date").val(),
          nextOfKin: [],
          neighbor: [],
          family: [],
          employmentHistory: [],
          business: [],
          educationalHistory: [],
          healthInfo: {
            bloodGroup: $("#blood_group").val(),
            genotype: $("#genotype").val(),
            medical_condition: $("#medical_condition").val(),
            disabilityStatus: $("#disability").val(),
          },
        };

        // Collect dynamic fields
        $(".next-of-kin-item").each(function () {
          formData.nextOfKin.push({
            nok_name: $(this).find(".next-of-kin-name").val(),
            nok_relationship: $(this).find(".next-of-kin-relationship").val(),
            nok_phone: $(this).find(".next-of-kin-phone").val(),
            nok_address: $(this).find(".next-of-kin-address").val(),
            nok_email: $(this).find(".next-of-kin-email").val(),
          });
        });

        $(".neighbor-item").each(function () {
          const id = $(this).data("id");
          console.log("id", id);
          const neighborData = {
            name: $(this).find(".neighbor-name").val(),
            phone: $(this).find(".neighbor-phone").val(),
            address: $(this).find(".neighbor-address").val(),
          };

          // Include ID if it exists (for existing references)
          if (id) {
            neighborData.id = id;

            // Find the corresponding verification token
            const token = verificationTokens.neighbor.find((n) => n.id === id);
            if (token) {
              neighborData.verificationToken = token.verificationToken;
              neighborData.verificationLink = token.verificationLink;
              neighborData.status = token.status;
              neighborData.verificationExpiresAt = token.verificationExpiresAt;
            }
          }

          formData.neighbor.push(neighborData);
        });

        $(".family-item").each(function () {
          const id = $(this).data("id");
          const familyData = {
            name: $(this).find(".family-name").val(),
            relationship: $(this).find(".family-relationship").val(),
            phone: $(this).find(".family-phone").val(),
            address: $(this).find(".family-address").val(),
          };

          // Include ID if it exists (for existing references)
          if (id) {
            familyData.id = id;

            // Find the corresponding verification token
            const token = verificationTokens.family.find((f) => f.id === id);
            if (token) {
              familyData.verificationToken = token.verificationToken;
              familyData.verificationLink = token.verificationLink;
              familyData.status = token.status;
              familyData.verificationExpiresAt = token.verificationExpiresAt;
            }
          }

          formData.family.push(familyData);
        });

        $(".employment-item").each(function () {
          formData.employmentHistory.push({
            company: $(this).find(".employment-company").val(),
            position: $(this).find(".employment-position").val(),
            start: $(this).find(".employment-start").val(),
            end: $(this).find(".employment-end").val(),
          });
        });

        $(".business-item").each(function () {
          formData.business.push({
            name: $(this).find(".business-name").val(),
            type: $(this).find(".business-type").val(),
            registrationNumber: $(this).find(".business-registration").val(),
          });
        });

        $(".education-item").each(function () {
          formData.educationalHistory.push({
            institution: $(this).find(".education-institution").val(),
            qualification: $(this).find(".education-qualification").val(),
            start: $(this).find(".education-start").val(),
            end: $(this).find(".education-end").val(),
          });
        });

        // Show loader
        $("#saveProfileBtn").prop("disabled", true).text("Saving...");

        try {
          // Real API call
          const response = await $.ajax({
            url: `${BACKEND_URL}/users/${user.id}`,
            method: "PUT",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            data: JSON.stringify(formData),
          });

          // Update UI after success
          $("#currentUser").text(`${formData.firstname} ${formData.lastname}`);
          showNotification("Profile updated successfully", "success");

          // Clear saved form data after successful save
          localStorage.removeItem("profileFormData");

          // Reset the form change tracking after successful save
          formHasUnsavedChanges = false;

          // and are correctly identified on subsequent saves.
          // populateNextOfKin(response.nextOfKin);
          // populateNeighbor(response.neighbor);
          // populateFamily(response.family);
          // populateEmploymentHistory(response.employmentHistory);
          // populateBusiness(response.business);
          // populateEducationalHistory(response.educationalHistory);

          // Define the field mappings for each dynamic section
          const familyFieldMap = {
            name: ".family-name",
            relationship: ".family-relationship",
            phone: ".family-phone",
            address: ".family-address",
          };
          const neighborFieldMap = {
            name: ".neighbor-name",
            phone: ".neighbor-phone",
            address: "neighbor-address",
          };
          const nextOfKinFieldMap = {
            nok_name: ".next-of-kin-name",
            nok_phone: ".next-of-kin-phone",
            nok_address: $(this).find(".next-of-kin-address"),
            nok_email: $(this).find(".next-of-kin-email"),
            nok_relationship: $(this).find(".next-of-kin-relationship"),
          };
          // Add maps for other sections as needed

          // Call the helper function for each dynamic section
          updateExistingItemsWithServerData(
            response.family,
            "#familyContainer",
            ".family-item",
            familyFieldMap
          );
          updateExistingItemsWithServerData(
            response.neighbor,
            "#neighborContainer",
            ".neighbor-item",
            neighborFieldMap
          );
          updateExistingItemsWithServerData(
            response.nextOfKin,
            "#nextOfKinContainer",
            ".next-of-kin-item",
            nextOfKinFieldMap
          );

          // Note: For employment, business, and education, you might want to add more fields
          // to the map to ensure a unique match if users can have multiple entries.
          // --- END: THE NEW FIX ---

          // Reload verification tokens after saving
          loadVerificationTokens();
        } catch (error) {
          console.error("Error updating profile:", error.message);
          showNotification(
            "Failed to update profile. Please try again.",
            "danger"
          );
        } finally {
          // Hide loader
          $("#saveProfileBtn").prop("disabled", false).text("Save Profile");
        }
      }

      // Modified loadUserData function to load verification tokens
      async function loadUserData() {
        try {
          const response = await $.ajax({
            url: `${BACKEND_URL}/users/me`,
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          const user = response; // expected user object from backend

          console.log("user", user);
          // Update user display
          $("#currentUser").text(user.firstname + " " + user.lastname);

          // Update user profile picture dynamically
          const profilePicUrl = user.passportPhoto
            ? user.passportPhoto
            : "https://picsum.photos/seed/user/40/40.jpg";

          $("#userProfilePic")
            .attr("src", profilePicUrl)
            .addClass("img-fluid rounded-circle profile-avatar");

          // Update profile completion
          updateProfileCompletion(
            user.profileCompletionPercentage,
            user.isProfileCompleted
          );

          // Update verification status
          updateVerificationStatus(user.isVerified);

          // Update two-factor status
          updateTwoFactorStatus(user.twoFactorEnabled);

          // Populate form fields
          $("#firstname").val(user.firstname);
          $("#lastname").val(user.lastname);
          $("#middlename").val(user.middlename);
          $("#email").val(user.email);
          $("#phone").val(user.phone);
          $("#NIN").val(user.NIN);
          $("#DOB").val(user.DOB);
          $("#gender").val(user.gender).trigger("change");
          $("#maritalStatus").val(user.maritalStatus).trigger("change");
          $("#nationality").val(user.nationality);
          $("#religion").val(user.religion);
          $("#community").val(user.community);
          $("#stateOfOrigin").val(user.stateOfOrigin).trigger("change");
          $("#lgaOfOrigin").val(user.lgaOfOrigin).trigger("change");
          $("#stateOfResidence").val(user.stateOfResidence).trigger("change");
          $("#lgaOfResidence").val(user.lgaOfResidence).trigger("change");
          $("#house_number").val(user.house_number);
          $("#street_name").val(user.street_name);
          $("#nearest_bus_stop_landmark").val(user.nearest_bus_stop_landmark);
          $("#city_town").val(user.city_town);
          $("#countryOfResidence").val(user.countryOfResidence);
          $("#identification").val(user.identification).trigger("change");
          $("#id_number").val(user.id_number);
          $("#issue_date").val(user.issue_date);
          $("#expiry_date").val(user.expiry_date);
          $("#profilePhotoImg").attr("src", user.passportPhoto);

          // Populate health info
          $("#blood_group").val(user.healthInfo.bloodGroup);
          $("#genotype").val(user.healthInfo.genotype);
          $("#medical_condition").val(user.healthInfo.medical_condition);
          $("#disability").val(user.healthInfo.disabilityStatus);

          // Populate next of kin
          populateNextOfKin(user.nextOfKin);

          // populate neighbor with verification status
          populateNeighbor(user.neighbor);

          // populate family with verification status
          console.log("user.family", user.family);
          populateFamily(user.family);

          // Populate employment history
          populateEmploymentHistory(user.employmentHistory);

          // Populate business
          populateBusiness(user.business);

          // Populate educational history
          populateEducationalHistory(user.educationalHistory);

          // Load verification tokens
          loadVerificationTokens();

          // Reset the form change tracking
          formHasUnsavedChanges = false;
        } catch (error) {
          console.error("Failed to fetch current user:", error);
          showNotification(
            "Unable to load user profile. Please refresh or log in again.",
            "danger"
          );

          // If server load fails, try to load from localStorage
          const hasLocalData = loadProfileFormData();
          if (!hasLocalData) {
            showNotification(
              "No local data available. Please check your connection.",
              "warning"
            );
          }
        }
      }

      // Initialize the profile form

      // First try to load from localStorage for immediate display
      const hasLocalData = loadProfileFormData();

      // Then load from server (this will override local data if successful)
      loadUserData();

      // Set up change tracking for all profile form inputs
      $("#profile-page input, #profile-page select, #profile-page textarea").on(
        "change",
        function () {
          formHasUnsavedChanges = true;
          // Save to localStorage on any change
          saveProfileFormData();
        }
      );

      // Also track changes when dynamic elements are added/removed
      $(document).on("DOMNodeInserted", function (e) {
        if (
          $(e.target).hasClass("next-of-kin-item") ||
          $(e.target).hasClass("neighbor-item") ||
          $(e.target).hasClass("family-item") ||
          $(e.target).hasClass("employment-item") ||
          $(e.target).hasClass("business-item") ||
          $(e.target).hasClass("education-item")
        ) {
          formHasUnsavedChanges = true;
          saveProfileFormData();
        }
      });

      // Handle page unload only for profile page
      $(window).on("beforeunload", function (e) {
        // Check if we're on the profile page
        if ($("#profile-page").is(":visible") && formHasUnsavedChanges) {
          const message = "Changes you made may not be saved.";
          e.returnValue = message;
          return message;
        }
      });

      // Save profile form data to localStorage
      function saveProfileFormData() {
        const formData = {
          // Basic info
          firstname: $("#firstname").val(),
          lastname: $("#lastname").val(),
          middlename: $("#middlename").val(),
          email: $("#email").val().trim(),
          phone: $("#phone").val(),
          NIN: $("#NIN").val(),
          DOB: $("#DOB").val(),
          gender: $("#gender").val(),
          maritalStatus: $("#maritalStatus").val(),
          nationality: $("#nationality").val(),
          religion: $("#religion").val(),
          community: $("#community").val(),
          stateOfOrigin: $("#stateOfOrigin").val(),
          lgaOfOrigin: $("#lgaOfOrigin").val(),
          stateOfResidence: $("#stateOfResidence").val(),
          lgaOfResidence: $("#lgaOfResidence").val(),
          house_number: $("#house_number").val(),
          street_name: $("#street_name").val(),
          nearest_bus_stop_landmark: $("#nearest_bus_stop_landmark").val(),
          city_town: $("#city_town").val(),
          countryOfResidence: $("#countryOfResidence").val(),
          identification: $("#identification").val(),
          id_number: $("#id_number").val(),
          issue_date: $("#issue_date").val(),
          expiry_date: $("#expiry_date").val(),

          // Health info
          healthInfo: {
            bloodGroup: $("#blood_group").val(),
            genotype: $("#genotype").val(),
            medical_condition: $("#medical_condition").val(),
            disabilityStatus: $("#disability").val(),
          },

          // Dynamic arrays
          nextOfKin: getNextOfKinData(),
          neighbor: getNeighborData(),
          family: getFamilyData(),
          employmentHistory: getEmploymentHistoryData(),
          business: getBusinessData(),
          educationalHistory: getEducationalHistoryData(),
        };

        localStorage.setItem("profileFormData", JSON.stringify(formData));
        console.log("Profile form data saved to localStorage");
      }

      // Load profile form data from localStorage
      function loadProfileFormData() {
        const savedData = localStorage.getItem("profileFormData");
        if (savedData) {
          const formData = JSON.parse(savedData);

          // Populate basic fields
          $("#firstname").val(formData.firstname || "");
          $("#lastname").val(formData.lastname || "");
          $("#middlename").val(formData.middlename || "");
          $("#email").val(formData.email || "");
          $("#phone").val(formData.phone || "");
          $("#NIN").val(formData.NIN || "");
          $("#DOB").val(formData.DOB || "");
          $("#gender")
            .val(formData.gender || "")
            .trigger("change");
          $("#maritalStatus")
            .val(formData.maritalStatus || "")
            .trigger("change");
          $("#nationality").val(formData.nationality || "");
          $("#religion").val(formData.religion || "");
          $("#community").val(formData.community || "");
          $("#stateOfOrigin").val(formData.stateOfOrigin || "");
          $("#lgaOfOrigin").val(formData.lgaOfOrigin || "");
          $("#stateOfResidence").val(formData.stateOfResidence || "");
          $("#lgaOfResidence").val(formData.lgaOfResidence || "");
          $("#house_number").val(formData.house_number || "");
          $("#street_name").val(formData.street_name || "");
          $("#nearest_bus_stop_landmark").val(
            formData.nearest_bus_stop_landmark || ""
          );
          $("#city_town").val(formData.city_town || "");
          $("#countryOfResidence").val(formData.countryOfResidence || "");
          $("#identification").val(formData.identification || "");
          $("#id_number").val(formData.id_number || "");
          $("#issue_date").val(formData.issue_date || "");
          $("#expiry_date").val(formData.expiry_date || "");

          // Populate health info
          if (formData.healthInfo) {
            $("#blood_group").val(formData.healthInfo.bloodGroup || "");
            $("#genotype").val(formData.healthInfo.genotype || "");
            $("#medical_condition").val(
              formData.healthInfo.medical_condition || ""
            );
            $("#disability").val(formData.healthInfo.disabilityStatus || "");
          }

          // Populate dynamic arrays
          if (formData.nextOfKin && formData.nextOfKin.length > 0) {
            populateNextOfKin(formData.nextOfKin);
          }

          if (formData.neighbor && formData.neighbor.length > 0) {
            populateNeighbor(formData.neighbor);
          }

          if (formData.family && formData.family.length > 0) {
            populateFamily(formData.family);
          }

          if (
            formData.employmentHistory &&
            formData.employmentHistory.length > 0
          ) {
            populateEmploymentHistory(formData.employmentHistory);
          }

          if (formData.business && formData.business.length > 0) {
            populateBusiness(formData.business);
          }

          if (
            formData.educationalHistory &&
            formData.educationalHistory.length > 0
          ) {
            populateEducationalHistory(formData.educationalHistory);
          }

          console.log("Profile form data loaded from localStorage");
          return true;
        }
        return false;
      }

      // Helper functions to get current dynamic data
      function getNextOfKinData() {
        const data = [];
        $(".next-of-kin-item").each(function () {
          data.push({
            nok_name: $(this).find(".next-of-kin-name").val(),
            nok_relationship: $(this).find(".next-of-kin-relationship").val(),
            nok_phone: $(this).find(".next-of-kin-phone").val(),
            nok_address: $(this).find(".next-of-kin-address").val(),
            nok_email: $(this).find(".next-of-kin-email").val(),
          });
        });
        return data;
      }

      function getNeighborData() {
        const data = [];
        $(".neighbor-item").each(function () {
          data.push({
            name: $(this).find(".neighbor-name").val(),
            phone: $(this).find(".neighbor-phone").val(),
            address: $(this).find(".neighbor-address").val(),
          });
        });
        return data;
      }

      function getFamilyData() {
        const data = [];
        $(".family-item").each(function () {
          data.push({
            name: $(this).find(".family-name").val(),
            relationship: $(this).find(".family-relationship").val(),
            phone: $(this).find(".family-phone").val(),
            address: $(this).find(".family-address").val(),
          });
        });
        return data;
      }

      function getEmploymentHistoryData() {
        const data = [];
        $(".employment-item").each(function () {
          data.push({
            company: $(this).find(".employment-company").val(),
            position: $(this).find(".employment-position").val(),
            start: $(this).find(".employment-start").val(),
            end: $(this).find(".employment-end").val(),
          });
        });
        return data;
      }

      function getBusinessData() {
        const data = [];
        $(".business-item").each(function () {
          data.push({
            name: $(this).find(".business-name").val(),
            type: $(this).find(".business-type").val(),
            registrationNumber: $(this).find(".business-registration").val(),
          });
        });
        return data;
      }

      function getEducationalHistoryData() {
        const data = [];
        $(".education-item").each(function () {
          data.push({
            institution: $(this).find(".education-institution").val(),
            qualification: $(this).find(".education-qualification").val(),
            start: $(this).find(".education-start").val(),
            end: $(this).find(".education-end").val(),
          });
        });
        return data;
      }

      async function initializeDashboard() {
        try {
          $("#dashboardLoader").show();

          // Update summary cards first
          await updateSummaryCards();

          // Fetch dashboard data from backend
          const dashboardRes = await $.ajax({
            url: `${BACKEND_URL}/users/initialize`,
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          const { analytics, activity } = dashboardRes || {};

          // --- Request Status Chart (Pie) ---
          if (analytics?.requestStatus) {
            const ctx1 = document
              .getElementById("requestStatusChart")
              ?.getContext("2d");
            if (!ctx1)
              return console.warn("requestStatusChart canvas not found");

            // Destroy old chart safely
            if (
              window.requestStatusChart &&
              typeof window.requestStatusChart.destroy === "function"
            ) {
              window.requestStatusChart.destroy();
            }

            window.requestStatusChart = new Chart(ctx1, {
              type: "pie",
              data: {
                labels: Object.keys(analytics.requestStatus),
                datasets: [
                  {
                    data: Object.values(analytics.requestStatus),
                    backgroundColor: ["#10b981", "#f59e0b", "#ef4444"],
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: { position: "bottom" },
                },
              },
            });
          }

          // --- Request Frequency Chart (Bar) ---
          if (analytics?.requestFrequency) {
            const ctx2 = document
              .getElementById("requestFrequencyChart")
              ?.getContext("2d");
            if (!ctx2)
              return console.warn("requestFrequencyChart canvas not found");

            if (
              window.requestFrequencyChart &&
              typeof window.requestFrequencyChart.destroy === "function"
            ) {
              window.requestFrequencyChart.destroy();
            }

            window.requestFrequencyChart = new Chart(ctx2, {
              type: "bar",
              data: {
                labels: Object.keys(analytics.requestFrequency),
                datasets: [
                  {
                    label: "Requests",
                    data: Object.values(analytics.requestFrequency),
                    backgroundColor: "#4c5fd5",
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } },
              },
            });
          }

          // --- Update Activity Timeline ---
          updateActivityTimeline(Array.isArray(activity) ? activity : []);
        } catch (error) {
          console.error("Error initializing dashboard:", error);
        } finally {
          $("#dashboardLoader").hide();
        }
      }

      async function updateSummaryCards() {
        try {
          $("#summaryLoader").show();

          // Fetch dashboard summary
          const response = await $.ajax({
            url: `${BACKEND_URL}/users/initialize`,
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          const { summary } = response;
          $("#totalRequestsCard").text(summary.totalRequests || 0);
          $("#approvedRequestsCard").text(summary.approvedRequests || 0);
          $("#pendingRequestsCard").text(
            // (summary.totalRequests || 0) -
            summary.pendingRequests || 0
          );

          // Fetch user profile info
          const userRes = await $.ajax({
            url: `${BACKEND_URL}/users/me`,
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          const profileCompletion = userRes.profileCompletionPercentage || 0;
          $("#profileCompletionCard").text(profileCompletion + "%");
          $("#profileCompletionBadge").text(profileCompletion + "%");

          // Fetch notifications
          const notifRes = await $.ajax({
            url: `${BACKEND_URL}/notifications`,
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          renderNotifications(notifRes);

          // Update badge for pending requests
          $("#pendingRequestsBadge").text(
            (summary.totalRequests || 0) - (summary.approvedCertificates || 0)
          );
        } catch (error) {
          console.error("Error updating summary cards:", error);
        } finally {
          $("#summaryLoader").hide();
        }
      }

      //  Render notifications & unread count
      function renderNotifications(notifListData) {
        const unreadCount = notifListData.filter((n) => !n.read).length;
        $("#notificationCount").text(unreadCount);

        const notifList = $(".dropdown-menu.dropdown-menu-end");
        notifList.find(".dynamic-notification, .mark-all-container").remove(); // clear old ones

        if (notifListData.length > 0) {
          notifListData.slice(0, 5).forEach((n) => {
            notifList.find("hr.dropdown-divider").before(`
      <li class="dynamic-notification">
        <a 
          class="dropdown-item d-block ${!n.read ? "fw-bold" : "text-muted"}" 
          href="#" 
          data-id="${n._id}"
        >
          ${n.title}<br/>
          <small class="text-muted">${
            n.createdAt ? new Date(n.createdAt).toLocaleString() : ""
          }</small>
        </a>
      </li>
    `);
          });

          //  Add "Mark all as read" button
          notifList.append(`
    <li class="mark-all-container text-center p-2">
      <button class="btn btn-sm btn-outline-primary" id="markAllReadBtn">
        <i class="bi bi-check2-all me-1"></i> Mark all as read
      </button>
    </li>
  `);
        } else {
          notifList.find("hr.dropdown-divider").before(`
      <li class="dynamic-notification">
        <a class="dropdown-item text-muted" href="#">No notifications yet</a>
      </li>
    `);
        }
      }

      //  Mark one notification as read
      $(document).on("click", ".dropdown-item[data-id]", async function (e) {
        e.preventDefault();
        const notifId = $(this).data("id");

        try {
          await $.ajax({
            url: `${BACKEND_URL}/notifications/${notifId}/mark-read`,
            method: "PATCH",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          $(this)
            .removeClass("fw-bold")
            .addClass("text-muted")
            .fadeTo(300, 0.8);

          const countEl = $("#notificationCount");
          const currentCount = parseInt(countEl.text()) || 0;
          countEl.text(Math.max(currentCount - 1, 0));
        } catch (error) {
          console.error("Failed to mark notification as read:", error);
        }
      });

      //  Mark all notifications as read
      $(document).on("click", "#markAllReadBtn", async function () {
        try {
          await $.ajax({
            url: `${BACKEND_URL}/notifications/mark-all-read`,
            method: "PATCH",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          $(".dropdown-item[data-id]")
            .removeClass("fw-bold")
            .addClass("text-muted");
          $("#notificationCount").text(0);
          showNotification("All notifications marked as read", "success");
        } catch (error) {
          console.error("Failed to mark all notifications as read:", error);
        }
      });

      //  WebSocket: receive new notifications in real-time
      function initializeWebSocket() {
        const socket = io(BACKEND_URL, {
          extraHeaders: {
            Authorization: `Bearer ${token}`,
          },
        });

        socket.on("connect", () => {
          console.log(" Connected to notification server");
        });

        socket.on("notification:new", (notification) => {
          console.log(" New notification received:", notification);

          // Show toast
          showNotification(notification.title, notification.message);

          // Increment unread count
          const countEl = $("#notificationCount");
          const currentCount = parseInt(countEl.text()) || 0;
          countEl.text(currentCount + 1);

          // Prepend notification
          const notifList = $(".dropdown-menu.dropdown-menu-end");
          notifList.find("hr.dropdown-divider").before(`
    <li class="dynamic-notification">
      <a class="dropdown-item fw-bold" href="#" data-id="${notification._id}">
        ${notification.title}<br/>
        <small class="text-muted">${new Date().toLocaleString()}</small>
      </a>
    </li>
  `);
        });

        socket.on("disconnect", () => {
          console.log(" Disconnected from notification server");
        });
      }

      $(document).ready(function () {
        updateSummaryCards();
        initializeWebSocket();
      });

      function updateActivityTimeline(activities) {
        const timeline = $("#activityTimeline");
        timeline.empty();

        activities.forEach((activity) => {
          const item = $(`
            <div class="activity-item">
                <div class="activity-time">${activity.time}</div>
                <div class="activity-content">${activity.content}</div>
            </div>
        `);
          timeline.append(item);
        });
      }

      function showPage(pageName) {
        // Hide all pages
        $(".page-content").addClass("d-none");

        // Show selected page
        $(`#${pageName}-page`).removeClass("d-none");

        // Initialize page-specific components
        switch (pageName) {
          case "dashboard":
            initializeDashboard();
            break;
          case "profile":
            // Profile page doesn't need special initialization
            break;
          case "requests":
            initializeRequestsPage();
            break;
          case "analytics":
            initializeAnalyticsPage();
            break;
          case "settings":
            // Settings page doesn't need special initialization
            break;
        }
      }

      function updateProfileCompletion(percentage, isCompleted) {
        $("#profileCompletionBar").css("width", percentage + "%");
        $("#profileCompletionText").text(percentage + "%");

        const statusText = isCompleted ? "Completed" : "Incomplete";
        const statusClass = isCompleted ? "verified" : "unverified";

        $("#profileStatus").text(statusText);
        $("#profileStatus")
          .removeClass("verified unverified")
          .addClass(statusClass);
      }

      function updateVerificationStatus(isVerified) {
        const statusText = isVerified ? "Verified" : "Unverified";
        const statusClass = isVerified ? "verified" : "unverified";

        $("#verificationStatus").text(statusText);
        $("#verificationStatus")
          .removeClass("verified unverified")
          .addClass(statusClass);
      }

      function updateTwoFactorStatus(isEnabled) {
        const statusText = isEnabled ? "Enabled" : "Disabled";

        $("#twoFactorStatus").text(statusText);
        $("#twoFactorToggle").prop("checked", isEnabled);
        $("#settingsTwoFactorToggle").prop("checked", isEnabled);
      }

      function populateNextOfKin(nextOfKinData) {
        const container = $("#nextOfKinContainer");
        container.empty();

        nextOfKinData.forEach((kin) => {
          const kinItem = $(`
            <div class="next-of-kin-item mb-3">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Full Name</label>
                                <input type="text" class="form-control next-of-kin-name" value="${kin.nok_name}" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Relationship</label>
                                <input type="text" class="form-control next-of-kin-relationship" value="${kin.nok_relationship}" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Phone</label>
                                <input type="tel" class="form-control next-of-kin-phone" value="${kin.nok_phone}" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Address</label>
                                <input type="text" class="form-control next-of-kin-address" value="${kin.nok_address}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email</label>
                                <input type="text" class="form-control next-of-kin-email" value="${kin.nok_email}" required>
                            </div>
                        </div>

   
                    
                        <div class="text-end">
                            <button type="button" class="btn btn-sm btn-outline-danger remove-next-of-kin">
                                <i class="bi bi-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `);
          container.append(kinItem);
        });
      }

      function populateEmploymentHistory(employmentData) {
        const container = $("#employmentHistoryContainer");
        container.empty();

        employmentData.forEach((emp) => {
          const empItem = $(`
            <div class="employment-item mb-3">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Company Name</label>
                                <input type="text" class="form-control employment-company" value="${emp.company}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Position</label>
                                <input type="text" class="form-control employment-position" value="${emp.position}" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Start Date</label>
                                <input type="date" class="form-control employment-start" value="${emp.start}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">End Date</label>
                                <input type="date" class="form-control employment-end" value="${emp.end}">
                            </div>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-sm btn-outline-danger remove-employment">
                                <i class="bi bi-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `);
          container.append(empItem);
        });
      }

      function populateBusiness(businessData) {
        const container = $("#businessContainer");
        container.empty();

        businessData.forEach((bus) => {
          const busItem = $(`
            <div class="business-item mb-3">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Business Name</label>
                                <input type="text" class="form-control business-name" value="${bus.name}" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Business Type</label>
                                <input type="text" class="form-control business-type" value="${bus.type}" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Registration Number</label>
                                <input type="text" class="form-control business-registration" value="${bus.registration}">
                            </div>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-sm btn-outline-danger remove-business">
                                <i class="bi bi-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `);
          container.append(busItem);
        });
      }

      function populateEducationalHistory(educationData) {
        console.log("educationData", educationData);
        const container = $("#educationHistoryContainer");
        container.empty();

        educationData.forEach((edu) => {
          const eduItem = $(`
            <div class="education-item mb-3">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Institution</label>
                                <input type="text" class="form-control education-institution" value="${edu.institution}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Qualification</label>
                                <input type="text" class="form-control education-qualification" value="${edu.qualification}" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Start Date</label>
                                <input type="date" class="form-control education-start" value="${edu.start}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">End Date</label>
                                <input type="date" class="form-control education-end" value="${edu.end}">
                            </div>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-sm btn-outline-danger remove-education">
                                <i class="bi bi-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `);
          container.append(eduItem);
        });
      }

      /**
       * Renders a status badge with appropriate styling.
       * This version is robust against undefined, null, or non-string data.
       * @param {string} data - The status string from the API.
       * @returns {string} HTML for the status badge.
       */
      function renderStatus(data) {
        // If data is missing, null, or not a string, display a default "N/A" status.
        if (!data || typeof data !== "string") {
          return `<span class="status-badge pending">N/A</span>`;
        }

        // Use toLowerCase() for a case-insensitive comparison, making it more robust.
        const status = data.toLowerCase();
        let badgeClass = "status-badge pending"; // Default class

        if (status === "Approved") {
          badgeClass = "status-badge approved";
        } else if (status === "Rejected") {
          badgeClass = "status-badge unverified";
        }

        // Now we are certain 'data' is a string, so toUpperCase() is safe to call.
        return `<span class="${badgeClass}">${data.toUpperCase()}</span>`;
      }

      /**
       * Renders a date in a user-friendly format.
       * @param {string} data - The date string from the API.
       * @returns {string} The formatted date or 'N/A'.
       */
      function renderDate(data) {
        return data ? new Date(data).toLocaleDateString() : "N/A";
      }

      /**
       * Renders a user's full name.
       * @param {object} row - The data row object.
       * @returns {string} The concatenated first and last name.
       */
      function renderName(row) {
        return `${row.firstname || ""} ${row.lastname || ""}`.trim();
      }

      /**
       * Factory function to create a renderer for the action buttons.
       * @param {string} documentType - The type of document ('idcard' or 'certificate').
       * @returns {function} A DataTables render function.
       */
      // function createActionsRenderer(documentType) {
      //   return function (data, type, row) {
      //     let actions = "";
      //     if (row.status === "Approved") {
      //       actions += `<button class="btn btn-sm btn-outline-primary download-btn" data-id="${row._id}">
      //         <i class="bi bi-download"></i> Download
      //       </button>`;
      //     }
      //     actions += ` <button class="btn btn-sm btn-outline-info view-btn" data-id="${row._id}" data-type="${documentType}">
      //       <i class="bi bi-eye"></i> View
      //     </button>`;
      //     return actions;
      //   };
      // }

      function createActionsRenderer(documentType) {
        return function (data, type, row) {
          let actions = "";

          // Always show view button
          actions += `<button class="btn btn-sm btn-outline-info view-btn" data-id="${row._id}" data-type="${documentType}">
      <i class="bi bi-eye"></i> View
    </button>`;

          // Show download button only for approved documents
          if (row.status === "Approved") {
            const buttonClass =
              documentType === "idcard"
                ? "btn-card-download"
                : "btn-cert-download";

            actions += `<button class="btn btn-sm btn-outline-primary ${buttonClass}" data-id="${row._id}">
        <i class="bi bi-download"></i> Download
      </button>`;
          }

          return actions;
        };
      }

      /**
       * Initializes a new DataTable or updates an existing one with new data.
       * @param {string} selector - The jQuery selector for the table.
       * @param {Array} data - The data array to populate the table.
       * @param {Array} columns - The DataTables column configuration array.
       */
      function initializeOrUpdateDataTable(selector, data, columns) {
        const commonOptions = {
          responsive: true,
          pageLength: 10,
          language: {
            emptyTable: "No records found",
            zeroRecords: "No matching records found",
          },
        };

        if ($.fn.DataTable.isDataTable(selector)) {
          $(selector).DataTable().clear().rows.add(data).draw();
        } else {
          $(selector).DataTable({
            data: data,
            columns: columns,
            ...commonOptions,
          });
        }
      }

      /**
       * Renders a status badge with appropriate styling.
       * This version is robust against undefined, null, or non-string data.
       * @param {string} data - The status string from the API.
       * @returns {string} HTML for the status badge.
       */
      function renderStatus(data) {
        if (!data || typeof data !== "string") {
          return `<span class="status-badge pending">N/A</span>`;
        }
        const status = data.toLowerCase();
        let badgeClass = "status-badge pending";
        if (status === "approved") badgeClass = "status-badge approved";
        else if (status === "rejected") badgeClass = "status-badge unverified";
        return `<span class="${badgeClass}">${data.toUpperCase()}</span>`;
      }

      /**
       * Renders a date in a user-friendly format.
       */
      function renderDate(data) {
        return data ? new Date(data).toLocaleDateString() : "N/A";
      }

      /**
       * Renders a user's full name.
       */
      function renderName(row) {
        return `${row.firstname || ""} ${row.lastname || ""}`.trim();
      }

      /**
       * Factory function to create a renderer for the action buttons.
       */
      // function createActionsRenderer(documentType) {
      //   return function (data, type, row) {
      //     let actions = "";
      //     if (row.status === "Approved") {
      //       actions += `<button class="btn btn-sm btn-outline-primary download-btn" data-id="${row._id}">
      //         <i class="bi bi-download"></i> Download
      //       </button>`;
      //     }
      //     actions += ` <button class="btn btn-sm btn-outline-info view-btn" data-id="${row._id}" data-type="${documentType}">
      //       <i class="bi bi-eye"></i> View
      //     </button>`;
      //     return actions;
      //   };
      // }

      /**
       * Initializes or updates a DataTable.
       */
      function initializeOrUpdateDataTable(selector, data, columns) {
        const commonOptions = {
          responsive: true,
          pageLength: 10,
          language: {
            emptyTable: "No records found",
            zeroRecords: "No matching records found",
          },
        };
        if ($.fn.DataTable.isDataTable(selector)) {
          $(selector).DataTable().clear().rows.add(data).draw();
        } else {
          $(selector).DataTable({
            data: data,
            columns: columns,
            ...commonOptions,
          });
        }
      }

      /**
       * NEW HELPER FUNCTION
       * Normalizes API response into a predictable array for DataTables.
       * @param {*} response - The raw response from the API.
       * @returns {Array} An array of items, ready for DataTables.
       */
      function normalizeDataForDataTable(response) {
        // 1. If response is null or undefined, return an empty array.
        if (!response) {
          return [];
        }

        // 2. If response is already an array, return it.
        if (Array.isArray(response)) {
          return response;
        }

        // 3. If response is a single object, wrap it in an array.
        if (typeof response === "object" && response !== null) {
          return [response];
        }

        // 4. Fallback for any other unexpected data type.
        return [];
      }

      async function initializeRequestsPage() {
        try {
          const [idcardRes, certificateRes] = await Promise.all([
            $.ajax({
              url: `${BACKEND_URL}/idcard/${user.id}`,
              method: "GET",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            }),
            $.ajax({
              url: `${BACKEND_URL}/indigene/certificate/${user.id}`,
              method: "GET",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            }),
          ]);

          // Use the new helper function to prepare the data
          const idcardData = normalizeDataForDataTable(idcardRes);
          const certificateData = normalizeDataForDataTable(certificateRes);

          const tableConfigs = [
            {
              selector: "#idcardRequestsTable",
              data: idcardData,
              columns: [
                { data: "_id" },
                { data: null, render: (data, type, row) => renderName(row) },
                { data: "dateOfIssue", render: renderDate },
                { data: "dateOfExpiration", render: renderDate },
                { data: "status", render: renderStatus },
                { data: "approvalDate", render: renderDate },
                {
                  data: null,
                  orderable: false,
                  render: createActionsRenderer("idcard"),
                },
              ],
            },
            {
              selector: "#certificateRequestsTable",
              data: certificateData,
              columns: [
                { data: "_id" },
                { data: null, render: (data, type, row) => renderName(row) },
                { data: "stateOfOrigin" },
                { data: "lgaOfOrigin" },
                { data: "kindred" },
                { data: "status", render: renderStatus },
                { data: "approvalDate", render: renderDate },
                {
                  data: null,
                  orderable: false,
                  render: createActionsRenderer("certificate"),
                },
              ],
            },
          ];

          tableConfigs.forEach((config) => {
            initializeOrUpdateDataTable(
              config.selector,
              config.data,
              config.columns
            );
          });
        } catch (error) {
          console.error("Error loading requests:", error);
        } finally {
          $("#requestsLoader").hide();
        }
      }

      async function initializeAnalyticsPage() {
        try {
          //  Fetch analytics data from backend
          const dashboardRes = await $.ajax({
            url: `${BACKEND_URL}/users/initialize`,
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          const { analytics, activity } = dashboardRes || {};

          //  Process and render analytics charts
          if (!idcardAnalyticsChart) {
            const ctx1 = document
              .getElementById("idcardAnalyticsChart")
              .getContext("2d");
            idcardAnalyticsChart = new Chart(ctx1, {
              type: "line",
              data: {
                labels: Object.keys(analytics.idcardRequests),
                datasets: [
                  {
                    label: "ID Card Requests",
                    data: Object.values(analytics.idcardRequests),
                    borderColor: "#4c5fd5",
                    backgroundColor: "rgba(76, 95, 213, 0.1)",
                    tension: 0.4,
                    fill: true,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } },
              },
            });
          }

          if (!certificateAnalyticsChart) {
            const ctx2 = document
              .getElementById("certificateAnalyticsChart")
              .getContext("2d");
            certificateAnalyticsChart = new Chart(ctx2, {
              type: "line",
              data: {
                labels: Object.keys(analytics.certificateRequests),
                datasets: [
                  {
                    label: "Certificate Requests",
                    data: Object.values(analytics.certificateRequests),
                    borderColor: "#10b981",
                    backgroundColor: "rgba(16, 185, 129, 0.1)",
                    tension: 0.4,
                    fill: true,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } },
              },
            });
          }

          if (!requestRatioChart) {
            const ctx3 = document
              .getElementById("requestRatioChart")
              .getContext("2d");
            requestRatioChart = new Chart(ctx3, {
              type: "doughnut",
              data: {
                labels: Object.keys(analytics.requestStatus),
                datasets: [
                  {
                    data: Object.values(analytics.requestStatus),
                    backgroundColor: ["#10b981", "#f59e0b", "#ef4444"],
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: "bottom" } },
              },
            });
          }

          if (!requestFrequencyAnalyticsChart) {
            const ctx4 = document
              .getElementById("requestFrequencyAnalyticsChart")
              .getContext("2d");
            requestFrequencyAnalyticsChart = new Chart(ctx4, {
              type: "bar",
              data: {
                labels: Object.keys(analytics.requestByDayAndHour),
                datasets: [
                  {
                    label: "Requests",
                    data: Object.values(analytics.requestByDayAndHour),
                    backgroundColor: "#4c5fd5",
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } },
              },
            });
          }
        } catch (error) {
          console.error("Error loading analytics:", error.message);
          showNotification(
            "Failed to load analytics. Please try again.",
            "danger"
          );
        } finally {
          // Hide loader if you have one
          $("#analyticsLoader").hide();
        }
      }

      async function uploadProfilePhoto(file) {
        if (!file) return;

        // Show progress bar
        $("#uploadProgress").show();
        $("#uploadProgress .progress-bar").css("width", "0%");

        // Prepare FormData for file upload
        const formData = new FormData();
        formData.append("passportPhoto", file); // field name must match your NestJS DTO

        try {
          // Perform AJAX upload
          const response = await $.ajax({
            url: `${BACKEND_URL}/users/${user.id}`,
            method: "PUT",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            data: formData,
            processData: false,
            contentType: false,
            xhr: function () {
              const xhr = new window.XMLHttpRequest();
              xhr.upload.addEventListener("progress", function (e) {
                if (e.lengthComputable) {
                  const percentComplete = (e.loaded / e.total) * 100;
                  $("#uploadProgress .progress-bar").css(
                    "width",
                    percentComplete + "%"
                  );
                }
              });
              return xhr;
            },
          });

          //  Update photo preview on success
          if (response?.photoUrl) {
            $("#profilePhotoImg").attr("src", response.photoUrl);
          }

          showNotification("Profile photo uploaded successfully", "success");
        } catch (error) {
          console.error("Upload failed:", error);
          showNotification("Failed to upload profile photo", "danger");
        } finally {
          // Hide loader after completion
          setTimeout(() => {
            $("#uploadProgress").hide();
            $("#uploadProgress .progress-bar").css("width", "0%");
          }, 800);
        }
      }

      function toggleTwoFactor(isEnabled) {
        // Update UI
        updateTwoFactorStatus(isEnabled);

        // Update user data
        mockAPI.currentUser.twoFactorEnabled = isEnabled;

        // Show notification
        showNotification(
          `Two-factor authentication ${isEnabled ? "enabled" : "disabled"}`,
          "success"
        );

        // In a real implementation, this would make an API call
        // POST /api/auth/twofactor/enable
        console.log("API Call: POST /api/auth/twofactor/enable", {
          enabled: isEnabled,
        });
      }

      $("#requestType").on("change", async function () {
        const user = await $.ajax({
          url: `${BACKEND_URL}/users/me`,
          method: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
        });
        const requestType = $(this).val();

        // Hide all request fields
        $(".request-fields").addClass("d-none");

        // Show relevant fields based on request type
        if (requestType === "idcard") {
          $("#idcardFields").removeClass("d-none");
          // Pre-fill with current user data
          $("#idcardFirstname").val(user.firstname);
          $("#idcardLastname").val(user.lastname);
          $("#idcardPhone").val(user.phone);
          $("#idcardEmail").val(user.email);
        } else if (requestType === "certificate") {
          $("#certificateFields").removeClass("d-none");
          // Pre-fill with current user data
          $("#certFirstname").val(user.firstname);
          $("#certLastname").val(user.lastname);
          $("#certMiddlename").val(user.middlename);
          $("#certDOB").val(user.DOB);
          $("#certMaritalStatus").val(user.maritalStatus);
          $("#certGender").val(user.gender);
          $("#certStateOfOrigin").val(user.stateOfOrigin);
          $("#certLGAOfOrigin").val(user.lgaOfOrigin);
          $("#certAddress").val(`${user.address}`);
          $("#certPhone").val(user.phone);
          $("#certKindred").val(user.community);
          $("#certFathersStateOfOrigin").val(user.stateOfOrigin);
          $("#certMothersStateOfOrigin").val(user.stateOfOrigin);
        }
      });

      async function submitNewRequest() {
        const requestType = $("#requestType").val();

        if (!requestType) {
          showNotification("Please select a request type", "error");
          return;
        }

        try {
          let formData = new FormData();

          // =====================
          // ID CARD REQUEST
          // =====================
          if (requestType === "idcard") {
            if (
              // !$("#cardType").val() ||
              !$("#idcardFirstname").val() ||
              !$("#idcardLastname").val() ||
              !$("#idcardEmail").val() ||
              !$("#idcardPhone").val()
            ) {
              showNotification("Please fill all required fields", "error");
              return;
            }

            // formData.append("card_type", $("#cardType").val());
            formData.append("phone", $("#idcardPhone").val());
            formData.append("firstname", $("#idcardFirstname").val());
            formData.append("lastname", $("#idcardLastname").val());
            formData.append("email", $("#idcardEmail").val());

            if ($("#ref_Letter")[0].files[0]) {
              formData.append("files", $("#ref_Letter")[0].files[0]);
            }
            if ($("#utilityBill")[0].files[0]) {
              formData.append("files", $("#utilityBill")[0].files[0]);
            }

            formData.append("userId", user.id);

            const response = await $.ajax({
              url: `${BACKEND_URL}/idcard/create`,
              method: "POST",
              data: formData,
              processData: false,
              contentType: false,
              headers: {
                Authorization: `Bearer ${token}`,
              },
            });

            showNotification(
              "ID Card request submitted successfully",
              "success"
            );
            // idcardRequestsTable.ajax.reload(); // Refresh table

            initializeRequestsPage();

            console.log("ID card response:", response);
          }

          // =====================
          // CERTIFICATE REQUEST
          // =====================
          else if (requestType === "certificate") {
            const requiredCertFields = [
              "certFirstname",
              "certLastname",
              "certDOB",
              "certMaritalStatus",
              "certGender",
              "certStateOfOrigin",
              "certLGAOfOrigin",
              "certWard",
              "certAddress",
              "certPhone",
              "certKindred",
              "certFathersName",
              "certFathersStateOfOrigin",
              "certMothersName",
              "certMothersStateOfOrigin",
              "certPurpose",
              "certPassportPhoto",
              "certIdCard",
              "certBirthCertificate",
            ];

            let isValid = true;
            for (const field of requiredCertFields) {
              if (!$("#" + field).val()) {
                isValid = false;
                break;
              }
            }

            if (!isValid) {
              showNotification("Please fill all required fields", "error");
              return;
            }

            formData.append("firstname", $("#certFirstname").val());
            formData.append("lastname", $("#certLastname").val());
            formData.append("middlename", $("#certMiddlename").val());
            formData.append("DOB", $("#certDOB").val());
            formData.append("maritalStatus", $("#certMaritalStatus").val());
            formData.append("gender", $("#certGender").val());
            formData.append("stateOfOrigin", $("#certStateOfOrigin").val());
            formData.append("lgaOfOrigin", $("#certLGAOfOrigin").val());
            formData.append("ward", $("#certWard").val());
            formData.append("address", $("#certAddress").val());
            formData.append("phone", $("#certPhone").val());
            formData.append("kindred", $("#certKindred").val());
            formData.append("fathersName", $("#certFathersName").val());
            formData.append(
              "fathersStateOfOrigin",
              $("#certFathersStateOfOrigin").val()
            );
            formData.append("mothersName", $("#certMothersName").val());
            formData.append(
              "mothersStateOfOrigin",
              $("#certMothersStateOfOrigin").val()
            );
            formData.append("guardian", $("#certGuardian").val() || "");
            formData.append(
              "relationshipToguardian",
              $("#certRelationshipToGuardian").val() || ""
            );
            formData.append("purpose", $("#certPurpose").val());

            if ($("#certPassportPhoto")[0].files[0]) {
              formData.append(
                "passportPhoto",
                $("#certPassportPhoto")[0].files[0]
              );
            }
            if ($("#certIdCard")[0].files[0]) {
              formData.append("idCard", $("#certIdCard")[0].files[0]);
            }
            if ($("#certBirthCertificate")[0].files[0]) {
              formData.append(
                "birthCertificate",
                $("#certBirthCertificate")[0].files[0]
              );
            }
            if ($("#certParentGuardianIndigeneCert")[0].files[0]) {
              formData.append(
                "parentGuardianIndigeneCert",
                $("#certParentGuardianIndigeneCert")[0].files[0]
              );
            }
            if ($("#certAttestationLetter")[0].files[0]) {
              formData.append(
                "uploadedAttestationUrl",
                $("#certAttestationLetter")[0].files[0]
              );
            }

            const response = await $.ajax({
              url: `${BACKEND_URL}/indigene/certificate/create`,
              method: "POST",
              data: formData,
              processData: false,
              contentType: false,
              headers: {
                Authorization: `Bearer ${token}`,
              },
            });

            showNotification(
              "Certificate request submitted successfully",
              "success"
            );
            certificateRequestsTable.ajax.reload();

            console.log("Certificate response:", response);
          }

          // =====================
          // COMMON CLEANUP
          // =====================
          $("#newRequestModal").modal("hide");
          $("#newRequestForm")[0].reset();
          $(".request-fields").addClass("d-none");
          updateSummaryCards();
        } catch (error) {
          console.error("Error submitting request:", error);
          showNotification(
            error.responseJSON?.message ||
              "Failed to submit request. Please try again.",
            "error"
          );
        }
      }

      function changePassword() {
        // Get form data
        const currentPassword = $("#currentPassword").val();
        const newPassword = $("#newPassword").val();
        const confirmPassword = $("#confirmPassword").val();

        // Validate form
        if (!currentPassword || !newPassword || !confirmPassword) {
          showNotification("Please fill in all fields", "danger");
          return;
        }

        // Validate passwords match
        if (newPassword !== confirmPassword) {
          showNotification("New passwords do not match", "error");
          return;
        }

        // Close modal
        $("#changePasswordModal").modal("hide");

        // Reset form
        $("#changePasswordForm")[0].reset();

        // Show notification
        showNotification("Password changed successfully", "success");

        // Make the API call
        $.ajax({
          url: `${BACKEND_URL}/auth/change-password`,
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          data: JSON.stringify({
            currentPassword: currentPassword,
            newPassword: newPassword,
          }),
          success: function (response) {
            showNotification("Password changed successfully", "success");
            changePasswordModal.hide();
            $("#changePasswordForm")[0].reset();
          },
          error: function (xhr) {
            const errorMessage = xhr.responseJSON
              ? xhr.responseJSON.message
              : "Failed to change password";
            showNotification(errorMessage, "danger");
          },
          complete: function () {
            // Re-enable the button
            $("#savePasswordBtn").prop("disabled", false).text("Save Changes");
          },
        });
      }

      function generateBackupCodes() {
        // Generate 10 backup codes
        const backupCodes = [];
        for (let i = 0; i < 10; i++) {
          backupCodes.push(
            Math.random().toString(36).substring(2, 10).toUpperCase()
          );
        }

        // Display backup codes
        const codesList = $("#backupCodesList");
        codesList.empty();

        backupCodes.forEach((code) => {
          codesList.append(
            `<div class="col-md-6 mb-2"><code>${code}</code></div>`
          );
        });

        // Show backup codes container
        $("#backupCodesContainer").removeClass("d-none");

        // Show notification
        showNotification("Backup codes generated successfully", "success");

        // In a real implementation, this would make an API call
        // GET /api/users/me/backup-codes
        console.log("API Call: GET /api/users/me/backup-codes");
      }

      function refreshDashboard() {
        // In a real implementation, this would fetch fresh data from the API
        // GET /api/users/me/analytics
        console.log("API Call: GET /api/users/me/analytics");

        // Simulate API delay
        showNotification("Refreshing dashboard...", "info");

        setTimeout(() => {
          // Update summary cards
          updateSummaryCards();

          // Update activity timeline
          updateActivityTimeline();

          // Show notification
          showNotification("Dashboard refreshed successfully", "success");
        }, 1000);
      }

      function refreshAnalytics() {
        // In a real implementation, this would fetch fresh analytics data from the API
        // GET /api/users/me/analytics
        console.log("API Call: GET /api/users/me/analytics");

        // Simulate API delay
        showNotification("Refreshing analytics...", "info");

        setTimeout(() => {
          // Update charts
          idcardAnalyticsChart.data.datasets[0].data = Object.values(
            mockAPI.analytics.idcardRequests
          );
          idcardAnalyticsChart.update();

          certificateAnalyticsChart.data.datasets[0].data = Object.values(
            mockAPI.analytics.certificateRequests
          );
          certificateAnalyticsChart.update();

          requestRatioChart.data.datasets[0].data = Object.values(
            mockAPI.analytics.requestStatus
          );
          requestRatioChart.update();

          requestFrequencyAnalyticsChart.data.datasets[0].data = Object.values(
            mockAPI.analytics.requestFrequency
          );
          requestFrequencyAnalyticsChart.update();

          // Show notification
          showNotification("Analytics refreshed successfully", "success");
        }, 1000);
      }

      function logout() {
        // Clear authentication token
        localStorage.removeItem("token");

        // Clear profile form data on logout
        localStorage.removeItem("profileFormData");

        // Redirect to login page
        window.location.href = "./auth/login.html";
      }

      function showNotification(message, type = "info") {
        const alertClass =
          type === "success"
            ? "alert-success"
            : type === "error"
            ? "alert-danger"
            : type === "warning"
            ? "alert-warning"
            : "alert-info";

        const notification = $(`
            <div class="alert ${alertClass} alert-dismissible fade show position-fixed" style="top: 80px; right: 20px; z-index: 9999; min-width: 300px;">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `);

        $("body").append(notification);

        setTimeout(() => {
          notification.alert("close");
        }, 5000);
      }

      // Event delegation for dynamically created elements
      // $(document).on("click", ".download-btn", function () {
      //   const requestId = $(this).data("id");
      //   showNotification(`Downloading document ${requestId}...`, "info");

      //   // Simulate download delay
      //   setTimeout(() => {
      //     showNotification(
      //       `Document ${requestId} downloaded successfully`,
      //       "success"
      //     );
      //   }, 1500);

      //   // In a real implementation, this would make an API call
      //   // GET /api/documents/:id/download
      //   console.log("API Call: GET /api/documents/" + requestId + "/download");
      // });

      $(document).on("click", ".view-btn", async function () {
        const requestId = $(this).data("id");
        const requestType = $(this).data("type"); // "certificate" or "idcard"

        try {
          let endpoint = "";

          if (requestType === "certificate") {
            endpoint = `${BACKEND_URL}/indigene/certificate/${user.id}`;
          } else if (requestType === "idcard") {
            endpoint = `${BACKEND_URL}/idcard/${user.id}`;
          } else {
            throw new Error("Unknown request type");
          }

          const request = await $.ajax({
            url: endpoint,
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          if (request) {
            showRequestDetailsModal(request); // show in modal or another page
          } else {
            alert("No request found for this ID.");
          }
        } catch (error) {
          console.error("Error fetching request details:", error);
          alert("Failed to fetch request details. Please try again.");
        }
      });

      function showRequestDetailsModal(request) {
        console.log(request);
        $("#viewRequestModal .modal-title").text(`Request #${request._id}`);
        $("#viewRequestModal .modal-body").html(`
  <p><strong>Name:</strong> ${request.firstname || request.fullname || ""} ${
          request.lastname || ""
        }</p>
  <p><strong>Status:</strong> ${request.status}</p>
  <p><strong>Issued:</strong> ${
    request.dateOfIssue
      ? new Date(request.dateOfIssue).toLocaleDateString()
      : "N/A"
  }</p>
  <p><strong>Expires:</strong> ${
    request.dateOfExpiration
      ? new Date(request.dateOfExpiration).toLocaleDateString()
      : "N/A"
  }</p>
`);
        $("#viewRequestModal").modal("show");
      }

      // LGA Data for Nigeria
      const nigeriaData = {
        adamawa: [
          "Demsa",
          "Fufure",
          "Ganye",
          "Gayuk",
          "Gombi",
          "Grie",
          "Hong",
          "Jada",
          "Larmurde",
          "Madagali",
          "Maiha",
          "Mayo Belwa",
          "Michika",
          "Mubi North",
          "Mubi South",
          "Numan",
          "Shelleng",
          "Song",
          "Toungo",
          "Yola North",
          "Yola South",
        ],
        akwa_ibom: [
          "Abak",
          "Eastern Obolo",
          "Eket",
          "Esit Eket",
          "Essien Udim",
          "Etim Ekpo",
          "Etinan",
          "Ibeno",
          "Ibesikpo Asutan",
          "Ibiono-Ibom",
          "Ikot Abasi",
          "Ika",
          "Ikono",
          "Ikot Ekpene",
          "Ini",
          "Mkpat-Enin",
          "Itu",
          "Mbo",
          "Nsit-Atai",
          "Nsit-Ibom",
          "Nsit-Ubium",
          "Obot Akara",
          "Okobo",
          "Onna",
          "Oron",
          "Udung-Uko",
          "Ukanafun",
          "Oruk Anam",
          "Uruan",
          "Urue-Offong/Oruko",
          "Uyo",
        ],
        anambra: [
          "Aguata",
          "Anambra East",
          "Anaocha",
          "Awka North",
          "Anambra West",
          "Awka South",
          "Ayamelum",
          "Dunukofia",
          "Ekwusigo",
          "Idemili North",
          "Idemili South",
          "Ihiala",
          "Njikoka",
          "Nnewi North",
          "Nnewi South",
          "Ogbaru",
          "Onitsha North",
          "Onitsha South",
          "Orumba North",
          "Orumba South",
          "Oyi",
        ],
        abia: [
          "Aba North",
          "Arochukwu",
          "Aba South",
          "Bende",
          "Isiala Ngwa North",
          "Ikwuano",
          "Isiala Ngwa South",
          "Isuikwuato",
          "Obi Ngwa",
          "Ohafia",
          "Osisioma",
          "Ugwunagbo",
          "Ukwa East",
          "Ukwa West",
          "Umuahia North",
          "Umuahia South",
          "Umu Nneochi",
        ],
        bauchi: [
          "Alkaleri",
          "Bauchi",
          "Bogoro",
          "Damban",
          "Darazo",
          "Dass",
          "Gamawa",
          "Ganjuwa",
          "Giade",
          "Itas/Gadau",
          "Jama'are",
          "Katagum",
          "Kirfi",
          "Misau",
          "Ningi",
          "Shira",
          "Tafawa Balewa",
          "Toro",
          "Warji",
          "Zaki",
        ],
        benue: [
          "Agatu",
          "Apa",
          "Ado",
          "Buruku",
          "Gboko",
          "Guma",
          "Gwer East",
          "Gwer West",
          "Katsina-Ala",
          "Konshisha",
          "Kwande",
          "Logo",
          "Makurdi",
          "Obi",
          "Ogbadibo",
          "Ohimini",
          "Oju",
          "Okpokwu",
          "Oturkpo",
          "Tarka",
          "Ukum",
          "Ushongo",
          "Vandeikya",
        ],
        borno: [
          "Abadam",
          "Askira/Uba",
          "Bama",
          "Bayo",
          "Biu",
          "Chibok",
          "Damboa",
          "Dikwa",
          "Guzamala",
          "Gubio",
          "Hawul",
          "Gwoza",
          "Jere",
          "Kaga",
          "Kala/Balge",
          "Konduga",
          "Kukawa",
          "Kulfi",
          "Kwaya Kusar",
          "Mafa",
          "Magumeri",
          "Maiduguri",
          "Mobbar",
          "Marte",
          "Monguno",
          "Ngala",
          "Nganzai",
          "Shani",
        ],
        bayelsa: [
          "Brass",
          "Ekeremor",
          "Kolokuma/Opokuma",
          "Nembe",
          "Ogbia",
          "Sagbama",
          "Southern Ijaw",
          "Yenagoa",
        ],
        cross_river: [
          "Abi",
          "Akamkpa",
          "Akpabuyo",
          "Bakassi",
          "Bekwarra",
          "Biase",
          "Boki",
          "Calabar Municipal",
          "Calabar South",
          "Etung",
          "Ikom",
          "Obanliku",
          "Obubra",
          "Obudu",
          "Odukpani",
          "Ogoja",
          "Yakuur",
          "Yala",
        ],
        delta: [
          "Aniocha North",
          "Aniocha South",
          "Bomadi",
          "Burutu",
          "Ethiope West",
          "Ethiope East",
          "Ika North East",
          "Ika South",
          "Isoko North",
          "Isoko South",
          "Ndokwa East",
          "Ndokwa West",
          "Okpe",
          "Oshimili North",
          "Oshimili South",
          "Patani",
          "Sapele",
          "Udu",
          "Ughelli North",
          "Ukwuani",
          "Ughelli South",
          "Uvwie",
          "Warri North",
          "Warri South",
          "Warri South West",
        ],
        ebonyi: [
          "Abakaliki",
          "Afikpo North",
          "Ebonyi",
          "Afikpo South",
          "Ezza North",
          "Ikwo",
          "Ezza South",
          "Ivo",
          "Ishielu",
          "Izzi",
          "Ohaozara",
          "Ohaukwu",
          "Onicha",
        ],
        edo: [
          "Akoko-Edo",
          "Egor",
          "Esan Central",
          "Esan North-East",
          "Esan South-East",
          "Esan West",
          "Etsako Central",
          "Etsako East",
          "Etsako West",
          "Igueben",
          "Ikpoba Okha",
          "Orhionmwon",
          "Oredo",
          "Ovia North-East",
          "Ovia South-West",
          "Owan East",
          "Owan West",
          "Uhunmwonde",
        ],
        ekiti: [
          "Ado Ekiti",
          "Efon",
          "Ekiti East",
          "Ekiti South-West",
          "Ekiti West",
          "Emure",
          "Gbonyin",
          "Ido Osi",
          "Ijero",
          "Ikere",
          "Ilejemeje",
          "Irepodun/Ifelodun",
          "Ikole",
          "Ise/Orun",
          "Moba",
          "Oye",
        ],
        enugu: [
          "Awgu",
          "Aninri",
          "Enugu East",
          "Enugu North",
          "Ezeagu",
          "Enugu South",
          "Igbo Etiti",
          "Igbo Eze North",
          "Igbo Eze South",
          "Isi Uzo",
          "Nkanu East",
          "Nkanu West",
          "Nsukka",
          "Udenu",
          "Oji River",
          "Uzo Uwani",
          "Udi",
        ],
        abuja: [
          "Abaji",
          "Bwari",
          "Gwagwalada",
          "Kuje",
          "Kwali",
          "Municipal Area Council",
        ],
        gombe: [
          "Akko",
          "Balanga",
          "Billiri",
          "Bukuru",
          "Dukku",
          "Funakaye",
          "Gombe",
          "Kaltungo",
          "Keffi",
          "Kwami",
          "Nafada",
          "Shongom",
          "Yamaltu/Deba",
        ],
        jigawa: [
          "Auyo",
          "Babura",
          "Buji",
          "Biriniwa",
          "Birnin Kudu",
          "Dutse",
          "Gagarawa",
          "Garki",
          "Gumel",
          "Guri",
          "Gwaram",
          "Gwiwa",
          "Hadejia",
          "Jahun",
          "Kafin Hausa",
          "Kazaure",
          "Kiri Kasama",
          "Kiyawa",
          "Kaugama",
          "Maigatari",
          "Malam Madori",
          "Miga",
          "Sule Tankarkar",
          "Roni",
          "Ringim",
          "Yankwashi",
          "Taura",
        ],
        lagos: [
          "Agege",
          "Ajeromi-Ifelodun",
          "Alimosho",
          "Amuwo-Odofin",
          "Badagry",
          "Apapa",
          "Epe",
          "Eti Osa",
          "Ibeju-Lekki",
          "Ifako-Ijaiye",
          "Ikeja",
          "Ikorodu",
          "Kosofe",
          "Lagos Island",
          "Mushin",
          "Lagos Mainland",
          "Ojo",
          "Oshodi-Isolo",
          "Shomolu",
          "Surulere Lagos State",
        ],
        oyo: [
          "Afijio",
          "Akinyele",
          "Atiba",
          "Atisbo",
          "Egbeda",
          "Ibadan North",
          "Ibadan North-East",
          "Ibadan North-West",
          "Ibadan South-East",
          "Ibarapa Central",
          "Ibadan South-West",
          "Ibarapa East",
          "Ido",
          "Ibarapa North",
          "Irepo",
          "Iseyin",
          "Itesiwaju",
          "Iwajowa",
          "Kajola",
          "Lagelu",
          "Ogbomosho North",
          "Ogbomosho South",
          "Ogo Oluwa",
          "Olorunsogo",
          "Oluyole",
          "Ona Ara",
          "Orelope",
          "Ori Ire",
          "Oyo",
          "Oyo East",
          "Saki East",
          "Saki West",
          "Surulere Oyo State",
        ],
        imo: [
          "Aboh Mbaise",
          "Ahiazu Mbaise",
          "Ehime Mbano",
          "Ezinihitte",
          "Ideato North",
          "Ideato South",
          "Ihitte/Uboma",
          "Ikeduru",
          "Isiala Mbano",
          "Mbaitoli",
          "Isu",
          "Ngor Okpala",
          "Njaba",
          "Nkwerre",
          "Nwangele",
          "Obowo",
          "Oguta",
          "Ohaji/Egbema",
          "Okigwe",
          "Orlu",
          "Orsu",
          "Oru East",
          "Oru West",
          "Owerri Municipal",
          "Owerri North",
          "Unuimo",
          "Owerri West",
        ],
        kaduna: [
          "Birnin Gwari",
          "Chikun",
          "Giwa",
          "Ikara",
          "Igabi",
          "Jaba",
          "Jema'a",
          "Kachia",
          "Kaduna North",
          "Kaduna South",
          "Kagarko",
          "Kajuru",
          "Kaura",
          "Kauru",
          "Kubau",
          "Kudan",
          "Lere",
          "Makarfi",
          "Sabon Gari",
          "Sanga",
          "Soba",
          "Zangon Kataf",
          "Zaria",
        ],
        kebbi: [
          "Aleiro",
          "Argungu",
          "Arewa Dandi",
          "Augie",
          "Bagudo",
          "Birnin Kebbi",
          "Bunza",
          "Dandi",
          "Fakai",
          "Gwandu",
          "Jega",
          "Kalgo",
          "Koko/Besse",
          "Maiyama",
          "Ngaski",
          "Shanga",
          "Suru",
          "Sakaba",
          "Wasagu/Danko",
          "Yauri",
          "Zuru",
        ],
        kano: [
          "Ajingi",
          "Albasu",
          "Bagwai",
          "Bebeji",
          "Bichi",
          "Bunkure",
          "Dala",
          "Dambatta",
          "Dawakin Kudu",
          "Dawakin Tofa",
          "Doguwa",
          "Fagge",
          "Gabasawa",
          "Garko",
          "Garun Mallam",
          "Gaya",
          "Gwale",
          "Gwarzo",
          "Kabo",
          "Kano Municipal",
          "Karaye",
          "Kibiya",
          "Kiru",
          "Kumbotso",
          "Kunchi",
          "Kura",
          "Madobi",
          "Makoda",
          "Minjibir",
          "Nasarawa",
          "Rano",
          "Rimin Gado",
          "Rogo",
          "Shanono",
          "Takai",
          "Sumaila",
          "Tarauni",
          "Tofa",
          "Tsanyawa",
          "Tudun Wada",
          "Ungogo",
          "Warawa",
          "Wudil",
        ],
        kogi: [
          "Ajaokuta",
          "Adavi",
          "Ankpa",
          "Bassa",
          "Dekina",
          "Ibaji",
          "Idah",
          "Igalamela Odolu",
          "Ijumu",
          "Kogi",
          "Kabba/Bunu",
          "Lokoja",
          "Ofu",
          "Mopa Muro",
          "Ogori/Magongo",
          "Okehi",
          "Okene",
          "Olamaboro",
          "Omala",
          "Yagba East",
          "Yagba West",
        ],
        osun: [
          "Aiyedire",
          "Atakunmosa West",
          "Atakunmosa East",
          "Aiyedaade",
          "Boluwaduro",
          "Boripe",
          "Ife East",
          "Ede South",
          "Ife North",
          "Ede North",
          "Ife South",
          "Ejigbo",
          "Ife Central",
          "Ifedayo",
          "Egbedore",
          "Ila",
          "Ifelodun",
          "Ilesa East",
          "Ilesa West",
          "Irepodun",
          "Irewole",
          "Isokan",
          "Iwo",
          "Obokun",
          "Odo Otin",
          "Ola Oluwa",
          "Olorunda",
          "Oriade",
          "Orolu",
          "Osogbo",
        ],
        sokoto: [
          "Gudu",
          "Gwadabawa",
          "Illela",
          "Isa",
          "Kebbe",
          "Kware",
          "Rabah",
          "Sabon Birni",
          "Shagari",
          "Silame",
          "Sokoto North",
          "Sokoto South",
          "Tambuwal",
          "Tangaza",
          "Tureta",
          "Wamako",
          "Wurno",
          "Yabo",
          "Binji",
          "Bodinga",
          "Dange Shuni",
          "Goronyo",
          "Gada",
        ],
        plateau: [
          "Bokkos",
          "Barkin Ladi",
          "Bassa",
          "Jos East",
          "Jos North",
          "Jos South",
          "Kanam",
          "Kanke",
          "Langtang South",
          "Langtang North",
          "Mangu",
          "Mikang",
          "Pankshin",
          "Qua'an Pan",
          "Riyom",
          "Shendam",
          "Wase",
        ],
        taraba: [
          "Ardo Kola",
          "Bali",
          "Donga",
          "Gashaka",
          "Gassol",
          "Ibi",
          "Jalingo",
          "Karim Lamido",
          "Kumi",
          "Lau",
          "Sardauna",
          "Takum",
          "Ussa",
          "Wukari",
          "Yorro",
          "Zing",
        ],
        yobe: [
          "Bade",
          "Bursari",
          "Damaturu",
          "Fika",
          "Fune",
          "Geidam",
          "Gujba",
          "Gulani",
          "Jakusko",
          "Karasuwa",
          "Machina",
          "Magumeri",
          "Maiduguri",
          "Mobbar",
          "Marte",
          "Monguno",
          "Ngala",
          "Nganzai",
          "Potiskum",
          "Tarmuwa",
          "Yunusari",
          "Yusufari",
        ],
        zamfara: [
          "Anka",
          "Birnin Magaji/Kiyaw",
          "Bakura",
          "Bukkuyum",
          "Bungudu",
          "Gummi",
          "Gusau",
          "Kaura Namoda",
          "Maradun",
          "Shinkafi",
          "Maru",
          "Talata Mafara",
          "Tsafe",
          "Zurmi",
        ],
        katsina: [
          "Bakori",
          "Batagarawa",
          "Batsari",
          "Baure",
          "Bindawa",
          "Charanchi",
          "Danja",
          "Dandume",
          "Dan Musa",
          "Daura",
          "Dutsi",
          "Dutsin Ma",
          "Faskari",
          "Funtua",
          "Ingawa",
          "Jibia",
          "Kafur",
          "Kaita",
          "Kankara",
          "Kankia",
          "Katsina",
          "Kurfi",
          "Kusada",
          "Mai'Adua",
          "Malumfashi",
          "Mashi",
          "Matazu",
          "Musawa",
          "Rimi",
          "Sabuwa",
          "Safana",
          "Sandamu",
          "Zango",
        ],
        kwara: [
          "Asa",
          "Baruten",
          "Edu",
          "Ilorin East",
          "Ifelodun",
          "Ilorin South",
          "Ekiti Kwara State",
          "Ilorin West",
          "Irepodun",
          "Isin",
          "Kaiama",
          "Moro",
          "Offa",
          "Oke Ero",
          "Oyun",
          "Pategi",
        ],
        nasarawa: [
          "Akwanga",
          "Awe",
          "Doma",
          "Karu",
          "Keana",
          "Keffi",
          "Lafia",
          "Kokona",
          "Nasarawa Egon",
          "Nasarawa",
          "Obi",
          "Toto",
          "Wamba",
        ],
        niger: [
          "Agaie",
          "Agwara",
          "Bida",
          "Borgu",
          "Bosso",
          "Chanchaga",
          "Edati",
          "Gbako",
          "Gurara",
          "Katcha",
          "Kontagora",
          "Lapai",
          "Lavun",
          "Mariga",
          "Magama",
          "Mokwa",
          "Mashegu",
          "Moya",
          "Paikoro",
          "Rafi",
          "Rijau",
          "Shiroro",
          "Suleja",
          "Tafa",
          "Wushishi",
        ],
        rivers: [
          "Abua/Odual",
          "Ahoada East",
          "Ahoada West",
          "Andoni",
          "Akuku-Toru",
          "Asari-Toru",
          "Bonny",
          "Degema",
          "Emuoha",
          "Eleme",
          "Ikwerre",
          "Etche",
          "Gokana",
          "Khana",
          "Obio/Akpor",
          "Ogba/Egbema/Ndoni",
          "Ogu/Bolo",
          "Okrika",
          "Omuma",
          "Opobo/Nkoro",
          "Oyigbo",
          "Port Harcourt",
          "Tai",
        ],
      };

      function updateLocalGovernmentsOfResidence() {
        const stateSelect = document.getElementById("stateOfResidence");
        const lgaSelect = document.getElementById("lgaOfResidence");
        const selectedState = stateSelect.value;
        // Clear previous options
        lgaSelect.innerHTML =
          '<option value="">Select Local Government</option>';

        if (nigeriaData[selectedState]) {
          nigeriaData[selectedState].forEach((lga) => {
            const option = document.createElement("option");
            option.value = lga;
            option.textContent = lga;
            lgaSelect.appendChild(option);
          });
        }
      }

      function addEmployment() {
        const empItem = $(`
          <div class="employment-item mb-3">
              <div class="card">
                  <div class="card-body">
                      <div class="row">
                          <div class="col-md-6 mb-3">
                              <label class="form-label">Company Name</label>
                              <input type="text" class="form-control employment-company" required>
                          </div>
                          <div class="col-md-6 mb-3">
                              <label class="form-label">Position</label>
                              <input type="text" class="form-control employment-position" required>
                          </div>
                      </div>
                      <div class="row">
                          <div class="col-md-6 mb-3">
                              <label class="form-label">Start Date</label>
                              <input type="date" class="form-control employment-start" required>
                          </div>
                          <div class="col-md-6 mb-3">
                              <label class="form-label">End Date</label>
                              <input type="date" class="form-control employment-end">
                          </div>
                      </div>
                      <div class="text-end">
                          <button type="button" class="btn btn-sm btn-outline-danger remove-employment">
                              <i class="bi bi-trash"></i> Remove
                          </button>
                      </div>
                  </div>
              </div>
          </div>
      `);
        $("#employmentHistoryContainer").append(empItem);
      }

      function addBusiness() {
        const busItem = $(`
          <div class="business-item mb-3">
              <div class="card">
                  <div class="card-body">
                      <div class="row">
                          <div class="col-md-4 mb-3">
                              <label class="form-label">Business Name</label>
                              <input type="text" class="form-control business-name" required>
                          </div>
                          <div class="col-md-4 mb-3">
                              <label class="form-label">Business Type</label>
                              <input type="text" class="form-control business-type" required>
                          </div>
                          <div class="col-md-4 mb-3">
                              <label class="form-label">Registration Number</label>
                              <input type="text" class="form-control business-registration">
                          </div>
                      </div>
                      <div class="text-end">
                          <button type="button" class="btn btn-sm btn-outline-danger remove-business">
                              <i class="bi bi-trash"></i> Remove
                          </button>
                      </div>
                  </div>
              </div>
          </div>
      `);
        $("#businessContainer").append(busItem);
      }

      function addEducation() {
        const eduItem = $(`
          <div class="education-item mb-3">
              <div class="card">
                  <div class="card-body">
                      <div class="row">
                          <div class="col-md-6 mb-3">
                              <label class="form-label">Institution</label>
                              <input type="text" class="form-control education-institution" required>
                          </div>
                          <div class="col-md-6 mb-3">
                              <label class="form-label">Qualification</label>
                              <input type="text" class="form-control education-qualification" required>
                          </div>
                      </div>
                      <div class="row">
                          <div class="col-md-6 mb-3">
                              <label class="form-label">Start Date</label>
                              <input type="date" class="form-control education-start" required>
                          </div>
                          <div class="col-md-6 mb-3">
                              <label class="form-label">End Date</label>
                              <input type="date" class="form-control education-end">
                          </div>
                      </div>
                      <div class="text-end">
                          <button type="button" class="btn btn-sm btn-outline-danger remove-education">
                              <i class="bi bi-trash"></i> Remove
                          </button>
                      </div>
                  </div>
              </div>
          </div>
      `);
        $("#educationHistoryContainer").append(eduItem);
      }

      function addNextOfKin() {
        const kinItem = $(`
          <div class="next-of-kin-item mb-3">
              <div class="card">
                  <div class="card-body">
                      <div class="row">
                          <div class="col-md-4 mb-3">
                              <label class="form-label">Full Name</label>
                              <input type="text" class="form-control next-of-kin-name" required>
                          </div>
                          <div class="col-md-4 mb-3">
                              <label class="form-label">Relationship</label>
                              <input type="text" class="form-control next-of-kin-relationship" required>
                          </div>
                          <div class="col-md-4 mb-3">
                              <label class="form-label">Phone</label>
                              <input type="tel" class="form-control next-of-kin-phone" required>
                          </div>
                      </div>
                      <div class="row">
                          <div class="col-md-6 mb-3">
                              <label class="form-label">Address</label>
                              <input type="text" class="form-control next-of-kin-address" required>
                          </div>
                          <div class="col-md-6 mb-3">
                              <label class="form-label">Email</label>
                              <input type="text" class="form-control next-of-kin-email" required>
                          </div>
                      </div>
                    
                      <div class="text-end">
                          <button type="button" class="btn btn-sm btn-outline-danger remove-next-of-kin">
                              <i class="bi bi-trash"></i> Remove
                          </button>
                      </div>
                  </div>
              </div>
          </div>
      `);
        $("#nextOfKinContainer").append(kinItem);
      }

      // Ensure profile form arrays and dynamic items are saved before a reload/refresh.
      // This forces a synchronous localStorage write so data isn't lost on refresh.
      (function () {
        function persistProfileIfVisible() {
          try {
            const profilePage = document.getElementById("profile-page");
            if (profilePage && !profilePage.classList.contains("d-none")) {
              // saveProfileFormData is defined in the page and writes dynamic arrays
              if (typeof saveProfileFormData === "function") {
                saveProfileFormData();
                // small guard log for debugging (remove if not needed)
                console.debug("profileFormData saved before unload");
              }
            }
          } catch (err) {
            console.warn("persistProfileIfVisible failed:", err);
          }
        }

        // Modern browsers: pagehide fires reliably when navigating away / reloading.
        window.addEventListener("pagehide", persistProfileIfVisible, {
          capture: true,
        });

        // beforeunload as a fallback (synchronous work only)
        window.addEventListener("beforeunload", function (e) {
          persistProfileIfVisible();
          // do not block unload; just ensure data is written
        });
      })();
    </script>

    <script type="text/javascript" src="../js/index.js"></script>
  </body>
</html>
