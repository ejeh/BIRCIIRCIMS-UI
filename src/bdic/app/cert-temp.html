<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Certificate of Indigene</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
      @font-face {
        font-family: "MyCustomFont";
        src: url("/fonts/goudybol.ttf") format("truetype");
      }
      @font-face {
        font-family: "VenturisADFNo2-Regular";
        src: url("/fonts/VenturisADFNo2-Regular.ttf.woff") format("woff");
        font-weight: normal;
        font-style: normal;
      }

      body,
      html {
        margin: 10px;
        padding: 10px;
        height: 100%;
        background: #f9f9f9;
        font-family: "Times New Roman", serif;
      }
      .certificate {
        width: 100%;
        /* height: 100%; */
        padding: 40px;
        border: 15px solid #28a745;
        background: white;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
        text-align: center;
        position: relative;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        text-transform: capitalize;
      }
      .certificate::before {
        content: "";
        position: absolute;
        top: 10px;
        left: 10px;
        right: 10px;
        bottom: 10px;
        border: 5px solid #28a745;
        opacity: 0.5;
      }
      .logo {
        width: 100px;
        margin-bottom: 10px;
      }
      .passport-photo {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 80px;
        height: 100px;
        border: 2px solid #000;
        object-fit: cover;
      }
      h1 {
        font-size: 30px;
        color: #28a745;
        margin-bottom: 10px;
        font-family: "MyCustomFont, sans-serif;";
        line-height: 25px;
        transform: scaleY(1.4);
        letter-spacing: -2px;
      }
      h2 {
        font-size: 20px;
        color: #333;
        margin: 5px 0;
        font-family: "VenturisADFNo2-Regular";
      }
      p {
        font-size: 20px;
        color: #555;
        margin: 5px 0;
        font-family: Verdana, Geneva, Tahoma, sans-serif;
      }
      .details {
        text-align: center;
        margin: 10px 20px;
      }
      .details p {
        margin: 5px 0;
      }
      .qr-code img {
        width: 80px;
        height: 80px;
      }
      .signature {
        /* text-align: right; */
        margin-top: 10px;
        text-align: center;
      }
      .signature p {
        font-weight: bold;
        color: #333;
        margin: 5px 0;
      }
      .footer-text {
        font-size: 12px;
        color: #777;
        margin-top: 10px;
      }
      .issue-date {
        font-size: 14px;
        color: #555;
        margin-top: 0;
      }
      .row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
      }
      .col-md-4 {
        flex: 1;
      }
      #date {
        margin-bottom: 0;
      }
      hr {
        margin-top: 0;
        margin-bottom: 0;
      }
      .fullname {
        font-size: 34px;
        color: #28a745;
      }
      .btn-secondary {
        color: white;
        background-color: #ff6175;
        border-color: #ff6175;
      }
    </style>
  </head>
  <body>
    <form id="upload-form" enctype="multipart/form-data">
      <input type="file" id="file" required />
      <button type="submit" class="btn btn-secondary">
        Upload Attestation
      </button>
    </form>
    <div class="certificate">
      <img
        class="logo"
        src="/assets//images/benue-state-logo.png"
        alt="State Logo"
      />
      <img
        id="passport"
        class="passport-photo"
        src="{{passportPhoto}}"
        alt="Passport Photo"
        crossorigin="anonymous"
      />
      <h1>
        CERTIFICATE <br /><span style="color: rgb(83, 83, 83); font-size: 28px">
          OF INDIGENE
        </span>
      </h1>
      <p>This is to certify that</p>
      <h2 id="name" class="fullname">Loading...</h2>
      <p>Is a bonafide indigene of Benue State, Nigeria.</p>
      <hr />
      <div class="details">
        <p>
          <strong>Local Government:</strong>
          <span id="lga" class="text-muted">Loading...</span>
        </p>
        <p>
          <strong>Family of Mr & Mrs:</strong>
          <span id="family" class="text-muted">Loading...</span>
        </p>
        <p>
          <strong>Council Ward:</strong>
          <span id="ward" class="text-muted">Loading...</span>
        </p>
        <p>
          <strong>Kindred:</strong>
          <span id="kindred" class="text-muted">Loading...</span>
        </p>
        <p>
          <strong>Date of Birth:</strong>
          <span id="dob" class="text-muted">Loading...</span>
        </p>
      </div>
      <div class="row">
        <div class="col-md-4">
          <p
            style="font-weight: bold; color: #525151; margin: 5px 0"
            id="date"
            class="text-muted"
          >
            Loading...
          </p>
          <hr />
          <div class="issue-date">
            <p>Issue Date:</p>
          </div>
        </div>
        <div class="col-md-4 qr-code">
          <img src="{{qrCodeUrl}}" alt="QR Code" />
        </div>
        <div class="col-md-4 signature">
          <img
            src="../src/assets/images/Adobe Express - file.png"
            alt="signature"
            width="20%"
          />
          <p style="margin-bottom: 10px">Dr. Samuel Dede Nyijeme</p>
          <p class="text-muted" style="color: #555">
            Honourable Commissioner <br />
            Benue State Ministry Board
          </p>
        </div>
      </div>
      <p class="footer-text">
        This certificate is issued based on the information provided by the
        applicant and verified by the relevant authorities.
      </p>
    </div>

    <script>
      $(document).ready(function () {
        // Retrieve the token from localStorage
        let userData = localStorage.getItem("token");
        userData = JSON.parse(userData);
        const { token, user } = userData; // Destructure to get only the token
        console.log(user);

        // Extract certificateId from the URL query parameters
        const urlParams = new URLSearchParams(window.location.search);
        const certificateId = urlParams.get("id");

        if (certificateId) {
          // Make the AJAX request
          $.ajax({
            url: `${BACKEND_URL}/indigene/certificate/${certificateId}/get`,
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            success: function (response) {
              console.log("Response received:", response);

              // Check if the response contains data
              if (response && Object.keys(response).length > 0) {
                const date = new Date();

                // Format as "February 20, 1991"
                const formattedDate = date.toLocaleDateString("en-US", {
                  year: "numeric",
                  month: "long",
                  day: "numeric",
                });

                const dob = new Date(response.DOB);
                // Format as "February 20, 1991"
                const formattedDOB = dob.toLocaleDateString("en-US", {
                  year: "numeric",
                  month: "long",
                  day: "numeric",
                });
                // Populate the certificate details
                $("#name").text(
                  `${response.firstname} ${response.middlename} ${response.lastname}`
                );
                $("#lga").text(response.lgaOfOrigin);
                $("#family").text(
                  response.fathersName + " " + response.mothersName
                );
                $("#ward").text(response.ward);
                $("#date").text(formattedDate);
                $("#kindred").text(response.kindred);
                $("#passport").text(user.passportPhoto);
                $("#dob").text(formattedDOB);
              } else {
                console.error("Empty data received from the backend.");
                alert("No certificate data found.");
              }
            },
            error: function (xhr, status, error) {
              console.error(
                "Error fetching certificate details:",
                status,
                error
              );
              alert(
                "Failed to load certificate details. Please try again later."
              );
            },
          });
        } else {
          console.error("Certificate ID not found in URL.");
          alert("Certificate ID is missing in the URL.");
        }
      });
    </script>
    <script>
      // upload attestation
      document.addEventListener("DOMContentLoaded", function () {
        const uploadForm = document.getElementById("upload-form");
        const fileInput = document.getElementById("file");

        uploadForm.addEventListener("submit", async function (e) {
          e.preventDefault();

          // Retrieve user authentication data
          const userData = JSON.parse(localStorage.getItem("token"));
          if (!userData?.token || !userData?.user?.id) {
            Swal.fire("Error", "User authentication failed!", "error");
            return;
          }

          // Fetch certificate ID dynamically
          try {
            const certResponse = await fetch(
              `${BACKEND_URL}/indigene/certificate/${userData.user.id}`,
              {
                method: "GET",
                headers: { Authorization: `Bearer ${userData.token}` },
              }
            );

            if (!certResponse.ok)
              throw new Error("Failed to retrieve certificate ID");

            const certData = await certResponse.json();
            const certificateId = certData._id;

            if (!certificateId) {
              Swal.fire("Error", "Certificate ID not found!", "error");
              return;
            }

            // Prepare file upload
            const formData = new FormData();
            formData.append("file", fileInput.files[0]);

            // Upload attestation file
            const uploadResponse = await fetch(
              `${BACKEND_URL}/indigene/certificate/upload/attestation/${certificateId}`,
              {
                method: "POST",
                body: formData,
                headers: { Authorization: `Bearer ${userData.token}` },
              }
            );

            if (!uploadResponse.ok)
              throw new Error("Failed to upload attestation");

            Swal.fire(
              "Success",
              "Attestation uploaded! Await admin approval.",
              "success"
            );
          } catch (error) {
            console.error("Upload Error:", error);
            Swal.fire("Error", "An error occurred during upload.", "error");
          }
        });
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script type="text/javascript" src="/js/index.js"></script>
  </body>
</html>
